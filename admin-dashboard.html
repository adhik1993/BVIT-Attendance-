<!DOCTYPE html>
<script>
// Global Firebase Offline Fallback (must be first)
(function() {
    if (typeof window.firebase === 'undefined') {
        window.firebaseOfflineMode = false;
        window.firebase = {
            database: function() {
                window.firebaseOfflineMode = true;
                return {
                    ref: function() { return { on: function() {}, once: function() {}, off: function() {}, set: function() {}, update: function() {}, remove: function() {} }; }
                };
            },
            auth: function() {
                window.firebaseOfflineMode = true;
                return {
                    onAuthStateChanged: function(cb) { cb(null); return function(){}; },
                    signOut: function() { return Promise.resolve(); },
                    currentUser: null
                };
            },
            apps: [],
        };
    }
})();
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BVIT</title>
    
    <!-- Load Firebase SDKs first -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Then load our Firebase config -->
    <script src="firebase-config.js"></script>
    
    <!-- Other resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --dark: #1F2937;
            --darker: #111827;
            --light: #F3F4F6;
            --lighter: #F9FAFB;
            --border: #E5E7EB;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --text-lighter: #9CA3AF;
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--light);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--darker);
            min-height: 100vh;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: var(--text-lighter);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link i {
            font-size: 1.25rem;
            width: 1.5rem;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .stat-students { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .stat-teachers { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .stat-attendance { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-performance { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Recent Activity Styles */
        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 0;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 2rem;
        }

        .activity-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .activity-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        .activity-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-header h3 i {
            font-size: 1.5rem;
        }

        .activity-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--primary-light);
            color: var(--primary);
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .activity-details {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .activity-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
            background: var(--light);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
        }

        .activity-detail i {
            font-size: 0.875rem;
            color: var(--primary);
        }

        .activity-time {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .action-title {
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 5rem;
                padding: 1rem;
            }

            .logo-text, .nav-text {
                display: none;
            }

            .main-content {
                margin-left: 5rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 1rem;
            }
        }

        /* Add logout button styles */
        .logout-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px; /* Added for better touch targets */
        }

        .logout-button:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .logout-button i {
            font-size: 1.2rem;
        }

        /* Update sidebar padding to accommodate logout button */
        .sidebar {
            padding-bottom: 100px;
        }

        /* Mobile styles for logout button */
        @media (max-width: 1024px) {
    .sidebar .logout-button {
        position: absolute;
        left: 20px;
        bottom: 70px;
        width: 48px;
        height: 48px;
        padding: 0;
        border-radius: 50%;
        justify-content: center;
        align-items: center;
        min-width: unset;
        min-height: unset;
    }
    .sidebar .logout-button span {
        display: none;
    }
    .sidebar .logout-button i {
        font-size: 1.3rem;
        margin: 0;
    }
    .header-logout { display: none !important; }
}
        @media (min-width: 1025px) {
            .header-logout { display: none !important; }
        }
        /* Ensure sidebar is scrollable and on top */
        .sidebar {
            overflow-y: auto;
            z-index: 9999;
        }

        /* Remove charts related styles */
        .charts-grid,
        .chart-container,
        .chart-header,
        .chart-title,
        .chart-actions {
            display: none;
        }

        /* Update grid layouts */
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .quick-actions {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        /* Make cards bigger */
        .stat-card {
            padding: 2rem;
        }

        .action-card {
            padding: 2rem;
        }

        .stat-icon {
            width: 4rem;
            height: 4rem;
            font-size: 2rem;
        }

        .action-icon {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .action-title {
            font-size: 1.2rem;
        }

        /* Update activity card */
        .activity-card {
            margin-top: 2rem;
        }

        .activity-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .activity-list {
            padding: 1rem;
        }

        .activity-item {
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-graduation-cap logo-icon"></i>
            <span class="logo-text">BVIT Admin</span>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="student-management.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Students</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="teacher-management.html" class="nav-link">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span class="nav-text">Teachers</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="clerk-management.html" class="nav-link">
                    <i class="fas fa-user-tie"></i>
                    <span class="nav-text">Clerks</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="view-reports.html" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-text">Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showAttendanceCheck()">
                    <i class="fas fa-calendar-check"></i>
                    <span class="nav-text">Attendance Check</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="showFeedbackReport()">
                    <i class="fas fa-comment-dots"></i>
                    <span class="nav-text">Feedback Report</span>
                </a>
            </li>


            <li class="nav-section">
                <span class="nav-section-title">Settings</span>
            </li>
            <li class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </li>
        </ul>
        <button class="logout-button" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="header">
                <h1 class="page-title">Dashboard Overview</h1>
                <div class="header-actions">
                    <button class="logout-button header-logout" onclick="handleLogout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon stat-students">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-value" id="totalStudents">Loading...</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-teachers">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-value" id="totalTeachers">Loading...</div>
                <div class="stat-label">Total Teachers</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-attendance">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stat-value" id="averageAttendance">Loading...</div>
                <div class="stat-label">Average Attendance</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-performance">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value" id="performanceRate">Loading...</div>
                <div class="stat-label">Performance Rate</div>
            </div>
        </div>


        <!-- Quick Actions -->
        <!--
        <div class="quick-actions">
            <div class="action-card" onclick="window.location.href='student-management.html'">
                <i class="fas fa-user-plus action-icon"></i>
                <div class="action-title">Add Student</div>
            </div>
            <div class="action-card" onclick="window.location.href='teacher-management.html'">
                <i class="fas fa-user-tie action-icon"></i>
                <div class="action-title">Add Teacher</div>
            </div>
            <div class="action-card" onclick="window.location.href='view-reports.html'">
                <i class="fas fa-file-alt action-icon"></i>
                <div class="action-title">View Reports</div>
            </div>
        </div>
        -->

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Attendance Trend</h3>
                <div class="chart-container">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Department Statistics</h3>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>
        </div>

        <!-- Feedback Report Section -->
        <div id="feedbackReportSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-comment-dots"></i> Feedback Report
                    <span id="feedbackStatusIndicator" style="font-size: 0.8rem; margin-left: 1rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 500;">Loading...</span>
                </h1>
                <div class="header-actions">
                    <button id="feedbackToggleBtn" class="btn" onclick="toggleFeedbackSystem()" style="margin-right: 1rem;">
                        <i class="fas fa-toggle-on"></i> <span id="feedbackToggleText">Disable Feedback</span>
                    </button>
                    <button class="btn btn-primary" onclick="showDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Feedback Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(79, 70, 229, 0.1); color: var(--primary);">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <div class="stat-value" id="totalFeedbacks">0</div>
                    <div class="stat-label">Total Feedbacks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--secondary);">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-value" id="averageRating">0.0</div>
                    <div class="stat-label">Average Rating</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="stat-value" id="topRatedTeacher">-</div>
                    <div class="stat-label">Top Rated Teacher</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="stat-value" id="thisMonthFeedbacks">0</div>
                    <div class="stat-label">This Month</div>
                </div>
            </div>

            <!-- Feedback Filters -->
            <div class="feedback-filters" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department:</label>
                        <select id="departmentFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Departments</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Class/Year:</label>
                        <select id="classFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Teacher:</label>
                        <select id="teacherFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Teachers</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Subject:</label>
                        <select id="subjectFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Subjects</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Lecture Type:</label>
                        <select id="lectureTypeFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Types</option>
                            <option value="Theory">Theory</option>
                            <option value="Practical">Practical</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Rating:</label>
                        <select id="ratingFilter" onchange="filterFeedbacks()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">All Ratings</option>
                            <option value="5">5 Stars</option>
                            <option value="4">4+ Stars</option>
                            <option value="3">3+ Stars</option>
                            <option value="2">2+ Stars</option>
                            <option value="1">1+ Stars</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Feedback Table -->
            <div class="feedback-table-container" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-table"></i> Feedback Details
                    </h3>
                </div>
                <div style="overflow-x: auto;">
                    <table id="feedbackTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Student</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Department</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Class</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Teacher</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Subject</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Type</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Rating</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Date</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Action</th>
                            </tr>
                        </thead>
                        <tbody id="feedbackTableBody">
                            <tr>
                                <td colspan="9" style="padding: 2rem; text-align: center; color: var(--text-light);">
                                    <i class="fas fa-spinner fa-spin"></i> Loading feedback data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Check Section -->
        <div id="attendanceCheckSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-calendar-check"></i> Attendance Check
                </h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showDashboard()">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="attendance-check-filters" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">Department:</label>
                        <select id="attendanceCheckDepartment" onchange="loadYearsForDepartment()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;">
                            <option value="">Select Department</option>
                            <option value="CT">Computer Technology</option>
                            <option value="IT">Information Technology</option>
                            <option value="ME">Mechanical Engineering</option>
                            <option value="CE">Civil Engineering</option>
                            <option value="EE">Electrical Engineering</option>
                            <option value="ET">Electronics & Telecommunication</option>
                            <option value="AI">Artificial Intelligence</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">Year:</label>
                        <select id="attendanceCheckYear" onchange="loadDivisionsForDepartment()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;">
                            <option value="">Select Year</option>
                            <option value="FY">First Year (FY)</option>
                            <option value="SY">Second Year (SY)</option>
                            <option value="TY">Third Year (TY)</option>
                            <option value="BE">Final Year (BE)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">Division:</label>
                        <select id="attendanceCheckDivision" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;">
                            <option value="">Select Division</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-dark);">Date:</label>
                        <input type="date" id="attendanceCheckDate" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;">
                    </div>
                    <div>
                        <button id="checkAttendanceBtn" class="btn btn-primary" onclick="checkAttendanceForDate()" style="width: 100%; padding: 0.75rem;">
                            <i class="fas fa-search"></i> Check Attendance
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="attendanceCheckResults" style="display: none;">
                <!-- Summary Stats -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(79, 70, 229, 0.1); color: var(--primary);">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-value" id="totalSubjectsCount">0</div>
                        <div class="stat-label">Total Subjects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--secondary);">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                        <div class="stat-value" id="theorySubjectsCount">0</div>
                        <div class="stat-label">Theory Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-value" id="practicalSubjectsCount">0</div>
                        <div class="stat-label">Practical Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="totalStudentsAttended">0</div>
                        <div class="stat-label">Students Attended</div>
                    </div>
                </div>

                <!-- Subjects Table -->
                <div class="subjects-table-container" style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-table"></i> Subjects with Attendance
                            <span id="selectedDateDisplay" style="font-size: 0.9rem; color: var(--text-light); font-weight: normal;"></span>
                        </h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="subjectsTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--light);">
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Subject</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Lecture Type</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Teacher</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Time</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Present</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Absent</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Total</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Percentage</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Action</th>
                                </tr>
                            </thead>
                            <tbody id="subjectsTableBody">
                                <tr>
                                    <td colspan="9" style="padding: 2rem; text-align: center; color: var(--text-light);">
                                        Select filters and click "Check Attendance" to view results
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batch Management Section -->
        <div id="batchManagementSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-users-cog"></i> Batch Management
                </h1>
                <p class="page-subtitle">Manage students in batches across all departments</p>
            </div>

            <!-- Filters -->
            <div class="filters-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department:</label>
                        <select id="batchDepartment" onchange="loadBatchYears(); loadBatchOptions();" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">-- Select Department --</option>
                            <option value="CT">Computer Technology</option>
                            <option value="IT">Information Technology</option>
                            <option value="ME">Mechanical Engineering</option>
                            <option value="CE">Civil Engineering</option>
                            <option value="EE">Electrical Engineering</option>
                            <option value="ET">Electronics & Telecommunication</option>
                            <option value="AI">Artificial Intelligence</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Year:</label>
                        <select id="batchYear" onchange="loadBatchDivisions(); loadBatchOptions();" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">-- Select Year --</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Division:</label>
                        <select id="batchDivision" onchange="loadBatchOptions()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">-- Select Division --</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Batch:</label>
                        <select id="batchLetter" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">-- Select Batch --</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="loadBatchStudents()" style="width: 100%; padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-search"></i> Load Students
                        </button>
                    </div>
                </div>
            </div>

            <!-- Batch Configuration Panel -->
            <div id="batchConfigPanel" style="display: none; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; border: 2px solid var(--primary);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-cogs"></i> Batch Configuration
                    </h3>
                    <button onclick="closeBatchConfig()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-light);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <!-- Batch A Configuration -->
                    <div style="border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: var(--lighter);">
                        <h4 style="margin: 0 0 1rem 0; color: var(--secondary); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-users"></i> Batch A Configuration
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Start Roll:</label>
                                <input type="number" id="batchAStart" value="1" min="1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">End Roll:</label>
                                <input type="number" id="batchAEnd" value="20" min="1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Extra Students (Roll Numbers):</label>
                            <input type="text" id="batchAExtra" placeholder="e.g., 25,27,30" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Comma-separated roll numbers to include</small>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Exclude Students (Roll Numbers):</label>
                            <input type="text" id="batchAExclude" placeholder="e.g., 5,10,15" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Comma-separated roll numbers to exclude</small>
                        </div>
                        <div id="batchAPreview" style="font-size: 0.875rem; color: var(--text-light); background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);">Preview: 1-20 (20 students)</div>
                    </div>

                    <!-- Batch B Configuration -->
                    <div style="border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: var(--lighter);">
                        <h4 style="margin: 0 0 1rem 0; color: var(--warning); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-users"></i> Batch B Configuration
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Start Roll:</label>
                                <input type="number" id="batchBStart" value="21" min="1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">End Roll:</label>
                                <input type="number" id="batchBEnd" value="40" min="1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Extra Students (Roll Numbers):</label>
                            <input type="text" id="batchBExtra" placeholder="e.g., 45,47,50" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Comma-separated roll numbers to include</small>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Exclude Students (Roll Numbers):</label>
                            <input type="text" id="batchBExclude" placeholder="e.g., 25,30,35" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Comma-separated roll numbers to exclude</small>
                        </div>
                        <div id="batchBPreview" style="font-size: 0.875rem; color: var(--text-light); background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);">Preview: 21-40 (20 students)</div>
                    </div>

                    <!-- Batch C Configuration -->
                    <div style="border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: var(--lighter);">
                        <h4 style="margin: 0 0 1rem 0; color: var(--danger); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-users"></i> Batch C Configuration
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Start Roll:</label>
                                <input type="number" id="batchCStart" value="41" min="1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">End Roll:</label>
                                <input type="number" id="batchCEnd" value="60" min="1" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Extra Students (Roll Numbers):</label>
                            <input type="text" id="batchCExtra" placeholder="e.g., 65,67,70" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Comma-separated roll numbers to include</small>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Exclude Students (Roll Numbers):</label>
                            <input type="text" id="batchCExclude" placeholder="e.g., 45,50,55" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; font-size: 0.875rem;">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Comma-separated roll numbers to exclude</small>
                        </div>
                        <div id="batchCPreview" style="font-size: 0.875rem; color: var(--text-light); background: white; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);">Preview: 41-60 (20 students)</div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="previewBatchConfiguration()" style="padding: 0.75rem 1.5rem; background: var(--info); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-eye"></i> Preview Configuration
                    </button>
                    <button onclick="saveBatchConfiguration()" style="padding: 0.75rem 1.5rem; background: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                    <button onclick="resetBatchConfiguration()" style="padding: 0.75rem 1.5rem; background: var(--warning); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-undo"></i> Reset to Default
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="batchActions" style="display: none; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="showBatchConfigPanel()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-cogs"></i> Configure Batch Ranges
                    </button>
                    <button onclick="showShiftStudentModal()" style="padding: 0.75rem 1.5rem; background: var(--secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-exchange-alt"></i> Shift Students Between Batches
                    </button>
                    <button onclick="deleteDuplicateRoll2026()" style="padding: 0.75rem 1.5rem; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-trash"></i> Delete Duplicate Roll 2026 (CE SY Batch B)
                    </button>
                    <button onclick="showBulkDeleteModal()" style="padding: 0.75rem 1.5rem; background: var(--warning); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-users-slash"></i> Bulk Delete Students
                    </button>
                    <button onclick="clearAllBatchConfigurations()" style="padding: 0.75rem 1.5rem; background: #6B7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        <i class="fas fa-eraser"></i> Clear All Configurations
                    </button>
                </div>
            </div>

            <!-- Students Table -->
            <div id="batchStudentsTable" style="display: none; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-users"></i> Batch Students
                        <span id="batchStudentsCount" style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; margin-left: 1rem;">0</span>
                    </h3>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">
                                    <input type="checkbox" id="selectAllBatchStudents" onchange="toggleSelectAllBatchStudents()">
                                </th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Roll No</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Department</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Year</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Division</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid var(--border);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="batchStudentsTableBody">
                            <tr>
                                <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-light);">
                                    Select filters and click "Load Students" to view batch students
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        console.log('Firebase services ready');

        // Function to update dashboard stats
        async function updateDashboardStats() {
            try {
                // Wait for Firebase initialization from firebase-config.js
                if (typeof window.waitForFirebase === 'function') {
                    await window.waitForFirebase();
                }
                console.log('Fetching dashboard stats...');
                
                // Get total students count
                const studentsSnapshot = await window.db.ref('students').once('value');
                const totalStudents = studentsSnapshot.exists() ? Object.keys(studentsSnapshot.val()).length : 0;
                document.getElementById('totalStudents').textContent = totalStudents;
                
                // Get total teachers count
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                const totalTeachers = teachersSnapshot.exists() ? Object.keys(teachersSnapshot.val()).length : 0;
                document.getElementById('totalTeachers').textContent = totalTeachers;
                
                // Calculate average attendance
                const attendanceSnapshot = await window.db.ref('attendance').once('value');
                let totalAttendance = 0;
                let attendanceCount = 0;
                
                if (attendanceSnapshot.exists()) {
                    attendanceSnapshot.forEach(dateSnapshot => {
                        const students = dateSnapshot.val().students || {};
                        const presentCount = Object.values(students).filter(status => status === true).length;
                        const totalCount = Object.keys(students).length;
                        if (totalCount > 0) {
                            totalAttendance += (presentCount / totalCount) * 100;
                            attendanceCount++;
                        }
                    });
                }
                
                const averageAttendance = attendanceCount > 0 ? (totalAttendance / attendanceCount).toFixed(1) : 0;
                document.getElementById('averageAttendance').textContent = averageAttendance + '%';
                
                // Calculate performance rate (based on attendance for now)
                const performanceRate = averageAttendance > 0 ? averageAttendance : 0;
                document.getElementById('performanceRate').textContent = performanceRate + '%';
                
                console.log('Dashboard stats updated:', {
                    totalStudents,
                    totalTeachers,
                    averageAttendance,
                    performanceRate
                });
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Function to update recent activities
        async function updateRecentActivities() {
            try {
                await waitForFirebase();
                const activityList = document.getElementById('activityList');
                
                // Check if element exists
                if (!activityList) {
                    console.warn('activityList element not found, skipping recent activities update');
                    return;
                }
                
                // Get recent attendance records from Firebase
                const attendanceSnapshot = await window.db.ref('attendance')
                    .orderByChild('timestamp')
                    .limitToLast(10)
                    .once('value');
                
                // Clear loading state
                activityList.innerHTML = '';
                
                if (attendanceSnapshot.exists()) {
                    // Convert to array and sort by timestamp
                    const activities = [];
                    attendanceSnapshot.forEach(snap => {
                        const data = snap.val();
                        if (data.teacherId) {
                        activities.push({
                                id: snap.key,
                                ...data,
                                timestamp: data.timestamp || Date.now()
                        });
                        }
                    });
                    
                    // Sort by timestamp descending
                    activities.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Get teacher details
                    const teacherIds = [...new Set(activities.map(a => a.teacherId))];
                    const teacherDetails = {};
                    
                    for (const teacherId of teacherIds) {
                        const teacherSnap = await window.db.ref('teachers/' + teacherId).once('value');
                        if (teacherSnap.exists()) {
                            const teacher = teacherSnap.val();
                            if (!teacher.firstName || !teacher.lastName) {
                                console.warn('Missing name for teacherId:', teacherId, teacher);
                            }
                            let displayName = '';
                            if (teacher.firstName && teacher.lastName) {
                                displayName = `${teacher.firstName} ${teacher.lastName}`;
                            } else if (teacher.firstName) {
                                displayName = teacher.firstName;
                            } else if (teacher.lastName) {
                                displayName = teacher.lastName;
                            } else {
                                displayName = 'Teacher';
                            }
                            teacherDetails[teacherId] = displayName;
                        } else {
                            console.warn('Teacher not found for teacherId:', teacherId);
                            teacherDetails[teacherId] = 'Teacher';
                        }
                    }
                    
                    // Add activities to the list
                    activities.slice(0, 10).forEach(activity => {
                        const timeAgo = getTimeAgo(activity.timestamp);
                        const teacherName = teacherDetails[activity.teacherId] || 'Teacher';
                        
                        const li = document.createElement('li');
                        li.className = 'activity-item';
                        li.innerHTML = `
                            <div class="activity-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">
                                    ${teacherName} took attendance
                                </div>
                                <div class="activity-details">
                                    <span class="activity-detail">
                                        <i class="fas fa-users"></i>
                                        ${activity.class || 'N/A'}
                                    </span>
                                    <span class="activity-detail">
                                        <i class="fas fa-book"></i>
                                        ${activity.subject || 'N/A'}
                                    </span>
                                    <span class="activity-detail">
                                        <i class="fas fa-clock"></i>
                                        ${activity.lectureType || 'N/A'}
                                    </span>
                                </div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        `;
                        activityList.appendChild(li);
                    });
                } else {
                    // Show no activities message
                    activityList.innerHTML = `
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">No attendance records found</div>
                            </div>
                        </li>
                    `;
                }
            } catch (error) {
                console.error('Error updating recent activities:', error);
                // Show error message only if element exists
                const activityList = document.getElementById('activityList');
                if (activityList) {
                    activityList.innerHTML = `
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Error loading attendance records</div>
                            </div>
                        </li>
                    `;
                }
            }
        }

        // Helper function to get time ago
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        // Helper function to get activity icon
        function getActivityIcon(type) {
            switch (type) {
                case 'attendance':
                    return 'fa-clipboard-check';
                case 'student':
                    return 'fa-user-graduate';
                case 'teacher':
                    return 'fa-chalkboard-teacher';
                case 'report':
                    return 'fa-file-alt';
                default:
                    return 'fa-bell';
            }
        }

        // Update stats and activities when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Update stats and activities
                updateDashboardStats();
                updateRecentActivities();
                
                // Initialize charts
                const attendanceChart = document.getElementById('attendanceChart');
                const departmentChart = document.getElementById('departmentChart');

                if (attendanceChart && departmentChart) {
                    try {
                        // Get attendance data for last 6 months
                        const attendanceData = await getAttendanceData();
                        
                        // Get department data
                        const departmentData = await getDepartmentData();
                        
                        // Attendance Trend Chart
                        new Chart(attendanceChart, {
                            type: 'line',
                            data: {
                                labels: attendanceData.labels,
                                datasets: [{
                                    label: 'Attendance Rate',
                                    data: attendanceData.values,
                                    borderColor: '#4F46E5',
                                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100
                                    }
                                }
                            }
                        });

                        // Department Chart
                        new Chart(departmentChart, {
                            type: 'bar',
                            data: {
                                labels: departmentData.labels,
                                datasets: [{
                                    label: 'Students',
                                    data: departmentData.values,
                                    backgroundColor: [
                                        'rgba(79, 70, 229, 0.7)',
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(245, 158, 11, 0.7)',
                                        'rgba(239, 68, 68, 0.7)',
                                        'rgba(59, 130, 246, 0.7)'
                                    ],
                                    borderRadius: 8
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Error initializing charts:', error);
                    }
                }
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });

        // Function to get attendance data for last 6 months
        async function getAttendanceData() {
            try {
                await waitForFirebase();
                const months = [];
                const values = [];
                const today = new Date();
                
                // Get last 6 months
                for (let i = 5; i >= 0; i--) {
                    const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    months.push(month.toLocaleString('default', { month: 'short' }));
                }
                
                // Get attendance data for each month
                const attendanceSnapshot = await window.db.ref('attendance').once('value');
                const attendanceData = attendanceSnapshot.val() || {};
                
                // Calculate monthly averages
                months.forEach(month => {
                    let totalAttendance = 0;
                    let count = 0;
                    
                    Object.entries(attendanceData).forEach(([date, data]) => {
                        const attendanceDate = new Date(date);
                        if (attendanceDate.toLocaleString('default', { month: 'short' }) === month) {
                            const students = data.students || {};
                            const presentCount = Object.values(students).filter(status => status === true).length;
                            const totalCount = Object.keys(students).length;
                            if (totalCount > 0) {
                                totalAttendance += (presentCount / totalCount) * 100;
                                count++;
                            }
                        }
                    });
                    
                    values.push(count > 0 ? (totalAttendance / count).toFixed(1) : 0);
                });
                
                return { labels: months, values };
                
            } catch (error) {
                console.error('Error getting attendance data:', error);
                return { labels: [], values: [] };
            }
        }



        // Handle logout
        function handleLogout() {
            console.log('Logging out...');
            
            // Clear session storage
            sessionStorage.clear();
            console.log('Session storage cleared');
            
            // Sign out from Firebase
            firebase.auth().signOut()
                .then(() => {
                    console.log('Firebase sign out successful');
                    window.location.href = 'welcome.html';
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                    // Still redirect to login page
                    window.location.href = 'welcome.html';
                });
        }

        // Debounce function to limit activity listener calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to check if admin is authenticated
        function isAdminAuthenticated() {
                const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn');
                const adminData = sessionStorage.getItem('adminData');
            const adminToken = localStorage.getItem('adminToken');
                
            console.log('Checking admin authentication:', {
                isAdminLoggedIn,
                hasAdminData: !!adminData,
                hasAdminToken: !!adminToken
            });
                
            return isAdminLoggedIn === 'true' && (adminData || adminToken);
        }

        // Function to navigate with session check
        function navigateWithSessionCheck(url) {
            console.log('Navigating to:', url);
            
            if (isAdminAuthenticated()) {
                // Reset auto logout timer if exists
                if (typeof startAutoLogoutTimer === 'function') {
                    startAutoLogoutTimer('admin');
                }
                // Force re-set session for admin
                sessionStorage.setItem('isAdminLoggedIn', 'true');
                if (!sessionStorage.getItem('adminData') && window.adminData) {
                    sessionStorage.setItem('adminData', JSON.stringify(window.adminData));
                }
                // Store current URL before navigation
                sessionStorage.setItem('lastPage', window.location.href);
                window.location.href = url;
            } else {
                console.log('Not authenticated, redirecting to welcome');
                sessionStorage.clear();
                localStorage.removeItem('adminToken');
                window.location.href = 'welcome.html';
            }
        }

        // Update navigation when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up navigation');
            
            // Check initial authentication
            if (!isAdminAuthenticated()) {
                console.log('Initial auth check failed');
                window.location.href = 'welcome.html';
                return;
            }
            
            // Update navigation links with debounced click handler
            const debouncedNavigate = debounce((url) => {
                navigateWithSessionCheck(url);
            }, 300);
            
            document.querySelectorAll('.nav-link, .action-card').forEach(element => {
                const href = element.getAttribute('href') || 
                            element.getAttribute('onclick')?.match(/window\.location\.href='([^']+)'/)?.[1];
                
                if (href && href !== '#') {
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Navigation clicked:', href);
                        debouncedNavigate(href);
                    });
                    
                    // Remove onclick attribute to prevent double navigation
                    element.removeAttribute('onclick');
                }
            });
            
            // Load dashboard data
            updateDashboardStats();
            updateRecentActivities();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && isAdminAuthenticated()) {
                console.log('Page visible, checking session');
                // Reset auto logout timer if exists
                if (typeof startAutoLogoutTimer === 'function') {
                    startAutoLogoutTimer('admin');
                }
            }
        });

        // Handle page focus
        window.addEventListener('focus', function() {
            if (isAdminAuthenticated()) {
                console.log('Page focused, checking session');
                // Reset auto logout timer if exists
                if (typeof startAutoLogoutTimer === 'function') {
                    startAutoLogoutTimer('admin');
                }
            }
        });

        // Authentication functions ready

        // Feedback Report Functions
        let allFeedbacks = [];
        let filteredFeedbacks = [];
        let feedbackSystemEnabled = true; // Default enabled

        // Toggle Feedback System
        async function toggleFeedbackSystem() {
            try {
                await waitForFirebase();
                
                // Toggle the state
                feedbackSystemEnabled = !feedbackSystemEnabled;
                
                // Update Firebase setting
                await window.db.ref('settings/feedbackEnabled').set(feedbackSystemEnabled);
                
                // Update UI
                updateFeedbackToggleUI();
                
                // Show confirmation
                const status = feedbackSystemEnabled ? 'enabled' : 'disabled';
                alert(`Feedback system has been ${status} successfully!`);
                
            } catch (error) {
                console.error('Error toggling feedback system:', error);
                alert('Error updating feedback system. Please try again.');
            }
        }

        // Update Toggle Button UI
        function updateFeedbackToggleUI() {
            const toggleBtn = document.getElementById('feedbackToggleBtn');
            const toggleText = document.getElementById('feedbackToggleText');
            const toggleIcon = toggleBtn.querySelector('i');
            const statusIndicator = document.getElementById('feedbackStatusIndicator');
            
            if (feedbackSystemEnabled) {
                toggleBtn.className = 'btn';
                toggleBtn.style.background = '#EF4444';
                toggleBtn.style.color = 'white';
                toggleIcon.className = 'fas fa-toggle-on';
                toggleText.textContent = 'Disable Feedback';
                
                // Update status indicator
                statusIndicator.textContent = 'ENABLED';
                statusIndicator.style.background = '#10B981';
                statusIndicator.style.color = 'white';
            } else {
                toggleBtn.className = 'btn';
                toggleBtn.style.background = '#10B981';
                toggleBtn.style.color = 'white';
                toggleIcon.className = 'fas fa-toggle-off';
                toggleText.textContent = 'Enable Feedback';
                
                // Update status indicator
                statusIndicator.textContent = 'DISABLED';
                statusIndicator.style.background = '#EF4444';
                statusIndicator.style.color = 'white';
            }
        }

        // Load Feedback System Status
        async function loadFeedbackSystemStatus() {
            try {
                await waitForFirebase();
                
                const statusSnapshot = await window.db.ref('settings/feedbackEnabled').once('value');
                if (statusSnapshot.exists()) {
                    feedbackSystemEnabled = statusSnapshot.val();
                } else {
                    // Set default if not exists
                    feedbackSystemEnabled = true;
                    await window.db.ref('settings/feedbackEnabled').set(true);
                }
                
                updateFeedbackToggleUI();
                
            } catch (error) {
                console.error('Error loading feedback system status:', error);
                feedbackSystemEnabled = true; // Default to enabled
                updateFeedbackToggleUI();
            }
        }

        // Show Feedback Report Section
        function showFeedbackReport() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('feedbackReportSection').style.display = 'block';
            document.querySelector('.page-title').textContent = 'Feedback Report';
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
            
            // Load feedback system status and data
            loadFeedbackSystemStatus();
            loadFeedbackData();
        }

        // Show Dashboard Section
        function showDashboard() {
            document.getElementById('feedbackReportSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            document.querySelector('.page-title').textContent = 'Dashboard Overview';
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('.nav-link[href="#"]').classList.add('active');
        }

        // Load Feedback Data from Firebase
        async function loadFeedbackData() {
            try {
                await waitForFirebase();
                
                const feedbackSnapshot = await window.db.ref('feedback').once('value');
                allFeedbacks = [];
                
                if (feedbackSnapshot.exists()) {
                    feedbackSnapshot.forEach(snap => {
                        const feedback = snap.val();
                        allFeedbacks.push({
                            id: snap.key,
                            ...feedback,
                            timestamp: feedback.timestamp || Date.now()
                        });
                    });
                }
                
                // Sort by timestamp descending
                allFeedbacks.sort((a, b) => b.timestamp - a.timestamp);
                
                // Update stats and populate filters
                await updateFeedbackStats();
                await populateFilters();
                
                // Show all feedbacks initially
                filteredFeedbacks = [...allFeedbacks];
                await displayFeedbacks();
                
            } catch (error) {
                console.error('Error loading feedback data:', error);
                document.getElementById('feedbackTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" style="padding: 2rem; text-align: center; color: var(--danger);">
                            <i class="fas fa-exclamation-triangle"></i> Error loading feedback data
                        </td>
                    </tr>
                `;
            }
        }

        // Update Feedback Statistics
        async function updateFeedbackStats() {
            const totalFeedbacks = allFeedbacks.length;
            document.getElementById('totalFeedbacks').textContent = totalFeedbacks;
            
            if (totalFeedbacks === 0) {
                document.getElementById('averageRating').textContent = '0.0';
                document.getElementById('topRatedTeacher').textContent = '-';
                document.getElementById('thisMonthFeedbacks').textContent = '0';
                return;
            }
            
            // Calculate average rating
            let totalRating = 0;
            let ratingCount = 0;
            
            allFeedbacks.forEach(feedback => {
                if (feedback.ratings) {
                    const ratings = Object.values(feedback.ratings);
                    const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                    totalRating += avgRating;
                    ratingCount++;
                }
            });
            
            const averageRating = ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : '0.0';
            document.getElementById('averageRating').textContent = averageRating;
            
            // Find top rated teacher
            const teacherRatings = {};
            allFeedbacks.forEach(feedback => {
                if (feedback.teacher && feedback.ratings) {
                    if (!teacherRatings[feedback.teacher]) {
                        teacherRatings[feedback.teacher] = { total: 0, count: 0 };
                    }
                    const ratings = Object.values(feedback.ratings);
                    const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                    teacherRatings[feedback.teacher].total += avgRating;
                    teacherRatings[feedback.teacher].count++;
                }
            });
            
            let topTeacher = '-';
            let topRating = 0;
            Object.keys(teacherRatings).forEach(teacher => {
                const avgRating = teacherRatings[teacher].total / teacherRatings[teacher].count;
                if (avgRating > topRating) {
                    topRating = avgRating;
                    topTeacher = teacher;
                }
            });
            
            // Get teacher name for display
            let displayTeacherName = topTeacher;
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        if (teacherId === topTeacher) {
                            displayTeacherName = teacher.firstName && teacher.lastName 
                                ? `${teacher.firstName} ${teacher.lastName}`.trim()
                                : teacher.name || topTeacher;
                        }
                    });
                }
            } catch (error) {
                console.error('Error resolving teacher name:', error);
            }
            
            document.getElementById('topRatedTeacher').textContent = displayTeacherName;
            
            // Count this month's feedbacks
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const thisMonthCount = allFeedbacks.filter(feedback => {
                const feedbackDate = new Date(feedback.timestamp);
                return feedbackDate.getMonth() === currentMonth && feedbackDate.getFullYear() === currentYear;
            }).length;
            
            document.getElementById('thisMonthFeedbacks').textContent = thisMonthCount;
        }

        // Populate Filter Dropdowns
        async function populateFilters() {
            let studentData = {};
            const teachers = [...new Set(allFeedbacks.map(f => f.teacher).filter(Boolean))];
            const subjects = [...new Set(allFeedbacks.map(f => f.subject).filter(Boolean))];
            
            // Get student data for departments and classes
            const departments = new Set();
            const classes = new Set();
            
            try {
                // Get all students to populate department and class filters
                const studentsSnapshot = await window.db.ref('students').once('value');
                if (studentsSnapshot.exists()) {
                    studentsSnapshot.forEach(snap => {
                        const student = snap.val();
                        if (student.email) {
                            studentData[student.email] = {
                                department: student.department || student.branch,
                                class: student.year
                            };
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading student data for filters:', error);
            }
            
            // Populate department filter
            const departmentFilter = document.getElementById('departmentFilter');
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            [...departments].sort().forEach(dept => {
                departmentFilter.innerHTML += `<option value="${dept}">${dept}</option>`;
            });
            
            // Populate class filter
            const classFilter = document.getElementById('classFilter');
            classFilter.innerHTML = '<option value="">All Classes</option>';
            [...classes].sort().forEach(cls => {
                classFilter.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
            
            // Populate teacher filter with resolved names
            const teacherFilter = document.getElementById('teacherFilter');
            teacherFilter.innerHTML = '<option value="">All Teachers</option>';
            
            // Get teacher names for filter display
            let teacherNames = {};
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        const teacherName = teacher.firstName && teacher.lastName 
                            ? `${teacher.firstName} ${teacher.lastName}`.trim()
                            : teacher.name || teacherId;
                        teacherNames[teacherId] = teacherName;
                    });
                }
            } catch (error) {
                console.error('Error loading teacher names for filter:', error);
            }
            
            teachers.forEach(teacherId => {
                const displayName = teacherNames[teacherId] || teacherId;
                teacherFilter.innerHTML += `<option value="${teacherId}">${displayName}</option>`;
            });
            
            // Populate subject filter
            const subjectFilter = document.getElementById('subjectFilter');
            subjectFilter.innerHTML = '<option value="">All Subjects</option>';
            subjects.forEach(subject => {
                subjectFilter.innerHTML += `<option value="${subject}">${subject}</option>`;
            });
        }

        // Filter Feedbacks
        async function filterFeedbacks() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const classFilter = document.getElementById('classFilter').value;
            const teacherFilter = document.getElementById('teacherFilter').value;
            const subjectFilter = document.getElementById('subjectFilter').value;
            const lectureTypeFilter = document.getElementById('lectureTypeFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            
            // Get student data for department and class filtering
            let studentData = {};
            if (departmentFilter || classFilter) {
                try {
                    const studentsSnapshot = await window.db.ref('students').once('value');
                    if (studentsSnapshot.exists()) {
                        studentsSnapshot.forEach(snap => {
                            const student = snap.val();
                            if (student.email) {
                                studentData[student.email] = {
                                    department: student.department || student.branch,
                                    class: student.year
                                };
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error loading student data for filtering:', error);
                }
            }
            
            filteredFeedbacks = allFeedbacks.filter(feedback => {
                // Department filter
                if (departmentFilter && feedback.studentId) {
                    const student = studentData[feedback.studentId];
                    if (!student || student.department !== departmentFilter) return false;
                }
                
                // Class filter
                if (classFilter && feedback.studentId) {
                    const student = studentData[feedback.studentId];
                    if (!student || student.class !== classFilter) return false;
                }
                
                // Teacher filter
                if (teacherFilter && feedback.teacher !== teacherFilter) return false;
                
                // Subject filter
                if (subjectFilter && feedback.subject !== subjectFilter) return false;
                
                // Lecture type filter
                if (lectureTypeFilter && feedback.lectureType !== lectureTypeFilter) return false;
                
                // Rating filter
                if (ratingFilter && feedback.ratings) {
                    const ratings = Object.values(feedback.ratings);
                    const avgRating = ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length;
                    const minRating = parseInt(ratingFilter);
                    if (avgRating < minRating) return false;
                }
                
                return true;
            });
            
            displayFeedbacks();
        }

        // Display Feedbacks in Table
        async function displayFeedbacks() {
            const tbody = document.getElementById('feedbackTableBody');
            
            if (filteredFeedbacks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="padding: 2rem; text-align: center; color: var(--text-light);">
                            <i class="fas fa-search"></i> No feedback found matching the filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get student data for department and class display
            let studentData = {};
            try {
                const studentsSnapshot = await window.db.ref('students').once('value');
                if (studentsSnapshot.exists()) {
                    studentsSnapshot.forEach(snap => {
                        const student = snap.val();
                        if (student.email) {
                            studentData[student.email] = {
                                department: student.department || student.branch || 'N/A',
                                class: student.year || 'N/A'
                            };
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading student data for display:', error);
            }
            
            // Get teacher data for name resolution
            let teacherData = {};
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        const teacherName = teacher.firstName && teacher.lastName 
                            ? `${teacher.firstName} ${teacher.lastName}`.trim()
                            : teacher.name || teacherId;
                        teacherData[teacherId] = teacherName;
                    });
                }
            } catch (error) {
                console.error('Error loading teacher data for display:', error);
            }
            
            tbody.innerHTML = '';
            
            filteredFeedbacks.forEach(feedback => {
                const date = new Date(feedback.timestamp).toLocaleDateString();
                
                // Get student info
                const student = studentData[feedback.studentId] || { department: 'N/A', class: 'N/A' };
                
                // Calculate overall rating
                let overallRating = 0;
                if (feedback.ratings) {
                    const ratings = Object.values(feedback.ratings);
                    overallRating = (ratings.reduce((sum, rating) => sum + rating, 0) / ratings.length).toFixed(1);
                }
                
                // Generate star display
                const stars = generateStars(parseFloat(overallRating));
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--border)';
                row.innerHTML = `
                    <td style="padding: 1rem;">${feedback.studentName || 'Unknown'}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: rgba(59, 130, 246, 0.1); color: var(--info); border-radius: 4px; font-size: 0.875rem;">
                            ${student.department}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: rgba(245, 158, 11, 0.1); color: var(--warning); border-radius: 4px; font-size: 0.875rem;">
                            ${student.class}
                        </span>
                    </td>
                    <td style="padding: 1rem;">${teacherData[feedback.teacher] || feedback.teacher || 'N/A'}</td>
                    <td style="padding: 1rem;">${feedback.subject || 'N/A'}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: ${feedback.lectureType === 'Theory' ? 'rgba(79, 70, 229, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; color: ${feedback.lectureType === 'Theory' ? 'var(--primary)' : 'var(--secondary)'}; border-radius: 4px; font-size: 0.875rem;">
                            ${feedback.lectureType || 'N/A'}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${stars}
                            <span style="font-weight: 500;">${overallRating}</span>
                        </div>
                    </td>
                    <td style="padding: 1rem;">${date}</td>
                    <td style="padding: 1rem;">
                        <button onclick="viewFeedbackDetails('${feedback.id}')" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Generate Star Rating Display
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star" style="color: #fbbf24;"></i>';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt" style="color: #fbbf24;"></i>';
                } else {
                    stars += '<i class="far fa-star" style="color: #d1d5db;"></i>';
                }
            }
            return stars;
        }

        // View Feedback Details
        async function viewFeedbackDetails(feedbackId) {
            const feedback = allFeedbacks.find(f => f.id === feedbackId);
            if (!feedback) return;
            
            // Resolve teacher name
            let teacherName = feedback.teacher || 'N/A';
            try {
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                if (teachersSnapshot.exists()) {
                    teachersSnapshot.forEach(snap => {
                        const teacher = snap.val();
                        const teacherId = teacher.teacherId || teacher.code || teacher.email || snap.key;
                        if (teacherId === feedback.teacher) {
                            teacherName = teacher.firstName && teacher.lastName 
                                ? `${teacher.firstName} ${teacher.lastName}`.trim()
                                : teacher.name || feedback.teacher;
                        }
                    });
                }
            } catch (error) {
                console.error('Error resolving teacher name in details:', error);
            }
            
            let detailsHtml = `
                <div style="max-width: 600px;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">Feedback Details</h4>
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <p><strong>Student:</strong> ${feedback.studentName || 'Unknown'}</p>
                        <p><strong>Teacher:</strong> ${teacherName}</p>
                        <p><strong>Subject:</strong> ${feedback.subject || 'N/A'}</p>
                        <p><strong>Lecture Type:</strong> ${feedback.lectureType || 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(feedback.timestamp).toLocaleString()}</p>
                    </div>
            `;
            
            if (feedback.ratings) {
                detailsHtml += '<h5 style="margin-bottom: 0.5rem;">Detailed Ratings:</h5><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';
                
                const ratingLabels = {
                    knowledge: 'Subject Knowledge',
                    clarity: 'Clarity of Explanation',
                    punctuality: 'Punctuality',
                    doubts: 'Doubt Clearing',
                    interaction: 'Student Interaction',
                    control: 'Class Control',
                    aids: 'Teaching Aids',
                    motivation: 'Motivation',
                    quality: 'Overall Quality'
                };
                
                Object.entries(feedback.ratings).forEach(([key, value]) => {
                    const label = ratingLabels[key] || key;
                    const stars = generateStars(value);
                    detailsHtml += `
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border);">
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${label}</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${stars}
                                <span>${value}/5</span>
                            </div>
                        </div>
                    `;
                });
                
                detailsHtml += '</div>';
            }
            
            detailsHtml += '</div>';
            
            // Show in a modal-like alert
            const popup = window.open('', '_blank', 'width=700,height=600,scrollbars=yes,resizable=yes');
            popup.document.write(`
                <html>
                    <head>
                        <title>Feedback Details</title>
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <style>
                            body { font-family: Arial, sans-serif; padding: 2rem; background: #f9fafb; }
                            .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            ${detailsHtml}
                            <button onclick="window.close()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #4F46E5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </body>
                </html>
            `);
        }

        // ========== ATTENDANCE CHECK FUNCTIONS ==========

        // Show Attendance Check Section
        function showAttendanceCheck() {
            // Hide all sections
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('feedbackReportSection').style.display = 'none';
            document.getElementById('attendanceCheckSection').style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector('a[onclick="showAttendanceCheck()"]').classList.add('active');
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceCheckDate').value = today;
        }

        // Load Years for Department (for attendance check)
        function loadYearsForDepartment() {
            const department = document.getElementById('attendanceCheckDepartment').value;
            const yearSelect = document.getElementById('attendanceCheckYear');
            const divisionSelect = document.getElementById('attendanceCheckDivision');
            
            // Reset year and division
            yearSelect.value = '';
            divisionSelect.innerHTML = '<option value="">Select Division</option>';
            
            // Hide results
            document.getElementById('attendanceCheckResults').style.display = 'none';
        }

        // Load Divisions for Department (for attendance check)
        function loadDivisionsForDepartment() {
            const department = document.getElementById('attendanceCheckDepartment').value;
            const divisionSelect = document.getElementById('attendanceCheckDivision');
            
            // Reset division
            divisionSelect.innerHTML = '<option value="">Select Division</option>';
            
            // Only CT department has divisions
            if (department === 'CT') {
                divisionSelect.innerHTML = `
                    <option value="">Select Division</option>
                    <option value="A">Division A</option>
                    <option value="B">Division B</option>
                    <option value="C">Division C</option>
                `;
            } else {
                // For other departments, add "All" option
                divisionSelect.innerHTML = '<option value="ALL">All Students</option>';
                divisionSelect.value = 'ALL';
            }
            
            // Hide results
            document.getElementById('attendanceCheckResults').style.display = 'none';
        }

        // Check Attendance for Selected Date
        async function checkAttendanceForDate() {
            try {
                const department = document.getElementById('attendanceCheckDepartment').value;
                const year = document.getElementById('attendanceCheckYear').value;
                const division = document.getElementById('attendanceCheckDivision').value;
                const date = document.getElementById('attendanceCheckDate').value;
                
                // Validation
                if (!department || !year || !date) {
                    alert('Please select Department, Year, and Date');
                    return;
                }
                
                if (department === 'CT' && !division) {
                    alert('Please select Division for CT department');
                    return;
                }
                
                // Show loading
                const btn = document.getElementById('checkAttendanceBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                btn.disabled = true;
                
                console.log('🔍 Checking attendance for:', { department, year, division, date });
                
                // Wait for Firebase initialization
                if (typeof window.waitForFirebase === 'function') {
                    await window.waitForFirebase();
                }
                
                // Get attendance records for the selected date
                const attendanceSnapshot = await window.db.ref('attendance').once('value');
                
                const subjectsData = [];
                let totalSubjects = 0;
                let theoryCount = 0;
                let practicalCount = 0;
                let totalStudentsAttended = 0;
                
                if (attendanceSnapshot.exists()) {
                    const teacherDetails = {}; // Cache for teacher names
                    
                    // Get teacher details first
                    const teachersSnapshot = await window.db.ref('teachers').once('value');
                    if (teachersSnapshot.exists()) {
                        teachersSnapshot.forEach(snap => {
                            const teacher = snap.val();
                            if (teacher && typeof teacher === 'object') {
                                const teacherId = teacher.teacherId || teacher.code || snap.key;
                                const firstName = teacher.firstName || '';
                                const lastName = teacher.lastName || '';
                                const fullName = `${firstName} ${lastName}`.trim() || teacher.name || teacherId;
                                
                                // Store teacher name with multiple possible keys
                                teacherDetails[teacherId] = fullName;
                                teacherDetails[snap.key] = fullName;
                                if (teacher.code && teacher.code !== teacherId) {
                                    teacherDetails[teacher.code] = fullName;
                                }
                                
                                console.log('📝 Teacher mapped:', {
                                    teacherId: teacherId,
                                    firebaseKey: snap.key,
                                    name: fullName,
                                    originalData: teacher
                                });
                            }
                        });
                    }
                    
                    console.log('👥 Teacher details cache:', teacherDetails);
                    
                    attendanceSnapshot.forEach(snap => {
                        const record = snap.val();
                        
                        // Check if record matches our criteria
                        if (record.date === date) {
                            // For new attendance structure (with class field)
                            if (record.class) {
                                const classCode = record.class;
                                const recordDept = extractDepartmentFromClass(classCode);
                                const recordYear = extractYearFromClass(classCode);
                                const recordDivision = extractDivisionFromClass(classCode);
                                
                                if (recordDept === department && recordYear === year) {
                                    // Check division match
                                    let divisionMatch = true;
                                    if (department === 'CT' && division !== 'ALL') {
                                        divisionMatch = recordDivision === division;
                                    }
                                    
                                    if (divisionMatch) {
                                        const students = record.students || {};
                                        const presentCount = Object.values(students).filter(status => status === true).length;
                                        const absentCount = Object.values(students).filter(status => status === false).length;
                                        const totalCount = Object.keys(students).length;
                                        const percentage = totalCount > 0 ? ((presentCount / totalCount) * 100).toFixed(1) : '0';
                                        
                                        // Enhanced teacher name resolution
                                        let teacherName = 'N/A';
                                        if (record.teacherId) {
                                            teacherName = teacherDetails[record.teacherId] || 
                                                         teacherDetails[record.teacherId.toUpperCase()] ||
                                                         teacherDetails[record.teacherId.toLowerCase()] ||
                                                         record.teacherId;
                                        }
                                        
                                        console.log('🔍 Teacher resolution for record:', {
                                            recordTeacherId: record.teacherId,
                                            resolvedName: teacherName,
                                            availableTeachers: Object.keys(teacherDetails)
                                        });

                                        subjectsData.push({
                                            subject: record.subject || 'N/A',
                                            lectureType: record.lectureType || 'N/A',
                                            teacher: teacherName,
                                            time: record.time || 'N/A',
                                            present: presentCount,
                                            absent: absentCount,
                                            total: totalCount,
                                            percentage: percentage,
                                            recordId: snap.key
                                        });
                                        
                                        totalSubjects++;
                                        if (record.lectureType === 'theory') theoryCount++;
                                        if (record.lectureType === 'practical') practicalCount++;
                                        totalStudentsAttended += presentCount;
                                    }
                                }
                            }
                            // For old attendance structure (with separate department, year fields)
                            else if (record.department === department && record.year === year) {
                                let divisionMatch = true;
                                if (department === 'CT' && division !== 'ALL' && record.division) {
                                    divisionMatch = record.division === division;
                                }
                                
                                if (divisionMatch) {
                                    const students = record.students || {};
                                    const presentCount = Object.values(students).filter(status => status === true).length;
                                    const absentCount = Object.values(students).filter(status => status === false).length;
                                    const totalCount = Object.keys(students).length;
                                    const percentage = totalCount > 0 ? ((presentCount / totalCount) * 100).toFixed(1) : '0';
                                    
                                    // Enhanced teacher name resolution for old structure
                                    let teacherName = 'N/A';
                                    if (record.teacherId) {
                                        teacherName = teacherDetails[record.teacherId] || 
                                                     teacherDetails[record.teacherId.toUpperCase()] ||
                                                     teacherDetails[record.teacherId.toLowerCase()] ||
                                                     record.teacherId;
                                    }
                                    
                                    console.log('🔍 Teacher resolution (old structure):', {
                                        recordTeacherId: record.teacherId,
                                        resolvedName: teacherName
                                    });

                                    subjectsData.push({
                                        subject: record.subject || 'N/A',
                                        lectureType: record.lectureType || 'N/A',
                                        teacher: teacherName,
                                        time: record.time || 'N/A',
                                        present: presentCount,
                                        absent: absentCount,
                                        total: totalCount,
                                        percentage: percentage,
                                        recordId: snap.key
                                    });
                                    
                                    totalSubjects++;
                                    if (record.lectureType === 'theory') theoryCount++;
                                    if (record.lectureType === 'practical') practicalCount++;
                                    totalStudentsAttended += presentCount;
                                }
                            }
                        }
                    });
                }
                
                console.log('📊 Found attendance data:', {
                    totalSubjects,
                    theoryCount,
                    practicalCount,
                    totalStudentsAttended,
                    subjectsData
                });
                
                // Update stats
                document.getElementById('totalSubjectsCount').textContent = totalSubjects;
                document.getElementById('theorySubjectsCount').textContent = theoryCount;
                document.getElementById('practicalSubjectsCount').textContent = practicalCount;
                document.getElementById('totalStudentsAttended').textContent = totalStudentsAttended;
                
                // Update date display
                const formattedDate = new Date(date).toLocaleDateString('en-IN', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('selectedDateDisplay').textContent = `(${formattedDate})`;
                
                // Update table
                updateSubjectsTable(subjectsData);
                
                // Show results
                document.getElementById('attendanceCheckResults').style.display = 'block';
                
            } catch (error) {
                console.error('Error checking attendance:', error);
                alert('Error loading attendance data. Please try again.');
            } finally {
                // Reset button
                const btn = document.getElementById('checkAttendanceBtn');
                btn.innerHTML = '<i class="fas fa-search"></i> Check Attendance';
                btn.disabled = false;
            }
        }

        // Update Subjects Table
        function updateSubjectsTable(subjectsData) {
            const tbody = document.getElementById('subjectsTableBody');
            
            if (subjectsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="padding: 2rem; text-align: center; color: var(--text-light);">
                            <i class="fas fa-info-circle"></i> No attendance records found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            subjectsData.forEach((subject, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--border)';
                
                // Color coding for percentage
                let percentageColor = '#EF4444'; // Red for low
                if (parseFloat(subject.percentage) >= 75) percentageColor = '#10B981'; // Green for good
                else if (parseFloat(subject.percentage) >= 50) percentageColor = '#F59E0B'; // Yellow for average
                
                row.innerHTML = `
                    <td style="padding: 1rem; font-weight: 500;">${subject.subject}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: ${subject.lectureType === 'theory' ? 'rgba(79, 70, 229, 0.1)' : 'rgba(16, 185, 129, 0.1)'}; color: ${subject.lectureType === 'theory' ? 'var(--primary)' : 'var(--secondary)'}; border-radius: 4px; font-size: 0.875rem; text-transform: capitalize;">
                            <i class="fas ${subject.lectureType === 'theory' ? 'fa-chalkboard' : 'fa-flask'}"></i> ${subject.lectureType}
                        </span>
                    </td>
                    <td style="padding: 1rem;">${subject.teacher}</td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; background: rgba(59, 130, 246, 0.1); color: var(--info); border-radius: 4px; font-size: 0.875rem;">
                            <i class="fas fa-clock"></i> ${subject.time}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="color: #10B981; font-weight: bold;">
                            <i class="fas fa-check-circle"></i> ${subject.present}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="color: #EF4444; font-weight: bold;">
                            <i class="fas fa-times-circle"></i> ${subject.absent}
                        </span>
                    </td>
                    <td style="padding: 1rem; font-weight: 500;">${subject.total}</td>
                    <td style="padding: 1rem;">
                        <span style="color: ${percentageColor}; font-weight: bold; padding: 0.25rem 0.5rem; background: ${percentageColor}20; border-radius: 4px;">
                            ${subject.percentage}%
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <button onclick="viewAttendanceDetails('${subject.recordId}')" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Helper functions to extract info from class code
        function extractDepartmentFromClass(classCode) {
            if (classCode.includes('CT')) return 'CT';
            if (classCode.includes('IT')) return 'IT';
            if (classCode.includes('ME')) return 'ME';
            if (classCode.includes('CE')) return 'CE';
            if (classCode.includes('EE')) return 'EE';
            if (classCode.includes('ET')) return 'ET';
            if (classCode.includes('AI')) return 'AI';
            return 'Unknown';
        }

        function extractYearFromClass(classCode) {
            if (classCode.includes('FY')) return 'FY';
            if (classCode.includes('SY')) return 'SY';
            if (classCode.includes('TY')) return 'TY';
            if (classCode.includes('BE')) return 'BE';
            return 'Unknown';
        }

        function extractDivisionFromClass(classCode) {
            if (classCode.includes('-A')) return 'A';
            if (classCode.includes('-B')) return 'B';
            if (classCode.includes('-C')) return 'C';
            return 'ALL';
        }

        // ========== BATCH MANAGEMENT FUNCTIONS ==========

        // Show Batch Management Section
        function showBatchManagement() {
            // Hide all sections
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('feedbackReportSection').style.display = 'none';
            document.getElementById('attendanceCheckSection').style.display = 'none';
            document.getElementById('batchManagementSection').style.display = 'block';
            
            // Update active nav
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.closest('.nav-link').classList.add('active');
        }

        // Load Years for Selected Department
        function loadBatchYears() {
            const department = document.getElementById('batchDepartment').value;
            const yearSelect = document.getElementById('batchYear');
            
            yearSelect.innerHTML = '<option value="">-- Select Year --</option>';
            
            if (department) {
                yearSelect.innerHTML += `
                    <option value="FY">First Year</option>
                    <option value="SY">Second Year</option>
                    <option value="TY">Third Year</option>
                    <option value="BE">Final Year</option>
                `;
            }
            
            // Reset dependent dropdowns
            document.getElementById('batchDivision').innerHTML = '<option value="">-- Select Division --</option>';
            document.getElementById('batchLetter').innerHTML = '<option value="">-- Select Batch --</option>';
        }

        // Load Divisions for Selected Department and Year
        function loadBatchDivisions() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            const divisionSelect = document.getElementById('batchDivision');
            
            divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
            
            if (department && year) {
                if (department === 'CT') {
                    divisionSelect.innerHTML += `
                        <option value="A">Division A</option>
                        <option value="B">Division B</option>
                        <option value="C">Division C</option>
                    `;
                } else {
                    divisionSelect.innerHTML += `<option value="ALL">All Students</option>`;
                }
                
                // Auto-load batch options if division is automatically set
                setTimeout(() => {
                    loadBatchOptions();
                }, 100);
            }
            
            // Reset batch dropdown
            document.getElementById('batchLetter').innerHTML = '<option value="">-- Select Batch --</option>';
        }

        // Load Batch Options
        function loadBatchOptions() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            const division = document.getElementById('batchDivision').value;
            const batchSelect = document.getElementById('batchLetter');
            
            console.log('Loading batch options:', { department, year, division });
            
            batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
            
            if (department && year && division) {
                console.log('Adding batch options A, B, C');
                batchSelect.innerHTML += `
                    <option value="A">Batch A (Students 1-20)</option>
                    <option value="B">Batch B (Students 21-40)</option>
                    <option value="C">Batch C (Students 41-60)</option>
                `;
                console.log('Batch options added successfully');
            } else {
                console.log('Missing required selections for batch options');
            }
        }

        // Load Students in Selected Batch
        async function loadBatchStudents() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            const division = document.getElementById('batchDivision').value;
            const batchLetter = document.getElementById('batchLetter').value;
            
            console.log('🔍 Loading batch students with filters:', { department, year, division, batchLetter });
            
            if (!department || !year || !division || !batchLetter) {
                alert('Please select all filters first');
                console.log('❌ Missing filters');
                return;
            }
            
            try {
                // Show loading message
                const tbody = document.getElementById('batchStudentsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 2rem; text-align: center; color: var(--primary);">
                            <i class="fas fa-spinner fa-spin"></i> Loading students...
                        </td>
                    </tr>
                `;
                
                console.log('📡 Fetching students from Firebase...');
                
                // Get all students using firebase.database()
                const studentsSnapshot = await firebase.database().ref('students').once('value');
                const allStudents = [];
                
                if (!studentsSnapshot.exists()) {
                    console.log('❌ No students found in database');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-light);">
                                No students found in database
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                studentsSnapshot.forEach(snapshot => {
                    const student = snapshot.val();
                    student.id = snapshot.key;
                    allStudents.push(student);
                });
                
                console.log(`📊 Total students in database: ${allStudents.length}`);
                
                // Debug: Show sample student data
                if (allStudents.length > 0) {
                    console.log('📋 Sample student data:', allStudents[0]);
                    console.log('🔍 Looking for:', { department, year });
                    
                    // Show unique branches and years in database
                    const uniqueBranches = [...new Set(allStudents.map(s => s.branch).filter(b => b))];
                    const uniqueYears = [...new Set(allStudents.map(s => s.year).filter(y => y))];
                    console.log('🏢 Available branches:', uniqueBranches);
                    console.log('📅 Available years:', uniqueYears);
                    
                    // Show CE students specifically
                    const ceStudents = allStudents.filter(s => s.branch && s.branch.includes('Civil'));
                    console.log('🏗️ CE students found:', ceStudents.length);
                    if (ceStudents.length > 0) {
                        console.log('🏗️ CE sample:', ceStudents[0]);
                        const ceYears = [...new Set(ceStudents.map(s => s.year))];
                        console.log('🏗️ CE years available:', ceYears);
                    }
                }
                
                // Map department codes to branch names
                const departmentMapping = {
                    'CE': 'Civil Engineering',
                    'IT': 'Information Technology', 
                    'ME': 'Mechanical Engineering',
                    'CT': 'Computer Technology',
                    'EE': 'Electrical Engineering',
                    'ET': 'Electronics & Telecommunication',
                    'AI': 'Artificial Intelligence'
                };
                
                // Map year codes to full names
                const yearMapping = {
                    'FY': 'First',
                    'SY': 'Second', 
                    'TY': 'Third',
                    'BE': 'Fourth'
                };
                
                const targetBranch = departmentMapping[department];
                const targetYear = yearMapping[year];
                
                console.log('🎯 Mapping:', { 
                    department, 
                    targetBranch, 
                    year, 
                    targetYear 
                });
                
                // Filter students by branch and year (using actual database fields)
                let filteredStudents = [];
                let debugCount = 0;
                
                filteredStudents = allStudents.filter(student => {
                    const branchMatch = student.branch === targetBranch;
                    const yearMatch = student.year === targetYear;
                    
                    // Debug first few mismatches
                    if (!branchMatch || !yearMatch) {
                        if (debugCount < 3) {
                            console.log('❌ No match:', {
                                studentBranch: student.branch,
                                targetBranch,
                                studentYear: student.year,
                                targetYear,
                                branchMatch,
                                yearMatch
                            });
                            debugCount++;
                        }
                    }
                    
                    return branchMatch && yearMatch;
                });
                
                console.log(`🎯 Students after dept/year filter: ${filteredStudents.length}`);
                
                // Filter by division if CT department
                if (department === 'CT' && division !== 'ALL') {
                    filteredStudents = filteredStudents.filter(student => student.division === division);
                    console.log(`🎯 Students after division filter: ${filteredStudents.length}`);
                }
                
                if (filteredStudents.length === 0) {
                    console.log('❌ No students found for selected filters');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-light);">
                                No students found for ${department} ${year} ${division !== 'ALL' ? division : ''}
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Sort by roll number with better error handling
                filteredStudents.sort((a, b) => {
                    // Handle different roll number formats safely
                    let rollA = 0;
                    let rollB = 0;
                    
                    try {
                        if (a.rollNo !== null && a.rollNo !== undefined) {
                            if (typeof a.rollNo === 'number') {
                                rollA = a.rollNo;
                            } else if (typeof a.rollNo === 'string') {
                                rollA = parseInt(a.rollNo.replace(/\D/g, '')) || 0;
                            }
                        }
                    } catch (e) {
                        console.warn('Error parsing rollNo for student:', a.name, a.rollNo);
                        rollA = 0;
                    }
                    
                    try {
                        if (b.rollNo !== null && b.rollNo !== undefined) {
                            if (typeof b.rollNo === 'number') {
                                rollB = b.rollNo;
                            } else if (typeof b.rollNo === 'string') {
                                rollB = parseInt(b.rollNo.replace(/\D/g, '')) || 0;
                            }
                        }
                    } catch (e) {
                        console.warn('Error parsing rollNo for student:', b.name, b.rollNo);
                        rollB = 0;
                    }
                    
                    return rollA - rollB;
                });
                
                console.log('📋 Students sorted by roll number');
                
                // Apply exact teacher panel batch logic
                let batchStudents;
                let startIndex = 0;
                let endIndex = 20;
                
                // Sort students by roll number first (like teacher panel) with safe error handling
                filteredStudents.sort((a, b) => {
                    // Handle different roll number formats safely
                    let rollA = 0;
                    let rollB = 0;
                    
                    try {
                        if (a.rollNo !== null && a.rollNo !== undefined) {
                            if (typeof a.rollNo === 'number') {
                                rollA = a.rollNo;
                            } else if (typeof a.rollNo === 'string') {
                                rollA = parseInt(a.rollNo.replace(/\D/g, '')) || 0;
                            }
                        }
                    } catch (e) {
                        console.warn('Error parsing rollNo for student:', a.name, a.rollNo);
                        rollA = 0;
                    }
                    
                    try {
                        if (b.rollNo !== null && b.rollNo !== undefined) {
                            if (typeof b.rollNo === 'number') {
                                rollB = b.rollNo;
                            } else if (typeof b.rollNo === 'string') {
                                rollB = parseInt(b.rollNo.replace(/\D/g, '')) || 0;
                            }
                        }
                    } catch (e) {
                        console.warn('Error parsing rollNo for student:', b.name, b.rollNo);
                        rollB = 0;
                    }
                    
                    return rollA - rollB;
                });
                
                console.log('📋 Students sorted by roll number');
                
                // 🎯 FIRST: Try to apply custom batch configuration
                console.log('🔧 Checking for custom batch configuration...');
                console.log(`🔍 Debug: Department=${department}, Year=${year}, Batch=${batchLetter}`);
                console.log(`🔍 Debug: Available configurations:`, batchConfigurations);
                console.log(`🔍 Debug: Looking for key: ${department}_${year}`);
                batchStudents = applyCustomBatchConfiguration(filteredStudents, batchLetter, department, year);
                
                // If no custom configuration found, fall back to hardcoded logic
                if (batchStudents === null) {
                    console.log('📋 No custom configuration found, using hardcoded batch logic');
                    
                    // Apply department/year specific batch logic (copied from teacher panel)
                    if (department === 'IT' && year === 'FY') {
                        // IT FY: A(1-20), B(21-40), C(41+)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 20; break;
                            case 'B': startIndex = 20; endIndex = 40; break;
                            case 'C': startIndex = 40; endIndex = filteredStudents.length; break;
                            default: startIndex = 0; endIndex = 20; break;
                        }
                        batchStudents = filteredStudents.slice(startIndex, endIndex);
                    
                } else if (department === 'IT' && year === 'SY') {
                    // IT SY: A(1-24), B(25-48), C(49-71)
                    switch (batchLetter) {
                        case 'A': startIndex = 0; endIndex = 24; break;
                        case 'B': startIndex = 24; endIndex = 48; break;
                        case 'C': startIndex = 48; endIndex = 71; break;
                        default: startIndex = 0; endIndex = 24; break;
                    }
                    batchStudents = filteredStudents.slice(startIndex, endIndex);
                    
                } else if (department === 'IT' && year === 'TY') {
                    // IT TY: A(1-23), B(24-46), C(47-70) with special roll handling
                    if (batchLetter === 'A') {
                        batchStudents = filteredStudents.slice(0, 23);
                        // Force add roll 3623 to Batch A
                        const roll3623Student = filteredStudents.find(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 3623);
                        if (roll3623Student && !batchStudents.some(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 3623)) {
                            batchStudents.push(roll3623Student);
                            console.log('🎯 Added roll 3623 to Batch A');
                        }
                        // Also add roll 23 if present
                        const roll23Student = filteredStudents.find(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 23);
                        if (roll23Student && !batchStudents.some(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 23)) {
                            batchStudents.push(roll23Student);
                            console.log('🎯 Added roll 23 to Batch A');
                        }
                        // Sort after adding
                        batchStudents.sort((a, b) => {
                            const rollA = parseInt((a.rollNo || '').replace(/\D/g, '')) || 0;
                            const rollB = parseInt((b.rollNo || '').replace(/\D/g, '')) || 0;
                            return rollA - rollB;
                        });
                    } else if (batchLetter === 'B') {
                        batchStudents = filteredStudents.slice(23, 46).filter(s => {
                            const roll = parseInt((s.rollNo || '').replace(/\D/g, ''));
                            return roll !== 23 && roll !== 3623; // Remove roll 23 and 3623 from Batch B
                        });
                        console.log('🎯 IT TY Batch B: Removed roll 23 and 3623');
                    } else if (batchLetter === 'C') {
                        batchStudents = filteredStudents.slice(46, 70);
                    } else {
                        batchStudents = filteredStudents.slice(0, 23);
                    }
                    
                } else if (department === 'CE' && year === 'SY') {
                    // CE SY: Special batch handling
                    if (batchLetter === 'A') {
                        // Batch A: 1-22 (0-21) and 27 (index 26)
                        batchStudents = filteredStudents.slice(0, 22).concat(filteredStudents.slice(26, 27));
                    } else if (batchLetter === 'B') {
                        // Batch B: 23-26 (22-25), 28-43 (27-43), and add 26 (index 25), remove 27 (index 26)
                        batchStudents = filteredStudents.slice(22, 26) // 23-26
                            .concat(filteredStudents.slice(27, 43))    // 28-43
                            .concat(filteredStudents.slice(25, 26));   // add 26
                    } else {
                        // Default fallback
                        batchStudents = filteredStudents.slice(0, 22).concat(filteredStudents.slice(26, 27));
                    }
                    
                } else if (department === 'CE' && year === 'TY') {
                    // CE TY: Only Batch A with roll 3001-3026
                    if (batchLetter === 'A') {
                        batchStudents = filteredStudents.filter(s => {
                            const roll = parseInt((s.rollNo || '').replace(/\D/g, ''));
                            return roll >= 3001 && roll <= 3026;
                        });
                        console.log('🎯 CE TY Batch A: Roll 3001-3026 loaded');
                    } else {
                        batchStudents = [];
                        console.log('🚫 CE TY: Only Batch A available');
                    }
                    
                } else if (department === 'ET' && year === 'FY') {
                    // ET FY: A(1-20), B(21-40), C(41+)
                    switch (batchLetter) {
                        case 'A': batchStudents = filteredStudents.slice(0, 20); break;
                        case 'B': batchStudents = filteredStudents.slice(20, 40); break;
                        case 'C': batchStudents = filteredStudents.slice(40); break;
                        default: batchStudents = filteredStudents.slice(0, 20); break;
                    }
                    
                } else if (department === 'ET' && year === 'SY') {
                    // ET SY: A(1-24), B(25-48), C(49-69)
                    switch (batchLetter) {
                        case 'A': batchStudents = filteredStudents.slice(0, 24); break;
                        case 'B': batchStudents = filteredStudents.slice(24, 48); break;
                        case 'C': batchStudents = filteredStudents.slice(48, 69); break;
                        default: batchStudents = filteredStudents.slice(0, 24); break;
                    }
                    
                } else if (department === 'ET' && year === 'TY') {
                    // ET TY: A(1-20), B(21-37), NO C
                    switch (batchLetter) {
                        case 'A': batchStudents = filteredStudents.slice(0, 20); break;
                        case 'B': batchStudents = filteredStudents.slice(20, 37); break;
                        default: batchStudents = filteredStudents.slice(0, 20); break;
                    }
                    
                } else if (department === 'EE' && year === 'TY') {
                    // EE TY: Only Batch A and B (no Batch C)
                    switch (batchLetter) {
                        case 'A': batchStudents = filteredStudents.slice(0, 23); break;
                        case 'B': batchStudents = filteredStudents.slice(23); break;
                        default: batchStudents = filteredStudents.slice(0, 23); break;
                    }
                    
                    } else {
                        // Default batch system for other departments/years (20 students per batch)
                        const batchMap = { 'A': 1, 'B': 2, 'C': 3 };
                        const batchNumber = batchMap[batchLetter] || 1;
                        startIndex = (batchNumber - 1) * 20;
                        endIndex = startIndex + 20;
                        batchStudents = filteredStudents.slice(startIndex, endIndex);
                    }
                } // Close the if (batchStudents === null) block
                
                console.log(`🎯 ${department} ${year} Batch ${batchLetter}: ${batchStudents.length} students loaded`);
                
                console.log(`✅ Final batch students: ${batchStudents.length}`);
                
                // Display students
                displayBatchStudents(batchStudents);
                
                // Show action buttons and table
                document.getElementById('batchActions').style.display = 'block';
                document.getElementById('batchStudentsTable').style.display = 'block';
                
            } catch (error) {
                console.error('❌ Error loading batch students:', error);
                alert('Error loading students: ' + error.message);
                
                // Show error in table
                const tbody = document.getElementById('batchStudentsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 2rem; text-align: center; color: var(--danger);">
                            Error loading students: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Display Batch Students in Table
        function displayBatchStudents(students) {
            const tbody = document.getElementById('batchStudentsTableBody');
            const countSpan = document.getElementById('batchStudentsCount');
            
            countSpan.textContent = students.length;
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 2rem; text-align: center; color: var(--text-light);">
                            No students found in this batch
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map(student => `
                <tr>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <input type="checkbox" class="student-checkbox" value="${student.id}">
                    </td>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">${student.rollNo || 'N/A'}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">${student.name || 'N/A'}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">${student.branch || 'N/A'}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">${student.year || 'N/A'}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">${student.division || 'N/A'}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
                        <button onclick="deleteStudent('${student.id}')" style="padding: 0.5rem 1rem; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Toggle Select All Batch Students
        function toggleSelectAllBatchStudents() {
            const selectAll = document.getElementById('selectAllBatchStudents');
            const checkboxes = document.querySelectorAll('.student-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // Delete Duplicate Roll 2026 from CE SY Batch B
        async function deleteDuplicateRoll2026() {
            const confirmDelete = confirm('Delete duplicate roll 2026 from CE Second Year Batch B?');
            if (!confirmDelete) return;
            
            try {
                console.log('🎯 Deleting duplicate roll 2026 from CE SY Batch B...');
                
                // Get all students
                const studentsSnapshot = await firebase.database().ref('students').once('value');
                const allStudents = [];
                
                studentsSnapshot.forEach(snapshot => {
                    const student = snapshot.val();
                    student.id = snapshot.key;
                    allStudents.push(student);
                });
                
                // Filter CE SY students only
                const cesyStudents = allStudents.filter(student => 
                    student.department === 'CE' && student.year === 'SY'
                );
                
                // Sort by roll number
                cesyStudents.sort((a, b) => {
                    const rollA = parseInt((a.rollNo || '').replace(/\D/g, '')) || 0;
                    const rollB = parseInt((b.rollNo || '').replace(/\D/g, '')) || 0;
                    return rollA - rollB;
                });
                
                // CE SY Batch B range: students 23-43 (index 22-42)
                const batchBStudents = cesyStudents.slice(22, 43);
                
                // Find roll 2026 students in Batch B
                const roll2026Students = batchBStudents.filter(student => {
                    const rollNo = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                    return rollNo === 2026;
                });
                
                console.log(`🔍 Found ${roll2026Students.length} students with roll 2026 in CE SY Batch B:`);
                roll2026Students.forEach((student, index) => {
                    console.log(`${index + 1}. ${student.name} - Roll: ${student.rollNo} - ID: ${student.id}`);
                });
                
                if (roll2026Students.length > 1) {
                    // Keep first, delete others
                    const keepStudent = roll2026Students[0];
                    const deleteStudents = roll2026Students.slice(1);
                    
                    console.log(`✅ Keeping: ${keepStudent.name} (Roll: ${keepStudent.rollNo})`);
                    console.log(`🗑️ Will delete ${deleteStudents.length} duplicate(s)`);
                    
                    // Delete duplicates
                    for (const student of deleteStudents) {
                        await firebase.database().ref('students/' + student.id).remove();
                        console.log(`🗑️ Deleted: ${student.name} (Roll: ${student.rollNo})`);
                    }
                    
                    console.log('✅ Duplicate deletion completed!');
                    alert(`Successfully deleted ${deleteStudents.length} duplicate roll 2026 student(s) from CE SY Batch B!`);
                    
                    // Reload students if currently viewing CE SY Batch B
                    const currentDept = document.getElementById('batchDepartment').value;
                    const currentYear = document.getElementById('batchYear').value;
                    const currentBatch = document.getElementById('batchLetter').value;
                    
                    if (currentDept === 'CE' && currentYear === 'SY' && currentBatch === 'B') {
                        loadBatchStudents();
                    }
                } else {
                    console.log('✅ No duplicates found - only one roll 2026 student in CE SY Batch B');
                    alert('No duplicate roll 2026 found in CE SY Batch B');
                }
                
            } catch (error) {
                console.error('❌ Error during deletion:', error);
                alert('Error occurred during deletion: ' + error.message);
            }
        }

        // Delete Individual Student
        async function deleteStudent(studentId) {
            const confirmDelete = confirm('Are you sure you want to delete this student?');
            if (!confirmDelete) return;
            
            try {
                await firebase.database().ref('students/' + studentId).remove();
                alert('Student deleted successfully!');
                loadBatchStudents(); // Reload the table
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student: ' + error.message);
            }
        }

        // Show Bulk Delete Modal
        function showBulkDeleteModal() {
            const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select students to delete');
                return;
            }
            
            const confirmDelete = confirm(`Delete ${selectedCheckboxes.length} selected student(s)?`);
            if (confirmDelete) {
                bulkDeleteStudents(selectedCheckboxes);
            }
        }

        // Bulk Delete Students
        async function bulkDeleteStudents(checkboxes) {
            try {
                const deletePromises = Array.from(checkboxes).map(checkbox => 
                    firebase.database().ref('students/' + checkbox.value).remove()
                );
                
                await Promise.all(deletePromises);
                alert(`Successfully deleted ${checkboxes.length} student(s)!`);
                loadBatchStudents(); // Reload the table
                
                // Reset select all checkbox
                document.getElementById('selectAllBatchStudents').checked = false;
                
            } catch (error) {
                console.error('Error in bulk delete:', error);
                alert('Error deleting students: ' + error.message);
            }
        }

        // Show Shift Student Modal
        function showShiftStudentModal() {
            const modal = document.createElement('div');
            modal.id = 'shiftStudentModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--primary);"><i class="fas fa-exchange-alt"></i> Shift Students Between Batches</h3>
                        <button onclick="closeShiftStudentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--light); border-radius: 8px;">
                        <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Select students from current batch and move them to a different batch within the same department and year.
                        </p>
                    </div>
                    
                    <form id="shiftStudentForm" onsubmit="shiftSelectedStudents(event)">
                        <!-- Source Batch Info -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px;">
                            <h4 style="margin: 0 0 1rem 0; color: var(--primary);">From (Current Batch):</h4>
                            <div id="sourceBatchInfo" style="color: var(--text-light);">
                                Please load a batch first to see source information
                            </div>
                        </div>
                        
                        <!-- Target Batch Selection -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Move To Batch:</label>
                            <select id="targetBatch" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                                <option value="">-- Select Target Batch --</option>
                                <option value="A">Batch A (1-20)</option>
                                <option value="B">Batch B (21-40)</option>
                                <option value="C">Batch C (41-60)</option>
                            </select>
                        </div>
                        
                        <!-- Selected Students Display -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Selected Students to Shift:</label>
                            <div id="selectedStudentsList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: var(--light);">
                                <p style="margin: 0; color: var(--text-light); text-align: center;">
                                    Select students from the table using checkboxes
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="closeShiftStudentModal()" style="padding: 0.75rem 1.5rem; background: var(--text-light); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="button" onclick="updateSelectedStudentsList()" style="padding: 0.75rem 1.5rem; background: var(--warning); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-sync"></i> Refresh Selected
                            </button>
                            <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-exchange-alt"></i> Shift Students
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateSourceBatchInfo();
            updateSelectedStudentsList();
        }
        
        // Close Shift Student Modal
        function closeShiftStudentModal() {
            const modal = document.getElementById('shiftStudentModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Update Source Batch Information
        function updateSourceBatchInfo() {
            const sourceBatchInfo = document.getElementById('sourceBatchInfo');
            if (!sourceBatchInfo) return;
            
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            const division = document.getElementById('batchDivision').value;
            const currentBatch = document.getElementById('batchLetter').value;
            
            if (department && year && currentBatch) {
                const departmentNames = {
                    'CE': 'Civil Engineering',
                    'IT': 'Information Technology',
                    'ME': 'Mechanical Engineering',
                    'CT': 'Computer Technology',
                    'EE': 'Electrical Engineering',
                    'ET': 'Electronics & Telecommunication',
                    'AI': 'Artificial Intelligence'
                };
                
                const yearNames = {
                    'FY': 'First Year',
                    'SY': 'Second Year',
                    'TY': 'Third Year',
                    'BE': 'Final Year'
                };
                
                sourceBatchInfo.innerHTML = `
                    <strong>Department:</strong> ${departmentNames[department] || department}<br>
                    <strong>Year:</strong> ${yearNames[year] || year}<br>
                    <strong>Division:</strong> ${division || 'All Students'}<br>
                    <strong>Current Batch:</strong> Batch ${currentBatch}
                `;
            } else {
                sourceBatchInfo.innerHTML = 'Please load a batch first to see source information';
            }
        }
        
        // Update Selected Students List
        function updateSelectedStudentsList() {
            const selectedList = document.getElementById('selectedStudentsList');
            if (!selectedList) return;
            
            // Get all checkboxes from the batch students table
            const checkboxes = document.querySelectorAll('#batchStudentsTableBody .student-checkbox:checked');
            
            console.log('🔍 Found checked checkboxes:', checkboxes.length);
            
            if (checkboxes.length === 0) {
                // Show all available students for selection
                const allCheckboxes = document.querySelectorAll('#batchStudentsTableBody .student-checkbox');
                console.log('📋 Total available students:', allCheckboxes.length);
                
                if (allCheckboxes.length === 0) {
                    selectedList.innerHTML = `
                        <p style="margin: 0; color: var(--danger); text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i> No students loaded. Please load a batch first.
                        </p>
                    `;
                } else {
                    selectedList.innerHTML = `
                        <p style="margin: 0; color: var(--text-light); text-align: center;">
                            <i class="fas fa-info-circle"></i> Select students from the table using checkboxes (${allCheckboxes.length} students available)
                        </p>
                    `;
                }
                return;
            }
            
            let studentsHtml = `<div style="font-weight: 500; margin-bottom: 0.5rem; color: var(--primary);">Selected ${checkboxes.length} student(s):</div>`;
            
            checkboxes.forEach((checkbox, index) => {
                const row = checkbox.closest('tr');
                const rollNo = row.cells[1].textContent;
                const name = row.cells[2].textContent;
                
                studentsHtml += `
                    <div style="padding: 0.5rem; margin-bottom: 0.25rem; background: var(--light); border-radius: 4px; font-size: 0.9rem;">
                        <strong style="color: var(--primary);">Roll ${rollNo}:</strong> ${name}
                    </div>
                `;
            });
            
            selectedList.innerHTML = studentsHtml;
        }
        
        // Shift Selected Students
        async function shiftSelectedStudents(event) {
            event.preventDefault();
            
            const targetBatch = document.getElementById('targetBatch').value;
            const checkboxes = document.querySelectorAll('#batchStudentsTableBody .student-checkbox:checked');
            
            if (!targetBatch) {
                alert('Please select target batch!');
                return;
            }
            
            if (checkboxes.length === 0) {
                alert('Please select students to shift!');
                return;
            }
            
            const currentBatch = document.getElementById('batchLetter').value;
            if (targetBatch === currentBatch) {
                alert('Target batch cannot be same as current batch!');
                return;
            }
            
            const confirmShift = confirm(`Shift ${checkboxes.length} students from Batch ${currentBatch} to Batch ${targetBatch}?\n\nThis will change their roll numbers to fit the target batch range.`);
            if (!confirmShift) return;
            
            try {
                console.log(`🔄 Shifting ${checkboxes.length} students from Batch ${currentBatch} to Batch ${targetBatch}`);
                
                const studentIds = Array.from(checkboxes).map(cb => cb.value);
                let successCount = 0;
                let errorCount = 0;
                
                // Get target batch range
                const targetRanges = {
                    'A': { start: 1, end: 20 },
                    'B': { start: 21, end: 40 },
                    'C': { start: 41, end: 60 }
                };
                
                const targetRange = targetRanges[targetBatch];
                
                // Get all students in target batch to find available roll numbers
                const department = document.getElementById('batchDepartment').value;
                const year = document.getElementById('batchYear').value;
                const departmentMapping = {
                    'CE': 'Civil Engineering',
                    'IT': 'Information Technology', 
                    'ME': 'Mechanical Engineering',
                    'CT': 'Computer Technology',
                    'EE': 'Electrical Engineering',
                    'ET': 'Electronics & Telecommunication',
                    'AI': 'Artificial Intelligence'
                };
                const yearMapping = {
                    'FY': 'First',
                    'SY': 'Second', 
                    'TY': 'Third',
                    'BE': 'Final'
                };
                
                const targetBranch = departmentMapping[department];
                const targetYear = yearMapping[year];
                
                // Get existing students in target range
                const allStudentsSnapshot = await firebase.database().ref('students').once('value');
                const existingRollNumbers = new Set();
                
                allStudentsSnapshot.forEach(snapshot => {
                    const student = snapshot.val();
                    if (student.branch === targetBranch && student.year === targetYear) {
                        const rollNo = parseInt(student.rollNo);
                        if (rollNo >= targetRange.start && rollNo <= targetRange.end) {
                            existingRollNumbers.add(rollNo);
                        }
                    }
                });
                
                // Find available roll numbers in target batch
                const availableRollNumbers = [];
                for (let i = targetRange.start; i <= targetRange.end; i++) {
                    if (!existingRollNumbers.has(i)) {
                        availableRollNumbers.push(i);
                    }
                }
                
                if (availableRollNumbers.length < studentIds.length) {
                    alert(`Not enough space in Batch ${targetBatch}!\nAvailable slots: ${availableRollNumbers.length}\nStudents to shift: ${studentIds.length}`);
                    return;
                }
                
                // Shift students with new roll numbers
                for (let i = 0; i < studentIds.length; i++) {
                    const studentId = studentIds[i];
                    const newRollNo = availableRollNumbers[i];
                    
                    try {
                        // Get student data
                        const studentSnapshot = await firebase.database().ref(`students/${studentId}`).once('value');
                        const studentData = studentSnapshot.val();
                        
                        if (studentData) {
                            const oldRollNo = studentData.rollNo;
                            
                            // Update student's roll number and batch info
                            await firebase.database().ref(`students/${studentId}`).update({
                                rollNo: newRollNo,
                                oldRollNo: oldRollNo,
                                lastBatch: currentBatch,
                                currentBatch: targetBatch,
                                shiftedAt: Date.now(),
                                shiftedBy: 'admin'
                            });
                            
                            console.log(`✅ Shifted student ${studentData.name}: Roll ${oldRollNo} → Roll ${newRollNo} (Batch ${currentBatch} → Batch ${targetBatch})`);
                            successCount++;
                        }
                    } catch (error) {
                        console.error(`❌ Error shifting student ${studentId}:`, error);
                        errorCount++;
                    }
                }
                
                alert(`Shift completed!\nSuccess: ${successCount} students moved to Batch ${targetBatch}\nErrors: ${errorCount} students\n\nStudents now have new roll numbers in the target batch range.`);
                closeShiftStudentModal();
                
                // Refresh the current batch to show updated data
                loadBatchStudents();
                
            } catch (error) {
                console.error('❌ Error during batch shift:', error);
                alert('Error shifting students: ' + error.message);
            }
        }
        
        // Show Add Student Modal (keeping original for reference)
        function showAddStudentModal() {
            const modal = document.createElement('div');
            modal.id = 'addStudentModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--primary);"><i class="fas fa-plus"></i> Add New Student</h3>
                        <button onclick="closeAddStudentModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                    </div>
                    
                    <form id="addStudentForm" onsubmit="addNewStudent(event)">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Student Name:</label>
                            <input type="text" id="studentName" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" placeholder="Enter full name">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Roll Number:</label>
                            <input type="number" id="studentRollNo" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" placeholder="Enter roll number">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email:</label>
                            <input type="email" id="studentEmail" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" placeholder="student@bvit.edu">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Department:</label>
                            <select id="studentDepartment" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                                <option value="">-- Select Department --</option>
                                <option value="Civil Engineering">Civil Engineering</option>
                                <option value="Computer Technology">Computer Technology</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Mechanical Engineering">Mechanical Engineering</option>
                                <option value="Electrical Engineering">Electrical Engineering</option>
                                <option value="Electronics & Telecommunication">Electronics & Telecommunication</option>
                                <option value="Artificial Intelligence">Artificial Intelligence</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Year:</label>
                            <select id="studentYear" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                                <option value="">-- Select Year --</option>
                                <option value="First">First Year</option>
                                <option value="Second">Second Year</option>
                                <option value="Third">Third Year</option>
                                <option value="Final">Final Year</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Division:</label>
                            <select id="studentDivision" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;">
                                <option value="">-- Select Division --</option>
                                <option value="A">Division A</option>
                                <option value="B">Division B</option>
                                <option value="C">Division C</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="closeAddStudentModal()" style="padding: 0.75rem 1.5rem; background: var(--text-light); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Close Add Student Modal
        function closeAddStudentModal() {
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Add New Student to Firebase
        async function addNewStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentName').value.trim().toUpperCase();
            const rollNo = parseInt(document.getElementById('studentRollNo').value);
            const email = document.getElementById('studentEmail').value.trim().toLowerCase();
            const branch = document.getElementById('studentDepartment').value;
            const year = document.getElementById('studentYear').value;
            const division = document.getElementById('studentDivision').value;
            
            if (!name || !rollNo || !email || !branch || !year) {
                alert('Please fill all required fields!');
                return;
            }
            
            try {
                console.log('🎯 Adding new student:', { name, rollNo, email, branch, year, division });
                
                // Check if roll number already exists
                const studentsSnapshot = await firebase.database().ref('students').once('value');
                const existingStudents = [];
                
                studentsSnapshot.forEach(snapshot => {
                    const student = snapshot.val();
                    if (student.rollNo === rollNo && student.branch === branch && student.year === year) {
                        existingStudents.push(student);
                    }
                });
                
                if (existingStudents.length > 0) {
                    alert(`Roll number ${rollNo} already exists in ${branch} ${year}!`);
                    return;
                }
                
                // Create new student object
                const newStudent = {
                    name: name,
                    rollNo: rollNo,
                    email: email,
                    branch: branch,
                    year: year,
                    division: division || '',
                    createdAt: Date.now(),
                    addedBy: 'admin'
                };
                
                // Add to Firebase
                const newStudentRef = await firebase.database().ref('students').push(newStudent);
                console.log('✅ Student added successfully:', newStudentRef.key);
                
                alert(`Student ${name} added successfully!`);
                closeAddStudentModal();
                
                // Refresh the current batch if loaded
                const currentBatch = document.getElementById('batchLetter').value;
                if (currentBatch) {
                    loadBatchStudents();
                }
                
            } catch (error) {
                console.error('❌ Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }

        // View Attendance Details
        async function viewAttendanceDetails(recordId) {
            try {
                const recordSnapshot = await window.db.ref(`attendance/${recordId}`).once('value');
                if (!recordSnapshot.exists()) {
                    alert('Attendance record not found');
                    return;
                }
                
                const record = recordSnapshot.val();
                const students = record.students || {};
                
                // Get student details
                const studentsSnapshot = await window.db.ref('students').once('value');
                const studentDetails = {};
                if (studentsSnapshot.exists()) {
                    studentsSnapshot.forEach(snap => {
                        const student = snap.val();
                        studentDetails[snap.key] = student.name || 'Unknown Student';
                    });
                }
                
                let detailsHtml = `
                    <div style="max-width: 800px;">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">Attendance Details</h4>
                        <div style="background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p><strong>Subject:</strong> ${record.subject || 'N/A'}</p>
                            <p><strong>Lecture Type:</strong> ${record.lectureType || 'N/A'}</p>
                            <p><strong>Class:</strong> ${record.class || 'N/A'}</p>
                            <p><strong>Date:</strong> ${record.date || 'N/A'}</p>
                            <p><strong>Time:</strong> ${record.time || 'N/A'}</p>
                        </div>
                        <h5 style="margin-bottom: 1rem;">Student Attendance:</h5>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--light); position: sticky; top: 0;">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border);">Student</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border);">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(students).forEach(([studentId, status]) => {
                    const studentName = studentDetails[studentId] || studentId;
                    const statusText = status ? 'Present' : 'Absent';
                    const statusColor = status ? '#10B981' : '#EF4444';
                    const statusIcon = status ? 'fa-check-circle' : 'fa-times-circle';
                    
                    detailsHtml += `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.75rem;">${studentName}</td>
                            <td style="padding: 0.75rem;">
                                <span style="color: ${statusColor}; font-weight: bold;">
                                    <i class="fas ${statusIcon}"></i> ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                detailsHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Show in a popup
                const popup = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
                popup.document.write(`
                    <html>
                        <head>
                            <title>Attendance Details</title>
                            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                            <style>
                                body { font-family: Arial, sans-serif; padding: 2rem; background: #f9fafb; }
                                .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                                :root {
                                    --primary: #4F46E5;
                                    --secondary: #10B981;
                                    --light: #F3F4F6;
                                    --border: #E5E7EB;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                ${detailsHtml}
                                <button onclick="window.close()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #4F46E5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                        </body>
                    </html>
                `);
                
            } catch (error) {
                console.error('Error viewing attendance details:', error);
                alert('Error loading attendance details. Please try again.');
            }
        }

        // ===== BATCH CONFIGURATION SYSTEM =====
        
        // Global variable to store batch configurations
        let batchConfigurations = {};
        
        // Show Batch Configuration Panel
        function showBatchConfigPanel() {
            console.log('🔧 Opening batch configuration panel...');
            
            // Load existing configuration for current department/year
            loadBatchConfiguration();
            
            // Show the panel
            document.getElementById('batchConfigPanel').style.display = 'block';
            
            // Add event listeners for real-time preview
            addBatchConfigEventListeners();
            
            // Update previews
            updateAllBatchPreviews();
        }
        
        // Close Batch Configuration Panel
        function closeBatchConfig() {
            document.getElementById('batchConfigPanel').style.display = 'none';
        }
        
        // Add Event Listeners for Real-time Preview
        function addBatchConfigEventListeners() {
            const inputs = ['batchAStart', 'batchAEnd', 'batchAExtra', 'batchAExclude',
                           'batchBStart', 'batchBEnd', 'batchBExtra', 'batchBExclude',
                           'batchCStart', 'batchCEnd', 'batchCExtra', 'batchCExclude'];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateAllBatchPreviews);
                }
            });
        }
        
        // Update All Batch Previews
        function updateAllBatchPreviews() {
            updateBatchPreview('A');
            updateBatchPreview('B');
            updateBatchPreview('C');
        }
        
        // Update Individual Batch Preview
        function updateBatchPreview(batch) {
            const startInput = document.getElementById(`batch${batch}Start`);
            const endInput = document.getElementById(`batch${batch}End`);
            const extraInput = document.getElementById(`batch${batch}Extra`);
            const excludeInput = document.getElementById(`batch${batch}Exclude`);
            const previewDiv = document.getElementById(`batch${batch}Preview`);
            
            if (!startInput || !endInput || !previewDiv) return;
            
            const start = parseInt(startInput.value) || 1;
            const end = parseInt(endInput.value) || 20;
            const extra = extraInput.value.trim();
            const exclude = excludeInput.value.trim();
            
            // Calculate base range
            const baseCount = Math.max(0, end - start + 1);
            
            // Parse extra students
            const extraNumbers = extra ? extra.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n)) : [];
            
            // Parse exclude students
            const excludeNumbers = exclude ? exclude.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n)) : [];
            
            // Calculate final count
            const finalCount = baseCount + extraNumbers.length - excludeNumbers.length;
            
            // Build preview text
            let previewText = `Range: ${start}-${end} (${baseCount} students)`;
            
            if (extraNumbers.length > 0) {
                previewText += `\n+ Extra: ${extraNumbers.join(', ')} (${extraNumbers.length} students)`;
            }
            
            if (excludeNumbers.length > 0) {
                previewText += `\n- Exclude: ${excludeNumbers.join(', ')} (${excludeNumbers.length} students)`;
            }
            
            previewText += `\nTotal: ${finalCount} students`;
            
            previewDiv.innerHTML = previewText.replace(/\n/g, '<br>');
            
            // Color coding based on student count
            if (finalCount <= 0) {
                previewDiv.style.color = '#EF4444';
                previewDiv.style.borderColor = '#EF4444';
            } else if (finalCount > 30) {
                previewDiv.style.color = '#F59E0B';
                previewDiv.style.borderColor = '#F59E0B';
            } else {
                previewDiv.style.color = '#10B981';
                previewDiv.style.borderColor = '#10B981';
            }
        }
        
        // Load Batch Configuration for Current Department/Year
        function loadBatchConfiguration() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            
            if (!department || !year) {
                resetBatchConfiguration();
                return;
            }
            
            const configKey = `${department}_${year}`;
            const savedConfig = batchConfigurations[configKey];
            
            if (savedConfig) {
                console.log(`📋 Loading saved configuration for ${configKey}:`, savedConfig);
                
                // Load Batch A
                document.getElementById('batchAStart').value = savedConfig.A.start || 1;
                document.getElementById('batchAEnd').value = savedConfig.A.end || 20;
                document.getElementById('batchAExtra').value = savedConfig.A.extra || '';
                document.getElementById('batchAExclude').value = savedConfig.A.exclude || '';
                
                // Load Batch B
                document.getElementById('batchBStart').value = savedConfig.B.start || 21;
                document.getElementById('batchBEnd').value = savedConfig.B.end || 40;
                document.getElementById('batchBExtra').value = savedConfig.B.extra || '';
                document.getElementById('batchBExclude').value = savedConfig.B.exclude || '';
                
                // Load Batch C
                document.getElementById('batchCStart').value = savedConfig.C.start || 41;
                document.getElementById('batchCEnd').value = savedConfig.C.end || 60;
                document.getElementById('batchCExtra').value = savedConfig.C.extra || '';
                document.getElementById('batchCExclude').value = savedConfig.C.exclude || '';
            } else {
                console.log(`🔧 No saved configuration found for ${configKey}, using defaults`);
                setDefaultBatchConfiguration(department, year);
            }
        }
        
        // Set Default Configuration Based on Department/Year
        function setDefaultBatchConfiguration(department, year) {
            // Set intelligent defaults based on existing hardcoded logic
            if (department === 'IT' && year === 'FY') {
                // IT FY: A(1-20), B(21-40), C(41+)
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 20;
                document.getElementById('batchBStart').value = 21;
                document.getElementById('batchBEnd').value = 40;
                document.getElementById('batchCStart').value = 41;
                document.getElementById('batchCEnd').value = 60;
            } else if (department === 'IT' && year === 'SY') {
                // IT SY: A(1-24), B(25-48), C(49-71)
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 24;
                document.getElementById('batchBStart').value = 25;
                document.getElementById('batchBEnd').value = 48;
                document.getElementById('batchCStart').value = 49;
                document.getElementById('batchCEnd').value = 71;
            } else if (department === 'IT' && year === 'TY') {
                // IT TY: A(1-23), B(24-46), C(47-70)
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 23;
                document.getElementById('batchBStart').value = 24;
                document.getElementById('batchBEnd').value = 46;
                document.getElementById('batchCStart').value = 47;
                document.getElementById('batchCEnd').value = 70;
            } else if (department === 'ET' && year === 'FY') {
                // ET FY: A(1-20), B(21-40), C(41+)
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 20;
                document.getElementById('batchBStart').value = 21;
                document.getElementById('batchBEnd').value = 40;
                document.getElementById('batchCStart').value = 41;
                document.getElementById('batchCEnd').value = 60;
            } else if (department === 'ET' && year === 'SY') {
                // ET SY: A(1-24), B(25-48), C(49-69)
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 24;
                document.getElementById('batchBStart').value = 25;
                document.getElementById('batchBEnd').value = 48;
                document.getElementById('batchCStart').value = 49;
                document.getElementById('batchCEnd').value = 69;
            } else if (department === 'CE' && year === 'SY') {
                // CE SY: Special configuration
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 22;
                document.getElementById('batchAExtra').value = '27';
                document.getElementById('batchBStart').value = 23;
                document.getElementById('batchBEnd').value = 43;
                document.getElementById('batchBExtra').value = '26';
                document.getElementById('batchBExclude').value = '27';
            } else {
                // Default: 20 students per batch
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 20;
                document.getElementById('batchBStart').value = 21;
                document.getElementById('batchBEnd').value = 40;
                document.getElementById('batchCStart').value = 41;
                document.getElementById('batchCEnd').value = 60;
            }
            
            // Clear extra/exclude fields for defaults
            if (department !== 'CE' || year !== 'SY') {
                document.getElementById('batchAExtra').value = '';
                document.getElementById('batchAExclude').value = '';
                document.getElementById('batchBExtra').value = '';
                document.getElementById('batchBExclude').value = '';
                document.getElementById('batchCExtra').value = '';
                document.getElementById('batchCExclude').value = '';
            }
        }
        
        // Reset Batch Configuration to Defaults
        function resetBatchConfiguration() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            
            if (department && year) {
                setDefaultBatchConfiguration(department, year);
            } else {
                // Global defaults
                document.getElementById('batchAStart').value = 1;
                document.getElementById('batchAEnd').value = 20;
                document.getElementById('batchAExtra').value = '';
                document.getElementById('batchAExclude').value = '';
                
                document.getElementById('batchBStart').value = 21;
                document.getElementById('batchBEnd').value = 40;
                document.getElementById('batchBExtra').value = '';
                document.getElementById('batchBExclude').value = '';
                
                document.getElementById('batchCStart').value = 41;
                document.getElementById('batchCEnd').value = 60;
                document.getElementById('batchCExtra').value = '';
                document.getElementById('batchCExclude').value = '';
            }
            
            updateAllBatchPreviews();
            alert('✅ Batch configuration reset to defaults!');
        }
        
        // Preview Batch Configuration
        function previewBatchConfiguration() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            
            if (!department || !year) {
                alert('⚠️ Please select department and year first!');
                return;
            }
            
            const config = getCurrentBatchConfiguration();
            
            // Create preview modal
            const modal = document.createElement('div');
            modal.id = 'batchPreviewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--primary);">
                            <i class="fas fa-eye"></i> Batch Configuration Preview
                        </h3>
                        <button onclick="closeBatchPreviewModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                    </div>
                    
                    <div style="background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <p style="margin: 0; font-weight: 500;">
                            <i class="fas fa-building"></i> Department: ${department} | 
                            <i class="fas fa-graduation-cap"></i> Year: ${year}
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        ${generateBatchPreviewCard('A', config.A)}
                        ${generateBatchPreviewCard('B', config.B)}
                        ${generateBatchPreviewCard('C', config.C)}
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: center;">
                        <button onclick="closeBatchPreviewModal()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                            <i class="fas fa-check"></i> Close Preview
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Generate Batch Preview Card
        function generateBatchPreviewCard(batch, config) {
            const colors = {
                'A': '#10B981',
                'B': '#F59E0B', 
                'C': '#EF4444'
            };
            
            const baseCount = Math.max(0, config.end - config.start + 1);
            const extraCount = config.extraNumbers ? config.extraNumbers.length : 0;
            const excludeCount = config.excludeNumbers ? config.excludeNumbers.length : 0;
            const totalCount = baseCount + extraCount - excludeCount;
            
            return `
                <div style="border: 2px solid ${colors[batch]}; border-radius: 8px; padding: 1rem; background: white;">
                    <h4 style="margin: 0 0 1rem 0; color: ${colors[batch]}; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-users"></i> Batch ${batch}
                    </h4>
                    <div style="font-size: 0.875rem; line-height: 1.5;">
                        <p style="margin: 0.5rem 0;"><strong>Range:</strong> ${config.start}-${config.end} (${baseCount} students)</p>
                        ${extraCount > 0 ? `<p style="margin: 0.5rem 0; color: #10B981;"><strong>+ Extra:</strong> ${config.extra} (${extraCount} students)</p>` : ''}
                        ${excludeCount > 0 ? `<p style="margin: 0.5rem 0; color: #EF4444;"><strong>- Exclude:</strong> ${config.exclude} (${excludeCount} students)</p>` : ''}
                        <hr style="margin: 0.75rem 0; border: none; border-top: 1px solid var(--border);">
                        <p style="margin: 0; font-weight: bold; font-size: 1rem; color: ${colors[batch]};">
                            <i class="fas fa-calculator"></i> Total: ${totalCount} students
                        </p>
                    </div>
                </div>
            `;
        }
        
        // Close Batch Preview Modal
        function closeBatchPreviewModal() {
            const modal = document.getElementById('batchPreviewModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Get Current Batch Configuration from Form
        function getCurrentBatchConfiguration() {
            return {
                A: {
                    start: parseInt(document.getElementById('batchAStart').value) || 1,
                    end: parseInt(document.getElementById('batchAEnd').value) || 20,
                    extra: document.getElementById('batchAExtra').value.trim(),
                    exclude: document.getElementById('batchAExclude').value.trim(),
                    extraNumbers: parseNumberList(document.getElementById('batchAExtra').value),
                    excludeNumbers: parseNumberList(document.getElementById('batchAExclude').value)
                },
                B: {
                    start: parseInt(document.getElementById('batchBStart').value) || 21,
                    end: parseInt(document.getElementById('batchBEnd').value) || 40,
                    extra: document.getElementById('batchBExtra').value.trim(),
                    exclude: document.getElementById('batchBExclude').value.trim(),
                    extraNumbers: parseNumberList(document.getElementById('batchBExtra').value),
                    excludeNumbers: parseNumberList(document.getElementById('batchBExclude').value)
                },
                C: {
                    start: parseInt(document.getElementById('batchCStart').value) || 41,
                    end: parseInt(document.getElementById('batchCEnd').value) || 60,
                    extra: document.getElementById('batchCExtra').value.trim(),
                    exclude: document.getElementById('batchCExclude').value.trim(),
                    extraNumbers: parseNumberList(document.getElementById('batchCExtra').value),
                    excludeNumbers: parseNumberList(document.getElementById('batchCExclude').value)
                }
            };
        }
        
        // Parse Number List from String
        function parseNumberList(str) {
            if (!str || str.trim() === '') return [];
            return str.split(',')
                     .map(n => parseInt(n.trim()))
                     .filter(n => !isNaN(n) && n > 0);
        }
        
        // Save Batch Configuration
        async function saveBatchConfiguration() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            
            if (!department || !year) {
                alert('⚠️ Please select department and year first!');
                return;
            }
            
            const config = getCurrentBatchConfiguration();
            const configKey = `${department}_${year}`;
            
            try {
                // Save to global configurations
                batchConfigurations[configKey] = config;
                
                // Save to localStorage for persistence
                localStorage.setItem('batchConfigurations', JSON.stringify(batchConfigurations));
                
                // Optionally save to Firebase
                if (window.db && typeof window.db.ref === 'function') {
                    await window.db.ref(`batchConfigurations/${configKey}`).set(config);
                    console.log(`💾 Batch configuration saved to Firebase for ${configKey}`);
                }
                
                console.log(`✅ Batch configuration saved for ${configKey}:`, config);
                alert(`✅ Batch configuration saved successfully for ${department} ${year}!`);
                
                // Close the configuration panel
                closeBatchConfig();
                
                // Reload students if currently viewing this department/year
                const currentDept = document.getElementById('batchDepartment').value;
                const currentYear = document.getElementById('batchYear').value;
                
                if (currentDept === department && currentYear === year) {
                    loadBatchStudents();
                }
                
            } catch (error) {
                console.error('❌ Error saving batch configuration:', error);
                alert('❌ Error saving configuration: ' + error.message);
            }
        }
        
        // Load Batch Configurations from Storage
        async function loadBatchConfigurationsFromStorage() {
            try {
                // Load from localStorage
                const localConfig = localStorage.getItem('batchConfigurations');
                if (localConfig) {
                    batchConfigurations = JSON.parse(localConfig);
                    console.log('📋 Loaded batch configurations from localStorage:', batchConfigurations);
                }
                
                // Load from Firebase (if available)
                if (window.db && typeof window.db.ref === 'function') {
                    const snapshot = await window.db.ref('batchConfigurations').once('value');
                    if (snapshot.exists()) {
                        const firebaseConfig = snapshot.val();
                        batchConfigurations = { ...batchConfigurations, ...firebaseConfig };
                        console.log('📋 Loaded batch configurations from Firebase:', firebaseConfig);
                    }
                }
                
            } catch (error) {
                console.error('⚠️ Error loading batch configurations:', error);
            }
        }
        
        // Apply Custom Batch Configuration to Student Loading
        function applyCustomBatchConfiguration(students, batchLetter, department, year) {
            const configKey = `${department}_${year}`;
            const savedConfig = batchConfigurations[configKey];
            
            console.log(`🔍 applyCustomBatchConfiguration Debug:`);
            console.log(`   - ConfigKey: ${configKey}`);
            console.log(`   - BatchLetter: ${batchLetter}`);
            console.log(`   - SavedConfig:`, savedConfig);
            console.log(`   - Students count: ${students.length}`);
            
            if (!savedConfig || !savedConfig[batchLetter]) {
                console.log(`📋 No custom configuration found for ${configKey} Batch ${batchLetter}, using default logic`);
                return null; // Fall back to existing hardcoded logic
            }
            
            const batchConfig = savedConfig[batchLetter];
            console.log(`🎯 Applying custom configuration for ${configKey} Batch ${batchLetter}:`, batchConfig);
            
            // Filter students by roll number range
            let batchStudents = students.filter(student => {
                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                return rollNum >= batchConfig.start && rollNum <= batchConfig.end;
            });
            
            // Add extra students
            if (batchConfig.extraNumbers && batchConfig.extraNumbers.length > 0) {
                const extraStudents = students.filter(student => {
                    const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                    return batchConfig.extraNumbers.includes(rollNum);
                });
                batchStudents = batchStudents.concat(extraStudents);
                console.log(`➕ Added ${extraStudents.length} extra students: ${batchConfig.extraNumbers.join(', ')}`);
            }
            
            // Remove excluded students
            if (batchConfig.excludeNumbers && batchConfig.excludeNumbers.length > 0) {
                const beforeCount = batchStudents.length;
                batchStudents = batchStudents.filter(student => {
                    const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                    return !batchConfig.excludeNumbers.includes(rollNum);
                });
                const excludedCount = beforeCount - batchStudents.length;
                console.log(`➖ Excluded ${excludedCount} students: ${batchConfig.excludeNumbers.join(', ')}`);
            }
            
            // Remove duplicates (in case extra students were already in range)
            const uniqueStudents = batchStudents.filter((student, index, self) => 
                index === self.findIndex(s => s.id === student.id)
            );
            
            console.log(`✅ Custom batch configuration applied: ${uniqueStudents.length} students in Batch ${batchLetter}`);
            return uniqueStudents;
        }
        
        // Clear all batch configurations (for debugging)
        function clearAllBatchConfigurations() {
            if (confirm('⚠️ This will clear all custom batch configurations. Are you sure?')) {
                batchConfigurations = {};
                localStorage.removeItem('batchConfigurations');
                
                // Clear from Firebase if available
                if (window.db && typeof window.db.ref === 'function') {
                    window.db.ref('batchConfigurations').remove();
                }
                
                console.log('🗑️ All batch configurations cleared');
                alert('✅ All batch configurations cleared. Students will now use default batch logic.');
                
                // Reload current batch if viewing
                const currentDept = document.getElementById('batchDepartment').value;
                const currentYear = document.getElementById('batchYear').value;
                if (currentDept && currentYear) {
                    loadBatchStudents();
                }
            }
        }
        
        // Load Batch Options based on Department and Year
        function loadBatchOptions() {
            const department = document.getElementById('batchDepartment').value;
            const year = document.getElementById('batchYear').value;
            const batchSelect = document.getElementById('batchLetter');
            
            // Clear existing options
            batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
            
            if (!department || !year) {
                console.log('🔍 Department or Year not selected, showing default batches');
                // Show default batches if department/year not selected
                batchSelect.innerHTML += '<option value="A">Batch A</option>';
                batchSelect.innerHTML += '<option value="B">Batch B</option>';
                batchSelect.innerHTML += '<option value="C">Batch C</option>';
                return;
            }
            
            console.log(`🔍 Loading batch options for ${department} ${year}`);
            
            // CE SY: Only Batch A and B (remove Batch C)
            if (department === 'CE' && year === 'SY') {
                batchSelect.innerHTML += '<option value="A">Batch A (1-22 + 27)</option>';
                batchSelect.innerHTML += '<option value="B">Batch B (23-26, 28-43)</option>';
                console.log('🎯 CE SY: Only showing Batch A and B (Batch C removed)');
                return;
            }
            
            // CE TY: Only Batch A (rolls 3001-3026)
            if (department === 'CE' && year === 'TY') {
                batchSelect.innerHTML += '<option value="A">Batch A (Roll 3001-3026)</option>';
                console.log('🎯 CE TY: Only showing Batch A');
                return;
            }
            
            // ET TY: Only Batch A and B (no Batch C)
            if (department === 'ET' && year === 'TY') {
                batchSelect.innerHTML += '<option value="A">Batch A (1-20)</option>';
                batchSelect.innerHTML += '<option value="B">Batch B (21-37)</option>';
                console.log('🎯 ET TY: Only showing Batch A and B (Batch C removed)');
                return;
            }
            
            // EE TY: Only Batch A and B (no Batch C)
            if (department === 'EE' && year === 'TY') {
                batchSelect.innerHTML += '<option value="A">Batch A (1-23)</option>';
                batchSelect.innerHTML += '<option value="B">Batch B (24+)</option>';
                console.log('🎯 EE TY: Only showing Batch A and B (Batch C removed)');
                return;
            }
            
            // ME SY: Only Batch A and B (no Batch C)
            if (department === 'ME' && year === 'SY') {
                batchSelect.innerHTML += '<option value="A">Batch A (1-22)</option>';
                batchSelect.innerHTML += '<option value="B">Batch B (23+)</option>';
                console.log('🎯 ME SY: Only showing Batch A and B (Batch C removed)');
                return;
            }
            
            // Default: Show all three batches for other departments/years
            batchSelect.innerHTML += '<option value="A">Batch A</option>';
            batchSelect.innerHTML += '<option value="B">Batch B</option>';
            batchSelect.innerHTML += '<option value="C">Batch C</option>';
            console.log(`🎯 ${department} ${year}: Showing all batches (A, B, C)`);
        }
        
        // Initialize batch configurations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBatchConfigurationsFromStorage();
        });
    </script>
</body>
</html> 