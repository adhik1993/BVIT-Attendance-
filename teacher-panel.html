<!DOCTYPE html>
<script>
// Global Firebase Offline Fallback (must be first)
(function() {
    if (typeof window.firebase === 'undefined') {
        window.firebaseOfflineMode = false;
        window.firebase = {
            database: function() {
                window.firebaseOfflineMode = true;
                return {
                    ref: function() { return { on: function() {}, once: function() {}, off: function() {}, set: function() {}, update: function() {}, remove: function() {} }; }
                };
            },
            auth: function() {
                window.firebaseOfflineMode = true;
                return {
                    onAuthStateChanged: function(cb) { cb(null); return function(){}; },
                    signOut: function() { return Promise.resolve(); },
                    currentUser: null
                };
            },
            apps: [],
        };
    }
})();
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Panel - BVIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <!-- EmailJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --dark: #1F2937;
            --darker: #111827;
            --light: #F3F4F6;
            --lighter: #F9FAFB;
            --border: #E5E7EB;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --text-lighter: #9CA3AF;
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--light);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--darker);
            min-height: 100vh;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            padding-bottom: 80px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: var(--text-lighter);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link i {
            font-size: 1.25rem;
            width: 1.5rem;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
        }


        /* Lab Assistant header highlight */
        .lab-assistant-header {
            background: #FFF7ED;
            border-bottom: 4px solid #D97706;
            border-radius: 0.75rem 0.75rem 0 0;
            box-shadow: 0 2px 8px 0 rgba(217, 119, 6, 0.08);
            padding: 1.5rem 2rem 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .lab-assistant-badge {
            display: inline-flex;
            align-items: center;
            background: #FDE68A;
            color: #D97706;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 999px;
            padding: 0.35em 0.9em 0.35em 0.7em;
            margin-left: 1.2em;
            box-shadow: 0 2px 6px 0 rgba(217, 119, 6, 0.09);
            gap: 0.5em;
        }
        .lab-assistant-badge i {
            margin-right: 0.35em;
        }
        .lab-assistant-header .page-title {
            color: #D97706;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .stat-classes { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .stat-students { background: rgba(16, 185, 129, 0.1); color: var(--secondary); }
        .stat-attendance { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-performance { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .action-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .action-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .action-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        /* Logout Button */
        .logout-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            padding: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .logout-button i {
            font-size: 1.2rem;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--light);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #f87171;
            color: #fff;
            border: 1px solid #dc2626;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 16px 0 rgba(220, 38, 38, 0.15);
            z-index: 9999;
            min-width: 280px;
            max-width: 90vw;
            justify-content: center;
        }
        .error-message i {
            font-size: 1.3em;
            margin-right: 8px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 5rem;
                padding: 1rem;
            }

            .logo-text, .nav-text {
                display: none;
            }

            .main-content {
                margin-left: 5rem;
            }

            .logout-button span {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 1rem;
            }
        }
        /* Add these new styles */
        .attendance-form {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .students-list {
            margin-top: 2rem;
        }

        .reports-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .date-range {
            display: flex;
            gap: 1rem;
        }

        .report-data {
            margin-top: 2rem;
        }

        .schedule-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .timetable {
            display: grid;
            gap: 1.5rem;
        }

        .weekday {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
        }

        .weekday h3 {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .notifications-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .notification-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            background: var(--light);
        }

        .notifications-list {
            min-height: 200px;
        }

        .no-notifications {
            text-align: center;
            color: var(--text-light);
            padding: 2rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }
        /* End of new styles */
        /* Attendance Page Styles */
        .attendance-container {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group label i {
            color: #4F46E5;
        }

        .form-group select,
        .form-group input[type="text"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            background: white;
        }

        .form-group select:focus,
        .form-group input[type="text"]:focus,
        .form-group input[type="date"]:focus {
            border-color: #4F46E5;
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-group select:hover,
        .form-group input[type="text"]:hover,
        .form-group input[type="date"]:hover {
            border-color: #9CA3AF;
        }

        .attendance-list {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .attendance-table th {
            background: #F9FAFB;
            font-weight: 600;
            color: #374151;
        }

        .attendance-table tr:hover {
            background: #F9FAFB;
        }

        .attendance-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-attendance {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            background: #E5E7EB;
            color: #374151;
        }

        .btn-attendance.active {
            background: #4F46E5;
            color: white;
        }

        .btn-attendance:hover {
            opacity: 0.9;
        }

        .status-cell {
            font-weight: 500;
        }

        .status-cell.present {
            color: #059669;
        }

        .status-cell.absent {
            color: #DC2626;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6B7280;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #9CA3AF;
        }

        .empty-state p {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .empty-state .subtitle {
            font-size: 14px;
            color: #6B7280;
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: #6B7280;
        }

        .loading-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #4F46E5;
        }

        .loading-state p {
            font-size: 18px;
            font-weight: 500;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #E5E7EB;
        }

        .list-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .action-btn.present-all {
            background: #059669;
            color: white;
        }

        .action-btn.absent-all {
            background: #DC2626;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
        }
        .attendance-toggle {
            position: relative;
            display: inline-block;
        }

        .attendance-toggle input {
            display: none;
        }

        .attendance-toggle label {
            display: inline-block;
            width: 120px;
            height: 34px;
            border-radius: 17px;
            background: #e9ecef;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .attendance-toggle label:after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 4px;
            left: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .attendance-toggle input:checked + label {
            background: var(--secondary);
        }

        .attendance-toggle input:checked + label:after {
            left: calc(100% - 30px);
        }

        .attendance-toggle label span {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
        }

        .attendance-toggle label .present {
            right: 10px;
            color: #495057;
        }

        .attendance-toggle label .absent {
            left: 10px;
            color: #495057;
        }

        .attendance-toggle input:checked + label .present {
            color: white;
        }

        .attendance-toggle input:checked + label .absent {
            color: transparent;
        }

        /* Table Styles */
        .attendance-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .attendance-table th {
            background: var(--darker);
            color: white;
            font-weight: 500;
        }

        .attendance-table tr:last-child td {
            border-bottom: none;
        }

        .attendance-table tr:hover {
            background: var(--lighter);
        }

        .empty-state {
            padding: 2rem;
            text-align: center;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-lighter);
            margin-bottom: 1rem;
        }

        .empty-state p {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .empty-state .subtitle {
            font-size: 0.9rem;
            color: var(--text-lighter);
        }

        /* Loading State */
        .loading-state {
            padding: 2rem;
            text-align: center;
            color: var(--text-light);
        }

        .loading-state i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .loading-state p {
            font-size: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }
        /* Add these new styles for attendance buttons */
        .attendance-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-attendance {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            background: #f3f4f6;
            color: #6b7280;
            min-width: 100px;
            justify-content: center;
        }

        .btn-attendance.present {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .btn-attendance.present.active {
            background: #059669;
            color: white;
        }

        .btn-attendance.absent {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .btn-attendance.absent.active {
            background: #dc2626;
            color: white;
        }

        .btn-attendance:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-attendance i {
            font-size: 16px;
        }

        /* Quick action buttons */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .action-btn.present-all {
            background: #059669;
            color: white;
        }

        .action-btn.absent-all {
            background: #dc2626;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Student row hover effect */
        tr:hover .btn-attendance {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Report styles */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .date-range {
            display: flex;
            gap: 10px;
        }

        .report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
        }

        .report-table th,
        .report-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .report-table th {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .report-table tr:hover {
            background: var(--primary-light);
        }

        .percentage-bar {
            position: relative;
            width: 100%;
            height: 20px;
            background: #f3f4f6;
            border-radius: 10px;
            overflow: hidden;
        }

        .percentage-bar .bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .percentage-bar span {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dark);
            font-weight: 500;
            font-size: 12px;
            text-shadow: 0 0 2px white;
        }

        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading-state i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Add these new styles for settings page */
        .settings-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-header i {
            font-size: 2rem;
            color: var(--primary);
            background: var(--primary-light);
            padding: 1rem;
            border-radius: 50%;
        }

        .settings-header h2 {
            color: var(--text-dark);
            font-size: 1.5rem;
            margin: 0;
        }

        .settings-section {
            background: var(--lighter);
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .settings-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .settings-section h3 {
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section h3 i {
            background: var(--primary-light);
            color: var(--primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .password-form {
            max-width: 400px;
        }

        .password-form .form-group {
            margin-bottom: 1.5rem;
        }

        .password-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .password-form input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .password-form input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
            outline: none;
        }

        .password-requirements {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
        }

        .password-requirements .title {
            color: var(--text-dark);
            font-weight: 500;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .password-requirements .title i {
            color: var(--primary);
        }

        .password-requirements ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .password-requirements li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            color: var(--text-light);
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.3s ease;
        }

        .password-requirements li.valid {
            color: var(--secondary);
            background: rgba(16, 185, 129, 0.1);
        }

        .password-requirements li i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .submit-btn {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
        }

        .submit-btn i {
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .settings-container {
                padding: 1rem;
            }

            .settings-section {
                padding: 1.5rem;
            }

            .password-form {
                max-width: 100%;
            }
        }
        
        /* Attendance Success Modal Styles */
        .attendance-success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .attendance-success-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .attendance-success-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .attendance-success-modal .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .attendance-success-modal.show .modal-content {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .attendance-success-modal .modal-header {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            position: relative;
            text-align: center;
        }
        
        .attendance-success-modal .success-icon {
            font-size: 48px;
            margin-bottom: 12px;
            animation: successPulse 2s infinite;
        }
        
        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .attendance-success-modal .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .attendance-success-modal .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .attendance-success-modal .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .attendance-success-modal .modal-body {
            padding: 24px;
        }
        
        .attendance-success-modal .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .attendance-success-modal .detail-item {
            background: #F8FAFC;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #10B981;
        }
        
        .attendance-success-modal .detail-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #64748B;
            margin-bottom: 8px;
        }
        
        .attendance-success-modal .detail-label i {
            color: #10B981;
        }
        
        .attendance-success-modal .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: #1E293B;
        }
        
        .attendance-success-modal .attendance-summary {
            background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #E2E8F0;
        }
        
        .attendance-success-modal .attendance-summary h3 {
            margin: 0 0 16px 0;
            color: #1E293B;
            font-size: 18px;
            text-align: center;
        }
        
        .attendance-success-modal .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .attendance-success-modal .summary-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }
        
        .attendance-success-modal .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        .attendance-success-modal .summary-item.present {
            border-top: 4px solid #10B981;
        }
        
        .attendance-success-modal .summary-item.absent {
            border-top: 4px solid #EF4444;
        }
        
        .attendance-success-modal .summary-item.total {
            border-top: 4px solid #3B82F6;
        }
        
        .attendance-success-modal .summary-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .attendance-success-modal .summary-item.present .summary-icon {
            color: #10B981;
        }
        
        .attendance-success-modal .summary-item.absent .summary-icon {
            color: #EF4444;
        }
        
        .attendance-success-modal .summary-item.total .summary-icon {
            color: #3B82F6;
        }
        
        .attendance-success-modal .summary-count {
            font-size: 28px;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 4px;
        }
        
        .attendance-success-modal .summary-label {
            font-size: 14px;
            color: #64748B;
            font-weight: 500;
        }
        
        .attendance-success-modal .percentage-bar {
            background: #E2E8F0;
            height: 32px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .attendance-success-modal .percentage-fill {
            background: linear-gradient(90deg, #10B981 0%, #059669 100%);
            height: 100%;
            border-radius: 16px;
            transition: width 1s ease;
            position: relative;
        }
        
        .attendance-success-modal .percentage-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            font-size: 14px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .attendance-success-modal .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #E2E8F0;
            text-align: center;
        }
        
        .attendance-success-modal .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .attendance-success-modal .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .attendance-success-modal .modal-content {
                width: 95%;
                margin: 20px;
            }
            
            .attendance-success-modal .details-grid {
                grid-template-columns: 1fr;
            }
            
            .attendance-success-modal .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .attendance-success-modal .modal-header {
                padding: 20px;
            }
            
            .attendance-success-modal .modal-body {
                padding: 20px;
            }
        }
        
        /* Delete Button Styles for Reports */
        .delete-btn {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            min-width: 80px;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, #DC2626, #B91C1C);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .delete-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
        }
        
        .delete-btn:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .delete-btn i {
            font-size: 13px;
        }
        
        /* Report Table Styles */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .report-table th {
            background: linear-gradient(135deg, #4F46E5, #4338CA);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .report-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #E5E7EB;
            vertical-align: middle;
        }
        
        .report-table tr:hover {
            background: #F9FAFB;
        }
        
        .report-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Status Badge Styles */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-badge.good {
            background: #D1FAE5;
            color: #065F46;
        }
        
        .status-badge.low {
            background: #FEE2E2;
            color: #991B1B;
        }
        
        /* Percentage Bar Styles */
        .percentage-bar {
            position: relative;
            background: #E5E7EB;
            border-radius: 10px;
            height: 20px;
            min-width: 100px;
            overflow: hidden;
        }
        
        .percentage-bar .bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .percentage-bar.good .bar {
            background: linear-gradient(90deg, #10B981, #059669);
        }
        
        .percentage-bar.low .bar {
            background: linear-gradient(90deg, #EF4444, #DC2626);
        }
        
        .percentage-bar span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Attendance Count Styles */
        .attendance-count {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .attendance-count.present {
            color: #047857;
        }
        
        .attendance-count.absent {
            color: #DC2626;
        }
        
        .attendance-count i {
            font-size: 12px;
        }
        
        /* Empty State Styles */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6B7280;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #9CA3AF;
        }
        
        .empty-state p {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .empty-state .subtitle {
            font-size: 14px;
            color: #9CA3AF;
        }

        /* 📊 Reports Section Enhanced Styling */
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .summary-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .summary-card:nth-child(1) .summary-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .summary-card:nth-child(2) .summary-icon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .summary-card:nth-child(3) .summary-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .summary-info {
            flex: 1;
        }

        .summary-count {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            line-height: 1;
            margin-bottom: 4px;
        }

        .summary-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .report-table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .report-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }

        .report-table thead::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
        }

        .report-table th {
            padding: 20px 16px;
            text-align: left;
            font-weight: 700;
            color: white;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
            position: relative;
        }

        .report-table th:first-child {
            padding-left: 24px;
        }

        .report-table th:last-child {
            padding-right: 24px;
        }

        .report-table td {
            padding: 18px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .report-table td:first-child {
            padding-left: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .report-table td:last-child {
            padding-right: 24px;
        }

        .report-table tbody tr {
            transition: all 0.3s ease;
            position: relative;
        }

        .report-table tbody tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: scale(1.01);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .report-table tbody tr:hover td {
            color: #0f172a;
        }

        .report-table tbody tr:last-child td {
            border-bottom: none;
        }

        .report-table tbody tr:nth-child(even) {
            background-color: rgba(248, 250, 252, 0.5);
        }

        .lecture-type {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .lecture-type:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .lecture-type.theory {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .lecture-type.theory::before {
            content: '📚';
            font-size: 10px;
        }

        .lecture-type.practical {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border: 1px solid #86efac;
        }

        .lecture-type.practical::before {
            content: '🔬';
            font-size: 10px;
        }

        .text-success {
            color: #059669 !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(5, 150, 105, 0.2);
        }

        .text-danger {
            color: #dc2626 !important;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(220, 38, 38, 0.2);
        }

        /* Enhanced Subject Name Styling */
        .report-table td:nth-child(2) strong {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 15px;
            font-weight: 800;
        }

        /* Enhanced Date Styling */
        .report-table td:first-child {
            font-family: 'Monaco', 'Menlo', monospace;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 8px;
            margin: 4px;
            display: inline-block;
            padding: 8px 12px !important;
            font-weight: 600;
            color: #475569;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .percentage {
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-width: 60px;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .percentage:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .percentage.high {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .percentage.high::before {
            content: '✅';
            font-size: 11px;
        }

        .percentage.medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .percentage.medium::before {
            content: '⚠️';
            font-size: 11px;
        }

        .percentage.low {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .percentage.low::before {
            content: '❌';
            font-size: 11px;
        }

        .delete-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }

        .delete-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .delete-btn i {
            font-size: 12px;
            animation: deleteIcon 2s ease-in-out infinite;
        }

        @keyframes deleteIcon {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* Table Header Glow Effect */
        .report-table thead {
            position: relative;
            overflow: hidden;
        }

        .report-table thead::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Enhanced Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #10b981;
            animation: spin 2s linear infinite;
        }

        .loading-state p {
            font-size: 18px;
            margin: 0;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced Error State */
        .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #dc2626;
        }

        .error-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #fca5a5;
        }

        .error-state p {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }

        .error-state .subtitle {
            font-size: 16px;
            color: #991b1b;
        }

        /* Enhanced Table Animation */
        .report-table tbody tr {
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }

        .report-table tbody tr:nth-child(1) { animation-delay: 0.1s; }
        .report-table tbody tr:nth-child(2) { animation-delay: 0.2s; }
        .report-table tbody tr:nth-child(3) { animation-delay: 0.3s; }
        .report-table tbody tr:nth-child(4) { animation-delay: 0.4s; }
        .report-table tbody tr:nth-child(5) { animation-delay: 0.5s; }
        .report-table tbody tr:nth-child(n+6) { animation-delay: 0.6s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design for Reports */
        @media (max-width: 768px) {
            .report-summary {
                grid-template-columns: 1fr;
            }

            .summary-card {
                padding: 16px;
            }

            .summary-count {
                font-size: 24px;
            }

            .report-table-container {
                overflow-x: auto;
                border-radius: 12px;
            }

            .report-table {
                min-width: 800px;
            }

            .report-table th,
            .report-table td {
                padding: 12px 8px;
                font-size: 13px;
            }

            .report-table th {
                padding: 16px 8px;
            }

            .lecture-type {
                padding: 6px 12px;
                font-size: 10px;
            }

            .percentage {
                padding: 6px 8px;
                font-size: 11px;
                min-width: 50px;
            }

            .delete-btn {
                padding: 8px 12px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
                </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-chalkboard-teacher logo-icon"></i>
            <span class="logo-text">Teacher Panel</span>
            </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#dashboard" class="nav-link active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#take-attendance" class="nav-link" data-page="take-attendance">
                    <i class="fas fa-clipboard-check"></i>
                    <span class="nav-text">Fill Attendance</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#view-reports" class="nav-link" data-page="view-reports">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-text">View Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#settings" class="nav-link" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span class="nav-text">Settings</span>
                </a>
            </li>
        </ul>
        <button class="logout-button" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div id="mainHeader" class="header">
            <h1 class="page-title">Welcome, <span id="teacherName">Teacher</span>
                <span id="roleBadge"></span>
            </h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download"></i>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon stat-classes">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-value" id="assignedClasses">0</div>
                <div class="stat-label">Assigned Classes</div>
                </div>
            <div class="stat-card">
                <div class="stat-icon stat-students">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-attendance">
                    <i class="fas fa-clipboard-check"></i>
        </div>
                <div class="stat-value" id="todayAttendance">0%</div>
                <div class="stat-label">Today's Attendance</div>
    </div>
            <div class="stat-card">
                <div class="stat-icon stat-performance">
                    <i class="fas fa-chart-line"></i>
    </div>
                <div class="stat-value" id="avgAttendance">0%</div>
                <div class="stat-label">Average Attendance</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-card" onclick="handleNavigation('take-attendance.html')">
                <i class="fas fa-clipboard-check action-icon"></i>
                <div class="action-title">Fill Attendance</div>
    </div>
            <div class="action-card" onclick="handleNavigation('view-reports.html')">
                <i class="fas fa-chart-bar action-icon"></i>
                <div class="action-title">View Reports</div>
    </div>
        </div>
    </main>

    <script>
        // Global teacher data
        let teacherData = null;
        
        console.log('Firebase services ready');
        
        // 📧 EmailJS Configuration
        // 🔧 REPLACE THESE VALUES WITH YOUR ACTUAL EmailJS CREDENTIALS:
        const EMAILJS_CONFIG = {
            publicKey: 'D3hARPpt5fnuBw1kN',     // ✅ Your Public Key
            serviceId: 'service_1qq5e1e',       // ✅ Your Gmail Service ID  
            templateId: 'template_dyjlgvx'      // ✅ Your Template ID
        };
        
        // ✅ TEMPLATE CREATED SUCCESSFULLY!
        // 📋 Next Steps:
        // 1. Copy your Template ID from EmailJS dashboard
        // 2. Copy your Service ID (Gmail service)
        // 3. Copy your Public Key from Account settings
        // 4. Replace the values above
        // 5. Test the email functionality
        
        // 📋 SETUP INSTRUCTIONS:
        // 1. Go to https://dashboard.emailjs.com/
        // 2. Create Gmail service → Copy Service ID
        // 3. Create email template → Copy Template ID  
        // 4. Go to Account → Copy Public Key
        // 5. Replace the values above with your actual IDs
        
        // Initialize EmailJS
        function initializeEmailJS() {
            try {
                if (typeof emailjs !== 'undefined') {
                    emailjs.init(EMAILJS_CONFIG.publicKey);
                    console.log('📧 EmailJS initialized successfully');
                } else {
                    console.warn('⚠️ EmailJS library not loaded');
                }
            } catch (error) {
                console.error('❌ EmailJS initialization failed:', error);
            }
        }
        
        // 📧 Send Attendance Email Notification with Smart Limits
        async function sendAttendanceEmail(attendanceData) {
            try {
                console.log('📧 Preparing to send attendance email:', attendanceData);
                
                // Check if EmailJS is available
                if (typeof emailjs === 'undefined') {
                    console.warn('⚠️ EmailJS not available, skipping email notification');
                    return { success: false, message: 'EmailJS not available' };
                }
                
                // 📊 Check daily email limit (EmailJS Free: 50/day)
                const today = new Date().toDateString();
                const dailyCount = parseInt(localStorage.getItem(`emailCount_${today}`)) || 0;
                const DAILY_LIMIT = 45; // Safety margin (EmailJS limit is 50)
                
                if (dailyCount >= DAILY_LIMIT) {
                    console.warn(`⚠️ Daily email limit reached (${dailyCount}/${DAILY_LIMIT})`);
                    return { success: false, message: 'Daily email limit reached' };
                }
                
                // 🎯 Smart Email Sending Logic
                const attendancePercentage = Math.round((attendanceData.presentCount / attendanceData.totalStudents) * 100);
                const currentHour = new Date().getHours();
                const isFirstClass = currentHour < 12; // Morning classes
                const isPractical = attendanceData.lectureType?.toLowerCase() === 'practical';
                const isLowAttendance = attendancePercentage < 75;
                
                // Send email for all attendance submissions
                const shouldSendEmail = true; // Always send email
                
                console.log('📧 Email will be sent for all attendance submissions:', {
                    percentage: attendancePercentage,
                    isFirstClass,
                    isPractical,
                    isLowAttendance
                });
                
                console.log('📧 Email approved for sending:', {
                    percentage: attendancePercentage,
                    isFirstClass,
                    isPractical,
                    isLowAttendance,
                    dailyCount: dailyCount + 1
                });
                
                // Prepare email template parameters
                const templateParams = {
                    teacher_name: attendanceData.teacher_name,
                    teacher_email: attendanceData.teacher_email,
                    subject: attendanceData.subject,
                    class_name: attendanceData.class_name,
                    date: new Date(attendanceData.date).toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }),
                    present_count: attendanceData.present_count,
                    absent_count: attendanceData.absent_count,
                    total_students: attendanceData.total_students,
                    attendance_percentage: attendanceData.attendance_percentage,
                    lecture_type: attendanceData.lecture_type,
                    submission_time: new Date().toLocaleString('en-IN'),
                    batch: attendanceData.batch || 'N/A'
                };
                
                console.log('📧 Email template parameters:', templateParams);
                
                // Send email using EmailJS
                const response = await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams
                );
                
                console.log('✅ Email sent successfully:', response);
                
                // 📊 Update daily email count
                const newCount = dailyCount + 1;
                localStorage.setItem(`emailCount_${today}`, newCount.toString());
                console.log(`📊 Daily email count updated: ${newCount}/${DAILY_LIMIT}`);
                
                return { success: true, response: response, dailyCount: newCount };
                
            } catch (error) {
                console.error('❌ Failed to send email:', error);
                return { success: false, error: error.message };
            }
        }

        // Check if user is already logged in
        window.onload = async function() {
            console.log('Teacher panel loading...');
            
            try {
                // Wait for Firebase initialization
                await initializeFirebase();
                
                // Wait for Firebase auth state with timeout
                await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe();
                        resolve(user);
                    });
                    
                    // Timeout after 5 seconds
                    setTimeout(() => {
                        console.log('⏰ Auth state timeout, proceeding...');
                        resolve(null);
                    }, 5000);
                });
                
                // Check both Firebase auth and session storage
                const currentUser = firebase.auth().currentUser;
                const isTeacherLoggedIn = sessionStorage.getItem('isTeacherLoggedIn');
                const teacherKey = sessionStorage.getItem('teacherKey');
                const teacherData = sessionStorage.getItem('teacherData');
                
                console.log('Auth state:', { currentUser, isTeacherLoggedIn, teacherKey });
                
                // If not properly authenticated, sign out and redirect
                if (!currentUser || !isTeacherLoggedIn || !teacherKey) {
                    console.log('Invalid authentication, redirecting to login');
                    await firebase.auth().signOut();
                    sessionStorage.clear();
                    window.location.href = 'teacher-login.html';
                    return;
                }
                
                // If teacher data missing, fetch from Firebase
                if (!teacherData) {
                    console.log('🔄 Teacher data missing, fetching from Firebase...');
                    try {
                        const teacherRef = firebase.database().ref('teachers').child(teacherKey);
                        const snapshot = await teacherRef.once('value');
                        const fetchedTeacherData = snapshot.val();
                        
                        if (fetchedTeacherData) {
                            sessionStorage.setItem('teacherData', JSON.stringify(fetchedTeacherData));
                            console.log('✅ Teacher data fetched and stored');
                        } else {
                            console.log('❌ Teacher data not found in Firebase');
                            window.location.href = 'teacher-login.html';
                            return;
                        }
                    } catch (error) {
                        console.error('❌ Error fetching teacher data:', error);
                        window.location.href = 'teacher-login.html';
                        return;
                    }
                }
                
                // Teacher verified through both auth and session storage, load panel
                console.log('Teacher verified, loading panel');
                const finalTeacherData = sessionStorage.getItem('teacherData');
                window.teacherData = JSON.parse(finalTeacherData);
                
                // Initialize EmailJS
                initializeEmailJS();
                
                // Load dashboard content
                console.log('🏠 Loading dashboard...');
                loadDashboardContent();
            } catch (error) {
                console.error('Error during authentication check:', error);
                await firebase.auth().signOut();
                sessionStorage.clear();
                window.location.href = 'teacher-login.html';
                return;
            }
        };
        
        // Lab Assistant UI highlight logic
        function applyLabAssistantUI() {
            if (window.teacherData && window.teacherData.role === 'Lab Assistant') {
                const header = document.getElementById('mainHeader');
                if (header) header.classList.add('lab-assistant-header');
                const badge = document.getElementById('roleBadge');
                if (badge) {
                    badge.innerHTML = '<span class="lab-assistant-badge"><i class="fas fa-flask"></i> Lab Assistant</span>';
                }
                const nameSpan = document.getElementById('teacherName');
                if (nameSpan) nameSpan.style.color = '#D97706';
            }
        }
        window.applyLabAssistantUI = applyLabAssistantUI;
    
    // Handle hash change function
    function handleHashChange() {
        // Hash change logic if needed
        console.log('Hash changed:', window.location.hash);
    }
    handleHashChange();

        // Load teacher dashboard initial data
        function loadTeacherDashboard(data) {
            teacherData = data;
            loadDashboardContent();
        }

        // Handle hash-based navigation
        window.addEventListener('hashchange', handleHashChange);

        function handleHashChange() {
            // Preserve current page on refresh, default to dashboard only if no hash
            const hash = window.location.hash.slice(1) || 'dashboard';
            updateActiveTab(hash);
            loadContent(hash);
        }

        function updateActiveTab(hash) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === hash) {
                    link.classList.add('active');
                }
            });
        }

        function loadContent(hash) {
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;
            
            // Show loading state
            mainContent.innerHTML = '<div class="loading">Loading...</div>';

            switch(hash) {
                case 'dashboard':
                    loadDashboardContent();
                    break;
                case 'take-attendance':
                    loadAttendanceContent();
                    break;
                case 'view-reports':
                    loadReportsContent();
                    break;
                case 'settings':
                    loadSettingsContent();
                    break;
                default:
                    loadDashboardContent();
            }
        }

        // Content loading functions
        function loadDashboardContent() {
            if (!window.teacherData) {
                console.log('Teacher data not available');
                return;
            }
            const teacherData = window.teacherData;
            
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Welcome, ${teacherData.firstName} ${teacherData.lastName}</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-classes">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-value">${teacherData.classes ? teacherData.classes.length : 0}</div>
                        <div class="stat-label">Assigned Classes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-students">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="totalStudents">Loading...</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-attendance">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-value" id="todayAttendance">Loading...</div>
                        <div class="stat-label">Today's Attendance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-performance">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="avgAttendance">Loading...</div>
                        <div class="stat-label">Average Attendance</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <div class="action-card" onclick="window.location.hash='take-attendance'">
                        <i class="fas fa-clipboard-check action-icon"></i>
                        <div class="action-title">Fill Attendance</div>
                    </div>
                    <div class="action-card" onclick="window.location.hash='view-reports'">
                        <i class="fas fa-chart-bar action-icon"></i>
                        <div class="action-title">View Reports</div>
                    </div>
                </div>
            `;

            // Load total students count based on teacher's assigned classes and departments
            loadTotalStudentsCount();
        }

        // Missing function definitions - Add these functions to fix JavaScript errors
        window.loadStudentsWithCache = async function() {
            console.log('📚 Loading students with cache...');
            try {
                const snapshot = await firebase.database().ref('students').once('value');
                return snapshot.val() || {};
            } catch (error) {
                console.error('Error loading students:', error);
                return {};
            }
        };

        window.loadAttendanceOptimized = async function() {
            console.log('📊 Loading attendance optimized...');
            try {
                const snapshot = await firebase.database().ref('attendance').once('value');
                return snapshot.val() || {};
            } catch (error) {
                console.error('Error loading attendance:', error);
                return {};
            }
        };

        window.saveAttendanceWithOfflineSupport = async function(data) {
            console.log('💾 Saving attendance with offline support...');
            try {
                await firebase.database().ref('attendance').push(data);
                return { success: true };
            } catch (error) {
                console.error('Error saving attendance:', error);
                return { success: false, error: error.message };
            }
        };

        // Function to load total students count for teacher's assigned classes
        async function loadTotalStudentsCount() {
            const totalStudentsElement = document.getElementById('totalStudents');
            if (!totalStudentsElement || !window.teacherData) return;

            try {
                const snapshot = await firebase.database().ref('students').once('value');
                let totalStudents = 0;
                const students = snapshot.val() || {};

                // Get teacher's assigned data
                const teacherClasses = window.teacherData.classes || [];
                const teacherDepartments = window.teacherData.departments || [];
                const teacherDivisions = window.teacherData.divisions || [];
                
                console.log('=== TEACHER DATA DEBUG ===');
                console.log('Teacher Classes:', teacherClasses);
                console.log('Teacher Departments:', teacherDepartments);
                console.log('Teacher Divisions:', teacherDivisions);
                console.log('Total students in database:', Object.keys(students).length);
                console.log('=========================');

                Object.values(students).forEach(student => {
                    // Get student details - use 'branch' field for department
                    const studentYear = (student.year || '').toString().toUpperCase();
                    const studentBranch = (student.branch || '').toString().toUpperCase();
                    const studentDiv = (student.division || '').toString().toUpperCase();
                    
                    // Convert year to standard format
                    let yearCode = '';
                    if (['FIRST', 'FIRST YEAR', '1', 'FY'].includes(studentYear)) yearCode = 'FY';
                    else if (['SECOND', 'SECOND YEAR', '2', 'SY'].includes(studentYear)) yearCode = 'SY';
                    else if (['THIRD', 'THIRD YEAR', '3', 'TY'].includes(studentYear)) yearCode = 'TY';
                    else if (['FOURTH', 'FOURTH YEAR', '4', 'BE'].includes(studentYear)) yearCode = 'BE';
                    else yearCode = studentYear;

                    // Convert branch/department to standard codes
                    let deptCode = '';
                    if (['COMPUTER TECHNOLOGY', 'COMPUTER', 'CT'].includes(studentBranch)) deptCode = 'CT';
                    else if (['INFORMATION TECHNOLOGY', 'IT'].includes(studentBranch)) deptCode = 'IT';
                    else if (['MECHANICAL ENGINEERING', 'MECHANICAL', 'ME'].includes(studentBranch)) deptCode = 'ME';
                    else if (['CIVIL ENGINEERING', 'CIVIL', 'CE'].includes(studentBranch)) deptCode = 'CE';
                    else if (['ELECTRICAL ENGINEERING', 'ELECTRICAL', 'EE'].includes(studentBranch)) deptCode = 'EE';
                    else if (['ELECTRONICS & TELECOMMUNICATION', 'ELECTRONICS', 'ET', 'E&TC'].includes(studentBranch)) deptCode = 'ET';
                    else if (['ARTIFICIAL INTELLIGENCE', 'AI'].includes(studentBranch)) deptCode = 'AI';
                    else deptCode = studentBranch;

                    // Check if student matches teacher's assigned classes
                    const matchesClass = teacherClasses.length === 0 || teacherClasses.includes(yearCode);
                    
                    // Check if student matches teacher's assigned departments
                    const matchesDepartment = teacherDepartments.length === 0 || 
                        teacherDepartments.some(dept => {
                            const teacherDeptCode = typeof dept === 'object' ? dept.code : dept;
                            return teacherDeptCode === deptCode;
                        });
                    
                    // Check if student matches teacher's assigned divisions (if teacher has divisions)
                    const matchesDivision = teacherDivisions.length === 0 || 
                        teacherDivisions.includes(studentDiv) ||
                        studentDiv === '' || studentDiv === null;

                    // Count student if all criteria match
                    if (matchesClass && matchesDepartment && matchesDivision) {
                        totalStudents++;
                        console.log('Matched student:', {
                            name: student.name,
                            rollNo: student.rollNo,
                            year: yearCode,
                            branch: studentBranch,
                            dept: deptCode,
                            div: studentDiv,
                            teacherClasses: teacherClasses,
                            teacherDepts: teacherDepartments
                        });
                    }
                });

                console.log('Total students for teacher:', totalStudents);
                
                // Fallback: If no students matched, show total students in database
                if (totalStudents === 0 && Object.keys(students).length > 0) {
                    console.log('No students matched criteria, showing total database count as fallback');
                    totalStudents = Object.keys(students).length;
                }
                
                totalStudentsElement.textContent = totalStudents;
            } catch (error) {
                console.error('Error loading total students:', error);
                totalStudentsElement.textContent = 'Error';
            }

            // Load today's attendance for teacher's classes
            loadTodayAttendance();

            // Load average attendance for teacher's classes
            loadAverageAttendance();
        }

        // Function to load today's attendance for teacher's assigned classes
        async function loadTodayAttendance() {
            const todayAttendanceElement = document.getElementById('todayAttendance');
            if (!todayAttendanceElement || !window.teacherData) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    todayAttendanceElement.textContent = 'Login required';
                    return;
                }

                const snapshot = await firebase.database().ref('attendance').once('value');
                let totalPresent = 0;
                let totalStudents = 0;

                const attendanceData = snapshot.val() || {};
                Object.values(attendanceData).forEach(record => {
                    // Check if record is for today and by current teacher
                    if (record.date === today && record.teacherId === currentUser.uid) {
                        const students = record.students || {};
                        totalStudents += Object.keys(students).length;
                        totalPresent += Object.values(students).filter(status => status === true || status === 'present').length;
                    }
                });

                const todayPercentage = totalStudents > 0 
                    ? Math.round((totalPresent / totalStudents) * 100) 
                    : 0;
                todayAttendanceElement.textContent = todayPercentage + '%';
                console.log('Today attendance loaded:', { totalPresent, totalStudents, percentage: todayPercentage });
            } catch (error) {
                console.error('Error loading today\'s attendance:', error);
                todayAttendanceElement.textContent = 'Error';
            }
        }

        // Function to load average attendance for teacher's assigned classes
        async function loadAverageAttendance() {
            const avgAttendanceElement = document.getElementById('avgAttendance');
            if (!avgAttendanceElement || !window.teacherData) return;

            try {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    avgAttendanceElement.textContent = 'Login required';
                    return;
                }

                const snapshot = await firebase.database().ref('attendance').once('value');
                let totalPresent = 0;
                let totalStudents = 0;
                let recordCount = 0;

                const attendanceData = snapshot.val() || {};
                Object.values(attendanceData).forEach(record => {
                    // Check if record is by current teacher
                    if (record.teacherId === currentUser.uid) {
                        const students = record.students || {};
                        totalStudents += Object.keys(students).length;
                        totalPresent += Object.values(students).filter(status => status === true || status === 'present').length;
                        recordCount++;
                    }
                });

                const avgPercentage = totalStudents > 0 
                    ? Math.round((totalPresent / totalStudents) * 100) 
                    : 0;
                avgAttendanceElement.textContent = avgPercentage + '%';
                console.log('Average attendance loaded:', { totalPresent, totalStudents, recordCount, percentage: avgPercentage });
            } catch (error) {
                console.error('Error loading average attendance:', error);
                avgAttendanceElement.textContent = 'Error';
            }
        }

        // Function to load attendance content
        function loadAttendanceContent() {
            console.log('📝 Loading attendance content...');
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;
            
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Take Attendance</h1>
                </div>
                <div class="attendance-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="department">Department:</label>
                            <select id="department" onchange="populateYearDropdown()">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="year">Year:</label>
                            <select id="year" onchange="populateDivisionDropdown()">
                                <option value="">Select Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="division">Division:</label>
                            <select id="division">
                                <option value="">Select Division</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="subject">Subject:</label>
                            <input type="text" id="subject" placeholder="Enter subject name">
                        </div>
                        <div class="form-group">
                            <label for="date">Date:</label>
                            <input type="date" id="date">
                        </div>
                        <div class="form-group">
                            <label for="lectureType">Lecture Type:</label>
                            <select id="lectureType" onchange="handleLectureTypeChange()">
                                <option value="">Select Type</option>
                                <option value="theory">Theory</option>
                                <option value="practical">Practical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="batchRow" style="display: none;">
                        <div class="form-group">
                            <label for="batch">Batch:</label>
                            <select id="batch">
                                <option value="">Select Batch</option>
                                <!-- Batch options will be populated dynamically by handleLectureTypeChange() -->
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="loadStudents()" class="btn btn-primary">Load Students</button>
                    </div>
                </div>
                <div id="studentsContainer" style="display: none;">
                    <div class="students-header">
                        <h3>Mark Attendance</h3>
                        <div class="bulk-actions">
                            <button type="button" onclick="markAllPresent()" class="btn btn-success">Mark All Present</button>
                            <button type="button" onclick="markAllAbsent()" class="btn btn-danger">Mark All Absent</button>
                        </div>
                    </div>
                    <div class="students-table-container">
                        <table class="students-table" id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Student Name</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Students will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="submitAttendance()" class="btn btn-primary">Save Attendance</button>
                    </div>
                </div>
            `;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Populate dropdowns with teacher's assigned data
            populateDepartmentDropdown();
            
            console.log('✅ Attendance content loaded successfully');
        }

        // Removed duplicate submitAttendance function - using the complete one at line 5876

        // Function to load today's attendance for teacher's assigned classes
        async function loadTodayAttendance() {
            const todayAttendanceElement = document.getElementById('todayAttendance');
            if (!todayAttendanceElement || !window.teacherData) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const teacherKey = sessionStorage.getItem('teacherKey');
                
                if (!teacherKey) {
                    todayAttendanceElement.textContent = '0%';
                    return;
                }
                
                const snapshot = await firebase.database().ref('attendance').once('value');
                let totalPresent = 0;
                let totalStudents = 0;
                
                const attendanceData = snapshot.val() || {};
                Object.values(attendanceData).forEach(record => {
                    if (record.date === today && record.teacherId === teacherKey) {
                        const students = record.students || {};
                        totalStudents += Object.keys(students).length;
                        totalPresent += Object.values(students).filter(status => status === true).length;
                    }
                });
                
                const percentage = totalStudents > 0 ? Math.round((totalPresent / totalStudents) * 100) : 0;
                todayAttendanceElement.textContent = percentage + '%';
            } catch (error) {
                console.error('Error loading today\'s attendance:', error);
                todayAttendanceElement.textContent = 'Error';
            }
        }

        // Function to show success message
        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Function to show error message
        function showErrorMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'error-message';
            messageDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Function to populate year dropdown with assigned years
        function populateYearDropdown() {
            const yearSelect = document.getElementById('year');
            if (!yearSelect) return;

            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            if (!teacherData || !teacherData.classes) {
                yearSelect.innerHTML = '<option value="">No classes assigned</option>';
                return;
            }

            yearSelect.innerHTML = '<option value="">-- Select Year --</option>';
            const yearMap = {
                'FY': 'First Year (FY)',
                'SY': 'Second Year (SY)',
                'TY': 'Third Year (TY)',
                'BE': 'Final Year (BE)'
            };

            teacherData.classes.forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${yearMap[year] || year}</option>`;
            });
            
            // Update batch dropdown when year changes
            setTimeout(() => handleLectureTypeChange(), 100);
        }

        // Function to populate department dropdown with assigned departments
        function populateDepartmentDropdown() {
            const departmentSelect = document.getElementById('department');
            if (!departmentSelect) return;

            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            if (!teacherData || !teacherData.departments) {
                departmentSelect.innerHTML = '<option value="">No departments assigned</option>';
                return;
            }

            departmentSelect.innerHTML = '<option value="">-- Select Department --</option>';
            teacherData.departments.forEach(dept => {
                departmentSelect.innerHTML += `<option value="${dept.code}">${dept.name}</option>`;
            });
        }

        // Function to populate division dropdown with assigned divisions
        function populateDivisionDropdown() {
            const divisionSelect = document.getElementById('division');
            if (!divisionSelect) return;

            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            console.log('👨‍🏫 Loading teacher divisions for panel:', teacherData);
            
            // Clear existing options except "All Divisions"
            divisionSelect.innerHTML = '<option value="">All Divisions</option>';
            
            // Get teacher's assigned divisions
            const assignedDivisions = teacherData?.divisions || [];
            
            console.log('📚 Teacher assigned divisions:', assignedDivisions);
            
            // If teacher has assigned divisions, add them to dropdown
            if (assignedDivisions && assignedDivisions.length > 0) {
                assignedDivisions.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division;
                    option.textContent = `Division ${division}`;
                    divisionSelect.appendChild(option);
                    console.log('✅ Added division option to panel:', division);
                });
            } else {
                // If no specific divisions assigned, show all divisions (fallback)
                console.log('⚠️ No specific divisions assigned, showing all divisions');
                const allDivisions = ['A', 'B', 'C'];
                allDivisions.forEach(division => {
                    const option = document.createElement('option');
                    option.value = division;
                    option.textContent = `Division ${division}`;
                    divisionSelect.appendChild(option);
                });
            }
            
            console.log('🎯 Division dropdown populated successfully in panel');
        }

        // Function to handle lecture type change and update batch dropdown
        function handleLectureTypeChange() {
            const lectureType = document.getElementById('lectureType');
            const batchRow = document.getElementById('batchRow');
            const batchSelect = document.getElementById('batch');
            const department = document.getElementById('department');
            const year = document.getElementById('year');
            
            // Check if elements exist before proceeding
            if (!lectureType || !batchRow || !batchSelect || !department || !year) {
                console.log('⚠️ Elements not found, skipping batch dropdown update');
                return;
            }
            
            const lectureTypeValue = lectureType.value;
            const departmentValue = department.value;
            const yearValue = year.value;
            
            if (lectureTypeValue === 'practical') {
                batchRow.style.display = 'block';
                
                // Clear existing options
                batchSelect.innerHTML = '<option value="">Select Batch</option>';
                
                // Special handling for CE TY - only Batch A
                if (departmentValue === 'CE' && yearValue === 'TY') {
                    batchSelect.innerHTML += '<option value="A">Batch A (Roll 3001-3026)</option>';
                    console.log('🎯 CE TY: Only Batch A available in dropdown');
                } else {
                    // Default batches for other departments/years
                    batchSelect.innerHTML += '<option value="A">Batch A</option>';
                    batchSelect.innerHTML += '<option value="B">Batch B</option>';
                    batchSelect.innerHTML += '<option value="C">Batch C</option>';
                }
            } else if (lectureTypeValue === 'theory') {
                batchRow.style.display = 'none';
                batchSelect.value = '';
            }
        }

        // Function to check if department has divisions
        function departmentHasDivisions(department) {
            // Only CT department has divisions
            return department === 'CT';
        }

        // Function to update division visibility
        function updateDivisionVisibility() {
            const departmentSelect = document.getElementById('department');
            const divisionGroup = document.querySelector('.division-group');
            
            if (!departmentSelect || !divisionGroup) return;
            
            const selectedDepartment = departmentSelect.value;
            
            if (departmentHasDivisions(selectedDepartment)) {
                divisionGroup.style.display = 'block';
            } else {
                divisionGroup.style.display = 'none';
                const divisionSelect = document.getElementById('division');
                if (divisionSelect) {
                    divisionSelect.value = '';
                }
            }
        }

        // Function to update batch dropdown based on department and year selection
        function updateBatchDropdown() {
            const departmentSelect = document.getElementById('department');
            const yearSelect = document.getElementById('year');
            const batchSelect = document.getElementById('batch');
            
            if (!departmentSelect || !yearSelect || !batchSelect) {
                return;
            }
            
            const selectedDepartment = departmentSelect.value;
            const selectedYear = yearSelect.value;
            
            console.log('🔄 Updating batch dropdown for:', {
                department: selectedDepartment,
                year: selectedYear
            });
            
            // Clear current options except the first one
            batchSelect.innerHTML = '<option value="">-- Select Batch --</option>';
            
            // Check if ME (Mechanical Engineering) - handle FY first, then other years
            if (selectedDepartment === 'ME') {
                if (selectedYear === 'FY') {
                    console.log('✅ ME FY detected - Showing Batch A, B, and C with proper split ranges');
                    // ME FY: Split students properly - no large ranges in single batch
                    batchSelect.innerHTML += '<option value="BatchA">Batch A (1801-1820)</option>';
                    batchSelect.innerHTML += '<option value="BatchB">Batch B (1821-1840)</option>';
                    batchSelect.innerHTML += '<option value="BatchC">Batch C (1841 onwards)</option>';
                } else if (selectedYear === 'SY') {
                    console.log('🚫 ME SY detected - Only showing Batch A and B (no Batch C)');
                    // ME SY: Batch A (2701-2725), Batch B (2726+)
                    batchSelect.innerHTML += '<option value="BatchA">Batch A (Roll 2701-2725)</option>';
                    batchSelect.innerHTML += '<option value="BatchB">Batch B (Roll 2726 onwards)</option>';
                } else if (selectedYear === 'TY') {
                    console.log('🚫 ME TY detected - Only showing Batch A and B (no Batch C)');
                    // ME TY: Batch A (1-23), Batch B (24-45)
                    batchSelect.innerHTML += '<option value="BatchA">Batch A (1-23 students)</option>';
                    batchSelect.innerHTML += '<option value="BatchB">Batch B (24-45 students)</option>';
                } else {
                    console.log('🚫 ME (other year) - Only showing Batch A and B (no Batch C)');
                    // Other ME years: Standard A & B only
                    batchSelect.innerHTML += '<option value="BatchA">Batch A (20 students)</option>';
                    batchSelect.innerHTML += '<option value="BatchB">Batch B (20 students)</option>';
                }
            } else if (selectedDepartment === 'CE' && selectedYear === 'SY') {
                console.log('🚫 CE SY detected - Only showing Batch A and B (no Batch C)');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (2001-2022, 2027)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (2023-2026, 2028 onwards)</option>';
            } else if (selectedDepartment === 'CE' && selectedYear === 'FY') {
                console.log('🎯 CE FY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1101-1120)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (1121-1140)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (1141 onwards)</option>';
            } else if (department === 'IT' && year === 'FY') {
                console.log('🎯 IT FY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1-20 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (21-40 students)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (41+ students)</option>';
            } else if (department === 'IT' && year === 'SY') {
                console.log('🎯 IT SY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (2601-2624)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (2625-2648)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (2649 onwards)</option>';
            } else if (department === 'IT' && year === 'TY') {
                console.log('🎯 IT TY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1-23 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (24-46 students)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (47-70 students)</option>';
            } else if (selectedDepartment === 'ET' && selectedYear === 'FY') {
                console.log('🎯 ET FY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1-20 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (21-40 students)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (41+ students)</option>';
            } else if (selectedDepartment === 'ET' && selectedYear === 'SY') {
                console.log('🎯 ET SY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1-24 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (25-48 students)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (2549 onwards)</option>';
            } else if (selectedDepartment === 'ET' && selectedYear === 'TY') {
                console.log('🚫 ET TY detected - Only showing Batch A and B (NO Batch C)');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1-20 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (21-37 students)</option>';
            } else if (selectedDepartment === 'EE' && selectedYear === 'TY') {
                console.log('🚫 EE TY detected - Only showing Batch A and B (no Batch C)');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1-23 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (24 onwards)</option>';
            } else if (selectedDepartment === 'AI' && selectedYear === 'FY') {
                console.log('🎯 AI FY detected - Custom batch ranges');
                batchSelect.innerHTML += '<option value="BatchA">Batch A (1001-1022)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (1023-1044)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (1045 onwards)</option>';
            } else {
                console.log('✅ Standard batches - Showing Batch A, B, and C');
                // Show all batches for other departments/years
                batchSelect.innerHTML += '<option value="BatchA">Batch A (20 students)</option>';
                batchSelect.innerHTML += '<option value="BatchB">Batch B (20 students)</option>';
                batchSelect.innerHTML += '<option value="BatchC">Batch C (20 students)</option>';
            }
            
            console.log('✅ Batch dropdown updated successfully');
        }

        // Update loadAttendanceContent function
        function loadAttendanceContent() {
            console.log('Loading attendance content');
            
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) {
                console.error('Main content element not found');
                return;
            }
            
            // Get teacher data from session storage
            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            console.log('Teacher data:', teacherData);
            
            if (!teacherData || !teacherData.departments || teacherData.departments.length === 0) {
                console.log('No departments assigned to teacher');
                mainContent.innerHTML = `
                    <div class="header">
                        <h1 class="page-title">Fill Attendance</h1>
                    </div>
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>No departments assigned</p>
                        <div class="subtitle">You don't have any departments assigned to you yet</div>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering attendance form');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Fill Attendance</h1>
                </div>

                <div class="attendance-container">
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="department">
                                <i class="fas fa-building"></i>
                                Select Department
                            </label>
                            <select id="department" onchange="updateClassOptions(); updateDivisionVisibility(); updateBatchDropdown();">
                                <option value="">-- Select Department --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="year">
                                <i class="fas fa-graduation-cap"></i>
                                Select Year
                            </label>
                            <select id="year" onchange="updateClassOptions(); updateBatchDropdown();">
                                <option value="">-- Select Year --</option>
                            </select>
                        </div>

                        <div class="form-group division-group" style="display: none;">
                            <label for="division">
                                <i class="fas fa-users"></i>
                                Select Division
                            </label>
                            <select id="division">
                                <option value="">All Divisions</option>
                                <option value="A">Division A</option>
                                <option value="B">Division B</option>
                                <option value="C">Division C</option>
                            </select>
                        </div>

                        <div class="form-group batch-group" id="batchGroup" style="display: none;">
                            <label for="batch">
                                <i class="fas fa-layer-group"></i>
                                Select Batch
                            </label>
                            <select id="batch" onchange="loadStudents()">
                                <option value="">-- Select Batch --</option>
                                <option value="BatchA">Batch A (20 students)</option>
                                <option value="BatchB">Batch B (20 students)</option>
                                <option value="BatchC">Batch C (20 students)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="subject">
                                <i class="fas fa-book"></i>
                                Subject
                            </label>
                            <input type="text" id="subject" placeholder="Enter subject name (max 4 chars)" required oninput="limitSubjectWords(this)" onkeydown="preventExtraWords(event, this)" maxlength="4">
                        </div>

                        <div class="form-group">
                            <label for="lectureType">
                                <i class="fas fa-chalkboard-teacher"></i>
                                Lecture Type
                            </label>
                            <select id="lectureType" onchange="toggleBatchVisibility(); loadStudents()">
                                <option value="">-- Select Type --</option>
                                <option value="theory">Theory</option>
                                <option value="practical">Practical</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="date">
                                <i class="fas fa-calendar-alt"></i>
                                Date
                            </label>
                            <input type="date" id="date" onchange="loadStudents()" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>

                    <div class="attendance-list">
                        <div class="list-header">
                            <h2>Students List</h2>
                            <div class="quick-actions">
                                <button onclick="markAllPresent()" class="action-btn present-all">
                                    <i class="fas fa-check-circle"></i> Mark All Present
                                </button>
                                <button onclick="markAllAbsent()" class="action-btn absent-all">
                                    <i class="fas fa-times-circle"></i> Mark All Absent
                                </button>
                            </div>
                        </div>

                        <table class="attendance-table">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Student Name</th>
                                    <th>Attendance</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-body">
                                <tr>
                                    <td colspan="3" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-info-circle"></i>
                                            <p>Please fill all required fields</p>
                                            <div class="subtitle">Department, Year, Subject, Date and Lecture Type are required</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="submit-section">
                            <button id="submitAttendanceBtn" onclick="submitAttendance()" class="submit-btn">
                                <i class="fas fa-save"></i> Submit Attendance
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Populate dropdowns with assigned departments and years
            populateDepartmentDropdown();
            populateYearDropdown();
            populateDivisionDropdown();
            
            // Update division visibility based on selected department
            updateDivisionVisibility();
            if (typeof window.applyLabAssistantUI === 'function') window.applyLabAssistantUI();
        }

        // Add styles for submit button and success message
        const style = document.createElement('style');
        style.textContent = `
            .submit-section {
                margin-top: 20px;
                padding: 20px;
                display: flex;
                justify-content: center;
            }

            .submit-btn {
                padding: 12px 24px;
                background: #10B981;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .submit-btn:hover {
                background: #059669;
            }

            .submit-btn:disabled {
                background: #9CA3AF;
                cursor: not-allowed;
            }

            .success-message {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #059669;
                color: white;
                padding: 16px 24px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                animation: slideIn 0.3s ease-out;
            }

            .success-message i {
                font-size: 20px;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        function loadReportsContent() {
            const mainContent = document.querySelector('.main-content');
            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            
            // Wait for Firebase to be ready
            if (!window.firebase || !firebase.apps.length) {
                console.log('⏳ Waiting for Firebase initialization...');
                setTimeout(loadReportsContent, 500);
                return;
            }
            
            const teacherId = firebase.auth().currentUser?.uid;

            if (!teacherData || !teacherId) {
                mainContent.innerHTML = `
                    <div class="header">
                        <h1 class="page-title">View Reports</h1>
                    </div>
                    <div class="reports-container">
                        <div class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Please login again</p>
                            <div class="subtitle">Your session has expired</div>
                        </div>
                    </div>
                `;
                return;
            }

            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Attendance Reports</h1>
                </div>
                <div class="reports-container">
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="reportDepartment">Department:</label>
                            <select id="reportDepartment" onchange="updateReportDivisionVisibility()">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reportYear">Year:</label>
                            <select id="reportYear" onchange="loadAttendanceReport()">
                                <option value="">All Years</option>
                                <option value="FY">First Year</option>
                                <option value="SY">Second Year</option>
                                <option value="TY">Third Year</option>
                                <option value="BE">Final Year</option>
                            </select>
                        </div>
                        <div class="form-group" id="reportDivisionGroup" style="display: none;">
                            <label for="reportDivision">Division:</label>
                            <select id="reportDivision" onchange="loadAttendanceReport()">
                                <option value="">All Divisions</option>
                                <option value="A">Division A</option>
                                <option value="B">Division B</option>
                                <option value="C">Division C</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate" onchange="loadAttendanceReport()">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate" onchange="loadAttendanceReport()">
                        </div>
                    </div>
                    <div id="reportContent">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading reports...</p>
                        </div>
                    </div>
                </div>
            `;

            // Populate department dropdown with teacher's assigned departments
            const departmentSelect = document.getElementById('reportDepartment');
            if (teacherData.departments && teacherData.departments.length > 0) {
                teacherData.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.code;
                    option.textContent = dept.name || dept.code;
                    departmentSelect.appendChild(option);
                });
            }

            // Set default date range (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Initialize division visibility
            updateReportDivisionVisibility();
            
            // Load initial report
            loadAttendanceReport();
            if (typeof window.applyLabAssistantUI === 'function') window.applyLabAssistantUI();
        }

        async function loadAttendanceReport() {
            const reportContent = document.getElementById('reportContent');
            const department = document.getElementById('reportDepartment').value;
            const year = document.getElementById('reportYear').value;
            const division = document.getElementById('reportDivision').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const teacherId = firebase.auth().currentUser?.uid;

            if (!startDate || !endDate) {
                showErrorMessage('Please select date range');
                return;
            }

            reportContent.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading attendance records...</p>
                </div>
            `;

            try {
                // Get current logged-in teacher info
                const teacherKey = sessionStorage.getItem('teacherKey');
                const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
                
                if (!teacherKey || !teacherData) {
                    throw new Error('Teacher not logged in properly');
                }

                console.log('🔍 Loading reports for teacher:', teacherKey);
                console.log('Teacher Data:', teacherData);

                // Helper function to normalize year format
                function normalizeYear(year) {
                    if (!year) return '';
                    year = year.toString().toUpperCase().trim();
                    if (['1', 'FIRST', 'FIRST YEAR', 'FY'].includes(year)) return 'FY';
                    if (['2', 'SECOND', 'SECOND YEAR', 'SY'].includes(year)) return 'SY';
                    if (['3', 'THIRD', 'THIRD YEAR', 'TY'].includes(year)) return 'TY';
                    if (['4', 'FOURTH', 'FOURTH YEAR', 'BE'].includes(year)) return 'BE';
                    return year;
                }

                // Helper function to normalize department code
                function normalizeDepartment(dept) {
                    if (!dept) return '';
                    dept = dept.toString().toUpperCase().trim();
                    const deptMap = {
                        'IT': ['IT', 'INFORMATION TECHNOLOGY', 'INFO TECH'],
                        'CT': ['CT', 'COMPUTER TECHNOLOGY', 'COMPUTER', 'COMP'],
                        'ME': ['ME', 'MECHANICAL', 'MECH'],
                        'CE': ['CE', 'CIVIL'],
                        'EE': ['EE', 'ELECTRICAL'],
                        'ET': ['ET', 'ELECTRONICS', 'E&TC']
                    };
                    
                    for (const [standard, variations] of Object.entries(deptMap)) {
                        if (variations.includes(dept)) {
                            return standard;
                        }
                    }
                    return dept;
                }

                // Query attendance records
                const snapshot = await firebase.database()
                    .ref('attendance')
                    .orderByChild('date')
                    .startAt(startDate)
                    .endAt(endDate)
                    .once('value');

                const records = [];
                
                snapshot.forEach(record => {
                    const data = record.val();
                    if (!data) return;

                    // 🔒 TEACHER-SPECIFIC FILTER: Only show records created by current teacher
                    if (data.teacherId !== teacherKey) {
                        console.log('⚠️ Skipping record - different teacher:', {
                            recordTeacher: data.teacherId,
                            currentTeacher: teacherKey
                        });
                        return; // Skip this record
                    }

                    console.log('✅ Processing record for current teacher:', data);

                    // Check if this record is for teacher's class
                    const recordClass = data.class || '';
                    let recordDept = '';
                    let recordYear = '';

                    // Handle different class code formats
                    if (recordClass.includes('-')) {
                        // Format: SY-IT-A
                        const parts = recordClass.split('-');
                        recordYear = parts[0];
                        recordDept = parts[1];
                    } else {
                        // Format: SYIT
                        recordYear = recordClass.substring(0, 2);
                        recordDept = recordClass.substring(2);
                    }

                    recordDept = normalizeDepartment(recordDept);
                    recordYear = normalizeYear(recordYear);

                    console.log('Parsed class:', {
                        original: recordClass,
                        year: recordYear,
                        department: recordDept
                    });

                    // Check if teacher teaches this class
                    const teachesClass = teacherData.classes.some(cls => {
                        const teacherYear = normalizeYear(cls);
                        console.log('Comparing years:', {
                            recordYear,
                            teacherYear,
                            matches: recordYear === teacherYear
                        });
                        return recordYear === teacherYear;
                    });

                    // Check if teacher teaches this department
                    const teachesDepartment = teacherData.departments.some(dept => {
                        const teacherDept = normalizeDepartment(dept.code);
                        console.log('Comparing departments:', {
                            recordDept,
                            teacherDept,
                            matches: recordDept === teacherDept
                        });
                        return recordDept === teacherDept;
                    });

                    // Only include records for teacher's classes and departments
                    const matchesDepartmentFilter = !department || normalizeDepartment(department) === recordDept;

                    console.log('Match results:', {
                        teachesClass,
                        teachesDepartment,
                        matchesDepartmentFilter
                    });

                    if (teachesClass && teachesDepartment && matchesDepartmentFilter) {
                        // Calculate attendance percentage
                        const students = data.students || {};
                        const totalStudents = Object.keys(students).length;
                        const presentStudents = Object.values(students)
                            .filter(status => status === true || status === 'present').length;
                        const percentage = totalStudents > 0 
                            ? Math.round((presentStudents / totalStudents) * 100) 
                            : 0;
                        
                        records.push({
                            key: record.key, // Firebase record key for deletion
                            date: data.date,
                            class: data.class,
                            subject: data.subject || '-',
                            lectureType: data.lectureType || '-',
                            totalStudents,
                            presentStudents,
                            percentage
                        });

                        console.log('Added record:', {
                            date: data.date,
                            class: data.class,
                            subject: data.subject,
                            lectureType: data.lectureType,
                            present: presentStudents,
                            total: totalStudents,
                            percentage
                        });
                    }
                });

                // Sort records by date (newest first)
                records.sort((a, b) => new Date(b.date) - new Date(a.date));

                console.log('Total records found:', records.length);

                if (records.length === 0) {
                    reportContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>No attendance records found</p>
                            <div class="subtitle">Try changing the filters or date range</div>
                        </div>
                    `;
                    return;
                }

                // Generate report HTML
                let html = `
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Class</th>
                                <th>Subject</th>
                                <th>Type</th>
                                <th>Present/Total</th>
                                <th>Percentage</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                records.forEach(record => {
                    const percentageClass = record.percentage < 75 ? 'low' : 'good';
                    const statusText = record.percentage < 75 ? 'Below Required' : 'Good';
                    const statusClass = record.percentage < 75 ? 'status-badge low' : 'status-badge good';
                    
                    html += `
                        <tr>
                            <td>${formatDate(record.date)}</td>
                            <td>${record.class}</td>
                            <td>${record.subject}</td>
                            <td style="text-transform: capitalize;">${record.lectureType}</td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <div class="attendance-count present">
                                        <i class="fas fa-check"></i>
                                        Present: ${record.presentStudents}/${record.totalStudents}
                                        <small style="color: #047857">(${Math.round((record.presentStudents/record.totalStudents) * 100)}%)</small>
                                    </div>
                                    <div class="attendance-count absent">
                                        <i class="fas fa-times"></i>
                                        Absent: ${record.totalStudents - record.presentStudents}/${record.totalStudents}
                                        <small style="color: #DC2626">(${Math.round(((record.totalStudents - record.presentStudents)/record.totalStudents) * 100)}%)</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="percentage-bar ${percentageClass}">
                                    <div class="bar" style="width: ${record.percentage}%"></div>
                                    <span>${record.percentage}%</span>
                                </div>
                            </td>
                            <td>
                                <span class="${statusClass}">
                                    <i class="fas ${record.percentage >= 75 ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                                    ${statusText}
                                </span>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteAttendanceRecord('${record.key}', '${record.date}', '${record.subject}', '${record.class}')" title="Delete Attendance Record">
                                    <i class="fas fa-trash-alt"></i>
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                reportContent.innerHTML = html;

            } catch (error) {
                console.error('Error loading attendance report:', error);
                reportContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Error loading report</p>
                        <div class="subtitle">${error.message}</div>
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Function to show success message
        function showSuccessMessage(message) {
            // Create success modal
            const modal = document.createElement('div');
            modal.className = 'success-modal-overlay';
            modal.innerHTML = `
                <div class="success-modal">
                    <div class="success-header">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3>Success!</h3>
                    </div>
                    <div class="success-message">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    <div class="success-footer">
                        <button class="btn btn-primary" onclick="closeSuccessModal(this)">OK</button>
                    </div>
                </div>
            `;
            
            // Add styles if not already added
            if (!document.querySelector('#success-modal-styles')) {
                const styles = document.createElement('style');
                styles.id = 'success-modal-styles';
                styles.textContent = `
                    .success-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        backdrop-filter: blur(5px);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease-out;
                    }
                    
                    .success-modal {
                        background: white;
                        border-radius: 12px;
                        padding: 0;
                        max-width: 400px;
                        width: 90%;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                        animation: slideIn 0.3s ease-out;
                        overflow: hidden;
                    }
                    
                    .success-header {
                        background: linear-gradient(135deg, #10B981, #059669);
                        color: white;
                        padding: 20px;
                        text-align: center;
                    }
                    
                    .success-icon {
                        font-size: 48px;
                        margin-bottom: 10px;
                        animation: pulse 1s ease-in-out infinite;
                    }
                    
                    .success-header h3 {
                        margin: 0;
                        font-size: 24px;
                        font-weight: 600;
                    }
                    
                    .success-message {
                        padding: 20px;
                        text-align: center;
                        line-height: 1.6;
                        color: #374151;
                        white-space: pre-line;
                    }
                    
                    .success-footer {
                        padding: 20px;
                        text-align: center;
                        border-top: 1px solid #E5E7EB;
                    }
                    
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { transform: translateY(-50px) scale(0.9); opacity: 0; }
                        to { transform: translateY(0) scale(1); opacity: 1; }
                    }
                    
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.1); }
                    }
                    
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(modal);
        }
        
        // Function to close success modal
        function closeSuccessModal(button) {
            const modal = button.closest('.success-modal-overlay');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }, 300);
            }
        }
        
        // Function to delete attendance record
        async function deleteAttendanceRecord(recordKey, date, subject, className) {
            // Get teacher information for confirmation
            const teacherData = JSON.parse(sessionStorage.getItem('teacherData') || '{}');
            const teacherName = `${teacherData.firstName || ''} ${teacherData.lastName || ''}`.trim() || 'Teacher';
            
            // Show detailed confirmation dialog
            const confirmMessage = `🗑️ Delete Attendance Record?\n\n` +
                `📅 Date: ${new Date(date).toLocaleDateString('en-IN')}\n` +
                `📚 Subject: ${subject}\n` +
                `🏫 Class: ${className}\n` +
                `👨‍🏫 Teacher: ${teacherName}\n\n` +
                `⚠️ This action cannot be undone!\n\n` +
                `Are you sure you want to delete this attendance record?`;
            
            if (!confirm(confirmMessage)) {
                console.log('❌ User cancelled attendance record deletion');
                return;
            }
            
            try {
                console.log('🗑️ Starting attendance record deletion:', {
                    recordKey,
                    date,
                    subject,
                    className,
                    teacher: teacherName
                });
                
                // Show loading state
                const deleteBtn = event.target.closest('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.disabled = true;
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    deleteBtn.style.background = '#9CA3AF';
                }
                
                // Delete from Firebase
                await firebase.database().ref('attendance').child(recordKey).remove();
                
                console.log('✅ Attendance record deleted successfully from Firebase');
                
                // Show success message
                showSuccessMessage(`✅ Attendance Record Deleted Successfully!\n\n` +
                    `Date: ${new Date(date).toLocaleDateString('en-IN')}\n` +
                    `Subject: ${subject}\n` +
                    `Class: ${className}`);
                
                // Reload the attendance report to reflect changes
                setTimeout(() => {
                    loadAttendanceReport();
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error deleting attendance record:', error);
                
                // Show error message
                alert(`❌ Error Deleting Record\n\n` +
                    `Failed to delete attendance record.\n` +
                    `Error: ${error.message}\n\n` +
                    `Please try again or contact support.`);
                
                // Re-enable delete button
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                    deleteBtn.style.background = '';
                }
            }
        }

        function loadScheduleContent() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `                <div class="header">
                    <h1 class="page-title">Schedule</h1>
                </div>
                <div class="schedule-container">
                    <div class="timetable">
                        <div class="weekday">
                            <h3>Monday</h3>
                            <div class="classes">
                                <!-- Classes will be loaded here -->
                            </div>
                        </div>
                        <div class="weekday">
                            <h3>Tuesday</h3>
                            <div class="classes">
                                <!-- Classes will be loaded here -->
                            </div>
                        </div>
                        <!-- Add other weekdays similarly -->
                    </div>
                </div>
            `;
        }

        function loadNotificationsContent() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `                <div class="header">
                    <h1 class="page-title">Notifications</h1>
                        </div>
                <div class="notifications-container">
                    <div class="notification-filters">
                        <button class="btn btn-primary active">All</button>
                        <button class="btn btn-outline">Unread</button>
                        <button class="btn btn-outline">Important</button>
                    </div>
                    <div class="notifications-list">
                        <!-- Notifications will be loaded here -->
                        <div class="no-notifications">
                            No new notifications
                        </div>
                    </div>
                </div>
            `;
        }

        // Handle logout
        async function handleLogout() {
            // Graceful logout with offline handling
            try {
                sessionStorage.clear();
                if (window.firebaseOfflineMode || typeof firebase === 'undefined' || !firebase.auth) {
                    // Offline or no firebase, just redirect
                    showErrorMessage('तुम्ही ऑफलाइन आहात किंवा लॉगआउट करण्यात अडचण आहे. पुन्हा लॉगिन करा.');
                    setTimeout(() => { window.location.href = 'teacher-login.html'; }, 1200);
                    return;
                }
                await firebase.auth().signOut();
                window.location.href = 'teacher-login.html';
            } catch (e) {
                showErrorMessage('लॉगआउट करताना त्रुटी आली. कृपया पुन्हा प्रयत्न करा.');
                setTimeout(() => {
                    firebase.auth().signOut().then(() => {
                        window.location.href = 'teacher-login.html';
                    });
                }, 1500);
            }
        }

        // Export report function
        function exportReport() {
            alert('Export feature coming soon!');
        }

        // Debounce function to limit function calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Add event listeners for form fields
        document.addEventListener('DOMContentLoaded', function() {
            // Debounced version of updateClassOptions
            const debouncedUpdate = debounce(updateClassOptions, 300);
            
            // These fields trigger student load
            const loadTriggerFields = ['department', 'year', 'subject', 'date', 'lectureType'];
            loadTriggerFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('change', debouncedUpdate);
                }
            });
            
            // Division changes don't trigger load, just update the filter
            const divisionSelect = document.getElementById('division');
            if (divisionSelect) {
                divisionSelect.addEventListener('change', function() {
                    const department = document.getElementById('department').value;
                    const year = document.getElementById('year').value;
                    const subject = document.getElementById('subject')?.value;
                    const selectedDate = document.getElementById('date')?.value;
                    const selectedLectureType = document.getElementById('lectureType')?.value;
                    
                    if (department && year && subject && selectedDate && selectedLectureType) {
                        const classCode = year + department + (this.value ? '-' + this.value : '');
                        loadStudents(classCode);
                    }
                });
            }

            // Pre-select department if teacher has only one department
            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            if (teacherData?.departments?.length === 1) {
                const departmentSelect = document.getElementById('department');
                if (departmentSelect) {
                    departmentSelect.value = teacherData.departments[0].code; // Use code for pre-selection
                    debouncedUpdate();
                }
            }

            // Pre-select year if teacher has only one year
            if (teacherData?.classes?.length === 1) {
                const yearSelect = document.getElementById('year');
                if (yearSelect) {
                    yearSelect.value = teacherData.classes[0];
                    debouncedUpdate();
                }
            }
        });

        // Update class options based on selections
        async function updateClassOptions() {
            console.log('updateClassOptions called');
            
            const department = document.getElementById('department').value;
            const year = document.getElementById('year').value;
            const division = document.getElementById('division')?.value || '';
            const subject = document.getElementById('subject')?.value;
            const selectedDate = document.getElementById('date')?.value;
            const selectedLectureType = document.getElementById('lectureType')?.value;
            
            console.log('Form values:', {
                department,
                year,
                division,
                subject,
                selectedDate,
                selectedLectureType
            });
            
            // Get teacher data
            const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
            console.log('Teacher data:', teacherData);
            
            // Check if teacher has this year assigned
            if (teacherData && teacherData.classes && teacherData.classes.includes(year)) {
                console.log('Year is assigned to teacher');
                
                // Generate class code (e.g., "FYME-A")
                const classCode = year + department + (division ? '-' + division : '');
                console.log('Generated class code:', classCode);
                
                // Show loading state while checking fields
                const tableBody = document.getElementById('attendance-body');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading students...</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                // Check required fields - division is optional
                if (!department || !year || !subject || !selectedDate || !selectedLectureType) {
                    console.log('Missing required fields:', {
                        department: !!department,
                        year: !!year,
                        subject: !!subject,
                        date: !!selectedDate,
                        lectureType: !!selectedLectureType
                    });
                    
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle"></i>
                                        <p>Please fill all required fields</p>
                                        <div class="subtitle">Department, Year, Subject, Date and Lecture Type are required</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    // All required fields are filled, load students
                    console.log('All required fields filled, loading students');
                    try {
                        await loadStudents(classCode);
                    } catch (error) {
                        console.error('Error loading students:', error);
                        if (tableBody) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="3" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-exclamation-circle"></i>
                                            <p>Error loading students</p>
                                            <div class="subtitle">Please try again</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }
                    }
                }
            } else {
                console.log('Year is not assigned to teacher');
                const tableBody = document.getElementById('attendance-body');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <p>You are not assigned to this year</p>
                                    <div class="subtitle">Please select a year that is assigned to you</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Function to get department full name from code
        function getDepartmentFullName(code) {
            const departmentMap = {
                'CT': 'Computer Technology',
                'IT': 'Information Technology',
                'ME': 'Mechanical Engineering',
                'CE': 'Civil Engineering',
                'EE': 'Electrical Engineering',
                'ET': 'Electronics & Telecommunication',
                'AI': 'Artificial Intelligence'
            };
            return departmentMap[code] || code;
        }

        // Function to normalize year format
        function normalizeYear(year) {
            if (!year) return '';
            year = year.toString().toUpperCase();
            
            if (['1', 'FIRST', 'FIRST YEAR', 'FY'].includes(year)) return 'FY';
            if (['2', 'SECOND', 'SECOND YEAR', 'SY'].includes(year)) return 'SY';
            if (['3', 'THIRD', 'THIRD YEAR', 'TY'].includes(year)) return 'TY';
            if (['4', 'FOURTH', 'FOURTH YEAR', 'BE', 'FINAL YEAR'].includes(year)) return 'BE';
            return year;
        }

        // Function to toggle batch visibility based on lecture type
        function toggleBatchVisibility() {
            const lectureType = document.getElementById('lectureType').value;
            const batchGroup = document.getElementById('batchGroup');
            const batchSelect = document.getElementById('batch');
            
            if (lectureType === 'practical') {
                // Show batch dropdown for practical
                batchGroup.style.display = 'block';
                console.log('Batch dropdown shown for practical lecture');
            } else {
                // Hide batch dropdown for theory
                batchGroup.style.display = 'none';
                batchSelect.value = ''; // Reset batch selection
                console.log('Batch dropdown hidden for theory lecture');
            }
        }

        // Function to generate batch-specific students for practical lectures
        async function generateBatchStudents(batch, department, year, division, tableBody) {
            console.log('Loading real students for batch:', batch);
            
            // Show loading state
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading Batch ${batch.replace('Batch', '')} students...</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            try {
                // Fetch real students from Firebase
                const studentsRef = window.db.ref('students');
                const snapshot = await studentsRef.once('value');
                
                if (!snapshot.exists()) {
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-user-slash"></i>
                                        <p>No students found in database</p>
                                        <div class="subtitle">Add students from Student Management section</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }
                
                const allStudents = [];
                const departmentFullName = getDepartmentFullName(department);
                const normalizedYear = normalizeYear(year);
                
                // Filter students by department and year
                snapshot.forEach((childSnapshot) => {
                    const student = childSnapshot.val();
                    
                    // Check department match
                    const studentDept = student.department || student.branch || '';
                    const matchesDepartment = studentDept.toLowerCase() === departmentFullName.toLowerCase();
                    
                    // Check year match
                    const studentYear = normalizeYear(student.year);
                    const matchesYear = studentYear === normalizedYear;
                    
                    // Check division match (if specified)
                    const matchesDivision = !division || division === '' || 
                        (student.division && student.division.toUpperCase() === division.toUpperCase());
                    
                    console.log('Student filtering:', {
                        studentName: student.name,
                        studentDept: studentDept,
                        studentYear: studentYear,
                        studentDivision: student.division,
                        selectedDivision: division,
                        matchesDepartment,
                        matchesYear,
                        matchesDivision
                    });
                    
                    if (matchesDepartment && matchesYear && matchesDivision) {
                        allStudents.push({
                            id: childSnapshot.key,
                            rollNo: student.rollNo || student.roll_no || 'N/A',
                            name: student.name || student.fullName || 'Unknown',
                            department: studentDept,
                            year: student.year,
                            division: student.division || ''
                        });
                    }
                });
                
                console.log(`Found ${allStudents.length} total students for ${departmentFullName} ${normalizedYear}`);
                
                // Sort students by roll number
                allStudents.sort((a, b) => {
                    const rollA = parseInt(a.rollNo) || 0;
                    const rollB = parseInt(b.rollNo) || 0;
                    return rollA - rollB;
                });
                
                // 🎯 Custom batch ranges for Computer Technology Second & Third Year
                const batchLetter = batch.replace('Batch', '');
                let startIndex, endIndex;
                
                // Check if this is Computer Technology Second Year
                if (department === 'CT' && year === 'SY') {
                    console.log('🎯 Applying custom CT SY batch ranges for Division:', division);
                    
                    if (division === 'A') {
                        // Division A: Batch A (1-24), Batch B (25-49), Batch C (50-72)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 24; break;   // Students 1-24
                            case 'B': startIndex = 24; endIndex = 49; break;  // Students 25-49
                            case 'C': startIndex = 49; endIndex = 72; break;  // Students 50-72
                            default: startIndex = 0; endIndex = 24; break;
                        }
                    } else if (division === 'B') {
                        // Division B: Batch A (1-24), Batch B (25-48), Batch C (49-72)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 24; break;   // Students 1-24
                            case 'B': startIndex = 24; endIndex = 48; break;  // Students 25-48
                            case 'C': startIndex = 48; endIndex = 72; break;  // Students 49-72
                            default: startIndex = 0; endIndex = 24; break;
                        }
                    } else if (division === 'C') {
                        // Division C: Batch A (1-24), Batch B (25-48), Batch C (49-72)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 24; break;   // Students 1-24
                            case 'B': startIndex = 24; endIndex = 48; break;  // Students 25-48
                            case 'C': startIndex = 48; endIndex = 72; break;  // Students 49-72
                            default: startIndex = 0; endIndex = 24; break;
                        }
                    } else {
                        // Default fallback for CT SY without specific division
                        const batchMap = { 'A': 1, 'B': 2, 'C': 3 };
                        const batchNumber = batchMap[batchLetter] || 1;
                        startIndex = (batchNumber - 1) * 20;
                        endIndex = startIndex + 20;
                    }
                } else if (department === 'CT' && year === 'TY') {
                    // 🎯 Computer Technology Third Year custom batch ranges
                    console.log('🎯 Applying custom CT TY batch ranges for Division:', division);
                    
                    if (division === 'A') {
                        // Division A: Only Batch C specified (41-61)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 20; break;   // Default for Batch A
                            case 'B': startIndex = 20; endIndex = 40; break;  // Default for Batch B
                            case 'C': startIndex = 40; endIndex = 61; break;  // Students 41-61
                            default: startIndex = 0; endIndex = 20; break;
                        }
                    } else if (division === 'B') {
                        // Division B: Only Batch C specified (41-55)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 20; break;   // Default for Batch A
                            case 'B': startIndex = 20; endIndex = 40; break;  // Default for Batch B
                            case 'C': startIndex = 40; endIndex = 55; break;  // Students 41-55
                            default: startIndex = 0; endIndex = 20; break;
                        }
                    } else if (division === 'C') {
                        // Division C: Only Batch C specified (41-61)
                        switch (batchLetter) {
                            case 'A': startIndex = 0; endIndex = 20; break;   // Default for Batch A
                            case 'B': startIndex = 20; endIndex = 40; break;  // Default for Batch B
                            case 'C': startIndex = 40; endIndex = 61; break;  // Students 41-61
                            default: startIndex = 0; endIndex = 20; break;
                        }
                    } else {
                        // Default fallback for CT TY without specific division
                        const batchMap = { 'A': 1, 'B': 2, 'C': 3 };
                        const batchNumber = batchMap[batchLetter] || 1;
                        startIndex = (batchNumber - 1) * 20;
                        endIndex = startIndex + 20;
                    }
                } else if (department === 'ME' && year === 'SY') {
                    // 🎯 Mechanical Engineering Second Year custom batch ranges (Only A & B)
                    console.log('🎯 Applying custom ME SY batch ranges (A & B only)');
                    
                    // Create filtered students array for ME SY with roll numbers 2701+
                    const meStudents = allStudents.filter(student => {
                        const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                        return rollNum >= 2701; // Only students with roll numbers 2701 and above
                    });
                    
                    console.log(`ME SY: Found ${meStudents.length} students with roll numbers 2701+`);
                    
                    // Apply batch-specific filtering based on roll number ranges
                    let batchStudents = [];
                    
                    switch (batchLetter) {
                        case 'A': 
                            // Batch A: Roll numbers 2701-2725
                            batchStudents = meStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2701 && rollNum <= 2725;
                            });
                            console.log(`ME SY Batch A: Found ${batchStudents.length} students (Roll 2701-2725)`);
                            break;
                        case 'B': 
                            // Batch B: Roll numbers 2726 onwards
                            batchStudents = meStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2726;
                            });
                            console.log(`ME SY Batch B: Found ${batchStudents.length} students (Roll 2726 onwards)`);
                            break;
                        default: 
                            // No Batch C for ME - default to Batch A
                            batchStudents = meStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2701 && rollNum <= 2725;
                            });
                            console.log(`ME SY Default (Batch A): Found ${batchStudents.length} students (Roll 2701-2725)`);
                            break;
                    }
                    
                    // Display the batch students directly
                    if (tableBody) {
                        if (batchStudents.length === 0) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="3" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-user-slash"></i>
                                            <p>No students found for ME SY Batch ${batchLetter}</p>
                                            <div class="subtitle">Roll numbers ${batchLetter === 'A' ? '2701-2725' : '2726+'}</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        } else {
                            let studentsHTML = '';
                            batchStudents.forEach((student, index) => {
                                studentsHTML += `
                                    <tr data-student-id="${student.id}">
                                        <td>${student.rollNo}</td>
                                        <td>${student.name}</td>
                                        <td>
                                            <div class="attendance-buttons">
                                                <button class="btn-attendance present" 
                                                    onclick="markAttendance('${student.id}', true)">
                                                    <i class="fas fa-check"></i>
                                                    Present
                                                </button>
                                                <button class="btn-attendance absent" 
                                                    onclick="markAttendance('${student.id}', false)">
                                                    <i class="fas fa-times"></i>
                                                    Absent
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });
                            tableBody.innerHTML = studentsHTML;
                        }
                    }
                    return; // Exit early since we handled the display
                } else if (department === 'ME' && year === 'TY') {
                    // 🎯 Mechanical Engineering Third Year custom batch ranges (Only A & B)
                    console.log('🎯 Applying custom ME TY batch ranges (A & B only)');
                    
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 23; 
                            break;   // Students 1-23
                        case 'B': 
                            startIndex = 23; 
                            endIndex = 45; 
                            break;   // Students 24-45
                        default: 
                            // No Batch C for ME - default to Batch A
                            startIndex = 0; 
                            endIndex = 23; 
                            break;
                    }
                } else if (department === 'CE' && year === 'SY') {
                    // 🎯 Civil Engineering Second Year custom batch ranges (Only A & B)
                    console.log('🎯 Applying custom CE SY batch ranges (A & B only)');
                    
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 22; 
                            break;   // Students 1-22
                        case 'B': 
                            startIndex = 22; 
                            endIndex = 43; 
                            break;   // Students 23-43
                        default: 
                            // No Batch C for CE SY - default to Batch A
                            startIndex = 0; 
                            endIndex = 22; 
                            break;
                    }
                } else if (department === 'EE' && year === 'FY') {
                    // 🎯 Electrical Engineering First Year custom batch ranges
                    console.log('🎯 Applying custom EE FY batch ranges');
                    
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 22; 
                            break;   // Students 1-22
                        case 'B': 
                            startIndex = 22; 
                            endIndex = 44; 
                            break;   // Students 23-44
                        case 'C': 
                            startIndex = 44; 
                            endIndex = allStudents.length; 
                            break;   // Students 45 onwards
                        default: 
                            startIndex = 0; 
                            endIndex = 22; 
                            break;
                    }
                } else if (department === 'EE' && year === 'SY') {
                    // 🎯 Electrical Engineering Second Year custom batch ranges
                    console.log('🎯 Applying custom EE SY batch ranges');
                    
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 20; 
                            break;   // Students 1-20
                        case 'B': 
                            startIndex = 20; 
                            endIndex = 40; 
                            break;   // Students 21-40
                        case 'C': 
                            startIndex = 40; 
                            endIndex = 60; 
                            break;   // Students 41-60
                        default: 
                            startIndex = 0; 
                            endIndex = 20; 
                            break;
                    }
                } else if (department === 'EE' && year === 'TY') {
                    // 🎯 Electrical Engineering Third Year custom batch ranges (Only A & B)
                    console.log('🎯 Applying custom EE TY batch ranges (A & B only)');
                    
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 23; 
                            break;   // Students 1-23
                        case 'B': 
                            startIndex = 23; 
                            endIndex = allStudents.length; 
                            break;   // Students 24 onwards
                        default: 
                            // No Batch C for EE TY - default to Batch A
                            startIndex = 0; 
                            endIndex = 23; 
                            break;
                    }
                } else if (department === 'IT' && year === 'FY') {
                    // 🎯 Information Technology First Year custom batch ranges
                    console.log('🎯 Applying custom IT FY batch ranges');
                    
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 20; 
                            break;   // Students 1-20
                        case 'B': 
                            startIndex = 20; 
                            endIndex = 40; 
                            break;   // Students 21-40
                        case 'C': 
                            startIndex = 40; 
                            endIndex = allStudents.length; 
                            break;   // Students 41 onwards
                        default: 
                            startIndex = 0; 
                            endIndex = 20; 
                            break;
                    }
                } else if (department === 'IT' && year === 'SY') {
                    // 🎯 Information Technology Second Year custom batch ranges by roll numbers
                    console.log('🎯 Applying custom IT SY batch ranges by roll numbers');
                    
                    // Declare batchStudents locally for IT SY
                    let batchStudents = [];
                    
                    switch (batchLetter) {
                        case 'A': 
                            // 🎯 IT SY Batch A: Roll 2601-2624
                            batchStudents = allStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2601 && rollNum <= 2624;
                            });
                            console.log('🎯 IT SY Batch A: Filtered students with roll 2601-2624:', batchStudents.length);
                            break;
                        case 'B': 
                            // 🎯 IT SY Batch B: Roll 2625-2648
                            batchStudents = allStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2625 && rollNum <= 2648;
                            });
                            console.log('🎯 IT SY Batch B: Filtered students with roll 2625-2648:', batchStudents.length);
                            break;
                        case 'C': 
                            // 🎯 IT SY Batch C: Roll 2649 onwards
                            batchStudents = allStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2649;
                            });
                            console.log('🎯 IT SY Batch C: Filtered students with roll >= 2649:', batchStudents.length);
                            break;
                        default: 
                            // Default to Batch A range
                            batchStudents = allStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2601 && rollNum <= 2624;
                            });
                            break;
                    }
                    
                    // Display the filtered students
                    if (batchStudents.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: #666;">
                                    <div class="no-students-message">
                                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                                        <div class="title">No students found for IT SY Batch ${batchLetter}</div>
                                        <div class="subtitle">Roll numbers ${batchLetter === 'A' ? '2601-2624' : batchLetter === 'B' ? '2625-2648' : '2649+'}</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        let studentsHTML = '';
                        batchStudents.forEach((student, index) => {
                            studentsHTML += `
                                <tr data-student-id="${student.id}">
                                    <td>${student.rollNo}</td>
                                    <td>${student.name}</td>
                                    <td>
                                        <div class="attendance-buttons">
                                            <button class="btn-attendance present" 
                                                onclick="markAttendance('${student.id}', true)">
                                                <i class="fas fa-check"></i>
                                                Present
                                            </button>
                                            <button class="btn-attendance absent" 
                                                onclick="markAttendance('${student.id}', false)">
                                                <i class="fas fa-times"></i>
                                                Absent
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        tableBody.innerHTML = studentsHTML;
                    }
                    return; // Exit early since we handled the display
                } else if (department === 'IT' && year === 'TY') {
                    // 🎯 Information Technology Third Year custom batch ranges (roll 23 only in Batch A)
                    console.log('🎯 Applying strict IT TY batch ranges: roll 23 only in Batch A');
                    // Always sort by rollNo (as integer)
                    allStudents.sort((a, b) => {
                        const rollA = parseInt((a.rollNo || '').replace(/\D/g, '')) || 0;
                        const rollB = parseInt((b.rollNo || '').replace(/\D/g, '')) || 0;
                        return rollA - rollB;
                    });
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 23; 
                            break;   // Students 1-23 (includes roll 23)
                        case 'B': 
                            startIndex = 23; 
                            endIndex = 46; 
                            break;   // Students 24-46 (roll 23 excluded)
                        case 'C': 
                            startIndex = 46; 
                            endIndex = 70; 
                            break;   // Students 47-70
                        default: 
                            startIndex = 0; 
                            endIndex = 23; 
                            break;
                    }
                    // IT TY special handling is now done in main slicing logic below
                    // No early returns needed here

                } else if (department === 'EE' && year === 'TY') {
                    console.log('🚫 EE TY detected - Only showing Batch A and B (no Batch C)');
                    // This is batch filtering logic, not dropdown logic - remove dropdown code
                    switch (batchLetter) {
                        case 'A': 
                            startIndex = 0; 
                            endIndex = 23; 
                            break;   // Students 1-23
                        case 'B': 
                            startIndex = 23; 
                            endIndex = allStudents.length; 
                            break;   // Students 24 onwards
                        default: 
                            startIndex = 0; 
                            endIndex = 23; 
                            break;
                    }
                } else {
                    // Default batch system for other departments/years (20 students per batch)
                    const batchMap = { 'A': 1, 'B': 2, 'C': 3 };
                    const batchNumber = batchMap[batchLetter] || 1;
                    startIndex = (batchNumber - 1) * 20;
                    endIndex = startIndex + 20;
                }
                
                let batchStudents;
                
                if (department === 'CE' && year === 'SY') {
                    // 🎯 CE SY roll-based slicing: A = 2001-2022 + 2027, B = 2023-2026 + 2028-2043 (skip 2027), no C
                    const toNum = (s) => parseInt(String((s.rollNo || '')).replace(/\D/g, '')) || 0;
                    if (batchLetter === 'A') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return (r >= 2001 && r <= 2022) || r === 2027;
                        });
                        console.log('🎯 CE SY Batch A: Rolls 2001-2022, 2027 loaded');
                    } else if (batchLetter === 'B') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return (r >= 2023 && r <= 2026) || (r >= 2028);
                        });
                        console.log('🎯 CE SY Batch B: Rolls 2023-2026, 2028 onwards loaded (skip 2027)');
                    } else {
                        batchStudents = [];
                        console.log('🚫 CE SY: No Batch C available');
                    }
                } else if (department === 'ET' && year === 'FY') {
                    // ET FY: A(1-20), B(21-40), C(41+)
                    switch (batchLetter) {
                        case 'A':
                            batchStudents = allStudents.slice(0, 20); // 1-20
                            break;
                        case 'B':
                            batchStudents = allStudents.slice(20, 40); // 21-40
                            break;
                        case 'C':
                            batchStudents = allStudents.slice(40); // 41 onwards
                            break;
                        default:
                            batchStudents = allStudents.slice(0, 20);
                            break;
                    }
                } else if (department === 'ET' && year === 'SY') {
                    // 🎯 Electronics & Telecommunication Second Year custom batch ranges
                    console.log('🎯 Applying custom ET SY batch ranges');
                    
                    switch (batchLetter) {
                        case 'A':
                            batchStudents = allStudents.slice(0, 24); // Students 1-24
                            console.log(`ET SY Batch A: Found ${batchStudents.length} students (1-24)`);
                            break;
                        case 'B':
                            batchStudents = allStudents.slice(24, 48); // Students 25-48
                            console.log(`ET SY Batch B: Found ${batchStudents.length} students (25-48)`);
                            break;
                        case 'C':
                            // Batch C: Roll numbers 2549 onwards
                            batchStudents = allStudents.filter(student => {
                                const rollNum = parseInt((student.rollNo || '').replace(/\D/g, '')) || 0;
                                return rollNum >= 2549;
                            });
                            console.log(`ET SY Batch C: Found ${batchStudents.length} students (Roll 2549 onwards)`);
                            break;
                        default:
                            batchStudents = allStudents.slice(0, 24);
                            console.log(`ET SY Default (Batch A): Found ${batchStudents.length} students (1-24)`);
                            break;
                    }
                } else if (department === 'ET' && year === 'TY') {
                    // ET TY: A(1-20), B(21-37), NO C
                    switch (batchLetter) {
                        case 'A':
                            batchStudents = allStudents.slice(0, 20); // 1-20
                            break;
                        case 'B':
                            batchStudents = allStudents.slice(20, 37); // 21-37
                            break;
                        default:
                            batchStudents = allStudents.slice(0, 20);
                            break;
                    }
                } else if (department === 'IT' && year === 'TY') {
                    // 🎯 IT TY Special handling: roll 3623 in Batch A
                    if (batchLetter === 'A') {
                        batchStudents = allStudents.slice(0, 23);
                        // Force add roll 3623 to Batch A
                        const roll3623Student = allStudents.find(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 3623);
                        if (roll3623Student && !batchStudents.some(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 3623)) {
                            batchStudents.push(roll3623Student);
                            console.log('🎯 Added roll 3623 to Batch A:', roll3623Student.name);
                        }
                        // Also add roll 23 if present
                        const roll23Student = allStudents.find(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 23);
                        if (roll23Student && !batchStudents.some(s => parseInt((s.rollNo || '').replace(/\D/g, '')) === 23)) {
                            batchStudents.push(roll23Student);
                            console.log('🎯 Added roll 23 to Batch A:', roll23Student.name);
                        }
                        // Sort after adding
                        batchStudents.sort((a, b) => {
                            const rollA = parseInt((a.rollNo || '').replace(/\D/g, '')) || 0;
                            const rollB = parseInt((b.rollNo || '').replace(/\D/g, '')) || 0;
                            return rollA - rollB;
                        });
                    } else if (batchLetter === 'B') {
                        batchStudents = allStudents.slice(23, 46).filter(s => {
                            const roll = parseInt((s.rollNo || '').replace(/\D/g, ''));
                            return roll !== 23 && roll !== 3623; // Remove roll 23 and 3623 from Batch B
                        });
                        console.log('🎯 Batch B: Removed roll 23 and 3623');
                    } else if (batchLetter === 'C') {
                        batchStudents = allStudents.slice(46, 70);
                    } else {
                        batchStudents = allStudents.slice(0, 23);
                    }
                } else if (department === 'AI' && year === 'FY') {
                    // 🎯 AI FY roll-based slicing: A = 1001-1022, B = 1023-1044, C = 1045 onwards
                    const toNum = (s) => parseInt(String((s.rollNo || '')).replace(/\D/g, '')) || 0;
                    if (batchLetter === 'A') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1001 && r <= 1022;
                        });
                        console.log('🎯 AI FY Batch A: Rolls 1001-1022 loaded');
                    } else if (batchLetter === 'B') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1023 && r <= 1044;
                        });
                        console.log('🎯 AI FY Batch B: Rolls 1023-1044 loaded');
                    } else if (batchLetter === 'C') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1045;
                        });
                        console.log('🎯 AI FY Batch C: Rolls 1045 onwards loaded');
                    } else {
                        batchStudents = [];
                        console.log('🚫 AI FY: Invalid batch selected');
                    }
                } else if (department === 'ME' && year === 'FY') {
                    // ME FY roll-based slicing: A = 1801-1820, B = 1821-1840, C = 1841-1861
                    const toNum = (s) => parseInt(String((s.rollNo || '')).replace(/\D/g, '')) || 0;
                    
                    // Debug: Show first 5 student roll numbers
                    console.log('ME FY Debug - First 5 student rolls:', allStudents.slice(0, 5).map(s => ({
                        name: s.name,
                        rollNo: s.rollNo,
                        extracted: toNum(s)
                    })));
                    
                    if (batchLetter === 'A') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1801 && r <= 1820;
                        });
                        console.log('ME FY Batch A: Rolls 1801-1820 loaded, found:', batchStudents.length);
                    } else if (batchLetter === 'B') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1821 && r <= 1840;
                        });
                        console.log('ME FY Batch B: Rolls 1821-1840 loaded, found:', batchStudents.length);
                        if (batchStudents.length === 0) {
                            console.log('ME FY Batch B Debug - All roll numbers:', allStudents.map(s => toNum(s)).sort((a,b) => a-b));
                        }
                    } else if (batchLetter === 'C') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1841;
                        });
                        console.log('ME FY Batch C: Rolls 1841 onwards loaded, found:', batchStudents.length);
                    } else {
                        batchStudents = [];
                        console.log('ME FY: Invalid batch selected');
                    }
                } else if (department === 'CE' && year === 'FY') {
                    // 🎯 CE FY roll-based slicing: A = 1101-1120, B = 1121-1140, C = 1141 onwards
                    const toNum = (s) => parseInt(String((s.rollNo || '')).replace(/\D/g, '')) || 0;
                    if (batchLetter === 'A') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1101 && r <= 1120;
                        });
                        console.log('🎯 CE FY Batch A: Rolls 1101-1120 loaded');
                    } else if (batchLetter === 'B') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1121 && r <= 1140;
                        });
                        console.log('🎯 CE FY Batch B: Rolls 1121-1140 loaded');
                    } else if (batchLetter === 'C') {
                        batchStudents = allStudents.filter(s => {
                            const r = toNum(s);
                            return r >= 1141;
                        });
                        console.log('🎯 CE FY Batch C: Rolls 1141 onwards loaded');
                    } else {
                        batchStudents = [];
                        console.log('🚫 CE FY: Invalid batch selected');
                    }
                } else if (department === 'CE' && year === 'TY') {
                    // 🎯 CE TY Special handling: Only Batch A with roll 3001-3026
                    if (batchLetter === 'A') {
                        // Filter students with roll numbers 3001-3026
                        batchStudents = allStudents.filter(s => {
                            const roll = parseInt((s.rollNo || '').replace(/\D/g, ''));
                            return roll >= 3001 && roll <= 3026;
                        });
                        // Sort by roll number
                        batchStudents.sort((a, b) => {
                            const rollA = parseInt((a.rollNo || '').replace(/\D/g, '')) || 0;
                            const rollB = parseInt((b.rollNo || '').replace(/\D/g, '')) || 0;
                            return rollA - rollB;
                        });
                        console.log('🎯 CE TY Batch A: Roll 3001-3026 loaded');
                    } else {
                        // No Batch B or C for CE TY
                        batchStudents = [];
                        console.log('🚫 CE TY: Only Batch A available');
                    }
                } else {
                    batchStudents = allStudents.slice(startIndex, endIndex);
                }
                
                // Enhanced logging with actual student ranges
                if (department === 'CT' && year === 'SY') {
                    console.log(`🎯 CT SY Division ${division} - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex} (${batchStudents.length} students loaded)`);
                } else if (department === 'CT' && year === 'TY') {
                    console.log(`🎯 CT TY Division ${division} - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex} (${batchStudents.length} students loaded)`);
                } else if (department === 'ME' && year === 'SY') {
                    console.log(`🎯 ME SY - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex === allStudents.length ? 'end' : endIndex} (${batchStudents.length} students loaded)`);
                } else if (department === 'IT' && year === 'FY') {
                    console.log(`🎯 IT FY - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex === allStudents.length ? 'end' : endIndex} (${batchStudents.length} students loaded)`);
                } else if (department === 'IT' && year === 'SY') {
                    console.log(`🎯 IT SY - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex} (${batchStudents.length} students loaded)`);
                } else if (department === 'IT' && year === 'TY') {
                    console.log(`🎯 IT TY - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex} (${batchStudents.length} students loaded)`);
                } else if (department === 'AI' && year === 'FY') {
                    console.log(`🎯 AI FY - Batch ${batchLetter}: Roll-based filtering (${batchStudents.length} students loaded)`);
                } else if (department === 'ME' && year === 'FY') {
                    console.log(`ME FY - Batch ${batchLetter}: Roll-based filtering (${batchStudents.length} students loaded)`);
                } else {
                    console.log(`📚 ${department} ${year} - Batch ${batchLetter}: Students ${startIndex + 1} to ${endIndex} (${batchStudents.length} students loaded)`);
                }
                
                if (batchStudents.length === 0) {
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-info-circle"></i>
                                        <p>No students found for Batch ${batchLetter}</p>
                                        <div class="subtitle">This batch range (${startIndex + 1}-${endIndex}) has no students</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }
                
                // Render batch students in table
                let html = '';
                batchStudents.forEach((student, index) => {
                    html += `
                        <tr data-student-id="${student.id}">
                            <td>${student.rollNo}</td>
                            <td>${student.name}</td>
                            <td>
                                <div class="attendance-buttons">
                                    <button class="btn-attendance present" 
                                        onclick="markAttendance('${student.id}', true)">
                                        <i class="fas fa-check"></i>
                                        Present
                                    </button>
                                    <button class="btn-attendance absent" 
                                        onclick="markAttendance('${student.id}', false)">
                                        <i class="fas fa-times"></i>
                                        Absent
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                if (tableBody) {
                    tableBody.innerHTML = html;
                }
                
                console.log(`Loaded ${batchStudents.length} real students for Batch ${batchLetter}`);
                
            } catch (error) {
                console.error('Error loading batch students:', error);
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <p>Error loading students</p>
                                    <div class="subtitle">${error.message}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        async function loadStudents(classCode) {
            console.log('Loading students for class:', classCode);
            
            const department = document.getElementById('department').value;
            const year = document.getElementById('year').value;
            const division = document.getElementById('division')?.value;
            const batch = document.getElementById('batch')?.value;
            const subject = document.getElementById('subject').value;
            const selectedDate = document.getElementById('date')?.value;
            const selectedLectureType = document.getElementById('lectureType')?.value;
            const tableBody = document.getElementById('attendance-body');

            // Check if all required fields are filled
            // For practical lectures, batch is also required
            const batchRequired = selectedLectureType === 'practical';
            if (!department || !year || !subject || !selectedDate || !selectedLectureType || (batchRequired && !batch)) {
                console.log('Missing required fields:', {
                    department: !!department,
                    year: !!year,
                    subject: !!subject,
                    date: !!selectedDate,
                    lectureType: !!selectedLectureType,
                    batch: !!batch,
                    batchRequired
                });
                
                if (tableBody) {
                    const batchMsg = batchRequired ? ', and Batch (for Practical)' : '';
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-info-circle"></i>
                                    <p>Please fill all required fields</p>
                                    <div class="subtitle">Department, Year, Subject, Date, Lecture Type${batchMsg} are required</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            // Show loading state
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading students...</p>
                            </div>
                        </td>
                    </tr>
                `;
            }

            await waitForFirebase();
            // For practical lectures with batch, generate batch-specific students
            if (selectedLectureType === 'practical' && batch) {
                console.log('Generating batch-specific students for:', batch);
                generateBatchStudents(batch, department, year, division, tableBody);
                return;
            }
            
            console.log('Fetching students from Firebase');
            console.log('Query parameters:', { department, year, division });
            
            const studentsRef = window.db.ref('students');
            
            try {
                const snapshot = await studentsRef.once('value');
                const students = [];
                
                if (!snapshot.exists()) {
                    console.log('No students found');
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-user-slash"></i>
                                        <p>No students found</p>
                                        <div class="subtitle">Add students from the Student Management section</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }

                // Get department full name
                const departmentFullName = getDepartmentFullName(department);
                console.log('Looking for department:', departmentFullName);

                // Normalize selected year
                const normalizedYear = normalizeYear(year);
                console.log('Looking for year:', normalizedYear);

                snapshot.forEach((childSnapshot) => {
                    const student = childSnapshot.val();
                    
                    // Check department/branch match
                    const studentDept = student.department || student.branch || '';
                    const matchesDepartment = studentDept.toLowerCase() === departmentFullName.toLowerCase();
                    
                    if (!matchesDepartment) {
                        console.log('Department mismatch:', studentDept, 'vs', departmentFullName);
                        return;
                    }

                    // Check year match
                    const studentYear = normalizeYear(student.year);
                    const matchesYear = studentYear === normalizedYear;
                    
                    if (!matchesYear) {
                        console.log('Year mismatch:', studentYear, 'vs', normalizedYear);
                        return;
                    }

                    // Check division only for Computer Technology
                    if (departmentFullName === 'Computer Technology' && division) {
                        const studentDivision = student.division || 'A';  // Default to A if not specified
                        if (studentDivision !== division) {
                            console.log('Division mismatch:', studentDivision, 'vs', division);
                            return;
                        }
                    }

                    // Get student name
                    let firstName = student.firstName;
                    let lastName = student.lastName;
                    
                    if (!firstName && student.name) {
                        const nameParts = student.name.split(' ');
                        firstName = nameParts[0];
                        lastName = nameParts.slice(1).join(' ');
                    }
                    
                    students.push({
                        id: childSnapshot.key,
                        ...student,
                        firstName: firstName || 'Unknown',
                        lastName: lastName || '',
                        rollNo: student.rollNo || '-'
                    });
                });

                console.log('Found matching students:', students.length);
                
                // Sort students by roll number
                students.sort((a, b) => {
                    const rollA = parseInt(a.rollNo) || 0;
                    const rollB = parseInt(b.rollNo) || 0;
                    return rollA - rollB;
                });

                if (students.length === 0) {
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <div class="empty-state">
                                        <i class="fas fa-user-slash"></i>
                                        <p>No students found</p>
                                        <div class="subtitle">No students found in selected class</div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    return;
                }

                let html = '';
                students.forEach(student => {
                    const studentName = student.name || `${student.firstName} ${student.lastName}`;
                    html += `
                        <tr data-student-id="${student.id}">
                            <td>${student.rollNo || '-'}</td>
                            <td>${studentName.trim()}</td>
                            <td>
                                <div class="attendance-buttons">
                                    <button class="btn-attendance present" 
                                        onclick="markAttendance('${student.id}', true)">
                                        <i class="fas fa-check"></i>
                                        Present
                                    </button>
                                    <button class="btn-attendance absent" 
                                        onclick="markAttendance('${student.id}', false)">
                                        <i class="fas fa-times"></i>
                                        Absent
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                if (tableBody) {
                    tableBody.innerHTML = html;
                }

            } catch (error) {
                console.error('Error loading students:', error);
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <p>Error loading students</p>
                                    <div class="subtitle">${error.message}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Local attendance storage (prevents automatic save)
        let localAttendanceData = {};
        
        // Function to limit subject field to 4 characters only
        function limitSubjectWords(input) {
            // Convert to uppercase
            input.value = input.value.toUpperCase();
            
            // Limit to exactly 4 characters
            if (input.value.length > 4) {
                input.value = input.value.substring(0, 4);
                showSubjectWarning();
            }
        }
        
        // Function to show subject word limit warning
        function showSubjectWarning() {
            // Remove existing warning if any
            const existingWarning = document.getElementById('subjectWarning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            // Create warning message
            const warning = document.createElement('div');
            warning.id = 'subjectWarning';
            warning.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #F59E0B;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Subject limited to 4 words only!
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(warning);
            
            // Remove warning after 3 seconds
            setTimeout(() => {
                if (warning.parentNode) {
                    warning.remove();
                }
            }, 3000);
        }
        
        // Function to prevent typing after 4 characters
        function preventExtraWords(event, input) {
            // Allow backspace, delete, arrow keys, etc.
            const allowedKeys = [
                'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 
                'ArrowUp', 'ArrowDown', 'Home', 'End', 'Tab',
                'Ctrl', 'Alt', 'Shift', 'Meta'
            ];
            
            // Allow if it's a control key
            if (allowedKeys.includes(event.key) || event.ctrlKey || event.altKey || event.metaKey) {
                return;
            }
            
            // Get current text
            const currentText = input.value;
            
            // Prevent if already at 4 character limit
            if (currentText.length >= 4 && event.key.length === 1 && input.selectionStart === input.selectionEnd) {
                event.preventDefault();
                showSubjectWarning();
                return false;
            }
        }
        
        // Function to mark attendance for a student (LOCAL ONLY - NO AUTO SAVE)
        function markAttendance(studentId, isPresent) {
            console.log('🔄 Marking attendance locally (NO AUTO SAVE):', { studentId, isPresent });
            
            const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
            if (!row) {
                console.warn('❌ Student row not found:', studentId);
                return;
            }

            const presentBtn = row.querySelector('.btn-attendance.present');
            const absentBtn = row.querySelector('.btn-attendance.absent');

            // Update UI only
            if (isPresent) {
                presentBtn.classList.add('active');
                absentBtn.classList.remove('active');
            } else {
                presentBtn.classList.remove('active');
                absentBtn.classList.add('active');
            }

            // Store attendance locally (NOT in Firebase)
            localAttendanceData[studentId] = isPresent;
            
            console.log('✅ Local attendance updated:', localAttendanceData);
            console.log('🚫 NO Firebase save performed - waiting for Submit button');
            
            // Check if all students are marked
            checkAttendanceCompletion();
        }
        
        // Function to check if all VISIBLE students have been marked (BATCH AWARE)
        function checkAttendanceCompletion() {
            // Only count VISIBLE student rows (not hidden by batch filtering)
            const visibleStudentRows = document.querySelectorAll('tr[data-student-id]:not([style*="display: none"])');
            const totalVisibleStudents = visibleStudentRows.length;
            
            // Count how many visible students are marked
            let markedVisibleStudents = 0;
            visibleStudentRows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                if (localAttendanceData.hasOwnProperty(studentId)) {
                    markedVisibleStudents++;
                }
            });
            
            console.log(`📊 Batch Attendance Progress: ${markedVisibleStudents}/${totalVisibleStudents} visible students marked`);
            
            const submitBtn = document.getElementById('submitAttendanceBtn');
            if (submitBtn) {
                if (markedVisibleStudents === totalVisibleStudents && totalVisibleStudents > 0) {
                    // All visible students marked - enable submit
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Submit Attendance';
                    submitBtn.style.background = '#10B981';
                    console.log('✅ All visible students marked - Submit button enabled');
                } else if (totalVisibleStudents > 0) {
                    // Not all visible students marked - disable submit
                    submitBtn.disabled = true;
                    const remaining = totalVisibleStudents - markedVisibleStudents;
                    submitBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Mark All Students (${remaining} remaining)`;
                    submitBtn.style.background = '#F59E0B';
                    console.log(`⚠️ ${remaining} visible students remaining - Submit button disabled`);
                } else {
                    // No visible students (probably no batch selected)
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-users"></i> Select Batch/Students First';
                    submitBtn.style.background = '#6B7280';
                    console.log('⚠️ No visible students - Submit button disabled');
                }
            }
        }

        // Update mark all functions (LOCAL ONLY - NO AUTO SAVE) - BATCH AWARE
        function markAllPresent() {
            console.log('🔄 Marking visible batch students present locally (NO AUTO SAVE)');
            
            // Only select VISIBLE student rows (not hidden by batch filtering)
            const visibleRows = document.querySelectorAll('tr[data-student-id]:not([style*="display: none"])');
            
            console.log(`📊 Found ${visibleRows.length} visible students to mark present`);
            
            visibleRows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const presentBtn = row.querySelector('.btn-attendance.present');
                const absentBtn = row.querySelector('.btn-attendance.absent');
                
                // Update UI only for visible students
                presentBtn.classList.add('active');
                absentBtn.classList.remove('active');
                
                // Store locally (NOT in Firebase)
                localAttendanceData[studentId] = true;
            });
            
            console.log('✅ Visible batch students marked present locally:', Object.keys(localAttendanceData).length, 'students');
            console.log('🚫 NO Firebase save performed - waiting for Submit button');
            
            // Check completion status
            checkAttendanceCompletion();
        }

        function markAllAbsent() {
            console.log('🔄 Marking visible batch students absent locally (NO AUTO SAVE)');
            
            // Only select VISIBLE student rows (not hidden by batch filtering)
            const visibleRows = document.querySelectorAll('tr[data-student-id]:not([style*="display: none"])');
            
            console.log(`📊 Found ${visibleRows.length} visible students to mark absent`);
            
            visibleRows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const presentBtn = row.querySelector('.btn-attendance.present');
                const absentBtn = row.querySelector('.btn-attendance.absent');
                
                // Update UI only for visible students
                presentBtn.classList.remove('active');
                absentBtn.classList.add('active');
                
                // Store locally (NOT in Firebase)
                localAttendanceData[studentId] = false;
            });
            
            console.log('✅ Visible batch students marked absent locally:', Object.keys(localAttendanceData).length, 'students');
            console.log('🚫 NO Firebase save performed - waiting for Submit button');
            
            // Check completion status
            checkAttendanceCompletion();
        }
        
        // Function to submit attendance (ONLY when Submit button is clicked)
        async function submitAttendance() {
            console.log('🚀 SUBMIT ATTENDANCE CLICKED - Starting Firebase save process');
            
            // Check if any students are marked
            const allStudentRows = document.querySelectorAll('tr[data-student-id]');
            const totalStudents = allStudentRows.length;
            const markedStudents = Object.keys(localAttendanceData).length;
            
            if (markedStudents === 0 || totalStudents === 0) {
                alert(`⚠️ Please mark at least one student!\n\nMarked: ${markedStudents} students\nTotal: ${totalStudents} students`);
                console.log(`❌ Submit blocked - No students marked`);
                return;
            }
            
            console.log(`✅ Proceeding with ${markedStudents}/${totalStudents} students marked`);
            
            // Get form data
            const department = document.getElementById('department').value;
            const year = document.getElementById('year').value;
            const division = document.getElementById('division')?.value;
            const batch = document.getElementById('batch')?.value;
            const subject = document.getElementById('subject').value;
            const selectedDate = document.getElementById('date').value;
            const selectedLectureType = document.getElementById('lectureType').value;
            
            if (!department || !year || !subject || !selectedDate || !selectedLectureType) {
                alert('⚠️ Please fill all required fields!');
                return;
            }
            
            // Show confirmation dialog
            const presentCount = Object.values(localAttendanceData).filter(status => status === true).length;
            const absentCount = totalStudents - presentCount;
            
            const confirmMsg = `📊 Confirm Attendance Submission:\n\n` +
                `🏫 Class: ${year}${department}${division ? '-' + division : ''}${batch ? '-' + batch : ''}\n` +
                `📚 Subject: ${subject}\n` +
                `📅 Date: ${selectedDate}\n` +
                `🎯 Type: ${selectedLectureType}\n\n` +
                `✅ Present: ${presentCount}\n` +
                `❌ Absent: ${absentCount}\n` +
                `📊 Total: ${totalStudents}\n\n` +
                `Are you sure you want to submit this attendance?`;
            
            if (!confirm(confirmMsg)) {
                console.log('❌ User cancelled attendance submission');
                return;
            }
            
            // Disable submit button during save
            const submitBtn = document.getElementById('submitAttendanceBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.style.background = '#9CA3AF';
            }
            
            try {
                console.log('📦 Starting Firebase save with local data:', localAttendanceData);
                
                // Create attendance key with timestamp for multiple sessions
                const classCode = year + department + (division ? '-' + division : '') + (batch ? '-' + batch : '');
                const timestamp = new Date().getTime(); // Add timestamp for unique sessions
                const sessionTime = new Date().toLocaleTimeString('en-GB', { hour12: false }); // HH:MM:SS format
                const attendanceKey = `${selectedDate}_${classCode}_${selectedLectureType}_${subject}_${timestamp}`;
                
                // Get teacher info
                const teacherKey = sessionStorage.getItem('teacherKey');
                if (!teacherKey) {
                    throw new Error('Teacher not logged in');
                }
                
                // Prepare attendance data
                const attendanceData = {
                    date: selectedDate,
                    time: sessionTime,
                    class: classCode,
                    subject: subject,
                    lectureType: selectedLectureType,
                    teacherId: teacherKey,
                    timestamp: new Date().toISOString(),
                    students: localAttendanceData,
                    totalStudents: totalStudents,
                    presentCount: presentCount,
                    absentCount: absentCount
                };
                
                // Save to Firebase
                const attendanceRef = firebase.database().ref('attendance').child(attendanceKey);
                await attendanceRef.set(attendanceData);
                
                console.log('✅ Attendance saved successfully to Firebase!');
                
                // 📧 Send Email Notification
                const teacherData = JSON.parse(sessionStorage.getItem('teacherData'));
                const currentUser = firebase.auth().currentUser;
                
                console.log('📊 Teacher Data:', teacherData);
                console.log('📊 Current User:', currentUser);
                
                // Fallback email for testing
                const fallbackEmail = 'sagar969999@gmail.com';
                
                const emailData = {
                    teacher_name: teacherData?.firstName + ' ' + (teacherData?.lastName || '') || 'BVIT Teacher',
                    teacher_email: teacherData?.email || currentUser?.email || 'teacher@bvit.edu',
                    subject: subject || 'Attendance Subject',
                    class_name: `${department}-${year}-${division}` || 'BVIT-CLASS',
                    date: new Date(selectedDate).toLocaleDateString('en-GB', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    }),
                    submission_time: new Date().toLocaleString('en-IN'),
                    lecture_type: selectedLectureType,
                    batch: batch || '',
                    present_count: presentCount,
                    absent_count: absentCount,
                    total_students: totalStudents,
                    attendance_percentage: Math.round((presentCount / totalStudents) * 100)
                };
                
                console.log('📧 Final Email Data:', emailData);
                console.log('📧 Sending attendance email notification...');
                const emailResult = await sendAttendanceEmail(emailData);
                console.log('📧 Email result:', emailResult);
                
                // Show detailed success popup
                showAttendanceSuccessPopup({
                    department: department,
                    year: year,
                    division: division,
                    batch: batch,
                    subject: subject,
                    date: selectedDate,
                    lectureType: selectedLectureType,
                    presentCount: presentCount,
                    absentCount: absentCount,
                    totalStudents: totalStudents,
                    classCode: classCode,
                    sessionTime: sessionTime
                });
                
                // Reset form
                localAttendanceData = {};
                document.getElementById('attendance-body').innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-check-circle" style="color: #10B981;"></i>
                                <p>Attendance Submitted Successfully!</p>
                                <div class="subtitle">Select new class to take attendance</div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Hide submit button
                if (submitBtn) {
                    submitBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('❌ Error saving attendance:', error);
                alert(`❌ Error saving attendance: ${error.message}`);
                
                // Re-enable submit button
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Submit Attendance';
                    submitBtn.style.background = '#10B981';
                }
            }
        }

        // Function to show detailed attendance success popup
        function showAttendanceSuccessPopup(data) {
            // Get teacher information
            const teacherData = JSON.parse(sessionStorage.getItem('teacherData') || '{}');
            const teacherName = `${teacherData.firstName || ''} ${teacherData.lastName || ''}`.trim() || 'Teacher';
            
            // Department name mapping
            const departmentNames = {
                'ME': 'Mechanical Engineering',
                'CT': 'Computer Technology',
                'IT': 'Information Technology',
                'EE': 'Electrical Engineering',
                'ET': 'Electronics & Telecommunication',
                'AI': 'Artificial Intelligence',
                'CE': 'Civil Engineering'
            };
            
            // Year name mapping
            const yearNames = {
                'FY': 'First Year',
                'SY': 'Second Year',
                'TY': 'Third Year',
                'BE': 'Final Year'
            };
            
            // Create popup HTML
            const popupHTML = `
                <div id="attendanceSuccessModal" class="attendance-success-modal">
                    <div class="modal-overlay" onclick="closeAttendanceSuccessModal()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h2>Attendance Submitted Successfully!</h2>
                            <button class="close-btn" onclick="closeAttendanceSuccessModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="modal-body">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-user-tie"></i>
                                        Teacher Name
                                    </div>
                                    <div class="detail-value">${teacherName}</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-building"></i>
                                        Department
                                    </div>
                                    <div class="detail-value">${departmentNames[data.department] || data.department}</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-graduation-cap"></i>
                                        Year
                                    </div>
                                    <div class="detail-value">${yearNames[data.year] || data.year}</div>
                                </div>
                                
                                ${data.division ? `
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-users"></i>
                                        Division
                                    </div>
                                    <div class="detail-value">Division ${data.division}</div>
                                </div>
                                ` : ''}
                                
                                ${data.batch ? `
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-layer-group"></i>
                                        Batch
                                    </div>
                                    <div class="detail-value">${data.batch}</div>
                                </div>
                                ` : ''}
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-book"></i>
                                        Subject
                                    </div>
                                    <div class="detail-value">${data.subject}</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-calendar-alt"></i>
                                        Date
                                    </div>
                                    <div class="detail-value">${new Date(data.date).toLocaleDateString('en-IN')}</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-clock"></i>
                                        Time
                                    </div>
                                    <div class="detail-value">${data.sessionTime}</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-envelope"></i>
                                        Email Notification
                                    </div>
                                    <div class="detail-value">
                                        ${data.emailSent ? 
                                            '<span style="color: #10B981;"><i class="fas fa-check-circle"></i> Sent Successfully</span>' : 
                                            '<span style="color: #F59E0B;"><i class="fas fa-exclamation-triangle"></i> Not Sent</span>'
                                        }
                                    </div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                        Lecture Type
                                    </div>
                                    <div class="detail-value">${data.lectureType.charAt(0).toUpperCase() + data.lectureType.slice(1)}</div>
                                </div>
                            </div>
                            
                            <div class="attendance-summary">
                                <h3>Attendance Summary</h3>
                                <div class="summary-grid">
                                    <div class="summary-item present">
                                        <div class="summary-icon">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div class="summary-details">
                                            <div class="summary-count">${data.presentCount}</div>
                                            <div class="summary-label">Present</div>
                                        </div>
                                    </div>
                                    
                                    <div class="summary-item absent">
                                        <div class="summary-icon">
                                            <i class="fas fa-times-circle"></i>
                                        </div>
                                        <div class="summary-details">
                                            <div class="summary-count">${data.absentCount}</div>
                                            <div class="summary-label">Absent</div>
                                        </div>
                                    </div>
                                    
                                    <div class="summary-item total">
                                        <div class="summary-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="summary-details">
                                            <div class="summary-count">${data.totalStudents}</div>
                                            <div class="summary-label">Total Students</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="percentage-bar">
                                    <div class="percentage-fill" style="width: ${(data.presentCount / data.totalStudents * 100)}%"></div>
                                    <div class="percentage-text">${Math.round(data.presentCount / data.totalStudents * 100)}% Present</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn-primary" onclick="closeAttendanceSuccessModal()">
                                <i class="fas fa-check"></i>
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add popup to body
            document.body.insertAdjacentHTML('beforeend', popupHTML);
            
            // Show popup with animation
            setTimeout(() => {
                document.getElementById('attendanceSuccessModal').classList.add('show');
            }, 100);
        }
        
        // Function to close attendance success modal
        function closeAttendanceSuccessModal() {
            const modal = document.getElementById('attendanceSuccessModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // ❌ REMOVED updateAttendance function - NO AUTO SAVE ALLOWED!
        // All attendance saving now happens ONLY through submitAttendance() function

        // Load teacher's classes into the select dropdown
        function loadTeacherClasses() {
            console.log('Loading teacher classes');
            
            const classSelect = document.getElementById('class');
            if (!classSelect) {
                console.log('Class select element not found');
                return;
            }

            // Show loading state
            classSelect.innerHTML = '<option value="">Loading classes...</option>';
            
            // Get teacher ID from session storage
            const teacherId = sessionStorage.getItem('teacherId');
            if (!teacherId) {
                console.error('Teacher ID not found in session');
                classSelect.innerHTML = '<option value="">Error: Please refresh page</option>';
                return;
            }
            
            console.log('Teacher ID:', teacherId);
            
            // Use stored teacher data if available
            const storedTeacherData = sessionStorage.getItem('teacherData');
            if (storedTeacherData) {
                const teacherData = JSON.parse(storedTeacherData);
                console.log('Using stored teacher data:', teacherData);
                
                if (teacherData && teacherData.classes) {
                    classSelect.innerHTML = '<option value="">-- Select Class --</option>';
                    
                    if (teacherData.classes.length > 0) {
                        console.log('Classes found:', teacherData.classes);
                        teacherData.classes.forEach(className => {
                            classSelect.innerHTML += `<option value="${className}">${className}</option>`;
                        });
                    } else {
                        console.log('No classes assigned');
                        classSelect.innerHTML = '<option value="">No classes assigned</option>';
                    }
                    return;
                }
            }
            
            console.log('Fetching teacher data from Firebase');
            
            // Fetch teacher data if not available
            db.ref('teachers/' + teacherId).once('value')
                .then((snapshot) => {
                    console.log('Firebase response:', snapshot.val());
                    
                    if (snapshot.exists()) {
                        const teacher = snapshot.val();
                        teacherData = teacher; // Update global teacherData
                        
                        classSelect.innerHTML = '<option value="">-- Select Class --</option>';
                        
                        if (teacher.classes && teacher.classes.length > 0) {
                            console.log('Classes found:', teacher.classes);
                            teacher.classes.forEach(className => {
                                classSelect.innerHTML += `<option value="${className}">${className}</option>`;
                            });
                        } else {
                            console.log('No classes assigned');
                            classSelect.innerHTML = '<option value="">No classes assigned</option>';
                        }
                    } else {
                        console.log('Teacher data not found');
                        classSelect.innerHTML = '<option value="">Error loading classes</option>';
                    }
                })
                .catch((error) => {
                    console.error('Error loading classes:', error);
                    classSelect.innerHTML = '<option value="">Error loading classes</option>';
                });
        }

        // Function to show loading overlay
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'flex';
        }

        // Function to hide loading overlay
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // Function to show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function loadSettingsContent() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="header">
                    <h1 class="page-title">Settings</h1>
                </div>
                <div class="settings-container">
                    <div class="settings-header">
                        <i class="fas fa-user-cog"></i>
                        <h2>Account Settings</h2>
                    </div>
                    <div class="settings-section">
                        <h3>
                            <i class="fas fa-lock"></i>
                            Change Password
                        </h3>
                        <form id="passwordForm" class="password-form" onsubmit="changePassword(event)">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" required 
                                    placeholder="Enter your current password">
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" required 
                                    placeholder="Enter your new password"
                                    onkeyup="checkPasswordStrength()">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" required 
                                    placeholder="Confirm your new password">
                            </div>
                            <div class="password-requirements">
                                <div class="title">
                                    <i class="fas fa-shield-alt"></i>
                                    Password Requirements
                                </div>
                                <ul id="passwordChecklist">
                                    <li id="lengthCheck">
                                        <i class="fas fa-circle"></i>
                                        At least 8 characters
                                    </li>
                                    <li id="upperCheck">
                                        <i class="fas fa-circle"></i>
                                        At least one uppercase letter
                                    </li>
                                    <li id="lowerCheck">
                                        <i class="fas fa-circle"></i>
                                        At least one lowercase letter
                                    </li>
                                    <li id="numberCheck">
                                        <i class="fas fa-circle"></i>
                                        At least one number
                                    </li>
                                    <li id="specialCheck">
                                        <i class="fas fa-circle"></i>
                                        At least one special character
                                    </li>
                                </ul>
                            </div>
                            <button type="submit" class="submit-btn" id="changePasswordBtn">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            
            // Check length
            const lengthValid = password.length >= 8;
            updateCheckmark('lengthCheck', lengthValid);
            
            // Check uppercase
            const upperValid = /[A-Z]/.test(password);
            updateCheckmark('upperCheck', upperValid);
            
            // Check lowercase
            const lowerValid = /[a-z]/.test(password);
            updateCheckmark('lowerCheck', lowerValid);
            
            // Check numbers
            const numberValid = /[0-9]/.test(password);
            updateCheckmark('numberCheck', numberValid);
            
            // Check special characters
            const specialValid = /[!@#$%^&*]/.test(password);
            updateCheckmark('specialCheck', specialValid);
        }

        function updateCheckmark(id, isValid) {
            const element = document.getElementById(id);
            if (isValid) {
                element.classList.add('valid');
                element.querySelector('i').className = 'fas fa-check-circle';
            } else {
                element.classList.remove('valid');
                element.querySelector('i').className = 'fas fa-circle';
            }
        }

        async function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords
            if (newPassword !== confirmPassword) {
                showErrorMessage('New passwords do not match');
                return;
            }
            
            // Check password requirements
            if (!isPasswordValid(newPassword)) {
                showErrorMessage('Please meet all password requirements');
                return;
            }

            // Disable submit button
            const submitBtn = document.getElementById('changePasswordBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
            
            try {
                // Get teacher data from session
                const teacherKey = sessionStorage.getItem('teacherKey');
                const teacherDataStr = sessionStorage.getItem('teacherData');
                
                if (!teacherKey || !teacherDataStr) {
                    showErrorMessage('Session expired. Please login again.');
                    window.location.href = 'teacher-login.html';
                    return;
                }
                
                const teacherData = JSON.parse(teacherDataStr);
                
                // Verify current password
                if (teacherData.initialPassword !== currentPassword) {
                    showErrorMessage('Current password is incorrect');
                    return;
                }

                // Update password in database
                await firebase.database().ref('teachers/' + teacherKey).update({
                    initialPassword: newPassword,
                    lastPasswordChange: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Update session storage with new password
                teacherData.initialPassword = newPassword;
                sessionStorage.setItem('teacherData', JSON.stringify(teacherData));
                
                // Show success message
                showSuccessMessage('Password changed successfully!');
                
                // Clear form
                document.getElementById('passwordForm').reset();
                
                // Reset password strength indicators
                const checklistItems = document.querySelectorAll('#passwordChecklist li');
                checklistItems.forEach(item => {
                    item.classList.remove('valid');
                    item.querySelector('i').className = 'fas fa-circle';
                });
                
                console.log('Password changed successfully for teacher:', teacherData.firstName);
                
            } catch (error) {
                console.error('Error changing password:', error);
                let errorMessage = 'Error changing password. Please try again.';
                
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Current password is incorrect';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'New password is too weak';
                        break;
                    case 'auth/requires-recent-login':
                        errorMessage = 'Please login again before changing password';
                        setTimeout(() => {
                            firebase.auth().signOut().then(() => {
                                window.location.href = 'teacher-login.html';
                            });
                        }, 2000);
                        break;
                    case 'auth/internal-error':
                        errorMessage = 'Please login again and try changing password';
                        setTimeout(() => {
                            firebase.auth().signOut().then(() => {
                                window.location.href = 'teacher-login.html';
                            });
                        }, 2000);
                        break;
                }
                
                showErrorMessage(errorMessage);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';
            }
        }

        function isPasswordValid(password) {
            return password.length >= 8 &&
                   /[A-Z]/.test(password) &&
                   /[a-z]/.test(password) &&
                   /[0-9]/.test(password) &&
                   /[!@#$%^&*]/.test(password);
        }

        // Function to update dashboard stats
        async function updateDashboardStats() {
            try {
                const totalStudentsElement = document.getElementById('totalStudents');
                const totalClassesElement = document.getElementById('totalClasses');
                const averageAttendanceElement = document.getElementById('averageAttendance');
                const recentActivitiesElement = document.getElementById('recentActivities');

                // Get teacher's assigned classes
                const teacherClasses = teacherData.classes || [];
                console.log('Teacher Classes:', teacherClasses);

                // Get total students count
                const studentsSnapshot = await firebase.database().ref('students').once('value');
                let totalStudents = 0;
                const students = studentsSnapshot.val() || {};

                Object.values(students).forEach(student => {
                    // Get student's class code
                    const studentYear = (student.year || '').toString().toUpperCase();
                    const studentDept = (student.department || student.branch || '').toString().toUpperCase();
                    
                    // Convert year format
                    let yearCode = '';
                    if (['FIRST', 'FIRST YEAR', '1'].includes(studentYear)) yearCode = 'FY';
                    else if (['SECOND', 'SECOND YEAR', '2'].includes(studentYear)) yearCode = 'SY';
                    else if (['THIRD', 'THIRD YEAR', '3'].includes(studentYear)) yearCode = 'TY';
                    else if (['FOURTH', 'FOURTH YEAR', '4', 'BE'].includes(studentYear)) yearCode = 'BE';
                    else yearCode = studentYear;

                    // Check if student's year matches any of teacher's assigned years
                    if (teacherClasses.includes(yearCode)) {
                        totalStudents++;
                    }
                });

                // Update UI elements if they exist
                if (totalStudentsElement) {
                    totalStudentsElement.textContent = totalStudents;
                }
                if (totalClassesElement) {
                    totalClassesElement.textContent = teacherClasses.length;
                }

                // Get average attendance
                const attendanceSnapshot = await firebase.database()
                    .ref('attendance')
                    .orderByChild('teacherId')
                    .equalTo(teacherId)
                    .once('value');

                let totalAttendance = 0;
                let attendanceCount = 0;

                attendanceSnapshot.forEach(record => {
                    const data = record.val();
                    const students = data.students || {};
                    const totalStudents = Object.keys(students).length;
                    const presentStudents = Object.values(students).filter(status => status === true).length;
                    if (totalStudents > 0) {
                        totalAttendance += (presentStudents / totalStudents) * 100;
                        attendanceCount++;
                    }
                });

                const averageAttendance = attendanceCount > 0 ? Math.round(totalAttendance / attendanceCount) : 0;

                if (averageAttendanceElement) {
                    averageAttendanceElement.textContent = `${averageAttendance}%`;
                }

                // Update recent activities
                if (recentActivitiesElement) {
                    const activitiesSnapshot = await firebase.database()
                        .ref('activities')
                        .orderByChild('teacherId')
                        .equalTo(teacherId)
                        .limitToLast(5)
                        .once('value');

                    const activities = [];
                    activitiesSnapshot.forEach(activity => {
                        activities.unshift({
                            id: activity.key,
                            ...activity.val()
                        });
                    });

                    if (activities.length > 0) {
                        recentActivitiesElement.innerHTML = activities.map(activity => `
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-${getActivityIcon(activity.type)}"></i>
                                </div>
                                <div class="activity-details">
                                    <div class="activity-title">${activity.title}</div>
                                    <div class="activity-time">${formatActivityTime(activity.timestamp)}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        recentActivitiesElement.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <p>No recent activities</p>
                            </div>
                        `;
                    }
                }

            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Helper function to get activity icon
        function getActivityIcon(type) {
            switch (type) {
                case 'attendance':
                    return 'clipboard-check';
                case 'report':
                    return 'chart-bar';
                default:
                    return 'bell';
            }
        }

        // Helper function to format activity time
        function formatActivityTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 24) {
                if (diffInHours < 1) {
                    const diffInMinutes = Math.floor((now - date) / (1000 * 60));
                    return `${diffInMinutes} minutes ago`;
                }
                return `${diffInHours} hours ago`;
            }
            
            return date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // Add helper function to get year full name
        function getYearFullName(year) {
            const yearMap = {
                'FY': 'First Year',
                'SY': 'Second Year',
                'TY': 'Third Year',
                'BE': 'Final Year'
            };
            return yearMap[year] || year;
        }

        // Add function to update division visibility in reports
        function updateReportDivisionVisibility() {
            const departmentSelect = document.getElementById('reportDepartment');
            const divisionGroup = document.getElementById('reportDivisionGroup');
            
            if (!departmentSelect || !divisionGroup) return;
            
            const selectedDepartment = departmentSelect.value;
            
            if (selectedDepartment === 'CT') {
                divisionGroup.style.display = 'block';
            } else {
                divisionGroup.style.display = 'none';
                const divisionSelect = document.getElementById('reportDivision');
                if (divisionSelect) {
                    divisionSelect.value = '';
                }
            }
            
            loadAttendanceReport();
        }

        // 📊 Complete Attendance Report Loading Function
        async function loadAttendanceReport() {
            console.log('📊 Loading attendance report...');
            
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) {
                console.error('❌ Report content element not found');
                return;
            }

            // Show loading state
            reportContent.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading attendance reports...</p>
                </div>
            `;

            try {
                // Get filter values
                const department = document.getElementById('reportDepartment')?.value || '';
                const year = document.getElementById('reportYear')?.value || '';
                const division = document.getElementById('reportDivision')?.value || '';
                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                
                // Get teacher info
                const teacherKey = sessionStorage.getItem('teacherKey');
                const teacherData = JSON.parse(sessionStorage.getItem('teacherData') || '{}');
                
                if (!teacherKey) {
                    throw new Error('Teacher not logged in');
                }

                if (!startDate || !endDate) {
                    reportContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <p>Please select date range</p>
                            <div class="subtitle">Choose start and end dates to view reports</div>
                        </div>
                    `;
                    return;
                }

                console.log('🔍 Filters:', { department, year, division, startDate, endDate, teacherKey });

                // Load attendance data from Firebase
                const attendanceSnapshot = await firebase.database().ref('attendance').once('value');
                const attendanceData = attendanceSnapshot.val() || {};
                
                console.log('📦 Raw attendance data loaded:', Object.keys(attendanceData).length, 'records');

                // Filter attendance records
                const filteredRecords = [];
                Object.entries(attendanceData).forEach(([key, record]) => {
                    // Teacher-specific filter (CRITICAL)
                    if (record.teacherId !== teacherKey) {
                        return; // Skip other teachers' records
                    }

                    // Date filter
                    if (record.date && startDate && endDate) {
                        if (record.date < startDate || record.date > endDate) {
                            return; // Skip records outside date range
                        }
                    }

                    // Department filter
                    if (department) {
                        const recordDept = extractDepartmentFromClass(record.class || record.department || '');
                        if (recordDept !== department) {
                            return; // Skip different departments
                        }
                    }

                    // Year filter
                    if (year) {
                        const recordYear = extractYearFromClass(record.class || record.year || '');
                        if (recordYear !== year) {
                            return; // Skip different years
                        }
                    }

                    // Division filter (only for CT department)
                    if (division && department === 'CT') {
                        const recordDivision = extractDivisionFromClass(record.class || record.division || '');
                        if (recordDivision !== division) {
                            return; // Skip different divisions
                        }
                    }

                    // Add record with key
                    filteredRecords.push({ key, ...record });
                });

                console.log('✅ Filtered records:', filteredRecords.length);

                if (filteredRecords.length === 0) {
                    reportContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>No attendance records found</p>
                            <div class="subtitle">Try adjusting your filters or date range</div>
                        </div>
                    `;
                    return;
                }

                // Generate report table
                let tableHTML = `
                    <div class="report-summary">
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="summary-info">
                                <div class="summary-count">${filteredRecords.length}</div>
                                <div class="summary-label">Total Records</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="summary-info">
                                <div class="summary-count">${filteredRecords.reduce((sum, r) => sum + (r.presentCount || 0), 0)}</div>
                                <div class="summary-label">Total Present</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="summary-info">
                                <div class="summary-count">${filteredRecords.reduce((sum, r) => sum + (r.absentCount || 0), 0)}</div>
                                <div class="summary-label">Total Absent</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Class</th>
                                    <th>Type</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Total</th>
                                    <th>%</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Sort records by date (newest first)
                filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                filteredRecords.forEach(record => {
                    const percentage = record.totalStudents > 0 
                        ? Math.round((record.presentCount / record.totalStudents) * 100)
                        : 0;
                    
                    const percentageClass = percentage >= 75 ? 'high' : percentage >= 50 ? 'medium' : 'low';
                    
                    tableHTML += `
                        <tr>
                            <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
                            <td><strong>${record.subject || 'N/A'}</strong></td>
                            <td>${record.class || 'N/A'}</td>
                            <td>
                                <span class="lecture-type ${record.lectureType}">
                                    ${record.lectureType === 'theory' ? 'Theory' : 'Practical'}
                                </span>
                            </td>
                            <td class="text-success"><strong>${record.presentCount || 0}</strong></td>
                            <td class="text-danger"><strong>${record.absentCount || 0}</strong></td>
                            <td>${record.totalStudents || 0}</td>
                            <td>
                                <span class="percentage ${percentageClass}">${percentage}%</span>
                            </td>
                            <td>
                                <button class="delete-btn" onclick="deleteAttendanceRecord('${record.key}', '${record.date}', '${record.subject}', '${record.class}')" title="Delete Attendance Record">
                                    <i class="fas fa-trash-alt"></i>
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                reportContent.innerHTML = tableHTML;
                console.log('✅ Report table generated successfully');

            } catch (error) {
                console.error('❌ Error loading attendance report:', error);
                reportContent.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading reports</p>
                        <div class="subtitle">${error.message}</div>
                    </div>
                `;
            }
        }

        // Helper functions for class parsing
        function extractDepartmentFromClass(classCode) {
            if (!classCode) return '';
            const match = classCode.match(/[A-Z]{2,3}/);
            return match ? match[0] : '';
        }

        function extractYearFromClass(classCode) {
            if (!classCode) return '';
            if (classCode.includes('FY') || classCode.includes('1')) return 'FY';
            if (classCode.includes('SY') || classCode.includes('2')) return 'SY';
            if (classCode.includes('TY') || classCode.includes('3')) return 'TY';
            if (classCode.includes('BE') || classCode.includes('4')) return 'BE';
            return '';
        }

        function extractDivisionFromClass(classCode) {
            if (!classCode) return '';
            const match = classCode.match(/-([ABC])/);
            return match ? match[1] : '';
        }

        // 🗑️ Delete Attendance Record Function
        async function deleteAttendanceRecord(recordKey, date, subject, className) {
            if (!recordKey) {
                alert('Invalid record key');
                return;
            }

            const confirmMessage = `Are you sure you want to delete this attendance record?\n\nDate: ${new Date(date).toLocaleDateString('en-IN')}\nSubject: ${subject}\nClass: ${className}`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                console.log('🗑️ Deleting attendance record:', recordKey);
                
                // Delete from Firebase
                await firebase.database().ref(`attendance/${recordKey}`).remove();
                
                console.log('✅ Attendance record deleted successfully');
                
                // Show success message
                alert('Attendance record deleted successfully!');
                
                // Reload the reports to reflect changes
                loadAttendanceReport();
                
            } catch (error) {
                console.error('❌ Error deleting attendance record:', error);
                alert('Error deleting attendance record. Please try again.');
            }
        }
    </script>
    
    <script>
        // Page initialization - preserve current page on refresh
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded, initializing...');
            
            // Get current hash or default to dashboard
            const currentHash = window.location.hash.slice(1);
            
            if (currentHash && currentHash !== 'dashboard') {
                console.log('📍 Preserving current page:', currentHash);
                // Page refresh - stay on current page (take-attendance, view-reports, etc.)
                // Don't call handleHashChange() to avoid double loading
            } else {
                console.log('📍 Loading dashboard (fresh visit or dashboard refresh)');
                // Fresh visit or dashboard refresh - load dashboard
                if (!currentHash) {
                    window.location.hash = 'dashboard';
                }
            }
        });
    </script>
    
    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
</body>
</html>

