<!DOCTYPE html>
<script>
// Force Firebase Online Mode
(function() {
    // Always force online mode
    window.firebaseOfflineMode = false;
    console.log('üî• Firebase online mode forced - will connect to real database');
    
    // Wait for Firebase SDK to load
    let attempts = 0;
    const maxAttempts = 50;
    
    function checkFirebaseSDK() {
        attempts++;
        if (typeof window.firebase !== 'undefined' && window.firebase.apps) {
            console.log('‚úÖ Firebase SDK loaded successfully after', attempts, 'attempts');
            return;
        }
        
        if (attempts < maxAttempts) {
            setTimeout(checkFirebaseSDK, 100);
        } else {
            console.error('‚ùå Firebase SDK failed to load after', maxAttempts, 'attempts');
        }
    }
    
    checkFirebaseSDK();
})();
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Reports - BVIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- XLSX Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDKs: Add these at the top -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --bg-light: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-light);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            margin-bottom: 40px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
            color: var(--white);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 10px;
            text-transform: none;
            letter-spacing: normal;
            background: none;
            -webkit-text-fill-color: unset;
        }

        .page-subtitle {
            color: var(--white);
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
            font-weight: normal;
        }

        /* Remove unused styles */
        .title-section, .subtitle-section, .floating-shapes {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-header {
                padding: 15px;
                margin-bottom: 30px;
            }

            .page-title {
                font-size: 2rem;
            }

            .page-subtitle {
                font-size: 1rem;
            }
        }

        .filter-container {
            background: var(--white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.95rem;
        }

        select, input[type="date"] {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-dark);
            background: var(--bg-light);
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background: var(--white);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 20px;
            text-align: center;
        }

        .table-container {
            background: var(--white);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        /* Toggle button styles */
        .view-toggle-section {
            margin-bottom: 20px;
            text-align: center;
        }

        .toggle-buttons {
            display: inline-flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .toggle-btn.active {
            background: #059669 !important;
            color: white !important;
        }

        .toggle-btn:not(.active) {
            background: transparent;
            color: #374151;
        }

        /* Modern table styles */
        .attendance-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .attendance-table th {
            background: #4F46E5;
            color: white;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attendance-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #E5E7EB;
            font-size: 0.95rem;
            color: #1F2937;
        }

        .attendance-table tr:last-child td {
            border-bottom: none;
        }

        .attendance-table tr:hover {
            background: #F9FAFB;
        }

        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge.good {
            background: #DCFCE7;
            color: #15803D;
        }

        .status-badge.low {
            background: #FEF3C7;
            color: #B45309;
        }

        .status-badge.critical {
            background: #FEE2E2;
            color: #B91C1C;
        }

        /* Attendance counts */
        .attendance-count {
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .attendance-count i {
            font-size: 1rem;
        }

        .attendance-count.present {
            color: #15803D;
        }

        .attendance-count.absent {
            color: #B91C1C;
        }

        .attendance-count.total {
            color: #4F46E5;
        }

        /* Percentage column */
        .attendance-percentage {
            font-weight: 600;
            color: #1F2937;
        }

        /* Student info */
        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-roll {
            width: 40px;
            height: 40px;
            background: #EEF2FF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #4F46E5;
            font-size: 0.9rem;
        }

        .student-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .student-name {
            font-weight: 600;
            color: #111827;
        }

        .student-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6B7280;
            font-size: 0.85rem;
        }

        .student-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .student-meta i {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Export button */
        .export-btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
            margin-bottom: 20px;
        }

        .export-btn:hover {
            background: #4338CA;
            transform: translateY(-2px);
        }

        .export-btn i {
            font-size: 1.1rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        /* Present/Absent Status Colors */
        .text-success {
            color: #10B981 !important;
            font-weight: bold;
        }
        
        .text-danger {
            color: #EF4444 !important;
            font-weight: bold;
        }
        
        .text-warning {
            color: #F59E0B !important;
            font-weight: bold;
        }
        
        /* Status specific styling */
        .status-present {
            background-color: #D1FAE5;
            color: #065F46;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status-absent {
            background-color: #FEE2E2;
            color: #991B1B;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .export-section {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        .attendance-filters {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Pagination Styles */
        .pagination-container {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-btn {
            background: var(--white);
            border: 2px solid var(--border);
            color: var(--text-dark);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .page-number {
            background: var(--white);
            border: 2px solid var(--border);
            color: var(--text-dark);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }

        .page-number:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-number.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .records-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .records-per-page label {
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .records-per-page select {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--white);
            color: var(--text-dark);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                text-align: center;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .percentage-filter {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .percentage-input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .percentage-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .group-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
        }

        .edit-btn:hover {
            background: var(--primary);
            color: white;
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        .delete-btn:hover {
            background: #EF4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            }

        .modal-form {
            display: flex;
                flex-direction: column;
                gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dark);
            }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px auto;
            }

            .page-title {
                font-size: 2rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 20px;
            }
            .attendance-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .student-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }

        /* Edit Attendance Modal Styles */
        .student-info {
            background: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .student-info p {
            margin: 5px 0;
            font-size: 0.95rem;
        }

        .attendance-edit {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .attendance-edit .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .attendance-edit label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .attendance-edit input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }

        .attendance-preview {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--secondary);
        }

        .attendance-preview p {
            margin: 0;
            font-size: 1.1rem;
        }

        #newPercentage {
            color: var(--secondary);
            font-weight: bold;
        }

        /* Attendance Records Styles */
        .attendance-records h4 {
            margin: 15px 0 10px 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .attendance-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: var(--bg-light);
            border-radius: 8px;
            border-left: 4px solid #e5e7eb;
        }

        .record-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .record-date {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .record-subject {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .record-type {
            color: var(--primary);
            font-size: 0.8rem;
            background: #e0e7ff;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .status-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-btn.present {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status-btn.present:hover {
            background: #bbf7d0;
        }

        .status-btn.absent {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status-btn.absent:hover {
            background: #fecaca;
        }

        .attendance-summary {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }

        .attendance-summary p {
            margin: 0;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Attendance Reports</h1>
            <p class="page-subtitle">View and analyze student attendance data</p>
        </div>

        <!-- Filters Section -->
        <div class="filter-container">
            <h3 class="filter-title">
                <i class="fas fa-filter"></i>
                Filter Reports
            </h3>
            <div class="filter-grid">
                <div class="form-group">
                    <label for="department">Department</label>
                    <select id="department" onchange="updateDivisionOptions()">
                        <option value="">All Departments</option>
                        <option value="CT">Computer Technology</option>
                        <option value="IT">Information Technology (IT)</option>
                        <option value="ME">Mechanical Engineering</option>
                        <option value="CE">Civil Engineering</option>
                        <option value="EE">Electrical Engineering (EE)</option>
                        <option value="ET">Electronics & Telecommunication (ET)</option>
                        <option value="AI">Artificial Intelligence (AI)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <select id="year">
                        <option value="">All Years</option>
                        <option value="FY">First Year</option>
                        <option value="SY">Second Year</option>
                        <option value="TY">Third Year</option>
                        <option value="BE">Final Year</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="division">Division</label>
                    <select id="division" disabled>
                        <option value="">All Divisions</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lectureType">Lecture Type</label>
                    <select id="lectureType">
                        <option value="">All Lectures</option>
                        <option value="theory">Theory</option>
                        <option value="practical">Practical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="batch">Batch</label>
                    <select id="batch">
                        <option value="">All Batches</option>
                        <option value="A">Batch A</option>
                        <option value="B">Batch B</option>
                        <option value="C">Batch C</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subject">Subject</label>
                    <input type="text" id="subject" placeholder="Enter subject name" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="form-group">
                    <label for="startDate">From Date</label>
                    <input type="date" id="startDate" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}">
                </div>
                <div class="form-group">
                    <label for="endDate">To Date</label>
                    <input type="date" id="endDate" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}">
                </div>
                <div class="form-group">
                    <label for="percentageFilter">Attendance Filter</label>
                    <select id="percentageFilter">
                        <option value="">All Students</option>
                        <option value="50">Below 50%</option>
                        <option value="60">Below 60%</option>
                        <option value="70">Below 70%</option>
                        <option value="75">Below 75%</option>
                        <option value="85">Below 85%</option>
                        <option value="custom">Custom Percentage</option>
                    </select>
                </div>
                <div class="form-group" id="customPercentageGroup" style="display: none;">
                    <label for="customPercentage">Custom Percentage</label>
                    <div class="input-group">
                        <input type="number" id="customPercentage" min="0" max="100" step="1" placeholder="Enter percentage">
                        <span class="input-group-text">%</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- Export Button Only -->
        <div class="action-buttons" style="margin: 20px 0; text-align: center;">
            <button onclick="exportToExcel()" class="btn btn-success">
                <i class="fas fa-file-excel"></i>
                Export to Excel
            </button>
        </div>



        <!-- View Toggle Section -->
        <div class="view-toggle-section" style="margin-bottom: 20px; text-align: center;">
            <div class="toggle-buttons" style="display: inline-flex; background: #f3f4f6; border-radius: 8px; padding: 4px;">
                <button id="subjectViewBtn" class="toggle-btn active" onclick="switchView('subject')" 
                        style="padding: 8px 16px; border: none; border-radius: 6px; background: #059669; color: white; cursor: pointer; margin-right: 4px;">
                    <i class="fas fa-list"></i> Subject-wise View
                </button>
                <button id="combinedViewBtn" class="toggle-btn" onclick="switchView('combined')" 
                        style="padding: 8px 16px; border: none; border-radius: 6px; background: transparent; color: #374151; cursor: pointer;">
                    <i class="fas fa-compress-alt"></i> Combined View
                </button>
            </div>
        </div>

        <!-- Table Section -->
                <div class="table-container">
            <table class="attendance-table">
                        <thead>
                    <tr>
                        <th rowspan="2">
                            <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                        </th>
                        <th rowspan="2">Roll No</th>
                        <th rowspan="2">Name</th>
                        <th rowspan="2">Department</th>
                        <th rowspan="2">Year</th>
                        <th rowspan="2">Division</th>
                        <th colspan="4" style="background: #059669; color: white;">Theory Classes</th>
                        <th colspan="4" style="background: #DC2626; color: white;">Practical Classes</th>
                        <th rowspan="2">Overall %</th>
                        <th rowspan="2">Actions</th>
                    </tr>
                    <tr>
                        <th style="background: #059669; color: white;">Present</th>
                        <th style="background: #059669; color: white;">Absent</th>
                        <th style="background: #059669; color: white;">Total</th>
                        <th style="background: #059669; color: white;">%</th>
                        <th style="background: #DC2626; color: white;">Present</th>
                        <th style="background: #DC2626; color: white;">Absent</th>
                        <th style="background: #DC2626; color: white;">Total</th>
                        <th style="background: #DC2626; color: white;">%</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <tr>
                        <td colspan="16" class="text-center p-4">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>Click "Load Reports" to view attendance data</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-container" id="paginationContainer" style="display: none;">
        <div class="pagination-info">
            <span id="paginationInfo">Showing 1-100 of 0 records</span>
        </div>
        <div class="pagination-controls">
            <button id="firstPageBtn" class="pagination-btn" onclick="goToPage(1)" disabled>
                <i class="fas fa-angle-double-left"></i> First
            </button>
            <button id="prevPageBtn" class="pagination-btn" onclick="goToPage(currentPage - 1)" disabled>
                <i class="fas fa-angle-left"></i> Previous
            </button>
            <span class="page-numbers" id="pageNumbers"></span>
            <button id="nextPageBtn" class="pagination-btn" onclick="goToPage(currentPage + 1)" disabled>
                Next <i class="fas fa-angle-right"></i>
            </button>
            <button id="lastPageBtn" class="pagination-btn" onclick="goToPage(totalPages)" disabled>
                Last <i class="fas fa-angle-double-right"></i>
            </button>
        </div>
        <div class="records-per-page">
            <label for="recordsPerPage">Records per page:</label>
            <select id="recordsPerPage" onchange="changeRecordsPerPage()">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
            </select>
        </div>
    </div>

    <script>
        // Use the global waitForFirebase function from firebase-config.js
        // No local function needed - just use window.waitForFirebase directly
        // Department mapping - same as in student and teacher sections
        const departmentFullNames = {
            'CT': 'Computer Technology',
            'IT': 'Information Technology',
            'ME': 'Mechanical Engineering', 
            'CE': 'Civil Engineering',
            'EE': 'Electrical Engineering',
            'ET': 'Electronics & Telecommunication',
            'AI': 'Artificial Intelligence',
            'CM': 'Computer Technology',
            'CIVIL': 'Civil Engineering',
            'COMP': 'Computer Technology',
            'MECH': 'Mechanical Engineering',
            'ENTC': 'Electronics & Telecommunication'
        };

        // Function to get department full name
        function getDepartmentFullName(code) {
            if (!code) return '-';
            // First try exact match
            if (departmentFullNames[code]) {
                return departmentFullNames[code];
            }
            // Try uppercase
            if (departmentFullNames[code.toUpperCase()]) {
                return departmentFullNames[code.toUpperCase()];
            }
            // If no match found, return the code itself
            console.log('Department code not found in mapping:', code);
            return code;
        }

        function getDepartmentCode(fullName) {
            const departmentMap = {
                'Computer Technology': 'CT',
                'Information Technology': 'IT',
                'Mechanical Engineering': 'ME',
                'Civil Engineering': 'CE',
                'Electrical Engineering': 'EE',
                'Electronics & Telecommunication': 'ET',
                'Artificial Intelligence': 'AI'
            };
            return departmentMap[fullName] || fullName;
        }

        function getYearCode(yearName) {
            const yearMap = {
                'First': 'FY',
                'Second': 'SY',
                'Third': 'TY',
                'Fourth': 'BE',
                'FY': 'FY',
                'SY': 'SY',
                'TY': 'TY',
                'BE': 'BE'
            };
            return yearMap[yearName] || yearName;
        }

        // Add this to your existing styles
        const additionalStyles = `
            .input-group {
                display: flex;
                align-items: center;
            }
            .input-group-text {
                padding: 8px 12px;
                background: #f3f4f6;
                border: 1px solid #e5e7eb;
                border-left: none;
                border-radius: 0 8px 8px 0;
            }
            #customPercentage {
                border-radius: 8px 0 0 8px;
            }
            .export-buttons .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
            .btn-success {
                background: #10B981;
                color: white;
            }
            .btn-success:hover {
                background: #059669;
            }
            .btn-danger {
                background: #EF4444;
                color: white;
            }
            .btn-danger:hover {
                background: #DC2626;
            }
        `;

        // Add styles to document
        const styleSheet = document.createElement("style");
        styleSheet.innerText = additionalStyles;
        document.head.appendChild(styleSheet);
        
        console.log('Firebase services ready');

        // Check authentication
        async function checkAuth() {
            console.log('Checking authentication...');
            
            // Wait for Firebase initialization
            if (typeof window.waitForFirebase === 'function') {
                await window.waitForFirebase();
            }
            
            const isAdminLoggedIn = sessionStorage.getItem('isAdminLoggedIn');
            const isTeacherLoggedIn = sessionStorage.getItem('isTeacherLoggedIn');
            const userRole = sessionStorage.getItem('userRole');
            const adminId = sessionStorage.getItem('adminId');
            const teacherId = sessionStorage.getItem('teacherId');
            
            console.log('Session storage:', { 
                isAdminLoggedIn, 
                isTeacherLoggedIn, 
                userRole, 
                adminId, 
                teacherId 
            });
            
            // Enhanced admin detection
            const isAdmin = isAdminLoggedIn === 'true' || userRole === 'admin' || adminId;
            const isTeacher = isTeacherLoggedIn === 'true' || userRole === 'teacher' || teacherId;
            
            console.log('User permissions:', { isAdmin, isTeacher });
            
            // Store enhanced permissions globally
            window.currentUserPermissions = {
                isAdmin: isAdmin,
                isTeacher: isTeacher,
                canDelete: isAdmin,
                canEdit: isAdmin || isTeacher,
                canView: isAdmin || isTeacher
            };
            
            if (!isAdmin && !isTeacher) {
                console.log('No valid session found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Show admin-specific UI elements if user is admin
            if (isAdmin) {
                console.log('User has admin privileges');
                showAdminFeatures();
            }
            
            // Check Firebase auth (with safety check) - but don't redirect if no user
            if (window.auth && window.auth.onAuthStateChanged) {
                window.auth.onAuthStateChanged((user) => {
                if (!user) {
                    console.log('No Firebase user found, but continuing with session auth');
                    // Don't redirect, just continue with session authentication
                }
                
                if (user) {
                    console.log('User authenticated:', user.uid);
                }
                
                // Initialize page regardless of Firebase auth status
                initializePage();
                });
            } else {
                console.log('Firebase auth not available, using session only');
                initializePage();
            }
        }

        // Initialize page
        function initializePage() {
            console.log('Initializing page...');

            // Set default date range (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];
            
            // Set default department to empty (All Departments)
            document.getElementById('department').value = '';
            
            // Set up event listeners
            document.getElementById('department').addEventListener('change', function() {
                console.log('Department changed to:', this.value);
                loadReports();
            });
            document.getElementById('year').addEventListener('change', loadReports);
            document.getElementById('division').addEventListener('change', loadReports);
            document.getElementById('lectureType').addEventListener('change', loadReports);
            document.getElementById('batch').addEventListener('change', function() {
                console.log('Batch changed to:', this.value);
                loadReports();
            });
            document.getElementById('startDate').addEventListener('change', loadReports);
            document.getElementById('endDate').addEventListener('change', loadReports);
            document.getElementById('percentageFilter').addEventListener('change', loadReports);
            document.getElementById('customPercentage').addEventListener('input', loadReports);

            // Show/hide custom percentage input
            document.getElementById('percentageFilter').addEventListener('change', function() {
                const customGroup = document.getElementById('customPercentageGroup');
                customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
            });

            // Initialize table headers for default view (subject-wise)
            updateTableHeaders(currentViewMode);

            // Load initial reports
            console.log('About to call loadReports()...');
            loadReports();
            console.log('loadReports() called');
        }

        // Function to load teachers from Firebase and populate teacher filter dropdown
        async function loadTeachersForFilter() {
            console.log('üîç Loading teachers for filter dropdown...');
            
            try {
                // Check if Firebase is available
                if (!window.db || typeof window.db.ref !== 'function') {
                    console.warn('Firebase database not available for loading teachers');
                    return;
                }

                // Load teachers from Firebase
                const teachersSnapshot = await window.db.ref('teachers').once('value');
                const teachersData = teachersSnapshot.val() || {};
                
                console.log('üìö Teachers data loaded:', Object.keys(teachersData).length, 'teachers');

                // Get teacher filter dropdown
                const teacherFilterSelect = document.getElementById('teacherFilter');
                
                // Clear existing options (keep "All Teachers")
                teacherFilterSelect.innerHTML = '<option value="">All Teachers</option>';

                // Create array of teachers with their info
                const teachersList = [];
                Object.entries(teachersData).forEach(([firebaseKey, teacher]) => {
                    if (teacher && typeof teacher === 'object') {
                        const teacherId = teacher.teacherId || teacher.code || firebaseKey;
                        const firstName = teacher.firstName || '';
                        const lastName = teacher.lastName || '';
                        const fullName = `${firstName} ${lastName}`.trim() || teacher.name || teacherId;
                        
                        teachersList.push({
                            id: teacherId,
                            name: fullName,
                            displayText: `${fullName} (${teacherId})`
                        });
                    }
                });

                // Sort teachers by name
                teachersList.sort((a, b) => a.name.localeCompare(b.name));

                // Add teachers to dropdown
                teachersList.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.displayText;
                    teacherFilterSelect.appendChild(option);
                });

                console.log('‚úÖ Teacher filter dropdown populated with', teachersList.length, 'teachers');

            } catch (error) {
                console.error('‚ùå Error loading teachers for filter:', error);
            }
        }

        // Function to ensure current user's teacher name is properly set
        function ensureCurrentUserTeacherName() {
            console.log('Ensuring current user teacher name is set...');
            
            // Get current user info
            const currentUserId = sessionStorage.getItem('teacherId');
            const firebaseUserId = window.auth && window.auth.currentUser ? window.auth.currentUser.uid : null;
            const currentUserEmail = window.auth && window.auth.currentUser ? window.auth.currentUser.email : null;
            
            console.log('Current user info:', { currentUserId, firebaseUserId, currentUserEmail });
            
            // Check if we already have a good teacher name
            const existingName = sessionStorage.getItem('teacherName');
            console.log('Existing teacher name in session:', existingName);
            
            // If we have "My Account" or similar generic names, replace them
            if (!existingName || existingName === 'null' || existingName === 'My Account' || 
                existingName === 'Teacher' || existingName === 'Unknown Teacher' || 
                existingName === 'admin' || existingName === 'Admin' || existingName === 'ADMIN' || 
                existingName.trim() === '') {
                
                console.log('Need to improve teacher name. Current name:', existingName);
                
                let betterName = null;
                
                // Try to get name from Firebase Auth
                if (window.auth && window.auth.currentUser) {
                    const user = window.auth.currentUser;
                    console.log('Firebase user info:', { displayName: user.displayName, email: user.email });
                    
                    if (user.displayName && user.displayName.trim() !== '' && user.displayName !== 'My Account') {
                        betterName = user.displayName.trim();
                        console.log('Found better name from Firebase Auth displayName:', betterName);
                    } else if (user.email) {
                        // Extract name from email
                        const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                        betterName = emailName.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                        console.log('Generated name from email:', betterName);
                    }
                }
                
                // Try localStorage as backup
                if (!betterName) {
                    const localName = localStorage.getItem('teacherName');
                    if (localName && localName !== 'null' && localName !== 'My Account' && localName.trim() !== '') {
                        betterName = localName;
                        console.log('Found name in localStorage:', betterName);
                    }
                }
                
                // Try userName from localStorage
                if (!betterName) {
                    const userName = localStorage.getItem('userName');
                    if (userName && userName !== 'null' && userName !== 'My Account' && userName.trim() !== '') {
                        betterName = userName;
                        console.log('Found userName in localStorage:', betterName);
                    }
                }
                
                // If we found a better name, update everything
                if (betterName && betterName !== 'My Account') {
                    console.log('Updating teacher name to:', betterName);
                    
                    // Convert to uppercase if it looks like a full name
                    if (betterName.split(' ').length >= 2) {
                        betterName = betterName.toUpperCase();
                    }
                    
                    // Update session storage
                    sessionStorage.setItem('teacherName', betterName);
                    
                    // Update localStorage as backup
                    localStorage.setItem('teacherName', betterName);
                    
                    // Update global mapping
                    if (currentUserId && window.teacherIdToName) {
                        window.teacherIdToName[currentUserId] = betterName;
                        console.log('Updated global teacher mapping for current user');
                    }
                    
                    // Try to create/update teacher record in Firebase
                    if (currentUserId && window.db) {
                        (async () => {
                            try {
                                const teacherRef = window.db.ref(`teachers/${currentUserId}`);
                                const snapshot = await teacherRef.once('value');
                                
                                if (!snapshot.exists()) {
                                    // Create new teacher record
                                    const teacherData = {
                                        name: betterName,
                                        teacherId: currentUserId,
                                        email: currentUserEmail || '',
                                        addedAutomatically: true,
                                        needsCompletion: true,
                                        createdAt: new Date().toISOString()
                                    };
                                    
                                    await teacherRef.set(teacherData);
                                    console.log('Teacher record created successfully for:', betterName);
                                    
                                    // Show success notification
                                    showNotification('Teacher Profile Updated', 
                                        `Your name has been updated to "${betterName}". Your attendance records will now show your correct name.`, 
                                        'success');
                                } else {
                                    // Update existing record if name is different
                                    const existingData = snapshot.val();
                                    if (!existingData.name || existingData.name === 'My Account' || 
                                        existingData.name === 'admin' || existingData.name === 'Admin' || 
                                        existingData.name === 'ADMIN' || existingData.name !== betterName) {
                                        await teacherRef.update({ name: betterName });
                                        console.log('Teacher record updated with new name:', betterName);
                                        
                                        showNotification('Teacher Name Updated', 
                                            `Your name has been updated to "${betterName}".`, 
                                            'success');
                                    }
                                }
                                
                                // Refresh reports to show updated name
                                setTimeout(() => {
                                    loadReports();
                                }, 2000);
                                
                            } catch (error) {
                                console.error('Error updating teacher record:', error);
                            }
                        })();
                    }
                } else {
                    console.log('Could not find a better name, keeping current name');
                }
            } else {
                console.log('Teacher name looks good:', existingName);
            }
        }
        
        // Function to find teacher name using comprehensive search
        function findTeacherNameComprehensive(teacherId) {
            // Try direct lookup in teachers node (window.allTeachersData)
            if (window.allTeachersData && window.allTeachersData[teacherId]) {
                const teacher = window.allTeachersData[teacherId];
                if (teacher.firstName && teacher.lastName) {
                    return teacher.firstName + ' ' + teacher.lastName;
                } else if (teacher.name) {
                    return teacher.name;
                }
            }
            return null;
        }

        // Function to show admin-specific features
        function showAdminFeatures() {
            console.log('Showing admin features...');
            
            // Enable delete buttons and admin-only features
            const deleteButtons = document.querySelectorAll('.admin-only, .delete-btn');
            deleteButtons.forEach(btn => {
                btn.style.display = 'block';
                btn.disabled = false;
            });
            
            // Show admin controls in the UI
            const adminControls = document.querySelectorAll('.admin-controls');
            adminControls.forEach(control => {
                control.style.display = 'block';
            });
            
            // Admin badge removed as per user request
            // const headerTitle = document.querySelector('h1');
            // if (headerTitle && !headerTitle.querySelector('.admin-badge')) {
            //     const adminBadge = document.createElement('span');
            //     adminBadge.className = 'admin-badge';
            //     adminBadge.style.cssText = `
            //         background: #DC2626;
            //         color: white;
            //         padding: 4px 8px;
            //         border-radius: 4px;
            //         font-size: 0.8em;
            //         margin-left: 10px;
            //         font-weight: normal;
            //     `;
            //     adminBadge.textContent = 'ADMIN';
            //     headerTitle.appendChild(adminBadge);
            // }
            
            console.log('Admin features enabled successfully');
        }
        
        // Function to show notifications to user
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#4F46E5';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                font-family: 'Segoe UI', sans-serif;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 4px;">${title}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;">${message}</div>
                    </div>
                    <button onclick="this.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                </div>
            `;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 8000);
        }
        
        // Call checkAuth when page loads
        window.onload = function() {
            checkAuth();
            // Set a delay to ensure Firebase Auth is ready, then ensure teacher name
            setTimeout(ensureCurrentUserTeacherName, 1500);
        };

        // Add this new function to handle division options
        function updateDivisionOptions() {
            const departmentSelect = document.getElementById('department');
            const divisionSelect = document.getElementById('division');
            
            // Clear current selection
            divisionSelect.value = '';
            
            // Enable/disable and update divisions based on department
            if (departmentSelect.value === 'CT') {
                divisionSelect.disabled = false;
                // Clear existing options
                divisionSelect.innerHTML = `
                    <option value="">All Divisions</option>
                    <option value="A">Division A</option>
                    <option value="B">Division B</option>
                    <option value="C">Division C</option>
                `;
            } else {
                divisionSelect.disabled = true;
                divisionSelect.innerHTML = '<option value="">All Divisions</option>';
            }
            
            // Reload reports with new filters
            loadReports();
        }

        // Global comprehensive teacher lookup function with enhanced fallback
        function getTeacherNameById(teacherId, teachersData, teacherNames) {
            // Try direct lookup in teachersData by UID
            if (teachersData && teachersData[teacherId]) {
                console.log('Found in mapping:', teacherNames[teacherId]);
                return teacherNames[teacherId];
            }

            // 0. Check teacherUidToCode mapping (new method)
            if (window.teacherUidToCode && window.teacherUidToCode[teacherId]) {
                const teacherCode = window.teacherUidToCode[teacherId];
                console.log('Found teacher code in UID mapping:', teacherCode);
                
                // Now look up the teacher by this code in teachersData
                for (const [id, teacher] of Object.entries(teachersData)) {
                    if (teacher.code && teacher.code.trim().toUpperCase() === teacherCode.trim().toUpperCase()) {
                        let name = '';
                        if (teacher.name && teacher.name.trim() !== '') {
                            name = teacher.name.trim();
                        } else if (teacher.firstName || teacher.lastName) {
                            name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                        } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                            name = teacher.displayName.trim();
                        }
                        if (name) {
                            console.log('Resolved teacher name via UID mapping:', name);
                            teacherNames[teacherId] = name;
                            return name;
                        }
                    }
                }
                
                // If we have the code but couldn't find the teacher, at least try to use the code
                console.log('Could not find teacher data for code, using code as fallback:', teacherCode);
                teacherNames[teacherId] = teacherCode;
                return teacherCode;
            }

            // 1. Try direct UID lookup (object key)
            if (teachersData[teacherId]) {
                const teacher = teachersData[teacherId];
                let name = '';
                if (teacher.name && teacher.name.trim() !== '') {
                    name = teacher.name.trim();
                } else if (teacher.firstName || teacher.lastName) {
                    name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                    name = teacher.displayName.trim();
                } else if (teacher.email) {
                    const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                    name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                }
                if (name) {
                    teacherNames[teacherId] = name;
                    return name;
                }
            }

            // 2. Try teacherId/code/email fields inside each teacher object
            for (const [id, teacher] of Object.entries(teachersData)) {
                // Check by teacherId
                if (teacher.teacherId && teacher.teacherId.trim().toUpperCase() === teacherId.trim().toUpperCase()) {
                    let name = '';
                    if (teacher.name && teacher.name.trim() !== '') {
                        name = teacher.name.trim();
                    } else if (teacher.firstName || teacher.lastName) {
                        name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                    } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                        name = teacher.displayName.trim();
                    } else if (teacher.email) {
                        const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                        name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }
                    if (name) {
                        teacherNames[teacherId] = name;
                        return name;
                    }
                }
                // Check by code
                if (teacher.code && teacher.code.trim().toUpperCase() === teacherId.trim().toUpperCase()) {
                    let name = '';
                    if (teacher.name && teacher.name.trim() !== '') {
                        name = teacher.name.trim();
                    } else if (teacher.firstName || teacher.lastName) {
                        name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                    } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                        name = teacher.displayName.trim();
                    } else if (teacher.email) {
                        const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                        name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }
                    if (name) {
                        teacherNames[teacherId] = name;
                        return name;
                    }
                }
                // Check by email
                if (teacher.email && teacher.email.trim().toLowerCase() === teacherId.trim().toLowerCase()) {
                    let name = '';
                    if (teacher.name && teacher.name.trim() !== '') {
                        name = teacher.name.trim();
                    } else if (teacher.firstName || teacher.lastName) {
                        name = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                    } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                        name = teacher.displayName.trim();
                    } else if (teacher.email) {
                        const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                        name = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                    }
                    if (name) {
                        teacherNames[teacherId] = name;
                        return name;
                    }
                }
            }

            // 3. Enhanced fallback: Try to get name from session storage or Firebase Auth
            if (teacherId === sessionStorage.getItem('teacherId') || 
                (window.auth && window.auth.currentUser && window.auth.currentUser.uid === teacherId)) {
                
                // Try to get name from session storage first
                const sessionTeacherName = sessionStorage.getItem('teacherName');
                if (sessionTeacherName && sessionTeacherName !== 'null' && sessionTeacherName.trim() !== '') {
                    console.log('Found teacher name in session storage:', sessionTeacherName);
                    teacherNames[teacherId] = sessionTeacherName;
                    return sessionTeacherName;
                }
                
                // Try to get name from Firebase Auth user
                if (window.auth && window.auth.currentUser) {
                    const user = window.auth.currentUser;
                    let authName = '';
                    
                    if (user.displayName && user.displayName.trim() !== '') {
                        authName = user.displayName.trim();
                    } else if (user.email) {
                        // Extract name from email
                        const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                        authName = emailName.split(' ').map(word =>
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                    }
                    
                    if (authName) {
                        console.log('Found teacher name from Firebase Auth:', authName);
                        teacherNames[teacherId] = authName;
                        // Also save to session storage for future use
                        sessionStorage.setItem('teacherName', authName);
                        return authName;
                    }
                }
            }

            // Not found
            console.log('Teacher not found for ID:', teacherId);
            return 'Teacher';
        }

        // Function to automatically add missing teacher record
        async function addMissingTeacherRecord(teacherId, teacherName) {
            try {
                console.log('Adding missing teacher record:', { teacherId, teacherName });
                // Check if record already exists to avoid duplicates
                const existingRecord = await window.db.ref(`teachers/${teacherId}`).once('value');
                if (existingRecord.exists()) {
                    console.log('Teacher record already exists, skipping creation');
                    return true;
                }
                // If teacherName is generic, set a placeholder
                let finalName = teacherName;
                if (!finalName || finalName.toLowerCase() === 'teacher' || finalName.toLowerCase() === 'admin') {
                    finalName = 'Enter Name';
                }
                const teacherData = {
                    name: finalName,
                    teacherId: teacherId,
                    email: window.auth && window.auth.currentUser ? window.auth.currentUser.email : '',
                    departments: [],
                    classes: [],
                    createdAt: new Date().toISOString(),
                    addedAutomatically: true,
                    needsCompletion: true // Flag to indicate this record needs admin attention
                };
                await window.db.ref(`teachers/${teacherId}`).set(teacherData);
                console.log('Missing teacher record added successfully');
                
                // Show notification to user
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10B981;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: 'Segoe UI', sans-serif;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Teacher Record Created</strong><br>
                            <small>Your profile has been added automatically. Attendance records will now show your name correctly.</small>
                        </div>
                        <button onclick="this.parentNode.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Remove notification after 8 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 8000);
                
                return true;
            } catch (error) {
                console.error('Error adding missing teacher record:', error);
                
                // Show error notification
                const errorNotification = document.createElement('div');
                errorNotification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #EF4444;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 400px;
                    font-family: 'Segoe UI', sans-serif;
                `;
                errorNotification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>
                            <strong>Error Creating Profile</strong><br>
                            <small>Failed to create teacher record. Please contact admin for assistance.</small>
                        </div>
                        <button onclick="this.parentNode.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                    </div>
                `;
                document.body.appendChild(errorNotification);
                
                setTimeout(() => {
                    if (errorNotification.parentNode) {
                        errorNotification.parentNode.removeChild(errorNotification);
                    }
                }, 8000);
                
                return false;
            }
        }

        async function loadReports() {
            console.log('=== loadReports() function called ===');
            try {
                console.log('Waiting for Firebase...');
                if (window.waitForFirebase) {
                    await window.waitForFirebase();
                } else {
                    console.log('Global waitForFirebase not available, proceeding anyway');
                }
                console.log('Firebase initialized, starting to load reports...');
                
                // Check if Firebase is actually available
                if (!window.db) {
                    console.error('Firebase database not available - showing demo data');
                    
                    // Show demo data for testing
                    const demoStudents = [
                        {
                            id: 'demo1',
                            name: 'Demo Student 1',
                            rollNo: '001',
                            department: 'CT',
                            departmentName: 'Computer Technology',
                            year: 'SY',
                            division: 'A',
                            subject: 'Demo Subject',
                            teacherName: 'Demo Teacher',
                            present: 8,
                            absent: 2,
                            total: 10,
                            percentage: 80
                        },
                        {
                            id: 'demo2',
                            name: 'Demo Student 2',
                            rollNo: '002',
                            department: 'CT',
                            departmentName: 'Computer Technology',
                            year: 'SY',
                            division: 'A',
                            subject: 'Demo Subject',
                            teacherName: 'Demo Teacher',
                            present: 6,
                            absent: 4,
                            total: 10,
                            percentage: 60
                        }
                    ];
                    
                    console.log('Showing demo data:', demoStudents);
                    updateTable(demoStudents);
                    return;
                }

                // Get user type and ID from session storage
                const isTeacher = sessionStorage.getItem('isTeacherLoggedIn') === 'true';
                const teacherId = sessionStorage.getItem('teacherId');
                console.log('Current user:', { isTeacher, teacherId });

                if (!teacherId && isTeacher) {
                    console.error('Teacher ID not found in session');
                    showError(new Error('Teacher ID not found. Please login again.'));
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                // Get all teachers data first
                let teachersData = {};
                if (window.db && typeof window.db.ref === 'function') {
                    try {
                        const teachersSnapshot = await window.db.ref('teachers').once('value');
                        teachersData = (teachersSnapshot && typeof teachersSnapshot.val === 'function') ? teachersSnapshot.val() || {} : {};
                    } catch (error) {
                        console.warn('Error loading teachers data:', error);
                        teachersData = {};
                    }
                } else {
                    console.warn('Firebase database not available, using empty teachers data');
                }
                console.log('All teachers data loaded:', teachersData);

                // Create comprehensive teacher name mapping
                const teacherNames = {};
                Object.entries(teachersData).forEach(([id, teacher]) => {
                    if (teacher) {
                        // Try different name field combinations
                        let teacherName = '';
                        if (teacher.name && teacher.name.trim() !== '') {
                            teacherName = teacher.name.trim();
                        } else if (teacher.firstName || teacher.lastName) {
                            teacherName = `${(teacher.firstName || '').trim()} ${(teacher.lastName || '').trim()}`.trim();
                        } else if (teacher.displayName && teacher.displayName.trim() !== '') {
                            teacherName = teacher.displayName.trim();
                        } else if (teacher.email) {
                            // Extract name from email and format it properly
                            const emailName = teacher.email.split('@')[0].replace(/[._]/g, ' ');
                            teacherName = emailName.split(' ').map(word => 
                                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                            ).join(' ');
                        } else {
                            teacherName = 'Unknown Teacher';
                        }
                        
                        console.log('Mapping teacher:', {
                            id: id,
                            teacherName: teacherName,
                            originalData: teacher
                        });
                        
                        // Map by Firebase ID
                        teacherNames[id] = teacherName;
                        
                        // Map by teacherId if it exists and is different
                        if (teacher.teacherId && teacher.teacherId !== id && teacher.teacherId.trim() !== '') {
                            teacherNames[teacher.teacherId] = teacherName;
                        }
                        
                        // Map by email if it exists
                        if (teacher.email && teacher.email.trim() !== '') {
                            teacherNames[teacher.email] = teacherName;
                        }
                        
                        // Map by code if it exists
                        if (teacher.code && teacher.code.trim() !== '') {
                            teacherNames[teacher.code] = teacherName;
                        }
                        
                        // Map by any other identifier fields
                        const identifierFields = ['username', 'userId', 'empId', 'employeeId'];
                        identifierFields.forEach(field => {
                            if (teacher[field] && teacher[field].trim() !== '' && teacher[field] !== id) {
                                teacherNames[teacher[field]] = teacherName;
                            }
                        });
                    }
                });
                console.log('Teacher names mapping:', teacherNames);
                
                // Check if current user is missing from teachers database
                const currentTeacherId = sessionStorage.getItem('teacherId');
                if (currentTeacherId && !teacherNames[currentTeacherId] && !teachersData[currentTeacherId]) {
                    console.warn('Current user not found in teachers database:', currentTeacherId);
                    
                    // Show helpful notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #F59E0B;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        max-width: 400px;
                        font-family: 'Segoe UI', sans-serif;
                    `;
                    notification.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Teacher Profile Missing</strong><br>
                                <small>Your teacher profile is not found in the database. Attendance records will show as "Unknown Teacher" until this is resolved.</small>
                            </div>
                            <button onclick="this.parentNode.parentNode.parentNode.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Auto-remove after 10 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 10000);
                }
        
        // Function moved to global scope - see above

                const filters = {
                    department: document.getElementById('department').value,
                    year: document.getElementById('year').value,
                    division: document.getElementById('division').value,
                    lectureType: document.getElementById('lectureType').value,
                    batch: document.getElementById('batch').value,
                    subject: document.getElementById('subject').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    teacherId: teacherId,
                    teacherNames: teacherNames, // Pass all teacher names
                    teachersData: teachersData // Pass original teachers data for lookup
                };

                console.log('Applied filters:', filters);

                // Show loading state
                showLoadingState();

                try {
                    // Check if Firebase is available
                    if (!window.db || typeof window.db.ref !== 'function') {
                        console.warn('Firebase database not available, showing empty attendance data');
                        updateTable([]);
                        return;
                    }
                    
                    // First verify access
                    await window.db.ref('.info/connected').once('value');
                    console.log('Firebase connection verified');
                    
                    // Query attendance based on user type
                    let attendanceQuery = window.db.ref('attendance');
                    // üîß CRITICAL FIX: Only filter by teacher if not admin/clerk
                    const isAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
                    const isClerk = sessionStorage.getItem('isClerkLoggedIn') === 'true';
                    
                    if (isTeacher && teacherId && !isAdmin && !isClerk) {
                        console.log('üîí Teacher access: Querying attendance for teacher:', teacherId);
                        attendanceQuery = attendanceQuery.orderByChild('teacherId').equalTo(teacherId);
                    } else if (isAdmin || isClerk) {
                        console.log('üîì Admin/Clerk access: Loading ALL attendance records');
                    }

                    let attendanceSnapshot, studentsSnapshot;
                    try {
                        [attendanceSnapshot, studentsSnapshot] = await Promise.all([
                            attendanceQuery.once('value'),
                            window.db.ref('students').once('value')
                        ]);
                    } catch (error) {
                        console.warn('Error fetching data from Firebase:', error);
                        updateTable([]);
                        return;
                    }
                    
                    console.log('Data fetched successfully');
                    
                    const attendanceData = (attendanceSnapshot && typeof attendanceSnapshot.val === 'function') ? attendanceSnapshot.val() || {} : {};
                    const studentsData = (studentsSnapshot && typeof studentsSnapshot.val === 'function') ? studentsSnapshot.val() || {} : {};

                    console.log('Records found:', {
                        attendance: Object.keys(attendanceData).length,
                        students: Object.keys(studentsData).length
                    });
                    
                    // Debug: Log first few attendance records to see structure
                    console.log('Sample attendance records:');
                    Object.entries(attendanceData).slice(0, 3).forEach(([key, record]) => {
                        console.log('Record:', key, {
                            teacherId: record.teacherId,
                            teacherName: record.teacherName,
                            teacher: record.teacher,
                            createdBy: record.createdBy,
                            subject: record.subject,
                            date: record.date,
                            hasStudents: !!record.students
                        });
                    });

                    // Process and display data
                    console.log('Processing attendance data...');
                    const processedData = await processAttendanceData(attendanceData, studentsData, filters);
                    console.log('Processed data:', processedData.length, 'students found');
                    console.log('Sample processed data:', processedData.slice(0, 2));
                    updateTable(processedData);
                    console.log('Table updated successfully');

                } catch (error) {
                    console.error('Error fetching data:', error);
                    showError(error);
                }
            } catch (error) {
                console.error('Error in loadReports:', error);
                showError(error);
            }
        }

        // Global variables to track current view mode and pagination
        let currentViewMode = 'subject'; // 'combined' or 'subject'
        let currentPage = 1;
        let recordsPerPage = 100;
        let totalRecords = 0;
        let totalPages = 0;
        let allStudentsData = []; // Store all data for pagination
        
        // Function to switch between views
        function switchView(viewMode) {
            currentViewMode = viewMode;
            
            // Update button styles
            const combinedBtn = document.getElementById('combinedViewBtn');
            const subjectBtn = document.getElementById('subjectViewBtn');
            
            if (viewMode === 'combined') {
                combinedBtn.style.background = '#059669';
                combinedBtn.style.color = 'white';
                subjectBtn.style.background = 'transparent';
                subjectBtn.style.color = '#374151';
            } else {
                subjectBtn.style.background = '#059669';
                subjectBtn.style.color = 'white';
                combinedBtn.style.background = 'transparent';
                combinedBtn.style.color = '#374151';
            }
            
            // Update table headers
            updateTableHeaders(viewMode);
            
            // Reload data with new view
            loadReports();
        }
        
        // Show loading spinner in table
function showLoadingState() {
    const tableBody = document.getElementById('attendanceTableBody');
    if (tableBody) {
        const colSpan = currentViewMode === 'subject' ? '4' : '16';
        tableBody.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center p-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>Loading attendance records...</p>
                </td>
            </tr>
        `;
    }
}

// Show error message in table
function showError(message) {
    const tableBody = document.getElementById('attendanceTableBody');
    if (tableBody) {
        const colSpan = currentViewMode === 'subject' ? '4' : '16';
        tableBody.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center p-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>${message || 'An error occurred while loading attendance records.'}</p>
                </td>
            </tr>
        `;
    }
}

// Update table with processed data (with pagination)
function updateTable(students) {
    const tableBody = document.getElementById('attendanceTableBody');
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    if (!students || students.length === 0) {
        const colSpan = currentViewMode === 'subject' ? '17' : '16';
        tableBody.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center" style="padding: 40px;">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p>No attendance records found</p>
                </td>
            </tr>
        `;
        hidePagination();
        return;
    }
    
    // Store all data for pagination
    allStudentsData = students;
    totalRecords = students.length;
    totalPages = Math.ceil(totalRecords / recordsPerPage);
    
    console.log('üìä Pagination Info:', {
        totalRecords,
        recordsPerPage,
        totalPages,
        currentPage
    });
    
    // Get current page data
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const currentPageData = students.slice(startIndex, endIndex);
    
    console.log('Updating table with', currentPageData.length, 'students (page', currentPage, 'of', totalPages, ')');
    
    // Generate table rows based on current view mode (using paginated data)
    if (currentViewMode === 'subject') {
        // Subject-wise detailed view: show individual student records
        tableBody.innerHTML = currentPageData.map(record => `
            <tr>
                <td>${record.rollNo || '-'}</td>
                <td>${record.name || '-'}</td>
                <td>${getDepartmentFullName(record.department) || record.department || '-'}</td>
                <td>${record.year || '-'}</td>
                <td>${record.division || '-'}</td>
                <td>${record.subject || '-'}</td>
                <td class="text-primary" style="font-weight: bold;">${record.teacherName || '-'}</td>
                <td class="${record.lectureType === 'practical' ? 'text-danger' : 'text-success'}">${record.lectureType || 'theory'}</td>
                <td class="${record.lectureType === 'practical' ? 'text-info' : 'text-muted'}">${record.lectureType === 'practical' ? (record.batch || 'A') : '-'}</td>
                <td>${record.date || '-'}</td>
                <td class="${record.statusClass} ${record.status === 'Present' ? 'status-present' : 'status-absent'}" style="font-weight: bold;">${record.status || '-'}</td>
                <td class="${record.statusClass} ${record.status === 'Present' ? 'status-present' : 'status-absent'}" style="font-weight: bold;">${record.attendancePercentage}%</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editStudentRecord('${record.recordKey}', '${record.studentId}')" title="Edit Record">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } else {
        // Combined view: show student details with theory/practical columns
        const selectedStudents = new Set(); // For checkbox functionality
        
        tableBody.innerHTML = currentPageData.map(student => {
            // Calculate theory totals
            const theoryTotal = (student.theoryPresent || 0) + (student.theoryAbsent || 0);
            const theoryPercentage = theoryTotal > 0 ? Math.round((student.theoryPresent / theoryTotal) * 100) : 0;
            
            // Calculate practical totals
            const practicalTotal = (student.practicalPresent || 0) + (student.practicalAbsent || 0);
            const practicalPercentage = practicalTotal > 0 ? Math.round((student.practicalPresent / practicalTotal) * 100) : 0;
            
            // Calculate overall percentage
            const totalPresent = (student.theoryPresent || 0) + (student.practicalPresent || 0);
            const totalClasses = theoryTotal + practicalTotal;
            const percentage = totalClasses > 0 ? Math.round((totalPresent / totalClasses) * 100) : 0;
            
            console.log('üìä Student display data:', {
                name: student.name,
                theoryPresent: student.theoryPresent || 0,
                theoryAbsent: student.theoryAbsent || 0,
                theoryTotal,
                practicalPresent: student.practicalPresent || 0,
                practicalAbsent: student.practicalAbsent || 0,
                practicalTotal,
                totalPresent,
                totalClasses,
                percentage
            });
            
            return `
                <tr>
                    <td><input type="checkbox" class="student-checkbox" value="${student.id || ''}" ${selectedStudents && selectedStudents.has && selectedStudents.has(student.id) ? 'checked' : ''} onchange="toggleStudent('${student.id}', this.checked)"></td>
                    <td>${student.rollNo || '-'}</td>
                    <td>${student.name || '-'}</td>
                    <td>${student.departmentName || getDepartmentFullName(student.department) || '-'}</td>
                    <td>${student.year || '-'}</td>
                    <td>${student.division || '-'}</td>
                    <td class="theory-data text-success" style="font-weight: bold;">${student.theoryPresent || 0}</td>
                    <td class="theory-data text-danger" style="font-weight: bold;">${student.theoryAbsent || 0}</td>
                    <td class="theory-data">${theoryTotal}</td>
                    <td class="theory-data ${getPercentageClass(theoryPercentage)}">${theoryPercentage}%</td>
                    <td class="practical-data text-success" style="font-weight: bold;">${student.practicalPresent || 0}</td>
                    <td class="practical-data text-danger" style="font-weight: bold;">${student.practicalAbsent || 0}</td>
                    <td class="practical-data">${practicalTotal}</td>
                    <td class="practical-data ${getPercentageClass(practicalPercentage)}">${practicalPercentage}%</td>
                    <td class="${getPercentageClass(percentage)}" style="font-weight: bold;">${percentage}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editStudent('${student.id}')" title="Edit Student">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    // Update pagination controls
    updatePaginationControls();
    
    console.log('Table updated successfully with pagination');
}

// Pagination Functions
function updatePaginationControls() {
    const paginationContainer = document.getElementById('paginationContainer');
    const paginationInfo = document.getElementById('paginationInfo');
    const pageNumbers = document.getElementById('pageNumbers');
    const firstPageBtn = document.getElementById('firstPageBtn');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const lastPageBtn = document.getElementById('lastPageBtn');
    
    if (!paginationContainer || totalRecords === 0) {
        hidePagination();
        return;
    }
    
    // Show pagination if more than recordsPerPage records
    if (totalRecords > recordsPerPage) {
        paginationContainer.style.display = 'flex';
        
        // Update pagination info
        const startRecord = (currentPage - 1) * recordsPerPage + 1;
        const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
        paginationInfo.textContent = `Showing ${startRecord}-${endRecord} of ${totalRecords} records`;
        
        // Update button states
        firstPageBtn.disabled = currentPage === 1;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        lastPageBtn.disabled = currentPage === totalPages;
        
        // Generate page numbers
        generatePageNumbers();
    } else {
        hidePagination();
    }
}

function generatePageNumbers() {
    const pageNumbers = document.getElementById('pageNumbers');
    if (!pageNumbers) return;
    
    let pagesHtml = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start page if we're near the end
    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Add ellipsis at the beginning if needed
    if (startPage > 1) {
        pagesHtml += `<span class="page-number" onclick="goToPage(1)">1</span>`;
        if (startPage > 2) {
            pagesHtml += `<span class="page-ellipsis">...</span>`;
        }
    }
    
    // Add page numbers
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        pagesHtml += `<span class="page-number ${activeClass}" onclick="goToPage(${i})">${i}</span>`;
    }
    
    // Add ellipsis at the end if needed
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pagesHtml += `<span class="page-ellipsis">...</span>`;
        }
        pagesHtml += `<span class="page-number" onclick="goToPage(${totalPages})">${totalPages}</span>`;
    }
    
    pageNumbers.innerHTML = pagesHtml;
}

function goToPage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    
    currentPage = page;
    updateTable(allStudentsData);
    
    // Scroll to top of table
    document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
}

function changeRecordsPerPage() {
    const select = document.getElementById('recordsPerPage');
    recordsPerPage = parseInt(select.value);
    currentPage = 1; // Reset to first page
    
    if (allStudentsData.length > 0) {
        updateTable(allStudentsData);
    }
}

function hidePagination() {
    const paginationContainer = document.getElementById('paginationContainer');
    if (paginationContainer) {
        paginationContainer.style.display = 'none';
    }
}

// Excel Export Function - ALWAYS exports COMPLETE database (bypasses pagination completely)
async function exportToExcel() {
    try {
        console.log('üöÄ FORCE EXPORTING COMPLETE DATABASE - IGNORING PAGINATION!');
        
        // Show loading indicator
        const loadingMsg = document.createElement('div');
        loadingMsg.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); 
                        z-index: 10000; text-align: center;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: #4F46E5; margin-bottom: 10px;"></i>
                <p style="margin: 0; font-weight: bold;">üìä Exporting COMPLETE database...</p>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #666;">Please wait, fetching all records...</p>
            </div>
        `;
        document.body.appendChild(loadingMsg);
        
        // Wait for Firebase to be ready
        if (typeof window.waitForFirebase === 'function') {
            await window.waitForFirebase();
        }
        
        // Check if Firebase is available
        if (!window.db || typeof window.db.ref !== 'function') {
            // Remove loading indicator
            document.body.removeChild(loadingMsg);
            throw new Error('Firebase database not available. Please refresh the page and try again.');
        }
        
        console.log('üî• Firebase ready, fetching COMPLETE database...');
        
        // FORCE fetch ALL data from database - completely bypass pagination
        let attendanceQuery = window.db.ref('attendance');
        
        // Apply teacher filter ONLY if teacher (not admin)
        const isTeacher = sessionStorage.getItem('isTeacherLoggedIn') === 'true';
        const teacherId = sessionStorage.getItem('teacherId');
        const isAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
        const isClerk = sessionStorage.getItem('isClerkLoggedIn') === 'true';
        
        if (isTeacher && teacherId && !isAdmin && !isClerk) {
            console.log('üë®‚Äçüè´ Teacher export: ALL records for teacher:', teacherId);
            attendanceQuery = attendanceQuery.orderByChild('teacherId').equalTo(teacherId);
        } else {
            console.log('üëë Admin/Clerk export: ALL ATTENDANCE RECORDS FROM DATABASE');
        }
        
        // Fetch EVERYTHING from database
        console.log('üì° Fetching complete database...');
        const [attendanceSnapshot, studentsSnapshot] = await Promise.all([
            attendanceQuery.once('value'),
            window.db.ref('students').once('value')
        ]);
        
        const rawAttendanceData = attendanceSnapshot.val() || {};
        const rawStudentsData = studentsSnapshot.val() || {};
        
        console.log('üíæ RAW DATABASE FETCHED:', {
            totalAttendanceRecords: Object.keys(rawAttendanceData).length,
            totalStudents: Object.keys(rawStudentsData).length
        });
        
        // Get current filters (but apply to COMPLETE dataset)
        const exportFilters = {
            department: document.getElementById('department').value,
            year: document.getElementById('year').value,
            division: document.getElementById('division').value,
            lectureType: document.getElementById('lectureType').value,
            batch: document.getElementById('batch').value,
            subject: document.getElementById('subject').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            teacherId: teacherId,
            teacherNames: window.teacherNames || {},
            teachersData: window.teachersData || {}
        };
        
        console.log('üéØ Applying filters to COMPLETE database:', exportFilters);
        
        // Process COMPLETE database with filters
        const completeExportData = await processAttendanceData(rawAttendanceData, rawStudentsData, exportFilters);
        
        console.log('‚úÖ COMPLETE DATABASE PROCESSED FOR EXPORT:', completeExportData.length, 'records');
        console.log('üîç First 3 export records for debugging:', completeExportData.slice(0, 3));
        
        // Remove loading indicator
        document.body.removeChild(loadingMsg);
        
        if (!completeExportData || completeExportData.length === 0) {
            alert('‚ùå ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä / No data found in complete database for export');
            return;
        }
        
        // Prepare data for export - use COMPLETE processed data
        const exportData = [];
        
        if (currentViewMode === 'subject') {
            // Subject-wise view export
            console.log('üìã Preparing subject-wise export data...');
            
            // Headers for subject-wise view - Fix column order to match actual data
            const headers = ['Roll No', 'Student Name', 'Department', 'Year', 'Division', 'Subject', 'Teacher Name', 'Lecture Type', 'Batch', 'Date Taken', 'Status', 'Attendance %'];
            exportData.push(headers);
            
            // Add ALL records from COMPLETE DATABASE (zero pagination)
            completeExportData.forEach((record, index) => {
                // Debug first few records to see data structure
                if (index < 5) {
                    console.log('üîç Export Record Debug:', {
                        index: index,
                        rollNo: record.rollNo,
                        name: record.name,
                        studentName: record.studentName,
                        studentId: record.studentId,
                        fullRecord: record
                    });
                }
                
                const row = [
                    record.rollNo || record.studentId || '-',
                    record.name || '-',
                    getDepartmentFullName(record.department) || record.department || '-',
                    record.year || '-',
                    record.division || '-',
                    record.subject || '-',
                    record.teacherName || '-',
                    record.lectureType || 'theory',
                    record.lectureType === 'practical' ? (record.batch || 'A') : '-',
                    record.date || '-',
                    record.status || '-',
                    record.attendancePercentage + '%' || '-'
                ];
                
                // Debug first few rows to see actual export data
                if (index < 5) {
                    console.log('üìä Export Row Debug:', {
                        originalRollNo: record.rollNo,
                        exportedRollNo: record.rollNo || record.studentId || '-',
                        name: record.name,
                        fullRow: row
                    });
                }
                
                exportData.push(row);
            });
            
        } else {
            // Combined view export
            console.log('üìã Preparing combined view export data...');
            
            // Headers for combined view
            const headers = [
                'Roll No', 'Student Name', 'Department', 'Year', 'Division',
                'Theory Present', 'Theory Absent', 'Theory Total', 'Theory %',
                'Practical Present', 'Practical Absent', 'Practical Total', 'Practical %',
                'Overall %'
            ];
            exportData.push(headers);
            
            // Add ALL records from COMPLETE DATABASE (zero pagination)
            completeExportData.forEach(student => {
                // Calculate theory totals
                const theoryTotal = (student.theoryPresent || 0) + (student.theoryAbsent || 0);
                const theoryPercentage = theoryTotal > 0 ? Math.round((student.theoryPresent / theoryTotal) * 100) : 0;
                
                // Calculate practical totals
                const practicalTotal = (student.practicalPresent || 0) + (student.practicalAbsent || 0);
                const practicalPercentage = practicalTotal > 0 ? Math.round((student.practicalPresent / practicalTotal) * 100) : 0;
                
                // Calculate overall percentage
                const totalPresent = (student.theoryPresent || 0) + (student.practicalPresent || 0);
                const totalClasses = theoryTotal + practicalTotal;
                const percentage = totalClasses > 0 ? Math.round((totalPresent / totalClasses) * 100) : 0;
                
                const row = [
                    student.rollNo || '-',
                    student.name || '-',
                    student.departmentName || getDepartmentFullName(student.department) || '-',
                    student.year || '-',
                    student.division || '-',
                    student.theoryPresent || 0,
                    student.theoryAbsent || 0,
                    theoryTotal,
                    theoryPercentage + '%',
                    student.practicalPresent || 0,
                    student.practicalAbsent || 0,
                    practicalTotal,
                    practicalPercentage + '%',
                    percentage + '%'
                ];
                exportData.push(row);
            });
        }
        
        console.log('üìä Export data prepared:', exportData.length, 'rows (including header)');
        
        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(exportData);
        
        // Set column widths based on view mode
        let colWidths;
        if (currentViewMode === 'subject') {
            // Subject-wise view column widths
            colWidths = [
                { wch: 10 }, // Roll No
                { wch: 25 }, // Name
                { wch: 15 }, // Department
                { wch: 8 },  // Year
                { wch: 10 }, // Division
                { wch: 20 }, // Subject
                { wch: 12 }, // Lecture Type
                { wch: 8 },  // Batch
                { wch: 12 }, // Date
                { wch: 10 }, // Status
                { wch: 12 }  // Attendance %
            ];
        } else {
            // Combined view column widths
            colWidths = [
                { wch: 10 }, // Roll No
                { wch: 25 }, // Name
                { wch: 15 }, // Department
                { wch: 8 },  // Year
                { wch: 10 }, // Division
                { wch: 10 }, // Theory Present
                { wch: 10 }, // Theory Absent
                { wch: 10 }, // Theory Total
                { wch: 12 }, // Theory %
                { wch: 12 }, // Practical Present
                { wch: 12 }, // Practical Absent
                { wch: 12 }, // Practical Total
                { wch: 12 }, // Practical %
                { wch: 12 }  // Overall %
            ];
        }
        
        ws['!cols'] = colWidths;
        
        // Add styling for header row
        const headerRange = XLSX.utils.decode_range(ws['!ref']);
        for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
            const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
            if (!ws[cellAddress]) continue;
            
            ws[cellAddress].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F46E5" } },
                alignment: { horizontal: "center", vertical: "center" }
            };
        }
        
        // Add worksheet to workbook
        const viewType = currentViewMode === 'subject' ? 'Subject-wise' : 'Combined';
        XLSX.utils.book_append_sheet(wb, ws, `${viewType} Report`);
        
        // Generate filename with current date and view type
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `Attendance_Report_${viewType}_${dateStr}_${timeStr}.xlsx`;
        
        // Save file
        XLSX.writeFile(wb, filename);
        
        console.log('‚úÖ Excel export completed:', filename);
        console.log('üéâ COMPLETE DATABASE EXPORTED:', completeExportData.length, 'total records');
        
        // Show detailed success notification
        const filterCount = Object.values(exportFilters).filter(f => f && typeof f === 'string' && f.trim() && f !== 'undefined').length;
        alert(`üéâ Excel export ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä! / COMPLETE Excel export successful!\n\nüìÅ File: ${filename}\nüìä Records exported: ${completeExportData.length}\nüíæ Source: COMPLETE DATABASE (not paginated)\nüéØ Filters applied: ${filterCount > 0 ? 'Yes (' + filterCount + ')' : 'No'}\nüëÄ View: ${viewType}\n\n‚úÖ ‡§∏‡§∞‡•ç‡§µ ‡§°‡•á‡§ü‡§æ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ù‡§æ‡§≤‡§æ! / All data exported successfully!`);
        
    } catch (error) {
        console.error('üí• EXPORT ERROR:', error);
        
        // Remove loading indicator if it exists
        const loadingMsg = document.querySelector('div[style*="position: fixed"]');
        if (loadingMsg) {
            document.body.removeChild(loadingMsg);
        }
        
        alert('üí• Export ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä! / Export Error!\n\n' + error.message + '\n\nPlease try again or contact support.');
    }
}

// Helper function to get percentage class for styling
function getPercentageClass(percentage) {
    if (percentage >= 75) return 'text-success';
    if (percentage >= 50) return 'text-warning';
    return 'text-danger';
}

// Process attendance data for both view modes
async function processAttendanceData(attendanceData, studentsData, filters) {
    console.log('Processing attendance data with filters:', filters);
    console.log('Current view mode:', currentViewMode);

    // --- SUBJECT-WISE DETAILED VIEW ---
    if (currentViewMode === 'subject') {
        console.log('üîç Processing subject-wise detailed view...');
        const detailedRecords = [];
        
        Object.entries(attendanceData).forEach(([recordKey, record]) => {
            console.log('üìù Processing record for subject view:', recordKey, {
                subject: record.subject,
                date: record.date,
                lectureType: record.lectureType,
                hasStudents: !!record.students,
                class: record.class,
                teacherId: record.teacherId,
                fullRecord: record
            });
            
            // Skip if not the teacher's record
            if (filters.teacherId && record.teacherId !== filters.teacherId) return;
            if (!record.subject || !record.date || !record.students) return;

            // Apply subject filter
            if (filters.subject && !record.subject.toLowerCase().includes(filters.subject.toLowerCase())) return;

            // Apply lecture type filter
            if (filters.lectureType && filters.lectureType.trim() !== '') {
                const recordLectureType = record.lectureType || 'theory'; // Default to theory if not specified
                if (recordLectureType !== filters.lectureType) {
                    console.log('‚è≠Ô∏è Skipping record - lecture type filter mismatch:', recordLectureType, 'vs', filters.lectureType);
                    return;
                }
            }

            // Date filtering
            const recordDate = new Date(record.date);
            const start = filters.startDate ? new Date(filters.startDate) : null;
            const end = filters.endDate ? new Date(filters.endDate) : null;
            if ((start && recordDate < start) || (end && recordDate > end)) return;

            // Process each student in this record
            Object.entries(record.students).forEach(([studentId, status]) => {
                const student = studentsData[studentId] || {};
                
                // Determine status
                const isPresent = (
                    status === true || 
                    status === 'present' || 
                    status === 'Present' || 
                    status === 'P' || 
                    status === 1 ||
                    status === '1'
                );
                
                // Extract department/year/division from record.class
                let department = '', year = '', division = '';
                if (record.class) {
                    const yearMatch = record.class.match(/(FY|SY|TY|BE)/i);
                    const deptMatch = record.class.match(/(CT|IT|ME|CE|EE|ET|AI|COMP|CIVIL|MECH|ENTC)/i);
                    const divMatch = record.class.match(/[^A-Z]([A-C])[^A-Z]?/i);
                    year = yearMatch ? yearMatch[1].toUpperCase() : '';
                    let dep = deptMatch ? deptMatch[1].toUpperCase() : '';
                    switch(dep) {
                        case 'COMP': dep = 'CT'; break;
                        case 'CIVIL': dep = 'CE'; break;
                        case 'MECH': dep = 'ME'; break;
                        case 'ENTC': dep = 'ET'; break;
                    }
                    department = dep;
                    division = divMatch ? divMatch[1].toUpperCase() : '';
                }
                
                // Get final values for filtering
                const finalDepartment = department || student.branch || student.department || '-';
                const finalYear = year || student.year || '-';
                const finalDivision = division || student.division || '-';
                
                // Apply department filter
                if (filters.department && finalDepartment !== filters.department) return;
                
                // Apply year filter
                if (filters.year && finalYear !== filters.year) return;
                
                // Apply division filter
                if (filters.division && finalDivision !== filters.division) return;
                
                // Extract batch information for practical lectures
                let batchInfo = '';
                if (record.lectureType === 'practical') {
                    if (record.batch) {
                        batchInfo = record.batch;
                    } else if (record.class && record.class.includes('Batch')) {
                        const batchMatch = record.class.match(/Batch([ABC])/i);
                        batchInfo = batchMatch ? batchMatch[1].toUpperCase() : '';
                    } else {
                        // Determine batch from student roll number (basic logic)
                        const rollNum = parseInt((student.rollNo || student.rollNumber || '').replace(/[^0-9]/g, '')) || 0;
                        if (rollNum >= 1 && rollNum <= 20) batchInfo = 'A';
                        else if (rollNum >= 21 && rollNum <= 40) batchInfo = 'B';
                        else if (rollNum >= 41) batchInfo = 'C';
                        else batchInfo = 'A'; // Default fallback
                    }
                }

                // Apply batch filter for practical lectures
                if (filters.batch && filters.batch.trim() !== '' && filters.batch !== 'all') {
                    if (record.lectureType === 'practical') {
                        // For practical lectures, check if batch matches
                        if (batchInfo !== filters.batch.toUpperCase()) {
                            console.log('‚è≠Ô∏è Skipping practical record - batch filter mismatch:', batchInfo, 'vs', filters.batch);
                            return;
                        }
                    }
                    // For theory lectures, we don't filter by batch (they don't have batches)
                }

                // Get teacher name from teacherNames mapping or teacherId
                const teacherName = filters.teacherNames[record.teacherId] || record.teacherId || 'Unknown Teacher';

                // Create detailed record for each student
                detailedRecords.push({
                    id: `${recordKey}_${studentId}`,
                    rollNo: student.rollNo || student.rollNumber || '-',
                    name: student.name || student.firstName || '-',
                    department: finalDepartment,
                    year: finalYear,
                    division: finalDivision,
                    subject: record.subject,
                    teacherName: teacherName,
                    lectureType: record.lectureType || 'theory',
                    batch: batchInfo,
                    date: record.date,
                    status: isPresent ? 'Present' : 'Absent',
                    statusClass: isPresent ? 'text-success' : 'text-danger',
                    attendancePercentage: isPresent ? 100 : 0,
                    recordKey: recordKey,
                    studentId: studentId,
                    studentName: student.name || student.firstName || '-'
                });
            });
        });
        
        console.log('üéØ Subject-wise detailed records:', detailedRecords.length, 'records created');
        console.log('üìä Sample detailed records:', detailedRecords.slice(0, 3));
        
        // Sort by date (newest first), then by subject, then by roll number
        detailedRecords.sort((a, b) => {
            const dateCompare = new Date(b.date) - new Date(a.date);
            if (dateCompare !== 0) return dateCompare;
            const subjectCompare = String(a.subject || '').localeCompare(String(b.subject || ''));
            if (subjectCompare !== 0) return subjectCompare;
            return String(a.rollNo || '').localeCompare(String(b.rollNo || ''));
        });
        
        return detailedRecords;
    }

    // --- COMBINED VIEW (per student) ---
    const studentMap = {};
    
    console.log('üîç Processing attendance records for combined view...');
    console.log('Total attendance records to process:', Object.keys(attendanceData).length);
    
    Object.entries(attendanceData).forEach(([recordKey, record]) => {
        console.log('üìù Processing record:', recordKey, {
            teacherId: record.teacherId,
            subject: record.subject,
            date: record.date,
            hasStudents: !!record.students,
            studentsType: typeof record.students,
            studentsKeys: record.students ? Object.keys(record.students).length : 0
        });
        
        // Skip if teacher filter is applied and doesn't match
        if (filters.teacherId && record.teacherId !== filters.teacherId) {
            console.log('‚è≠Ô∏è Skipping - teacher filter mismatch');
            return;
        }
        
        // Apply subject filter
        if (filters.subject && filters.subject.trim() !== '') {
            if (!record.subject || !record.subject.toLowerCase().includes(filters.subject.toLowerCase())) {
                console.log('‚è≠Ô∏è Skipping - subject filter mismatch:', record.subject, 'vs', filters.subject);
                return;
            }
        }
        
        // Apply lecture type filter
        if (filters.lectureType && filters.lectureType.trim() !== '') {
            const recordLectureType = record.lectureType || 'theory'; // Default to theory if not specified
            if (recordLectureType !== filters.lectureType) {
                console.log('‚è≠Ô∏è Skipping - lecture type filter mismatch:', recordLectureType, 'vs', filters.lectureType);
                return;
            }
        }
        
        // Apply date filters
        if ((filters.startDate && filters.startDate.trim() !== '') || (filters.endDate && filters.endDate.trim() !== '')) {
            if (!record.date) {
                console.log('‚è≠Ô∏è Skipping - no date in record');
                return;
            }
            
            const recordDate = new Date(record.date);
            const start = (filters.startDate && filters.startDate.trim() !== '') ? new Date(filters.startDate) : null;
            const end = (filters.endDate && filters.endDate.trim() !== '') ? new Date(filters.endDate) : null;
            
            if ((start && recordDate < start) || (end && recordDate > end)) {
                console.log('‚è≠Ô∏è Skipping - date filter mismatch:', record.date, 'not between', filters.startDate, 'and', filters.endDate);
                return;
            }
        }
        
        // Check if students data exists
        if (!record.students) {
            console.log('‚ö†Ô∏è No students data in record:', recordKey);
            return;
        }
        
        // Process each student in the record
        Object.entries(record.students).forEach(([studentId, status]) => {
            console.log('üë®‚Äçüéì Processing student:', studentId, 'Status:', status);
            
            // Initialize student if not exists
            if (!studentMap[studentId]) {
                const student = studentsData[studentId] || {};
                
                // Get student department/year/division for filtering
                const studentDept = student.branch || student.department || '-';
                const studentYear = student.year || '-';
                const studentDiv = student.division || '-';
                
                // Apply department filter
                if (filters.department && filters.department.trim() !== '' && studentDept !== filters.department) {
                    console.log('‚è≠Ô∏è Skipping student - department filter mismatch:', studentDept, 'vs', filters.department);
                    return;
                }
                
                // Apply year filter
                if (filters.year && filters.year.trim() !== '' && studentYear !== filters.year) {
                    console.log('‚è≠Ô∏è Skipping student - year filter mismatch:', studentYear, 'vs', filters.year);
                    return;
                }
                
                // Apply division filter
                if (filters.division && filters.division.trim() !== '' && studentDiv !== filters.division) {
                    console.log('‚è≠Ô∏è Skipping student - division filter mismatch:', studentDiv, 'vs', filters.division);
                    return;
                }
                
                studentMap[studentId] = {
                    id: studentId,
                    name: student.name || student.firstName || '-',
                    rollNo: student.rollNo || student.rollNumber || '-',
                    department: studentDept,
                    year: studentYear,
                    division: studentDiv,
                    present: 0,
                    absent: 0,
                    total: 0,
                    theoryPresent: 0,
                    theoryAbsent: 0,
                    practicalPresent: 0,
                    practicalAbsent: 0
                };
                console.log('‚úÖ Created new student entry:', studentMap[studentId]);
            } else {
                // Check if existing student matches filters
                const existingStudent = studentMap[studentId];
                
                // Apply filters to existing student
                if (filters.department && filters.department.trim() !== '' && existingStudent.department !== filters.department) {
                    console.log('‚è≠Ô∏è Skipping existing student - department filter mismatch:', existingStudent.department, 'vs', filters.department);
                    return;
                }
                
                if (filters.year && filters.year.trim() !== '' && existingStudent.year !== filters.year) {
                    console.log('‚è≠Ô∏è Skipping existing student - year filter mismatch:', existingStudent.year, 'vs', filters.year);
                    return;
                }
                
                if (filters.division && filters.division.trim() !== '' && existingStudent.division !== filters.division) {
                    console.log('‚è≠Ô∏è Skipping existing student - division filter mismatch:', existingStudent.division, 'vs', filters.division);
                    return;
                }
            }
            
            // Determine if present or absent
            const isPresent = (
                status === true || 
                status === 'present' || 
                status === 'Present' || 
                status === 'P' || 
                status === 1 ||
                status === '1'
            );
            
            console.log('üìä Student attendance check:', {
                studentId,
                status,
                isPresent,
                statusType: typeof status
            });
            
            // Update counts
            if (isPresent) {
                studentMap[studentId].present++;
                // Check if it's theory or practical
                if (record.lectureType === 'practical') {
                    studentMap[studentId].practicalPresent++;
                } else {
                    studentMap[studentId].theoryPresent++;
                }
            } else {
                studentMap[studentId].absent++;
                // Check if it's theory or practical
                if (record.lectureType === 'practical') {
                    studentMap[studentId].practicalAbsent++;
                } else {
                    studentMap[studentId].theoryAbsent++;
                }
            }
            studentMap[studentId].total++;
            
            console.log('üìà Updated student counts:', {
                studentId,
                present: studentMap[studentId].present,
                absent: studentMap[studentId].absent,
                total: studentMap[studentId].total
            });
        });
    });
    
    console.log('üéØ Final student map:', Object.keys(studentMap).length, 'students processed');
    console.log('üìä Sample processed students:', Object.values(studentMap).slice(0, 3));
    let rows = Object.values(studentMap);
    
    // Apply percentage filtering
    const percentageFilter = document.getElementById('percentageFilter').value;
    if (percentageFilter && percentageFilter.trim() !== '') {
        let thresholdPercentage;
        
        if (percentageFilter === 'custom') {
            const customValue = document.getElementById('customPercentage').value;
            thresholdPercentage = parseInt(customValue) || 0;
            if (!customValue || customValue.trim() === '' || thresholdPercentage <= 0) {
                console.log('üî¥ Custom percentage not valid, skipping filter');
                return rows;
            }
        } else {
            thresholdPercentage = parseInt(percentageFilter);
        }
        
        console.log('üìä Applying percentage filter:', thresholdPercentage + '%');
        
        rows = rows.filter(student => {
            const totalPresent = (student.theoryPresent || 0) + (student.practicalPresent || 0);
            const totalClasses = (student.theoryPresent || 0) + (student.theoryAbsent || 0) + 
                               (student.practicalPresent || 0) + (student.practicalAbsent || 0);
            const percentage = totalClasses > 0 ? Math.round((totalPresent / totalClasses) * 100) : 0;
            
            const shouldInclude = percentage < thresholdPercentage;
            console.log('üîç Student filter check:', {
                name: student.name,
                percentage: percentage + '%',
                threshold: thresholdPercentage + '%',
                included: shouldInclude
            });
            
            return shouldInclude;
        });
        
        console.log('üìä After percentage filtering:', rows.length, 'students remaining');
    }
    
    // Sort students by department first, then by roll number within each department
    console.log('üîÑ Sorting students by department and roll number...');
    rows.sort((a, b) => {
        // First sort by department
        const deptCompare = (a.department || '').localeCompare(b.department || '');
        if (deptCompare !== 0) return deptCompare;
        
        // Then sort by roll number within same department
        const rollA = String(a.rollNo || '');
        const rollB = String(b.rollNo || '');
        
        // Extract numeric part from roll number for proper sorting
        const numA = parseInt(rollA.replace(/[^0-9]/g, '')) || 0;
        const numB = parseInt(rollB.replace(/[^0-9]/g, '')) || 0;
        
        // If numeric parts are different, sort by number
        if (numA !== numB) {
            return numA - numB;
        }
        
        // If numeric parts are same, sort alphabetically
        return rollA.localeCompare(rollB);
    });
    
    console.log('‚úÖ Students sorted by department and roll number');
    console.log('üìä First few sorted students:', rows.slice(0, 5).map(s => ({
        dept: s.department,
        rollNo: s.rollNo,
        name: s.name
    })));
    
    return rows;
}

// Function to update table headers based on view mode
        function updateTableHeaders(viewMode) {
    const tableHead = document.querySelector('.attendance-table thead');
    if (viewMode === 'subject') {
        // Subject-wise detailed view
        tableHead.innerHTML = `
            <tr>
                <th>Roll No</th>
                <th>Student Name</th>
                <th>Department</th>
                <th>Year</th>
                <th>Division</th>
                <th>Subject</th>
                <th>Teacher Name</th>
                <th>Lecture Type</th>
                <th>Batch</th>
                <th>Date Taken</th>
                <th>Status</th>
                <th>Attendance %</th>
                <th>Actions</th>
            </tr>
        `;
    } else {
            const tableHead = document.querySelector('.attendance-table thead');
            if (viewMode === 'subject') {
                tableHead.innerHTML = `
                    <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Year</th>
                        <th>Division</th>
                        <th>Subject</th>
                        <th>Teacher Name</th>
                        <th>Lecture Type</th>
                        <th>Batch</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Attendance %</th>
                        <th>Actions</th>
                    </tr>
                `;
            } else {
                tableHead.innerHTML = `
                    <tr>
                        <th rowspan="2"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th rowspan="2">Roll No</th>
                        <th rowspan="2">Name</th>
                        <th rowspan="2">Department</th>
                        <th rowspan="2">Year</th>
                        <th rowspan="2">Division</th>
                        <th colspan="4" style="background: #059669; color: white;">Theory Classes</th>
                        <th colspan="4" style="background: #DC2626; color: white;">Practical Classes</th>
                        <th rowspan="2">Overall %</th>
                        <th rowspan="2">Actions</th>
                    </tr>
                    <tr>
                        <th style="background: #059669; color: white;">Present</th>
                        <th style="background: #059669; color: white;">Absent</th>
                        <th style="background: #059669; color: white;">Total</th>
                        <th style="background: #059669; color: white;">%</th>
                        <th style="background: #DC2626; color: white;">Present</th>
                        <th style="background: #DC2626; color: white;">Absent</th>
                        <th style="background: #DC2626; color: white;">Total</th>
                        <th style="background: #DC2626; color: white;">%</th>
                    </tr>
                `;
            }
        }

        async function processAttendanceData(attendanceData, studentsData, filters) {
    console.log('Processing attendance data with filters:', filters);
    console.log('Current view mode:', currentViewMode);

    // --- SUBJECT-WISE AGGREGATED VIEW ---
    if (currentViewMode === 'subject') {
        // Group by {subject, date}
        const subjectDateMap = {};
        Object.entries(attendanceData).forEach(([recordKey, record]) => {
            // Skip if not the teacher's record
            if (filters.teacherId && record.teacherId !== filters.teacherId) return;
            if (!record.subject || !record.date || !record.students) return;

            // Apply subject filter
            if (filters.subject && record.subject && !record.subject.toLowerCase().includes(filters.subject.toLowerCase())) return;
            // Apply date filter
            const recordDate = new Date(record.date);
            const start = filters.startDate ? new Date(filters.startDate) : null;
            const end = filters.endDate ? new Date(filters.endDate) : null;
            if ((start && recordDate < start) || (end && recordDate > end)) return;

            // Optionally apply department/year/division filters (from record.class)
            // ... (expand if needed)

            const key = `${record.subject}__${record.date}`;
            if (!subjectDateMap[key]) {
                subjectDateMap[key] = {
                    subject: record.subject,
                    date: record.date,
                    present: 0,
                    absent: 0,
                    department: '',
                    year: '',
                    division: ''
                };
                // Optionally extract department/year/division from record.class
                if (record.class) {
                    // Try to extract parts
                    const yearMatch = record.class.match(/(FY|SY|TY|BE)/i);
                    const deptMatch = record.class.match(/(CT|IT|ME|CE|EE|ET|AI|COMP|CIVIL|MECH|ENTC)/i);
                    const divMatch = record.class.match(/[^A-Z]([A-C])[^A-Z]?/i);
                    subjectDateMap[key].year = yearMatch ? yearMatch[1].toUpperCase() : '';
                    let dep = deptMatch ? deptMatch[1].toUpperCase() : '';
                    switch(dep) {
                        case 'COMP': dep = 'CT'; break;
                        case 'CIVIL': dep = 'CE'; break;
                        case 'MECH': dep = 'ME'; break;
                        case 'ENTC': dep = 'ET'; break;
                    }
                    subjectDateMap[key].department = dep;
                    subjectDateMap[key].division = divMatch ? divMatch[1].toUpperCase() : '';
                }
            }
            // Count present/absent
            Object.values(record.students).forEach(status => {
                const isPresent = (
                    status === true || status === 'true' || status === 'present' || status === 'Present' || status === 'PRESENT' || status === 'P' || status === 'p' || status === 1 || status === '1' || (typeof status === 'string' && status.toLowerCase().trim() === 'present')
                );
                if (isPresent) {
                    subjectDateMap[key].present++;
                } else {
                    subjectDateMap[key].absent++;
                }
            });
        });
        // Convert to array for rendering
        let rows = Object.values(subjectDateMap);
        // Sort by date descending, then subject
        rows.sort((a, b) => (b.date.localeCompare(a.date)) || a.subject.localeCompare(b.subject));
        return rows;
    }
    // --- END SUBJECT-WISE AGGREGATED VIEW ---

    // --- ORIGINAL LOGIC FOR COMBINED VIEW ---
            console.log('Processing attendance data with filters:', filters);
            console.log('Current view mode:', currentViewMode);
            
            const studentAttendance = {};
            let totalStudents = 0;
            let filteredStudents = 0;
            let totalTheoryAttendance = 0;
            let totalPracticalAttendance = 0;

            // First, find students who have attendance records
            Object.entries(attendanceData).forEach(([recordKey, record]) => {
                // Skip if not the teacher's record
                if (filters.teacherId && record.teacherId !== filters.teacherId) {
                    return;
                }

                if (record && record.students) {
                    // Get lecture type from record
                    const lectureType = record.lectureType || 'theory'; // default to theory if not specified
                    
                    // Get teacher name from mapping - try multiple approaches
                    let teacherName = 'Unknown Teacher';
                    
                    console.log('Resolving teacher name for record:', {
                        recordId: recordKey,
                        teacherId: record.teacherId,
                        teacherName: record.teacherName,
                        teacher: record.teacher,
                        createdBy: record.createdBy,
                        availableTeachers: Object.keys(filters.teacherNames)
                    });
                    
                    // Method 1: Direct teacher name from record
                    if (record.teacherName && record.teacherName !== 'Unknown Teacher' && record.teacherName.trim() !== '') {
                        teacherName = record.teacherName.trim();
                        console.log('Method 1 - Direct teacher name:', teacherName);
                    }
                    // Method 2: Teacher field from record
                    else if (record.teacher && record.teacher.trim() !== '') {
                        teacherName = record.teacher.trim();
                        console.log('Method 2 - Teacher field:', teacherName);
                    }
                    // Method 3: Look up by teacherId in mapping
                    else if (record.teacherId && filters.teacherNames[record.teacherId]) {
                        teacherName = filters.teacherNames[record.teacherId];
                        console.log('Method 3 - TeacherId mapping:', teacherName);
                    }
                    // Method 4: Look up by createdBy in mapping
                    else if (record.createdBy && filters.teacherNames[record.createdBy]) {
                        teacherName = filters.teacherNames[record.createdBy];
                        console.log('Method 4 - CreatedBy mapping:', teacherName);
                    }
                    // Method 5: Try to find teacher by partial match in mapping
                    else if (record.teacherId) {
                        // Try to find a teacher that contains this ID
                        for (const [id, name] of Object.entries(filters.teacherNames)) {
                            if (id.includes(record.teacherId) || record.teacherId.includes(id)) {
                                teacherName = name;
                                console.log('Method 5 - Partial match:', teacherName);
                                break;
                            }
                        }
                    }
                    // Method 6: Extract name from email if teacherId looks like email
                    if (teacherName === 'Unknown Teacher' && record.teacherId && record.teacherId.includes('@')) {
                        teacherName = record.teacherId.split('@')[0].replace(/[._]/g, ' ');
                        // Capitalize first letter of each word
                        teacherName = teacherName.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                        console.log('Method 6 - Email extraction:', teacherName);
                    }
                    // Method 7: Use createdBy as fallback if it's not an ID
                    else if (teacherName === 'Unknown Teacher' && record.createdBy && 
                             !record.createdBy.includes('-') && 
                             record.createdBy !== 'Unknown Teacher' && 
                             record.createdBy.trim() !== '') {
                        teacherName = record.createdBy.trim();
                        console.log('Method 7 - CreatedBy fallback:', teacherName);
                    }
                    // Method 8: Try to get teacher name from any available field
                    else if (teacherName === 'Unknown Teacher') {
                        // Look for any field that might contain teacher name
                        const possibleFields = ['teacherName', 'teacher', 'createdBy', 'teacherId'];
                        for (const field of possibleFields) {
                            if (record[field] && 
                                typeof record[field] === 'string' && 
                                record[field].trim() !== '' && 
                                record[field] !== 'Unknown Teacher' &&
                                !record[field].includes('-') &&
                                record[field].length > 2) {
                                teacherName = record[field].trim();
                                console.log('Method 8 - Found in field', field, ':', teacherName);
                                break;
                            }
                        }
                    }
                    
                    // Method 9: Enhanced lookup with fallback mechanism
                    if (teacherName === 'Unknown Teacher' && record.teacherId) {
                        // Try direct lookup in all teachers data
                        if (window.allTeachersData && window.allTeachersData[record.teacherId]) {
                            const teacher = window.allTeachersData[record.teacherId];
                            if (teacher.name && teacher.name !== 'My Account' && teacher.name !== 'admin') {
                                teacherName = teacher.name;
                                console.log('Method 9a - Direct teacher data lookup:', teacherName);
                            }
                        }
                        
                        // If still unknown, try enhanced lookup
                        if (teacherName === 'Unknown Teacher') {
                            const resolvedName = getTeacherNameById ? getTeacherNameById(record.teacherId, filters.teachersData, filters.teacherNames) : null;
                            if (resolvedName && resolvedName !== 'Unknown Teacher') {
                                teacherName = resolvedName;
                                console.log('Method 9b - Enhanced lookup resolved:', teacherName);
                            }
                        }
                        
                        // If this is the current user's record and we still can't find them
                        if (teacherName === 'Unknown Teacher') {
                            const currentTeacherId = sessionStorage.getItem('teacherId');
                            const currentAdminId = sessionStorage.getItem('adminId');
                            const currentFirebaseId = window.auth && window.auth.currentUser ? window.auth.currentUser.uid : null;
                            
                            if (record.teacherId === currentTeacherId || 
                                record.teacherId === currentAdminId || 
                                record.teacherId === currentFirebaseId) {
                                console.log('This is current user record, attempting to resolve name');
                                
                                // Try to get name from Firebase Auth or session
                                let fallbackName = null;
                                
                                // Check session storage first
                                const sessionName = sessionStorage.getItem('teacherName');
                                if (sessionName && sessionName !== 'null' && sessionName !== 'admin' && 
                                    sessionName !== 'Admin' && sessionName !== 'My Account' && sessionName.trim() !== '') {
                                    fallbackName = sessionName;
                                }
                                
                                // Check Firebase Auth
                                if (!fallbackName && window.auth && window.auth.currentUser) {
                                    const user = window.auth.currentUser;
                                    if (user.displayName && user.displayName.trim() !== '') {
                                        fallbackName = user.displayName.trim();
                                    } else if (user.email) {
                                        const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                                        fallbackName = emailName.split(' ').map(word =>
                                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                        ).join(' ');
                                    }
                                }
                                
                                if (fallbackName) {
                                    teacherName = fallbackName;
                                    // Always update the mapping immediately, regardless of DB write
                                    filters.teacherNames[record.teacherId] = fallbackName;
                                    filters.teachersData[record.teacherId] = {
                                        name: fallbackName,
                                        teacherId: record.teacherId,
                                        addedAutomatically: true
                                    };
                                    console.log('Method 9c - Current user fallback name:', fallbackName);
                                    // Attempt to add to DB asynchronously, but don't block UI
                                    addMissingTeacherRecord(record.teacherId, fallbackName).catch(error => {
                                        console.error('Failed to add missing teacher record:', error);
                                    });
                                } else {
                                    // Try one more time with comprehensive search
                                    const comprehensiveName = findTeacherNameComprehensive(record.teacherId);
                                    if (comprehensiveName) {
                                        teacherName = comprehensiveName;
                                        console.log('Method 9d - Comprehensive search found:', comprehensiveName);
                                    } else {
                                        teacherName = 'Current User';
                                        console.log('Method 9e - Fallback to Current User');
                                    }
                                }
                            } else {
                                // Try comprehensive search for any unknown teacher
                                const comprehensiveName = findTeacherNameComprehensive(record.teacherId);
                                if (comprehensiveName) {
                                    teacherName = comprehensiveName;
                                    console.log('Method 9f - Comprehensive search found:', comprehensiveName);
                                } else {
                                    teacherName = 'Unknown Teacher';
                                    console.log('Method 9g - Fallback to Unknown Teacher');
                                }
                            }
                        }
                    }
                    
                    // Method 10: If still Unknown Teacher, try comprehensive lookup on any ID fields
                    if (teacherName === 'Unknown Teacher') {
                        const idsToTry = [record.teacherId, record.createdBy];
                        for (const id of idsToTry) {
                            if (id && typeof id === 'string' && id.trim() !== '') {
                                const resolvedName = getTeacherNameById(id, filters.teachersData, filters.teacherNames);
                                if (resolvedName) {
                                    teacherName = resolvedName;
                                    console.log('Method 10 - Resolved ID to name:', teacherName);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // ‡§ú‡§∞ teacherName UID‡§∏‡§æ‡§∞‡§ñ‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ 'Unknown Teacher' ‡§Ö‡§∏‡•á‡§≤, ‡§§‡§∞ fallback ‡§µ‡§æ‡§™‡§∞‡§æ
                    if (
                        !teacherName ||
                        teacherName === 'Unknown Teacher' ||
                        (teacherName.length > 20 && /^[A-Za-z0-9]{20,}$/.test(teacherName))
                    ) {
                        // fallbackName ‡§Æ‡§ø‡§≥‡§µ‡§æ (session/Firebase Auth)
                        let fallbackName = null;
                        const sessionName = sessionStorage.getItem('teacherName');
                        if (sessionName && sessionName !== 'null' && sessionName.trim() !== '' && sessionName.toLowerCase() !== 'admin') {
                            fallbackName = sessionName;
                        } else if (window.auth && window.auth.currentUser) {
                            const user = window.auth.currentUser;
                            if (user.displayName && user.displayName.trim() !== '' && user.displayName.toLowerCase() !== 'admin') {
                                fallbackName = user.displayName.trim();
                            } else if (user.email) {
                                const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                                if (emailName.toLowerCase() !== 'admin') {
                                    fallbackName = emailName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                                }
                            }
                        }
                        teacherName = fallbackName || 'Teacher';
                        filters.teacherNames[record.teacherId] = teacherName;
                        filters.teachersData[record.teacherId] = {
                            name: teacherName,
                            teacherId: record.teacherId,
                            addedAutomatically: true
                        };
                        console.warn('Fallback teacher name ‡§µ‡§æ‡§™‡§∞‡§≤‡§æ:', teacherName);
                    }
                    
                    console.log('Teacher name resolution for record:', {
                        recordId: recordKey,
                        teacherId: record.teacherId,
                        resolvedTeacherName: teacherName,
                        recordTeacherName: record.teacherName,
                        recordTeacher: record.teacher,
                        createdBy: record.createdBy,
                        availableInMapping: record.teacherId ? !!filters.teacherNames[record.teacherId] : false
                    });

                    // Extract class info from record
                    let recordDepartment = '';
                    let recordYear = '';
                    let recordDivision = '';
                    if (record.class) {
                        // First try exact match pattern
                        const exactMatch = record.class.match(/^(FY|SY|TY|BE)(CT|IT|ME|CE|EE|ET|AI)(?:-([A-C]))?$/i);
                        if (exactMatch) {
                            recordYear = exactMatch[1].toUpperCase();
                            recordDepartment = exactMatch[2].toUpperCase();
                            recordDivision = exactMatch[3] ? exactMatch[3].toUpperCase() : '';
                        } else {
                            // Try to extract parts
                            const yearMatch = record.class.match(/(FY|SY|TY|BE)/i);
                            const deptMatch = record.class.match(/(CT|IT|ME|CE|EE|ET|AI|COMP|CIVIL|MECH|ENTC)/i);
                            const divMatch = record.class.match(/[^A-Z]([A-C])[^A-Z]/i);
                            
                            recordYear = yearMatch ? yearMatch[1].toUpperCase() : '';
                            recordDepartment = deptMatch ? deptMatch[1].toUpperCase() : '';
                            recordDivision = divMatch ? divMatch[1].toUpperCase() : '';
                            
                            // Map department codes
                            if (recordDepartment) {
                                switch (recordDepartment.toUpperCase()) {
                                    case 'COMP': recordDepartment = 'CT'; break;
                                    case 'CIVIL': recordDepartment = 'CE'; break;
                                    case 'MECH': recordDepartment = 'ME'; break;
                                    case 'ENTC': recordDepartment = 'ET'; break;
                                }
                            }
                        }
                        console.log('Parsed class code:', {
                            original: record.class,
                            year: recordYear,
                            department: recordDepartment,
                            division: recordDivision
                        });
                    }

                    Object.keys(record.students).forEach(studentId => {
                        if (studentsData[studentId]) {
                            totalStudents++;
                            const student = studentsData[studentId];
                            
                            // Get student's department, year and division
                            const studentDepartment = student.department || student.branch || recordDepartment || '-';
                            const studentDepartmentCode = getDepartmentCode(studentDepartment);
                            const studentYear = getYearCode(student.year || recordYear || '-');
                            const studentDivision = student.division || recordDivision || '-';
                            
                            console.log('Processing student:', {
                                name: student.name,
                                department: studentDepartmentCode,
                                year: studentYear,
                                division: studentDivision,
                                filters: filters
                            });

                            // Apply department filter
                            if (filters.department && studentDepartmentCode !== filters.department) {
                                console.log('Skipping student - department mismatch:', {
                                    student: student.name,
                                    studentDepartment: studentDepartmentCode,
                                    filterDepartment: filters.department
                                });
                                return;
                            }

                            // Apply year filter
                            if (filters.year && studentYear !== filters.year) {
                                console.log('Skipping student - year mismatch:', {
                                    student: student.name,
                                    studentYear,
                                    filterYear: filters.year
                                });
                                return;
                            }

                            // Apply division filter
                            if (filters.division && studentDivision !== filters.division) {
                                console.log('Skipping student - division mismatch:', {
                                    student: student.name,
                                    studentDivision,
                                    filterDivision: filters.division
                                });
                                return;
                            }

                            filteredStudents++;

                            // Create key based on view mode
                            const studentKey = currentViewMode === 'subject' 
                                ? `${studentId}_${record.subject || 'unknown'}` 
                                : studentId;
                            
                            // Initialize student record if not exists
                            if (!studentAttendance[studentKey]) {
                                studentAttendance[studentKey] = {
                                    id: studentId,
                                    name: student.name || `${student.firstName || ''} ${student.lastName || ''}`.trim(),
                                    rollNo: student.rollNo,
                                    department: studentDepartmentCode,
                                    departmentName: getDepartmentFullName(studentDepartmentCode),
                                    year: studentYear,
                                    division: studentDivision,
                                    ...(currentViewMode === 'subject' && { subject: record.subject || '-' }),
                                    theoryPresent: 0,
                                    theoryAbsent: 0,
                                    theoryTotal: 0,
                                    practicalPresent: 0,
                                    practicalAbsent: 0,
                                    practicalTotal: 0,
                                    teacherName: (function() {
                                        // Always try to get the best possible teacher name
                                        let bestName = null;
                                        
                                        // Priority 1: Direct teacher name from record
                                        if (teacherName && 
                                            teacherName !== 'Unknown Teacher' && 
                                            teacherName !== 'My Account' && 
                                            teacherName !== 'Teacher' && 
                                            teacherName !== 'admin' && 
                                            teacherName !== 'Admin' && 
                                            teacherName !== 'ADMIN' && 
                                            !(teacherName.length > 20 && /^[A-Za-z0-9]{20,}$/.test(teacherName))) {
                                            bestName = teacherName;
                                        }
                                        
                                        // Priority 2: Session storage
                                        if (!bestName) {
                                            const sessionName = sessionStorage.getItem('teacherName');
                                            if (sessionName && sessionName !== 'null' && sessionName !== 'My Account' && sessionName.trim() !== '') {
                                                bestName = sessionName;
                                            }
                                        }
                                        
                                        // Priority 3: Firebase Auth current user
                                        if (!bestName && window.auth && window.auth.currentUser) {
                                            const user = window.auth.currentUser;
                                            if (user.displayName && user.displayName.trim() !== '' && user.displayName !== 'My Account') {
                                                bestName = user.displayName.trim();
                                            } else if (user.email) {
                                                const emailName = user.email.split('@')[0].replace(/[._]/g, ' ');
                                                bestName = emailName.split(' ').map(word => 
                                                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                                ).join(' ');
                                            }
                                        }
                                        
                                        // Priority 4: Try record fields
                                        if (!bestName) {
                                            if (record.createdBy && record.createdBy !== 'Unknown Teacher' && record.createdBy.trim() !== '') {
                                                bestName = record.createdBy;
                                            } else if (record.teacherId && record.teacherId.includes('@')) {
                                                const emailName = record.teacherId.split('@')[0].replace(/[._]/g, ' ');
                                                bestName = emailName.split(' ').map(word => 
                                                    word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                                                ).join(' ');
                                            }
                                        }
                                        
                                        // Final result
                                        if (bestName && bestName.split(' ').length >= 2) {
                                            return bestName.toUpperCase();
                                        }
                                        return bestName || 'CURRENT TEACHER';
                                    })(),
                                    teacherId: record.teacherId || '-',
                                    present: 0,
                                    absent: 0,
                                    total: 0,
                                    dates: {}
                                };
                                console.log('Added student:', {
                                    name: studentAttendance[studentKey].name,
                                    department: studentDepartmentCode,
                                    year: studentYear,
                                    division: studentDivision
                                });
                            }
                        }
                    });
                }
            });

            console.log('Filtering summary:', {
                totalStudents,
                filteredStudents,
                filters
            });

            // Process attendance records for found students
            Object.entries(attendanceData).forEach(([key, record]) => {
                if (!record.date || !record.students) {
                    return;
                }

                // Apply subject filter if specified
                if (filters.subject && record.subject && 
                    !record.subject.toLowerCase().includes(filters.subject.toLowerCase())) {
                    return;
                }

                const recordDate = new Date(record.date);
                const start = filters.startDate ? new Date(filters.startDate) : null;
                const end = filters.endDate ? new Date(filters.endDate) : null;

                if ((!start || recordDate >= start) && (!end || recordDate <= end)) {
                    Object.entries(record.students).forEach(([studentId, status]) => {
                        const studentKey = studentId;
                        if (studentAttendance[studentKey]) {
                            // Get lecture type from record
                            const lectureType = record.lectureType || 'theory';
                            
                            // Update total count based on lecture type
                            if (lectureType.toLowerCase() === 'practical') {
                                studentAttendance[studentKey].practicalTotal++;
                            } else {
                                studentAttendance[studentKey].theoryTotal++;
                            }
                            
                            // Overall total
                            studentAttendance[studentKey].total++;
                            
                            // Enhanced status checking to handle all possible formats
                            if (Math.random() < 0.01) { // Log 1% of records to avoid spam
                                console.log('Attendance status debug:', {
                                    studentId,
                                    status,
                                    lectureType,
                                    date: record.date,
                                    subject: record.subject
                                });
                            }
                            
                            // Handle null/undefined values
                            if (status === null || status === undefined) {
                                console.warn('Null/undefined attendance status found:', {
                                    studentId,
                                    date: record.date,
                                    subject: record.subject
                                });
                                // Treat as absent
                                if (lectureType.toLowerCase() === 'practical') {
                                    studentAttendance[studentKey].practicalAbsent++;
                                } else {
                                    studentAttendance[studentKey].theoryAbsent++;
                                }
                                studentAttendance[studentKey].absent++;
                                studentAttendance[studentKey].dates[record.date] = 'absent';
                                return;
                            }
                            
                            const isPresent = (
                                status === true || 
                                status === 'true' ||
                                status === 'present' || 
                                status === 'Present' || 
                                status === 'PRESENT' ||
                                status === 'P' ||
                                status === 'p' ||
                                status === 1 ||
                                status === '1' ||
                                (typeof status === 'string' && status.toLowerCase().trim() === 'present')
                            );
                            
                            if (isPresent) {
                                // Update theory/practical present count
                                if (lectureType.toLowerCase() === 'practical') {
                                    studentAttendance[studentKey].practicalPresent++;
                                } else {
                                    studentAttendance[studentKey].theoryPresent++;
                                }
                                studentAttendance[studentKey].present++;
                            } else {
                                // Update theory/practical absent count
                                if (lectureType.toLowerCase() === 'practical') {
                                    studentAttendance[studentKey].practicalAbsent++;
                                } else {
                                    studentAttendance[studentKey].theoryAbsent++;
                                }
                                studentAttendance[studentKey].absent++;
                            }
                            
                            studentAttendance[studentKey].dates[record.date] = status;
                        }
                    });
                }
            });

            // Convert to array and calculate percentages
            let students = Object.values(studentAttendance).map(student => {
                const percentage = student.total > 0 ? ((student.present / student.total) * 100) : 0;
                const theoryPercentage = student.theoryTotal > 0 ? ((student.theoryPresent / student.theoryTotal) * 100) : 0;
                const practicalPercentage = student.practicalTotal > 0 ? ((student.practicalPresent / student.practicalTotal) * 100) : 0;
                
                return {
                    ...student,
                    percentage,
                    theoryPercentage,
                    practicalPercentage
                };
            });
            
            // Debug: Log attendance summary
            console.log('Attendance processing summary:', {
                totalStudentRecords: students.length,
                studentsWithAttendance: students.filter(s => s.total > 0).length,
                studentsWithoutAttendance: students.filter(s => s.total === 0).length,
                totalPresentRecords: students.reduce((sum, s) => sum + s.present, 0),
                totalAbsentRecords: students.reduce((sum, s) => sum + s.absent, 0),
                totalRecords: students.reduce((sum, s) => sum + s.total, 0),
                sampleStudents: students.slice(0, 3).map(s => ({
                    name: s.name,
                    present: s.present,
                    absent: s.absent,
                    total: s.total,
                    percentage: s.percentage.toFixed(1)
                }))
            });

            // Apply percentage filter if selected
            const percentageFilter = document.getElementById('percentageFilter').value;
            const customPercentage = document.getElementById('customPercentage').value;
            const filterPercentage = percentageFilter === 'custom' ? parseFloat(customPercentage) : parseFloat(percentageFilter);

            if (filterPercentage) {
                students = students.filter(student => student.percentage < filterPercentage);
            }

            console.log('Final filtered students:', {
                total: students.length,
                byDepartment: students.reduce((acc, s) => {
                    acc[s.department] = (acc[s.department] || 0) + 1;
                    return acc;
                }, {}),
                byYear: students.reduce((acc, s) => {
                    acc[s.year] = (acc[s.year] || 0) + 1;
                    return acc;
                }, {}),
                byDivision: students.reduce((acc, s) => {
                    acc[s.division] = (acc[s.division] || 0) + 1;
                    return acc;
                }, {})
            });
            
            return students;
        }

        // Helper functions for department and year code conversion
        function getDepartmentCode(department) {
            if (!department) return '-';
            const dept = department.toString().toUpperCase();
            switch (dept) {
                case 'COMPUTER TECHNOLOGY':
                case 'COMPUTER':
                case 'COMP':
                    return 'CT';
                case 'INFORMATION TECHNOLOGY':
                case 'IT':
                    return 'IT';
                case 'MECHANICAL ENGINEERING':
                case 'MECHANICAL':
                case 'MECH':
                    return 'ME';
                case 'CIVIL ENGINEERING':
                case 'CIVIL':
                    return 'CE';
                case 'ELECTRICAL ENGINEERING':
                case 'ELECTRICAL':
                case 'EE':
                    return 'EE';
                case 'ELECTRONICS & TELECOMMUNICATION':
                case 'ELECTRONICS AND TELECOMMUNICATION':
                case 'ENTC':
                case 'ET':
                    return 'ET';
                case 'ARTIFICIAL INTELLIGENCE':
                case 'AI':
                    return 'AI';
                default:
                    return dept.length <= 3 ? dept : dept.substring(0, 3);
            }
        }

        function getDepartmentFullName(code) {
            if (!code) return '-';
            switch (code.toUpperCase()) {
                case 'CT': return 'Computer Technology';
                case 'IT': return 'Information Technology';
                case 'ME': return 'Mechanical Engineering';
                case 'CE': return 'Civil Engineering';
                case 'EE': return 'Electrical Engineering';
                case 'ET': return 'Electronics & Telecommunication';
                case 'AI': return 'Artificial Intelligence';
                default: return code;
            }
        }

        function getYearCode(year) {
            if (!year) return '-';
            const yr = year.toString().toUpperCase();
            switch (yr) {
                case 'FIRST YEAR':
                case 'FIRST':
                case '1':
                case 'I':
                    return 'FY';
                case 'SECOND YEAR':
                case 'SECOND':
                case '2':
                case 'II':
                    return 'SY';
                case 'THIRD YEAR':
                case 'THIRD':
                case '3':
                case 'III':
                    return 'TY';
                case 'FINAL YEAR':
                case 'FOURTH YEAR':
                case 'FOURTH':
                case 'FINAL':
                case '4':
                case 'IV':
                    return 'BE';
                default:
                    return yr.length <= 3 ? yr : yr.substring(0, 3);
            }
        }

        function showLoadingState() {
            // Show loading state in table
            const tableBody = document.getElementById('attendanceTableBody');
            if (tableBody) {
                const colSpan = currentViewMode === 'subject' ? '9' : '16';
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="text-center p-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading attendance records...</p>
                        </td>
                    </tr>
                `;
            }
        }

        function showError(error) {
            const tableBody = document.getElementById('attendanceTableBody');
            if (tableBody) {
                const colSpan = currentViewMode === 'subject' ? '9' : '16';
                tableBody.innerHTML = `
                        <tr>
                        <td colspan="${colSpan}" class="text-center p-4">
                            <i class="fas fa-exclamation-circle text-danger fa-2x mb-3"></i>
                            <p>Error loading attendance data</p>
                            <p class="text-muted small">${error.message}</p>
                            </td>
                        </tr>
                    `;
            }
        }

        // Add these new functions for selection handling
        let selectedStudents = new Set();

        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedStudents.add(checkbox.value);
                } else {
                    selectedStudents.delete(checkbox.value);
                }
            });
            
            updateDeleteButton();
        }

        function toggleStudent(studentId, checked) {
            if (checked) {
                selectedStudents.add(studentId);
            } else {
                selectedStudents.delete(studentId);
            }
            
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.student-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            selectAllCheckbox.checked = selectedStudents.size === allCheckboxes.length;
            
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const deleteBtn = document.querySelector('button[onclick="confirmDeleteAllAttendance()"]');
            if (selectedStudents.size > 0) {
                deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedStudents.size})`;

function updateDeleteButton() {
    const deleteBtn = document.querySelector('button[onclick="confirmDeleteAllAttendance()"]');
    if (selectedStudents.size > 0) {
        deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete Selected (${selectedStudents.size})`;
    } else {
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete All Attendance';
    }
}

// Robust updateTable function for dual view attendance reports
function updateTable(students) {
    const tableBody = document.getElementById('attendanceTableBody');
    if (!tableBody) return;
    currentFilteredStudents = students;
    if (!Array.isArray(students) || students.length === 0) {
        const colSpan = currentViewMode === 'subject' ? 4 : 16;
        tableBody.innerHTML = `
            <tr>
                <td colspan="${colSpan}" class="text-center" style="padding: 40px;">
                    No attendance records found.
                </td>
            </tr>
        `;
        return;
    }
    
    let rows = '';
    if (currentViewMode === 'subject') {
        students.forEach(row => {
            rows += `
                <tr>
                    <td>${row.subject || '-'}</td>
                    <td>${row.date || '-'}</td>
                    <td class="attendance-count present">${row.present || 0}</td>
                    <td class="attendance-count absent">${row.absent || 0}</td>
                </tr>
            `;
        });
    } else {
        students.forEach(student => {
            const theoryPercentage = student.theoryTotal > 0 ? ((student.theoryPresent / student.theoryTotal) * 100).toFixed(1) : '0.0';
            const practicalPercentage = student.practicalTotal > 0 ? ((student.practicalPresent / student.practicalTotal) * 100).toFixed(1) : '0.0';
            const percentage = student.total > 0 ? ((student.present / student.total) * 100).toFixed(1) : '0.0';
            const getPercentageClass = (perc) => {
                perc = parseFloat(perc);
                if (perc >= 75) return 'percentage-good';
                if (perc >= 50) return 'percentage-warning';
                return 'percentage-danger';
            };
            rows += `
                <tr>
                    <td><input type="checkbox" class="student-checkbox" value="${student.id || ''}" ${selectedStudents && selectedStudents.has && selectedStudents.has(student.id) ? 'checked' : ''} onchange="toggleStudent('${student.id}', this.checked)"></td>
                    <td>${student.rollNo || '-'}</td>
                    <td>${student.name || '-'}</td>
                    <td>${student.departmentName || getDepartmentFullName(student.department) || '-'}</td>
                    <td>${student.year || '-'}</td>
                    <td>${student.division || '-'}</td>
                    <td class="theory-data text-success" style="font-weight: bold;">${student.theoryPresent || 0}</td>
                    <td class="theory-data text-danger" style="font-weight: bold;">${student.theoryAbsent || 0}</td>
                    <td class="theory-data">${theoryTotal}</td>
                    <td class="theory-data ${getPercentageClass(theoryPercentage)}">${theoryPercentage}%</td>
                    <td class="practical-data text-success" style="font-weight: bold;">${student.practicalPresent || 0}</td>
                    <td class="practical-data text-danger" style="font-weight: bold;">${student.practicalAbsent || 0}</td>
                    <td class="practical-data">${practicalTotal}</td>
                    <td class="practical-data ${getPercentageClass(practicalPercentage)}">${practicalPercentage}%</td>
                    <td class="${getPercentageClass(percentage)}" style="font-weight: bold;">${percentage}%</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editStudent('${student.id}')" title="Edit Student">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    tableBody.innerHTML = rows;
}

        function getCurrentFilteredData() {
            return currentFilteredStudents;
        }

        function exportToExcel() {
            const students = getCurrentFilteredData();
            if (!students || students.length === 0) {
                alert('No data to export');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for export
            const exportData = students.map(student => ({
                'Roll No': student.rollNo,
                'Name': student.name,
                'Department': student.department,
                'Year': student.year,
                'Division': student.division,
                'Subject': student.subject,
                'Teacher': student.teacherName,
                'Present': student.present,
                'Absent': student.absent,
                'Total': student.total,
                'Attendance %': student.percentage.toFixed(1) + '%'
            }));

            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Add worksheet to workbook
            const filterValue = document.getElementById('percentageFilter').value;
            const filterText = filterValue === 'custom' 
                ? document.getElementById('customPercentage').value 
                : filterValue;
            const sheetName = filterValue 
                ? `Below ${filterText}% Attendance` 
                : 'All Students';
            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Generate Excel file
            const date = new Date().toLocaleDateString().replace(/\//g, '-');
            XLSX.writeFile(wb, `Attendance_Report_${date}.xlsx`);
        }

        // PDF export function removed as per user request
        // function exportToPDF() { ... }

        function getCurrentFilteredData() {
            // Get the current filtered data from the table
            const tableBody = document.getElementById('attendanceTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            const students = [];
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 0) continue; // Skip if no cells (like in loading/error state)
                
                // Get text content of cells
                const rollNo = cells[1].textContent.trim();
                const name = cells[2].textContent.trim();
                const department = cells[3].textContent.trim();
                const year = cells[4].textContent.trim();
                const division = cells[5].textContent.trim();
                const subject = cells[6].textContent.trim();
                const teacherName = cells[7].textContent.trim();
                const presentMatch = (cells[8].textContent || '').match(/\d+/);
                const absentMatch = (cells[9].textContent || '').match(/\d+/);
                const present = parseInt(presentMatch ? presentMatch[0] : '0');
                const absent = parseInt(absentMatch ? absentMatch[0] : '0');
                const percentage = parseFloat(cells[10].textContent);
                
                students.push({
                    id: cells[0].querySelector('.student-checkbox').value, // Use the checkbox value as the ID
                    rollNo,
                    name,
                    department,
                    year,
                    division,
                    subject,
                    teacherName,
                    present,
                    absent,
                    total: present + absent,
                    percentage
                });
            }
            
            return students;
        }

        // Add event listener for subject filter
        document.addEventListener('DOMContentLoaded', () => {
            // Add existing event listeners
            document.getElementById('department').addEventListener('change', loadReports);
            document.getElementById('year').addEventListener('change', loadReports);
            document.getElementById('division').addEventListener('change', loadReports);
            document.getElementById('startDate').addEventListener('change', loadReports);
            document.getElementById('endDate').addEventListener('change', loadReports);
            document.getElementById('percentageFilter').addEventListener('change', loadReports);
            document.getElementById('customPercentage').addEventListener('input', loadReports);
            
            // Add new subject filter event listener
            document.getElementById('subject').addEventListener('input', debounce(loadReports, 500));
        });

        // Add debounce function to prevent too many API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to show delete confirmation modal
        function confirmDeleteAllAttendance() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'block';
        }

        // Function to close delete confirmation modal
        function closeDeleteModal() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'none';
        }

        // Function to delete all attendance records
        async function deleteAllAttendance() {
            try {
                console.log('Starting delete operation...');
                
                // Check if user is admin
                const isAdmin = sessionStorage.getItem('isAdminLoggedIn') === 'true';
                console.log('Is admin?', isAdmin);
                
                if (!isAdmin) {
                    alert('Only administrators can delete attendance records.');
                    closeDeleteModal();
                    return;
                }

                // Show loading state
                const deleteBtn = document.querySelector('.modal-footer .btn-danger');
                const originalText = deleteBtn.innerHTML;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                deleteBtn.disabled = true;

                // Get attendance records
                const snapshot = await window.db.ref('attendance').once('value');
                const attendanceData = snapshot.val() || {};

                try {
                    // If specific students are selected
                    if (selectedStudents.size > 0) {
                        console.log('Deleting attendance for selected students:', selectedStudents);
                        
                        // Create updates object
                        const updates = {};
                        
                        // For each attendance record
                        Object.entries(attendanceData).forEach(([key, record]) => {
                            if (record.students) {
                                // Keep only non-selected students
                                const updatedStudents = {};
                                Object.entries(record.students).forEach(([studentId, status]) => {
                                    if (!selectedStudents.has(studentId)) {
                                        updatedStudents[studentId] = status;
                                    }
                                });
                                
                                if (Object.keys(updatedStudents).length > 0) {
                                    // Update record with remaining students
                                    updates[`attendance/${key}/students`] = updatedStudents;
                                } else {
                                    // If no students left, delete the entire record
                                    updates[`attendance/${key}`] = null;
                                }
                            }
                        });
                        
                        // Apply updates
                        await window.db.ref().update(updates);
                        console.log('Selected students attendance deleted');
                        
                    } else {
                        // Delete all attendance records
                        await window.db.ref('attendance').remove();
                        console.log('All attendance records deleted');
                    }

                    // Clear selected students
                    selectedStudents.clear();
                    
                    // Close modal
                    closeDeleteModal();

                    // Show success message
                    alert('Selected attendance records have been deleted successfully.');

                    // Clear the table immediately
                    const tableBody = document.getElementById('attendanceTableBody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center" style="padding: 40px;">
                                <i class="fas fa-folder-open" style="font-size: 48px; color: #9CA3AF; margin-bottom: 16px;"></i>
                                <p style="color: #4B5563; font-size: 1.1rem; font-weight: 500;">No attendance records found</p>
                                <p style="color: #6B7280; font-size: 0.95rem;">All selected records have been deleted</p>
                            </td>
                        </tr>
                    `;

                    // Force reload data from server
                    await window.db.ref('attendance').once('value', null, { serverCache: true });
                    
                    // Reload reports with cache disabled
                    await loadReports();

                    // Refresh the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);

                } catch (error) {
                    console.error('Error in delete operation:', error);
                    alert('Error deleting records: ' + error.message);
                }

            } catch (error) {
                console.error('Error in deleteAllAttendance:', error);
                alert('Error deleting attendance records: ' + error.message);
            } finally {
                // Reset button state
                const deleteBtn = document.querySelector('.modal-footer .btn-danger');
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('deleteConfirmModal');
            if (event.target == modal) {
                closeDeleteModal();
            }
        };

        // Initialize teacher UID to code mapping
        (async function() {
            try {
                // Wait for Firebase to be ready
                if (typeof window.waitForFirebase === 'function') {
                    await window.waitForFirebase();
                }
                
                // Check if db is available
                if (window.db && typeof window.db.ref === 'function') {
                    const teacherUidToCodeSnap = await window.db.ref('teacherUidToCode').once('value');
                    window.teacherUidToCode = teacherUidToCodeSnap.exists() ? teacherUidToCodeSnap.val() : {};
                    console.log('Teacher UID to Code mapping loaded:', Object.keys(window.teacherUidToCode).length, 'entries');
                    console.log('Sample mapping entries:', Object.entries(window.teacherUidToCode).slice(0, 3));
                } else {
                    console.warn('Firebase database not available, using empty teacher UID mapping');
                    window.teacherUidToCode = {};
                }
            } catch (error) {
                console.error('Error loading teacher UID to code mapping:', error);
                window.teacherUidToCode = {};
            }
        })();

        // Function to edit student attendance - Simple version
        function editStudent(studentId) {
            console.log('Edit button clicked for student ID:', studentId);
            console.log('Current filtered students:', currentFilteredStudents);
            
            // Find the student data from current filtered students
            let student = currentFilteredStudents.find(s => s.id === studentId);
            
            // If not found by id, try to find by other fields
            if (!student) {
                student = currentFilteredStudents.find(s => 
                    s.rollNo === studentId || 
                    s.name === studentId ||
                    JSON.stringify(s).includes(studentId)
                );
            }
            
            if (!student) {
                alert('Student not found. ID: ' + studentId);
                console.error('Student not found with ID:', studentId);
                return;
            }

            console.log('Found student:', student);

            // Simple prompt to change present/absent counts
            const currentPresent = student.present || 0;
            const currentAbsent = student.absent || 0;
            const total = currentPresent + currentAbsent;
            
            if (total === 0) {
                alert('This student has no attendance records to edit.');
                return;
            }
            
            const newPresent = prompt(`Student: ${student.name} (${student.rollNo})\n\nCurrent: ${currentPresent} Present, ${currentAbsent} Absent\nTotal Lectures: ${total}\n\nEnter new Present count (0-${total}):`, currentPresent);
            
            if (newPresent === null) return; // User cancelled
            
            const presentCount = parseInt(newPresent);
            if (isNaN(presentCount) || presentCount < 0 || presentCount > total) {
                alert('Invalid number. Please enter a number between 0 and ' + total);
                return;
            }
            
            const absentCount = total - presentCount;
            
            // Update the student data
            updateStudentAttendance(student, presentCount, absentCount);
        }

        // Function to update student attendance - Simple version
        async function updateStudentAttendance(student, newPresent, newAbsent) {
            try {
                console.log('Updating attendance for student:', student);
                console.log('New values - Present:', newPresent, 'Absent:', newAbsent);
                
                // Wait for Firebase to be ready
                await waitForFirebase();
                
                // Try to update the student data directly in the processed data structure
                // This is a simpler approach that works with the current data
                
                // Update the student object in currentFilteredStudents immediately
                const studentIndex = currentFilteredStudents.findIndex(s => 
                    s.rollNo === student.rollNo && s.name === student.name
                );
                
                if (studentIndex !== -1) {
                    currentFilteredStudents[studentIndex].present = newPresent;
                    currentFilteredStudents[studentIndex].absent = newAbsent;
                    currentFilteredStudents[studentIndex].total = newPresent + newAbsent;
                    
                    console.log('Updated student data:', currentFilteredStudents[studentIndex]);
                    
                    // Immediately update the table display
                    updateTable(currentFilteredStudents);
                    
                    console.log('Table updated with new data');
                } else {
                    console.log('Student not found in currentFilteredStudents for immediate update');
                }
                
                // Also try to find and update in Firebase
                const attendanceRef = window.firebase.database().ref('attendance');
                const snapshot = await attendanceRef.once('value');
                const allAttendance = snapshot.val() || {};
                
                console.log('Searching in', Object.keys(allAttendance).length, 'attendance records');
                
                // Find matching records (there might be multiple)
                const matchingKeys = [];
                Object.keys(allAttendance).forEach(key => {
                    const record = allAttendance[key];
                    if (record.rollNo === student.rollNo || 
                        (record.name === student.name && record.department === student.department)) {
                        matchingKeys.push(key);
                        console.log('Found matching record:', key, record);
                    }
                });
                
                if (matchingKeys.length > 0) {
                    // Update all matching records
                    const updates = {};
                    matchingKeys.forEach(key => {
                        updates[`attendance/${key}/present`] = newPresent;
                        updates[`attendance/${key}/absent`] = newAbsent;
                        updates[`attendance/${key}/total`] = newPresent + newAbsent;
                        updates[`attendance/${key}/lastModified`] = new Date().toISOString();
                    });
                    
                    await window.firebase.database().ref().update(updates);
                    console.log('Updated', matchingKeys.length, 'records in Firebase');
                } else {
                    console.log('No matching records found in Firebase, creating new record');
                    // Create new record
                    await attendanceRef.push({
                        rollNo: student.rollNo,
                        name: student.name,
                        department: student.department || student.departmentName,
                        year: student.year,
                        division: student.division,
                        present: newPresent,
                        absent: newAbsent,
                        total: newPresent + newAbsent,
                        lastModified: new Date().toISOString(),
                        createdBy: 'edit_function'
                    });
                }
                
                alert(`Attendance updated successfully!\n\nStudent: ${student.name}\nNew Present: ${newPresent}\nNew Absent: ${newAbsent}\n\nTable has been updated with new values.`);
                
                // Table is already updated immediately above, no need to reload
                
            } catch (error) {
                console.error('Error updating attendance:', error);
                alert('Error updating attendance: ' + error.message);
            }
        }

        // Simple edit functionality complete - no complex functions needed
        
        } // Close updateStudentAttendance function
        
        // Function to edit individual student record in subject-wise view
        async function editStudentRecord(recordKey, studentId) {
            console.log('Edit record clicked:', { recordKey, studentId });
            
            try {
                // Wait for Firebase to be ready
                await waitForFirebase();
                
                // Get the attendance record
                const recordRef = window.db.ref(`attendance/${recordKey}`);
                const snapshot = await recordRef.once('value');
                const record = snapshot.val();
                
                if (!record || !record.students || !record.students[studentId]) {
                    alert('Record not found!');
                    return;
                }
                
                const currentStatus = record.students[studentId];
                const isCurrentlyPresent = (
                    currentStatus === true || 
                    currentStatus === 'present' || 
                    currentStatus === 'Present' || 
                    currentStatus === 'P' || 
                    currentStatus === 1 ||
                    currentStatus === '1'
                );
                
                const newStatus = confirm(
                    `Current Status: ${isCurrentlyPresent ? 'Present' : 'Absent'}\n\n` +
                    `Click OK to mark as ${isCurrentlyPresent ? 'Absent' : 'Present'}\n` +
                    `Click Cancel to keep current status`
                );
                
                if (newStatus) {
                    // Update the status
                    const updatedStatus = !isCurrentlyPresent;
                    await recordRef.child(`students/${studentId}`).set(updatedStatus);
                    
                    // Update present/absent counts
                    const students = record.students;
                    let presentCount = 0, absentCount = 0;
                    
                    Object.values(students).forEach(status => {
                        const isPresent = (
                            status === true || 
                            status === 'present' || 
                            status === 'Present' || 
                            status === 'P' || 
                            status === 1 ||
                            status === '1'
                        );
                        if (isPresent) presentCount++;
                        else absentCount++;
                    });
                    
                    // Update counts in record
                    await recordRef.update({
                        presentCount: presentCount,
                        absentCount: absentCount,
                        lastModified: new Date().toISOString()
                    });
                    
                    alert(`Status updated successfully!\nNew Status: ${updatedStatus ? 'Present' : 'Absent'}`);
                    
                    // Reload the reports
                    loadReports();
                }
                
            } catch (error) {
                console.error('Error editing record:', error);
                alert('Error updating record: ' + error.message);
            }
        }
        
        } // Close another block
        } // Close final block
        
        // Export to Excel functionality - DISABLED (using complete database export instead)
        function exportToExcelOLD() {
            console.log('üîÑ Starting Excel export...');
            
            try {
                // Get the current table data
                const table = document.querySelector('.attendance-table');
                if (!table) {
                    alert('No data to export. Please load reports first.');
                    return;
                }
                
                // Get table headers with proper structure
                const headers = [];
                const headerRow = table.querySelector('thead tr');
                if (headerRow) {
                    const headerCells = headerRow.querySelectorAll('th');
                    headerCells.forEach(cell => {
                        // Skip checkbox column
                        if (!cell.querySelector('input[type="checkbox"]')) {
                            let headerText = cell.textContent.trim();
                            // Clean up header text
                            headerText = headerText.replace(/\s+/g, ' ');
                            headers.push(headerText);
                        }
                    });
                }
                
                // Get table data with proper formatting
                const data = [];
                const bodyRows = table.querySelectorAll('tbody tr');
                bodyRows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, index) => {
                        // Skip checkbox column (first column)
                        if (index > 0) {
                            let cellText = cell.textContent.trim();
                            
                            // Handle percentage cells - keep % symbol for clarity
                            if (cell.classList.contains('percentage-cell') || cellText.includes('%')) {
                                // Keep percentage as is for better readability
                                rowData.push(cellText);
                            } else if (cellText === '-' || cellText === '') {
                                // Handle empty or dash values
                                rowData.push('');
                            } else {
                                // Regular cell data
                                rowData.push(cellText);
                            }
                        }
                    });
                    if (rowData.length > 0) {
                        data.push(rowData);
                    }
                });
                
                console.log('üìä Export data prepared:', { headers: headers.length, rows: data.length });
                console.log('üìã Headers:', headers);
                
                if (data.length === 0) {
                    alert('No attendance data to export. Please load reports first.');
                    return;
                }
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Create worksheet data with headers
                const wsData = [headers, ...data];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Set column widths based on current view mode
                let colWidths;
                if (currentViewMode === 'combined') {
                    // Combined view column widths
                    colWidths = [
                        { wch: 10 }, // Roll No
                        { wch: 25 }, // Name
                        { wch: 15 }, // Department
                        { wch: 8 },  // Year
                        { wch: 10 }, // Division
                        { wch: 10 }, // Theory Present
                        { wch: 10 }, // Theory Absent
                        { wch: 10 }, // Theory Total
                        { wch: 12 }, // Theory %
                        { wch: 12 }, // Practical Present
                        { wch: 12 }, // Practical Absent
                        { wch: 12 }, // Practical Total
                        { wch: 12 }, // Practical %
                        { wch: 12 }, // Overall %
                        { wch: 10 }  // Actions (if present)
                    ];
                } else {
                    // Subject-wise view column widths
                    colWidths = headers.map(header => {
                        switch(header.toLowerCase()) {
                            case 'roll no': return { wch: 10 };
                            case 'name': return { wch: 25 };
                            case 'department': return { wch: 15 };
                            case 'subject': return { wch: 20 };
                            case 'year': return { wch: 8 };
                            case 'division': return { wch: 10 };
                            case 'lecture type': return { wch: 12 };
                            case 'date': return { wch: 12 };
                            case 'status': return { wch: 10 };
                            default: return { wch: 12 };
                        }
                    });
                }
                
                // Ensure we don't exceed the actual number of columns
                if (colWidths.length > headers.length) {
                    colWidths = colWidths.slice(0, headers.length);
                }
                
                ws['!cols'] = colWidths;
                
                // Add styling for header row
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) continue;
                    
                    ws[cellAddress].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "4F46E5" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }
                
                // Add worksheet to workbook
                const viewType = currentViewMode === 'subject' ? 'Subject-wise' : 'Combined';
                XLSX.utils.book_append_sheet(wb, ws, `${viewType} Report`);
                
                // Generate filename with current date and view type
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `Attendance_Report_${viewType}_${dateStr}_${timeStr}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                console.log('‚úÖ Excel export completed:', filename);
                
                // Show success notification
                showNotification(
                    'Export Successful', 
                    `Attendance report exported as ${filename}`, 
                    'success'
                );
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        
    </script>

    <!-- Add required libraries for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
</body>
</html> 