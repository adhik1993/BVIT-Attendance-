<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clerk Panel - BVIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #f5f5f5;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --dark: #1F2937;
            --darker: #111827;
            --light: #F3F4F6;
            --lighter: #F9FAFB;
            --border: #E5E7EB;
            --text-dark: #1F2937;
            --text-light: #6B7280;
            --sidebar-width: 280px;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--darker);
            min-height: 100vh;
            padding: 1.5rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .sidebar-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .sidebar-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-section {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 1.5rem 0 0.5rem 0;
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(79, 70, 229, 0.2);
            color: white;
            transform: translateX(4px);
        }

        .nav-link i {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .logout-btn {
            position: absolute;
            bottom: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        /* Main Content Area */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
            background: var(--light);
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .page-title {
            color: var(--text-dark);
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .card-icon.students {
            background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
        }

        .card-icon.teachers {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .card-icon.attendance {
            background: linear-gradient(135deg, var(--accent) 0%, #D97706 100%);
        }

        .card-icon.reports {
            background: linear-gradient(135deg, var(--danger) 0%, #DC2626 100%);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .card-subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .card-content {
            margin-top: 1rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .quick-actions {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 2rem;
        }

        .quick-actions h3 {
            margin-bottom: 1.5rem;
            color: var(--text-dark);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-card {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .action-card:hover {
            background: var(--white);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .action-card i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .action-card h4 {
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .action-card p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Logout Button */
        .logout-btn {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #DC2626;
            transform: translateY(-2px);
        }
        
        .logout-btn i {
            font-size: 1rem;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                min-height: auto;
                padding: 1rem;
                position: relative;
            }
            
            .sidebar-header {
                flex-direction: row;
                text-align: left;
                margin-bottom: 1rem;
            }
            
            .sidebar-title {
                font-size: 1.2rem;
            }
            
            .nav-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .nav-item {
                flex: 1;
                min-width: calc(50% - 0.25rem);
            }
            
            .nav-link {
                padding: 0.5rem;
                font-size: 0.875rem;
                text-align: center;
            }
            
            .nav-link span {
                display: block;
                margin-top: 0.25rem;
            }
            
            .nav-section {
                width: 100%;
                margin: 0.5rem 0;
                font-size: 0.875rem;
            }
            
            .logout-btn {
                position: static;
                margin-top: 1rem;
                padding: 0.5rem;
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .header {
                margin-bottom: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .card {
                padding: 1rem !important;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: none !important;
                margin: 1rem !important;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .filters {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .filters select, .filters input {
                width: 100% !important;
            }
            
            .action-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .action-buttons button {
                width: 100% !important;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .sidebar {
                padding: 0.5rem;
            }
            
            .nav-item {
                min-width: 100%;
            }
            
            .main-content {
                padding: 0.5rem;
            }
            
            .card {
                padding: 0.75rem !important;
            }
            
            .page-title {
                font-size: 1.25rem;
            }
            
            .modal-content {
                margin: 0.5rem !important;
            }
        }

        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Enhanced Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                display: none;
                width: 100%;
                min-height: auto;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
                padding: 4rem 1rem 1rem;
                overflow-y: auto;
            }
            
            .sidebar.active {
                display: block;
            }
            
            .sidebar-header {
                flex-direction: row;
                text-align: left;
                margin-bottom: 1rem;
            }
            
            .nav-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .nav-item {
                flex: 1;
                min-width: calc(50% - 0.25rem);
            }
            
            .nav-link {
                padding: 0.75rem;
                font-size: 0.875rem;
                text-align: center;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .nav-link i {
                font-size: 1.25rem;
                margin: 0;
            }
            
            .nav-section {
                width: 100%;
                margin: 1rem 0 0.5rem;
                text-align: center;
            }
            
            .main-content {
                margin-left: 0;
                margin-top: 4rem;
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -1rem;
                padding: 0 1rem;
            }
            
            table {
                min-width: 600px;
            }
            
            .filters {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .filters select,
            .filters input {
                width: 100% !important;
            }
            
            .action-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .action-buttons button {
                width: 100% !important;
                justify-content: center;
            }
            
            .logout-btn {
                position: static;
                margin: 1rem 0;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 4rem 0.75rem 0.75rem;
            }
            
            .nav-item {
                min-width: 100%;
            }
            
            .nav-link {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .nav-link i {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 0.75rem;
            }
            
            .header {
                padding: 0.75rem;
            }
            
            .page-title {
                font-size: 1.25rem;
            }
            
            .card {
                padding: 0.75rem;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .table-container {
                margin: 0 -0.75rem;
                padding: 0 0.75rem;
            }
            
            .filters select,
            .filters input,
            .filters button {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
            
            .action-buttons button {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-certificate logo-icon"></i>
            <div>
                <h2 class="sidebar-title">BVIT Clerk</h2>
                <p class="sidebar-subtitle" id="clerkName">Certificate Management</p>
            </div>
        </div>
        
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" id="nav-dashboard" class="nav-link active">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                
                <li class="nav-section">Certificate Management</li>
                
                <li class="nav-item">
                    <a href="#" id="nav-applications" class="nav-link">
                        <i class="fas fa-file-alt"></i>
                        <span>View Applications</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="#" id="nav-approve" class="nav-link">
                        <i class="fas fa-check-circle"></i>
                        <span>Approve Certificates</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="#" id="nav-print" class="nav-link">
                        <i class="fas fa-print"></i>
                        <span>Print Certificates</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="#" id="nav-history" class="nav-link">
                        <i class="fas fa-history"></i>
                        <span>Certificate History</span>
                    </a>
                </li>
                
                <li class="nav-section">Account</li>
                
                <li class="nav-item">
                    <a href="#" id="nav-password" class="nav-link">
                        <i class="fas fa-key"></i>
                        <span>Change Password</span>
                    </a>
                </li>
            </ul>
        </nav>
        
        <button class="logout-btn" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
        </button>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt"></i> Dashboard Overview
                </h1>
            </div>

            <div class="container" style="padding: 2rem;">
            <div class="dashboard-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Pending Applications Card -->
                <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #FEF3C7; color: #F59E0B; padding: 12px; border-radius: 10px; font-size: 24px;">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #1F2937;">Pending Applications</h3>
                            <p style="margin: 0; color: #6B7280; font-size: 14px;">Awaiting review</p>
                        </div>
                    </div>
                    <div style="font-size: 32px; font-weight: 700; color: #F59E0B;" id="pendingApplications">0</div>
                </div>

                <!-- Approved Certificates Card -->
                <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #D1FAE5; color: #10B981; padding: 12px; border-radius: 10px; font-size: 24px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #1F2937;">Approved This Month</h3>
                            <p style="margin: 0; color: #6B7280; font-size: 14px;">Successfully processed</p>
                        </div>
                    </div>
                    <div style="font-size: 32px; font-weight: 700; color: #10B981;" id="approvedCount">0</div>
                </div>

                <!-- Rejected Applications Card -->
                <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #FEE2E2; color: #EF4444; padding: 12px; border-radius: 10px; font-size: 24px;">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #1F2937;">Rejected This Month</h3>
                            <p style="margin: 0; color: #6B7280; font-size: 14px;">Not approved</p>
                        </div>
                    </div>
                    <div style="font-size: 32px; font-weight: 700; color: #EF4444;" id="rejectedCount">0</div>
                </div>

                <!-- Total Processed Card -->
                <div class="card" style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #DBEAFE; color: #3B82F6; padding: 12px; border-radius: 10px; font-size: 24px;">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #1F2937;">Total Processed</h3>
                            <p style="margin: 0; color: #6B7280; font-size: 14px;">All time</p>
                        </div>
                    </div>
                    <div style="font-size: 32px; font-weight: 700; color: #3B82F6;" id="totalProcessed">0</div>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Applications Section (Hidden by default) -->
        <div id="applicationsSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-file-alt"></i> View Applications
                </h1>
                <button class="btn btn-primary" onclick="showDashboard()" style="background: #6B7280; padding: 10px 20px; border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>

            <div class="container" style="padding: 2rem;">
                <!-- Filters -->
                <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Status</label>
                            <select id="statusFilter" onchange="filterApplications()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department</label>
                            <select id="departmentFilter" onchange="filterApplications()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Date</label>
                            <input type="date" id="dateFilter" onchange="filterApplications()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="refreshApplications()" style="background: #4F46E5; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Applications Table -->
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1F2937;">Bonafide Certificate Applications</h3>
                        <span id="applicationsCount" style="background: #EEF2FF; color: #4F46E5; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">0 Applications</span>
                    </div>
                    
                    <div id="applicationsContent">
                        <!-- Applications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Approve Certificates Section (Hidden by default) -->
        <div id="approveCertificatesSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-check-circle"></i> Approve Certificates
                </h1>
                <button class="btn btn-primary" onclick="showDashboard()" style="background: #6B7280; padding: 10px 20px; border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>

            <div class="container" style="padding: 2rem;">
                <!-- Filters -->
                <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Status</label>
                            <select id="certificateStatusFilter" onchange="filterCertificates()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Status</option>
                                <option value="approved">Ready to Print</option>
                                <option value="printed">Printed</option>
                                <option value="issued">Issued</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department</label>
                            <select id="certificateDepartmentFilter" onchange="filterCertificates()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                            </select>
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="refreshCertificates()" style="background: #4F46E5; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Certificates Table -->
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1F2937;">Approved Applications for Certificate Generation</h3>
                        <span id="certificatesCount" style="background: #EEF2FF; color: #4F46E5; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">0 Certificates</span>
                    </div>
                    
                    <div id="certificatesContent">
                        <!-- Certificates will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Print Certificates Section (Hidden by default) -->
        <div id="printCertificatesSection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-print"></i> Print Certificates
                </h1>
                <button class="btn btn-primary" onclick="showDashboard()" style="background: #6B7280; padding: 10px 20px; border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>

            <div class="container" style="padding: 2rem;">
                <!-- Filters -->
                <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Print Status</label>
                            <select id="printStatusFilter" onchange="filterPrintCertificates()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Status</option>
                                <option value="ready">Ready to Print</option>
                                <option value="printed">Already Printed</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department</label>
                            <select id="printDepartmentFilter" onchange="filterPrintCertificates()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Batch Print</label>
                            <button onclick="printSelectedCertificates()" id="batchPrintBtn" style="background: #10B981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;" disabled>
                                <i class="fas fa-print"></i> Print Selected (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="refreshPrintCertificates()" style="background: #4F46E5; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Print Queue Table -->
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1F2937;">Certificate Print Queue</h3>
                        <span id="printCertificatesCount" style="background: #EEF2FF; color: #4F46E5; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">0 Certificates</span>
                    </div>
                    
                    <div id="printCertificatesContent">
                        <!-- Print certificates will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Certificate History Section (Hidden by default) -->
        <div id="certificateHistorySection" style="display: none;">
            <div class="header">
                <h1 class="page-title">
                    <i class="fas fa-history"></i> Certificate History
                </h1>
                <button class="btn btn-primary" onclick="showDashboard()" style="background: #6B7280; padding: 10px 20px; border: none; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>

            <div class="container" style="padding: 2rem;">
                <!-- Search and Filters -->
                <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Search</label>
                            <input type="text" id="historySearchInput" placeholder="Search by student name, roll no, certificate ID..." onkeyup="searchHistory()" style="width: 100%; padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Status</label>
                            <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Status</option>
                                <option value="issued">Issued</option>
                                <option value="printed">Printed</option>
                                <option value="approved">Approved</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department</label>
                            <select id="historyDepartmentFilter" onchange="filterHistory()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white;">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electrical">Electrical</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Date Range</label>
                            <input type="date" id="historyDateFilter" onchange="filterHistory()" style="padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px;">
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="refreshHistory()" style="background: #4F46E5; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div style="margin-top: 25px;">
                            <button onclick="exportHistory()" style="background: #10B981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Statistics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #10B981; margin-bottom: 8px;" id="totalIssued">0</div>
                        <div style="color: #6B7280; font-size: 14px;">Total Issued</div>
                    </div>
                    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #3B82F6; margin-bottom: 8px;" id="totalPrinted">0</div>
                        <div style="color: #6B7280; font-size: 14px;">Total Printed</div>
                    </div>
                    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #F59E0B; margin-bottom: 8px;" id="thisMonth">0</div>
                        <div style="color: #6B7280; font-size: 14px;">This Month</div>
                    </div>
                    <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #8B5CF6; margin-bottom: 8px;" id="thisWeek">0</div>
                        <div style="color: #6B7280; font-size: 14px;">This Week</div>
                    </div>
                </div>

                <!-- History Table -->
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1F2937;">Certificate History Records</h3>
                        <span id="historyCount" style="background: #EEF2FF; color: #4F46E5; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">0 Records</span>
                    </div>
                    
                    <div id="historyContent">
                        <!-- History records will be loaded here -->
                    </div>
                    
                    <!-- Pagination -->
                    <div id="historyPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
                        <!-- Pagination will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Password Change Modal -->
    <div id="passwordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 10px; padding: 30px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #1F2937; font-size: 20px;">Change Password</h3>
                <button onclick="closePasswordChange()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6B7280;">&times;</button>
            </div>
            
            <form id="passwordForm">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1F2937;">Current Password</label>
                    <input type="password" id="currentPassword" required style="width: 100%; padding: 10px; border: 1px solid #E5E7EB; border-radius: 5px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1F2937;">New Password</label>
                    <input type="password" id="newPassword" required style="width: 100%; padding: 10px; border: 1px solid #E5E7EB; border-radius: 5px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #1F2937;">Confirm New Password</label>
                    <input type="password" id="confirmPassword" required style="width: 100%; padding: 10px; border: 1px solid #E5E7EB; border-radius: 5px; font-size: 14px;">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closePasswordChange()" style="padding: 10px 20px; border: 1px solid #E5E7EB; background: white; color: #6B7280; border-radius: 5px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 10px 20px; border: none; background: #4F46E5; color: white; border-radius: 5px; cursor: pointer; font-weight: 600;">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Check if clerk is logged in
        if (!sessionStorage.getItem('isClerkLoggedIn')) {
            window.location.href = 'welcome.html';
        }

        // Wait for Firebase to initialize
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                    resolve();
                } else {
                    setTimeout(() => {
                        waitForFirebase().then(resolve);
                    }, 100);
                }
            });
        }

        // Get clerk data
        const clerkData = JSON.parse(sessionStorage.getItem('clerkData') || '{}');
        const clerkKey = sessionStorage.getItem('clerkKey');

        // Update clerk name in header
        const clerkNameElement = document.getElementById('clerkName');
        if (clerkNameElement) {
            clerkNameElement.textContent = `Welcome, ${clerkData.firstName || 'Clerk'} ${clerkData.lastName || ''}`;
        }

        // Password modal functions
        function openPasswordChange() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function closePasswordChange() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Wait for Firebase to initialize
                await waitForFirebase();
                
                // Load bonafide applications data
                const bonafideSnapshot = await firebase.database().ref('bonafideApplications').once('value');
                const applications = bonafideSnapshot.val() || {};
                
                // Count applications by status
                let pendingCount = 0;
                let approvedCount = 0;
                let rejectedCount = 0;
                let totalCount = 0;
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                Object.values(applications).forEach(app => {
                    totalCount++;
                    
                    if (app.status === 'pending') {
                        pendingCount++;
                    } else if (app.status === 'approved') {
                        const appDate = new Date(app.processedDate || app.applicationDate);
                        if (appDate.getMonth() === currentMonth && appDate.getFullYear() === currentYear) {
                            approvedCount++;
                        }
                    } else if (app.status === 'rejected') {
                        const appDate = new Date(app.processedDate || app.applicationDate);
                        if (appDate.getMonth() === currentMonth && appDate.getFullYear() === currentYear) {
                            rejectedCount++;
                        }
                    }
                });
                
                // Update dashboard cards
                document.getElementById('pendingApplications').textContent = pendingCount;
                document.getElementById('approvedCount').textContent = approvedCount;
                document.getElementById('rejectedCount').textContent = rejectedCount;
                document.getElementById('totalProcessed').textContent = totalCount;

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Set sample data for demo purposes
                document.getElementById('pendingApplications').textContent = '5';
                document.getElementById('approvedCount').textContent = '12';
                document.getElementById('rejectedCount').textContent = '2';
                document.getElementById('totalProcessed').textContent = '19';
            }
        }

        // Handle password change - will be initialized after DOM loads
        function initializePasswordForm() {
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match');
                        return;
                    }
                    
                    if (currentPassword !== clerkData.initialPassword) {
                        alert('Current password is incorrect');
                        return;
                    }
                    
                    try {
                        // Wait for Firebase to initialize
                        await waitForFirebase();
                        
                        // Update password in Firebase
                        await firebase.database().ref('clerks/' + clerkKey).update({
                            initialPassword: newPassword,
                            lastPasswordChange: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        // Update session data
                        clerkData.initialPassword = newPassword;
                        sessionStorage.setItem('clerkData', JSON.stringify(clerkData));
                        
                        alert('Password changed successfully!');
                        closePasswordChange();
                    } catch (error) {
                        console.error('Error changing password:', error);
                        alert('Error changing password. Please try again.');
                    }
                });
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('isClerkLoggedIn');
                sessionStorage.removeItem('clerkKey');
                sessionStorage.removeItem('clerkData');
                window.location.href = 'welcome.html';
            }
        }

        // Initialize modal click handler
        function initializeModalHandlers() {
            const passwordModal = document.getElementById('passwordModal');
            if (passwordModal) {
                passwordModal.addEventListener('click', (e) => {
                    if (e.target.id === 'passwordModal') {
                        closePasswordChange();
                    }
                });
            }
        }

        // Navigation active state management
        function setActiveNavigation(activeId) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to selected nav item
            const activeLink = document.getElementById(activeId);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Add click handlers to navigation links
        function initializeNavigation() {
            // Dashboard
            document.getElementById('nav-dashboard').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNavigation('nav-dashboard');
                // Dashboard is current page, no redirect needed
            });

            // View Applications
            document.getElementById('nav-applications').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNavigation('nav-applications');
                // Show applications section instead of redirecting
                showApplications();
            });

            // Approve Certificates
            document.getElementById('nav-approve').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNavigation('nav-approve');
                // Show approve certificates section
                showApproveCertificates();
            });

            // Print Certificates
            document.getElementById('nav-print').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNavigation('nav-print');
                // Show print certificates section
                showPrintCertificates();
            });

            // Certificate History
            document.getElementById('nav-history').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNavigation('nav-history');
                // Show certificate history section
                showCertificateHistory();
            });

            // Change Password
            document.getElementById('nav-password').addEventListener('click', (e) => {
                e.preventDefault();
                setActiveNavigation('nav-password');
                openPasswordChange();
            });
        }

        // Applications functionality
        let allApplications = [];
        let filteredApplications = [];
        
        // Applications data (will be loaded from Firebase)
        // Sample data removed - using Firebase only
        
        // Show applications section
        async function showApplications() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('applicationsSection').style.display = 'block';
            setActiveNavigation('nav-applications');
            
            // Load fresh data from Firebase
            await loadApplicationsData();
        }
        
        // Show dashboard section
        function showDashboard() {
            document.getElementById('dashboardSection').style.display = 'block';
            document.getElementById('applicationsSection').style.display = 'none';
            document.getElementById('approveCertificatesSection').style.display = 'none';
            document.getElementById('printCertificatesSection').style.display = 'none';
            document.getElementById('certificateHistorySection').style.display = 'none';
            setActiveNavigation('nav-dashboard');
        }
        
        // Load applications data
        async function loadApplicationsData() {
            try {
                if (window.firebase && window.firebase.database) {
                    // Load from Firebase
                    const snapshot = await window.firebase.database().ref('bonafideApplications').once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        // Convert Firebase data to array format
                        allApplications = Object.keys(data).map(key => ({
                            id: key,
                            firebaseKey: key,
                            ...data[key]
                        }));
                        
                        // Sort by submission date (newest first)
                        allApplications.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                        
                        console.log('Applications loaded from Firebase:', allApplications.length);
                    } else {
                        allApplications = [];
                        console.log('No applications found in Firebase');
                    }
                } else {
                    console.log('Firebase not available, using sample data');
                    // Fallback to sample data if Firebase not available
                    allApplications = sampleApplications || [];
                }
                
                // Update display
                filteredApplications = [...allApplications];
                displayApplications();
                updateApplicationsCount();
                
            } catch (error) {
                console.error('Error loading applications:', error);
                // Fallback to sample data on error
                allApplications = sampleApplications || [];
                filteredApplications = [...allApplications];
                displayApplications();
                updateApplicationsCount();
            }
        }
        
        // Display applications in table
        function displayApplications() {
            const content = document.getElementById('applicationsContent');
            
            if (filteredApplications.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; color: #9CA3AF;"></i>
                        <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No Applications Found</h3>
                        <p style="font-size: 14px;">No bonafide certificate applications match your current filters.</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F9FAFB;">
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Application ID</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Student Details</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Department</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Purpose</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Status</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredApplications.map(app => `
                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding: 15px; color: #1F2937;"><strong>${getDisplayId(app)}</strong></td>
                                    <td style="padding: 15px; color: #1F2937;">
                                        <div><strong>${app.studentName}</strong></div>
                                        <div style="font-size: 0.8rem; color: #6B7280;">Roll: ${app.rollNumber || app.rollNo || 'N/A'} | Class: ${app.class || app.year || 'N/A'}</div>
                                        <div style="font-size: 0.8rem; color: #6B7280;"> ${app.contactNumber || 'N/A'}</div>
                                    </td>
                                    <td style="padding: 15px; color: #1F2937;">${app.department}</td>
                                    <td style="padding: 15px; color: #1F2937;">${app.purpose}</td>
                                    <td style="padding: 15px;">
                                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; ${
                                            app.status === 'pending' ? 'background: #FEF3C7; color: #F59E0B;' :
                                            app.status === 'approved' ? 'background: #D1FAE5; color: #10B981;' :
                                            'background: #FEE2E2; color: #EF4444;'
                                        }">
                                            ${app.status}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="viewApplication('${app.id}')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            ${app.status === 'pending' ? `
                                                <button onclick="approveApplication('${app.id}')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-check"></i> Approve
                                                </button>
                                                <button onclick="rejectApplication('${app.id}')" style="background: #EF4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-times"></i> Reject
                                                </button>
                                            ` : app.status === 'approved' ? `
                                                <button onclick="printBonafideCertificate(updateCertificateAcademicYear({...allApplications.find(a => a.id === '${app.id}')}))" style="background: #8B5CF6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-print"></i> Print
                                                </button>
                                                <button onclick="generatePDFCertificate(updateCertificateAcademicYear({...allApplications.find(a => a.id === '${app.id}')}))" style="background: #DC2626; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-file-pdf"></i> PDF
                                                </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = tableHTML;
        }
        
        // Filter applications
        function filterApplications() {
            const statusFilter = document.getElementById('statusFilter').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            filteredApplications = allApplications.filter(app => {
                let matchesStatus = statusFilter === 'all' || app.status === statusFilter;
                let matchesDepartment = departmentFilter === 'all' || app.department === departmentFilter;
                let matchesDate = true;
                
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const appDate = new Date(app.applicationDate);
                    matchesDate = appDate.toDateString() === filterDate.toDateString();
                }
                
                return matchesStatus && matchesDepartment && matchesDate;
            });
            
            displayApplications();
            updateApplicationsCount();
        }
        
        // Update applications count
        function updateApplicationsCount() {
            const countElement = document.getElementById('applicationsCount');
            countElement.textContent = `${filteredApplications.length} Applications`;
        }
        
        // Refresh applications
        function refreshApplications() {
            loadApplicationsData();
        }
        
        // View application details in modal
        function viewApplication(applicationId) {
            const app = allApplications.find(a => a.id === applicationId);
            if (!app) {
                alert('Application not found!');
                return;
            }
            
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            // Create modal HTML
            const modalHTML = `
                <div id="applicationModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #E5E7EB; padding-bottom: 15px;">
                            <h2 style="color: #1F2937; margin: 0; font-size: 24px; font-weight: 700;"> Application Details</h2>
                            <button onclick="closeApplicationModal()" style="background: #EF4444; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;"></button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div style="background: #F3F4F6; padding: 15px; border-radius: 8px;">
                                <h3 style="color: #374151; margin: 0 0 10px 0; font-size: 14px; font-weight: 600; text-transform: uppercase;">Application ID</h3>
                                <p style="color: #1F2937; margin: 0; font-size: 16px; font-weight: 700;">${getDisplayId(app)}</p>
                            </div>
                            <div style="background: #F3F4F6; padding: 15px; border-radius: 8px;">
                                <h3 style="color: #374151; margin: 0 0 10px 0; font-size: 14px; font-weight: 600; text-transform: uppercase;">Status</h3>
                                <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; ${
                                    app.status === 'pending' ? 'background: #FEF3C7; color: #F59E0B;' :
                                    app.status === 'approved' ? 'background: #D1FAE5; color: #10B981;' :
                                    'background: #FEE2E2; color: #EF4444;'
                                }">${app.status}</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #374151; margin: 0 0 15px 0; font-size: 18px; font-weight: 600; border-bottom: 1px solid #E5E7EB; padding-bottom: 8px;"> Student Information</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Full Name</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">${app.studentName || 'N/A'}</p>
                                </div>
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Roll Number</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">${app.rollNumber || app.rollNo || 'N/A'}</p>
                                </div>
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Department</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">${app.department || 'N/A'}</p>
                                </div>
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Class/Year</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">${app.class || app.year || 'N/A'}</p>
                                </div>
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Contact Number</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;"> ${app.contactNumber || 'N/A'}</p>
                                </div>
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Email Address</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;"> ${app.email || app.studentEmail || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #374151; margin: 0 0 15px 0; font-size: 18px; font-weight: 600; border-bottom: 1px solid #E5E7EB; padding-bottom: 8px;"> Application Details</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Purpose</label>
                                <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500; background: #F9FAFB; padding: 10px; border-radius: 6px;">${app.purpose || 'N/A'}</p>
                            </div>
                            ${app.address ? `
                                <div style="margin-bottom: 15px;">
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Address</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500; background: #F9FAFB; padding: 10px; border-radius: 6px;">${app.address}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #374151; margin: 0 0 15px 0; font-size: 18px; font-weight: 600; border-bottom: 1px solid #E5E7EB; padding-bottom: 8px;"> Timeline</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Submitted On</label>
                                    <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">${formatDate(app.submissionDate || app.applicationDate)}</p>
                                </div>
                                ${app.processedDate ? `
                                    <div>
                                        <label style="color: #6B7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Processed On</label>
                                        <p style="color: #1F2937; margin: 5px 0 0 0; font-size: 16px; font-weight: 500;">${formatDate(app.processedDate)}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeApplicationModal()" style="background: #6B7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">Close</button>
                            ${app.status === 'pending' ? `
                                <button onclick="closeApplicationModal(); approveApplication('${app.id}')" style="background: #10B981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;"> Approve</button>
                                <button onclick="closeApplicationModal(); rejectApplication('${app.id}')" style="background: #EF4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;"> Reject</button>
                            ` : ''}
                            ${app.status === 'approved' ? `
                                <button onclick="closeApplicationModal(); printBonafideCertificate(updateCertificateAcademicYear({...app}))" style="background: #3B82F6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;"> Print Certificate</button>
                                <button onclick="closeApplicationModal(); generatePDFCertificate(updateCertificateAcademicYear({...app}))" style="background: #DC2626; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;"> Generate PDF</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Close application modal
        function closeApplicationModal() {
            const modal = document.getElementById('applicationModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Generate smart certificate ID
        function generateSmartCertificateId(department, rollNumber) {
            // Get department code
            const deptCode = getDepartmentCode(department);
            
            // Get current year (last 2 digits)
            const year = new Date().getFullYear().toString().slice(-2);
            
            // Get current month
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // Generate random 3-digit number
            const random = Math.floor(Math.random() * 900) + 100;
            
            // Format: CERT-DEPT-ROLL-YYMM-XXX
            // Example: CERT-CS-101-2501-456
            return `CERT-${deptCode}-${rollNumber}-${year}${month}-${random}`;
        }
        
        // Get department code for certificate
        function getDepartmentCode(department) {
            const deptCodes = {
                'Computer Science': 'CS',
                'Computer Engineering': 'CE', 
                'Information Technology': 'IT',
                'Electronics': 'EC',
                'Electronics and Communication': 'EC',
                'Mechanical': 'ME',
                'Mechanical Engineering': 'ME',
                'Civil': 'CV',
                'Civil Engineering': 'CV',
                'Electrical': 'EE',
                'Electrical Engineering': 'EE',
                'Automobile': 'AU',
                'Automobile Engineering': 'AU'
            };
            
            return deptCodes[department] || 'GN'; // GN = General
        }
        
        // Get display ID - use applicationId if available, otherwise generate smart ID
        function getDisplayId(app) {
            // If application has custom applicationId and it's already in smart format, use it
            if (app.applicationId && app.applicationId.includes('-') && !app.applicationId.startsWith('-')) {
                return app.applicationId;
            }
            
            // For old applications with Firebase keys (starting with -), generate smart display ID
            if (app.id && app.id.startsWith('-')) {
                const deptCode = getDepartmentCode(app.department || 'General');
                const rollNo = app.rollNumber || app.rollNo || '000';
                
                // Extract date from submission if available
                let dateCode = '2501'; // default
                if (app.submissionDate) {
                    const date = new Date(app.submissionDate);
                    const year = date.getFullYear().toString().slice(-2);
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    dateCode = year + month;
                }
                
                // Use last 3 characters of Firebase key as random
                const random = app.id.slice(-3).replace(/[^0-9]/g, '').padStart(3, '0');
                
                return `BF-${deptCode}-${rollNo}-${dateCode}-${random}`;
            }
            
            // For old timestamp-based IDs (like BF1753512787795), convert to smart format
            if (app.id && app.id.startsWith('BF') && app.id.length > 10 && /^BF\d+$/.test(app.id)) {
                const deptCode = getDepartmentCode(app.department || 'General');
                const rollNo = app.rollNumber || app.rollNo || '000';
                
                // Extract date from submission if available
                let dateCode = '2501'; // default
                if (app.submissionDate) {
                    const date = new Date(app.submissionDate);
                    const year = date.getFullYear().toString().slice(-2);
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    dateCode = year + month;
                }
                
                // Use last 3 digits of timestamp as random
                const random = app.id.slice(-3);
                
                return `BF-${deptCode}-${rollNo}-${dateCode}-${random}`;
            }
            
            // Fallback to original ID
            return app.id || 'N/A';
        }
        
        // Approve application
        async function approveApplication(applicationId) {
            if (confirm('Are you sure you want to approve this application?')) {
                try {
                    const app = allApplications.find(a => a.id === applicationId);
                    if (app) {
                        // Update local data
                        app.status = 'approved';
                        app.processedDate = new Date().toISOString();
                        app.processedBy = 'Clerk Admin';
                        app.approvedDate = new Date().toLocaleString('en-IN', {
                            timeZone: 'Asia/Kolkata',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        
                        // Update in Firebase
                        if (window.firebase && window.firebase.database) {
                            await window.firebase.database().ref(`bonafideApplications/${applicationId}`).update({
                                status: 'approved',
                                processedDate: app.processedDate,
                                processedBy: app.processedBy,
                                approvedDate: app.approvedDate
                            });
                            
                            // Also create certificate entry with smart certificate ID
                            const certificateData = {
                                ...app,
                                certificateId: generateSmartCertificateId(app.department, app.rollNumber || app.rollNo),
                                certificateStatus: 'ready_to_print',
                                approvedDate: app.approvedDate,
                                createdDate: new Date().toISOString(),
                                academicYear: getCurrentAcademicYear() // Auto-set current academic year
                            };
                            
                            await window.firebase.database().ref('certificates').push(certificateData);
                            
                            console.log('Application approved and certificate created');
                        }
                        
                        // Ask if user wants to print certificate immediately
                        const printChoice = confirm('Application approved successfully!\n\nChoose printing option:\n\nOK = Print Certificate\nCancel = Generate PDF');
                        
                        if (printChoice) {
                            // Update academic year before printing
                            const updatedApp = updateCertificateAcademicYear({...app});
                            printBonafideCertificate(updatedApp);
                        } else {
                            // Generate PDF option
                            const pdfChoice = confirm('Generate PDF Certificate?\n\nOK = Generate PDF\nCancel = Skip for now');
                            if (pdfChoice) {
                                const updatedApp = updateCertificateAcademicYear({...app});
                                generatePDFCertificate(updatedApp);
                            } else {
                                alert('Certificate has been created and is ready for printing.\nYou can print it later from the Print Certificates section.');
                            }
                        }
                        filterApplications();
                        
                        // Refresh certificates section if it's currently open
                        if (document.getElementById('approveCertificatesSection').style.display !== 'none') {
                            loadCertificatesData();
                        }
                        
                        // Refresh print certificates section if it's currently open
                        if (document.getElementById('printCertificatesSection').style.display !== 'none') {
                            loadPrintCertificatesData();
                        }
                        
                        // Refresh history section if it's currently open
                        if (document.getElementById('certificateHistorySection').style.display !== 'none') {
                            loadHistoryData();
                        }
                    }
                } catch (error) {
                    console.error('Error approving application:', error);
                    alert('Error approving application. Please try again.');
                }
            }
        }
        
        // Print Bonafide Certificate with BHARATI VIDYAPEETH template
        function printBonafideCertificate(certificate, generatePDF = false) {
            const currentDate = new Date().toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            });
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Bonafide Certificate - ${certificate.studentName}</title>
                    <style>
                        @page { 
                            size: A4 portrait; 
                            margin: 15mm;
                        }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        html, body {
                            width: 210mm;
                            height: 297mm;
                            font-family: 'Times New Roman', serif;
                            background: white;
                            margin: 0;
                            padding: 15mm;
                            line-height: 1.5;
                            font-size: 12pt;
                        }
                        .certificate {
                            width: 100%;
                            max-width: 180mm;
                            height: auto;
                            min-height: 240mm;
                            margin: 0;
                            border: 2px solid #1e40af;
                            padding: 15mm;
                            background: white;
                            position: relative;
                            page-break-inside: avoid;
                            box-sizing: border-box;
                        }
                        .certificate::before {
                            content: '';
                            position: absolute;
                            top: 15px; left: 15px; right: 15px; bottom: 15px;
                            border: 2px solid #3b82f6;
                            pointer-events: none;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 8mm;
                            border-bottom: 1px solid #1e40af;
                            padding-bottom: 5mm;
                            padding-top: 2mm;
                        }
                        .college-name {
                            font-size: 16pt;
                            font-weight: bold;
                            color: #1e40af;
                            margin-bottom: 3mm;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            line-height: 1.2;
                        }
                        .college-address {
                            font-size: 10pt;
                            color: #4b5563;
                            margin-bottom: 2mm;
                            font-weight: 500;
                        }
                        .college-code {
                            font-size: 9pt;
                            color: #6b7280;
                            font-style: italic;
                        }
                        .logo {
                            width: 35mm; height: 35mm;
                            margin: 0 auto 5mm;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .logo img {
                            width: 35mm;
                            height: 35mm;
                            object-fit: contain;
                        }
                        .certificate-title {
                            font-size: 14pt;
                            font-weight: bold;
                            color: #dc2626;
                            text-align: center;
                            margin: 6mm 0;
                            text-decoration: underline;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }
                        .content {
                            font-size: 11pt;
                            color: #374151;
                            text-align: justify;
                            margin-bottom: 8mm;
                            line-height: 1.6;
                            padding: 0;
                        }
                        .student-info {
                            display: inline;
                            font-weight: bold;
                            color: #1e40af;
                            text-decoration: underline;
                        }
                        .footer {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 8mm;
                            padding-top: 3mm;
                            border-top: 1px solid #d1d5db;
                            width: 100%;
                            box-sizing: border-box;
                        }
                        .signature {
                            text-align: center;
                            flex: 1;
                            margin: 0 3mm;
                            max-width: 50mm;
                        }
                        .signature-line {
                            border-bottom: 1px solid #374151;
                            width: 30mm;
                            margin: 6mm auto 2mm;
                        }
                        .signature-title {
                            font-size: 9pt;
                            font-weight: bold;
                            color: #4b5563;
                        }
                        .date {
                            text-align: right;
                            margin-top: 5mm;
                            margin-bottom: 3mm;
                            font-weight: bold;
                            color: #1e40af;
                            font-size: 9pt;
                        }
                        .seal {
                            position: absolute;
                            bottom: 15mm; left: 15mm;
                            width: 20mm; height: 20mm;
                            border: 1px solid #dc2626;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: rgba(220, 38, 38, 0.1);
                            font-size: 7pt;
                            font-weight: bold;
                            color: #dc2626;
                            text-align: center;
                            line-height: 1.1;
                        }
                        .watermark {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(-45deg);
                            font-size: 60pt;
                            color: rgba(30, 64, 175, 0.05);
                            font-weight: bold;
                            z-index: 1;
                            pointer-events: none;
                        }
                        @media print {
                            @page {
                                size: A4 portrait;
                                margin: 15mm;
                            }
                            html, body {
                                width: 210mm;
                                height: 297mm;
                                margin: 0;
                                padding: 15mm;
                                background: white !important;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                                font-size: 12pt;
                            }
                            .certificate {
                                width: 100% !important;
                                max-width: 180mm !important;
                                height: auto !important;
                                min-height: 240mm !important;
                                margin: 0 !important;
                                padding: 15mm !important;
                                border: 2px solid #1e40af !important;
                                background: white !important;
                                box-shadow: none;
                                page-break-inside: avoid;
                                transform: none;
                            }
                            .footer {
                                margin-top: 6mm !important;
                                padding-top: 2mm !important;
                            }
                            .signature {
                                margin: 0 2mm !important;
                                max-width: 45mm !important;
                            }
                            .signature-line {
                                width: 25mm !important;
                                margin: 4mm auto 1mm !important;
                            }
                            .watermark {
                                display: block !important;
                                opacity: 0.05 !important;
                            }
                        }
                    </style>
                </head>
                <body onload="window.print(); window.close();">
                    <div class="certificate">
                        <div class="watermark">BVIT</div>
                        <div class="header">
                            <div class="logo">
                                <img src="https://i.postimg.cc/7YtqgV7g/Adobe-Express-20231230-0106150-009053291427646104.png" alt="BVIT Logo">
                            </div>
                            <div class="college-name">BHARATI VIDYAPEETH INSTITUTE OF TECHNOLOGY</div>
                            <div class="college-address">SEC-7, CBD BELAPUR, NAVI MUMBAI - 400614</div>
                            <div class="college-code">(An Autonomous Institute affiliated to University of Mumbai)</div>
                        </div>
                        
                        <div class="certificate-title">BONAFIDE CERTIFICATE</div>
                        
                        <div class="content">
                            This is to certify that <span class="student-info">${certificate.studentName}</span>, 
                            Roll No. <span class="student-info">${certificate.rollNumber || certificate.rollNo || 'N/A'}</span> 
                            is a bonafide student of this institute studying in 
                            <span class="student-info">${certificate.class || certificate.year || 'N/A'}</span> year 
                            <span class="student-info">${certificate.department || 'N/A'}</span> department 
                            during the Academic Year <span class="student-info">${certificate.academicYear || getCurrentAcademicYear()}</span>.
                            <br><br>
                            This certificate is issued for the purpose of 
                            <span class="student-info">${certificate.purpose || 'Official Purpose'}</span> 
                            as requested by the student.
                            <br><br>
                            The student bears good moral character and conduct during the period of study in this institute.
                        </div>
                        
                        <div class="date">
                            Date: ${currentDate}
                        </div>
                        
                        <div class="footer">
                            <div class="signature">
                                <div class="signature-line"></div>
                                <div class="signature-title">Clerk In-Charge</div>
                            </div>
                            <div class="signature">
                                <div class="signature-line"></div>
                                <div class="signature-title">Principal</div>
                            </div>
                        </div>
                        
                        <div class="seal">
                            COLLEGE<br>SEAL
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            // If PDF generation is requested
            if (generatePDF) {
                // Wait for content to load, then generate PDF
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 1000);
                };
            }
        }
        
        // Generate PDF Certificate
        async function generatePDFCertificate(certificate) {
            try {
                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <div>Generating PDF Certificate...</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingMsg);
                
                // Create certificate HTML for PDF
                const currentDate = new Date().toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                
                const certificateHTML = `
                    <div id="pdfCertificate" style="width: 210mm; height: 297mm; padding: 15mm; background: white; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; position: relative;">
                        <div style="width: 100%; max-width: 180mm; height: auto; min-height: 240mm; margin: 0; border: 2px solid #1e40af; padding: 15mm; background: white; position: relative; box-sizing: border-box;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 60pt; color: rgba(30, 64, 175, 0.05); font-weight: bold; z-index: 1; pointer-events: none;">BVIT</div>
                            
                            <div style="text-align: center; margin-bottom: 8mm; border-bottom: 1px solid #1e40af; padding-bottom: 5mm; padding-top: 2mm;">
                                <div style="width: 35mm; height: 35mm; margin: 0 auto 5mm; display: flex; align-items: center; justify-content: center;">
                                    <img src="https://i.postimg.cc/7YtqgV7g/Adobe-Express-20231230-0106150-009053291427646104.png" style="width: 35mm; height: 35mm; object-fit: contain;">
                                </div>
                                <div style="font-size: 16pt; font-weight: bold; color: #1e40af; margin-bottom: 3mm; text-transform: uppercase; letter-spacing: 1px; line-height: 1.2;">BHARATI VIDYAPEETH INSTITUTE OF TECHNOLOGY</div>
                                <div style="font-size: 10pt; color: #4b5563; margin-bottom: 2mm; font-weight: 500;">SEC-7, CBD BELAPUR, NAVI MUMBAI - 400614</div>
                                <div style="font-size: 9pt; color: #6b7280; font-style: italic;">(An Autonomous Institute affiliated to University of Mumbai)</div>
                            </div>
                            
                            <div style="font-size: 14pt; font-weight: bold; color: #dc2626; text-align: center; margin: 6mm 0; text-decoration: underline; text-transform: uppercase; letter-spacing: 1px;">BONAFIDE CERTIFICATE</div>
                            
                            <div style="font-size: 11pt; color: #374151; text-align: justify; margin-bottom: 8mm; line-height: 1.6; padding: 0;">
                                This is to certify that <span style="display: inline; font-weight: bold; color: #1e40af; text-decoration: underline;">${certificate.studentName}</span>, 
                                Roll No. <span style="display: inline; font-weight: bold; color: #1e40af; text-decoration: underline;">${certificate.rollNumber || certificate.rollNo || 'N/A'}</span> 
                                is a bonafide student of this institute studying in 
                                <span style="display: inline; font-weight: bold; color: #1e40af; text-decoration: underline;">${certificate.class || certificate.year || 'N/A'}</span> year 
                                <span style="display: inline; font-weight: bold; color: #1e40af; text-decoration: underline;">${certificate.department || 'N/A'}</span> department 
                                during the Academic Year <span style="display: inline; font-weight: bold; color: #1e40af; text-decoration: underline;">${certificate.academicYear || getCurrentAcademicYear()}</span>.
                                <br><br>
                                This certificate is issued for the purpose of 
                                <span style="display: inline; font-weight: bold; color: #1e40af; text-decoration: underline;">${certificate.purpose || 'Official Purpose'}</span> 
                                as requested by the student.
                                <br><br>
                                The student bears good moral character and conduct during the period of study in this institute.
                            </div>
                            
                            <div style="text-align: right; margin-top: 5mm; margin-bottom: 3mm; font-weight: bold; color: #1e40af; font-size: 9pt;">
                                Date: ${currentDate}
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 8mm; padding-top: 3mm; border-top: 1px solid #d1d5db; width: 100%; box-sizing: border-box;">
                                <div style="text-align: center; flex: 1; margin: 0 3mm; max-width: 50mm;">
                                    <div style="border-bottom: 1px solid #374151; width: 30mm; margin: 6mm auto 2mm;"></div>
                                    <div style="font-size: 9pt; font-weight: bold; color: #4b5563;">Clerk In-Charge</div>
                                </div>
                                <div style="text-align: center; flex: 1; margin: 0 3mm; max-width: 50mm;">
                                    <div style="border-bottom: 1px solid #374151; width: 30mm; margin: 6mm auto 2mm;"></div>
                                    <div style="font-size: 9pt; font-weight: bold; color: #4b5563;">Principal</div>
                                </div>
                            </div>
                            
                            <div style="position: absolute; bottom: 15mm; left: 15mm; width: 20mm; height: 20mm; border: 1px solid #dc2626; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(220, 38, 38, 0.1); font-size: 7pt; font-weight: bold; color: #dc2626; text-align: center; line-height: 1.1;">
                                COLLEGE<br>SEAL
                            </div>
                        </div>
                    </div>
                `;
                
                // Create temporary container
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = certificateHTML;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                document.body.appendChild(tempContainer);
                
                const certificateElement = tempContainer.querySelector('#pdfCertificate');
                
                // Generate PDF using html2canvas and jsPDF
                const canvas = await html2canvas(certificateElement, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 794, // A4 width in pixels at 96 DPI
                    height: 1123 // A4 height in pixels at 96 DPI
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                
                // Generate filename
                const filename = `Bonafide_Certificate_${certificate.studentName?.replace(/\s+/g, '_')}_${getDisplayId(certificate)}.pdf`;
                
                // Open PDF in browser instead of download
                const pdfBlob = pdf.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                window.open(pdfUrl, '_blank');
                
                // Clean up
                document.body.removeChild(tempContainer);
                document.body.removeChild(loadingMsg);
                
                alert('PDF Certificate opened in new tab successfully!');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF certificate. Please try again.');
                
                // Clean up loading message
                const loadingMsg = document.querySelector('div[style*="position: fixed"]');
                if (loadingMsg) {
                    document.body.removeChild(loadingMsg.parentElement);
                }
            }
        }
        
        // Get current academic year
        function getCurrentAcademicYear() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 0-based month
            
            // Academic year starts from June (month 6)
            if (currentMonth >= 6) {
                // June to December: current year to next year
                return `${currentYear}-${(currentYear + 1).toString().slice(-2)}`;
            } else {
                // January to May: previous year to current year
                return `${currentYear - 1}-${currentYear.toString().slice(-2)}`;
            }
        }
        
        // Update academic year in certificate
        function updateCertificateAcademicYear(certificate) {
            if (!certificate.academicYear || certificate.academicYear === '2024-25') {
                certificate.academicYear = getCurrentAcademicYear();
            }
            return certificate;
        }
        
        // Reject application
        async function rejectApplication(applicationId) {
            const reason = prompt('Please enter rejection reason:');
            if (reason && confirm('Are you sure you want to reject this application?')) {
                try {
                    const app = allApplications.find(a => a.id === applicationId);
                    if (app) {
                        // Update local data
                        app.status = 'rejected';
                        app.processedDate = new Date().toISOString();
                        app.processedBy = 'Clerk Admin';
                        app.rejectionReason = reason;
                        app.rejectedDate = new Date().toLocaleString('en-IN', {
                            timeZone: 'Asia/Kolkata',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        
                        // Update in Firebase
                        if (window.firebase && window.firebase.database) {
                            await window.firebase.database().ref(`bonafideApplications/${applicationId}`).update({
                                status: 'rejected',
                                processedDate: app.processedDate,
                                processedBy: app.processedBy,
                                rejectionReason: reason,
                                rejectedDate: app.rejectedDate
                            });
                            
                            console.log('Application rejected and updated in Firebase');
                        }
                        
                        alert('Application rejected successfully!\n\nReason: ' + reason);
                        filterApplications();
                    }
                } catch (error) {
                    console.error('Error rejecting application:', error);
                    alert('Error rejecting application. Please try again.');
                }
            }
        }
        
        // Certificates functionality
        let allCertificates = [];
        let filteredCertificates = [];
        
        // Certificates data (will be loaded from Firebase)
        // Sample data removed - using Firebase only
        
        // Show approve certificates section
        async function showApproveCertificates() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('applicationsSection').style.display = 'none';
            document.getElementById('printCertificatesSection').style.display = 'none';
            document.getElementById('certificateHistorySection').style.display = 'none';
            document.getElementById('approveCertificatesSection').style.display = 'block';
            
            // Set active navigation
            setActiveNavigation('nav-approve');
            
            // Load approved certificates
            await loadCertificatesData();
        }
        
        // Load certificates data
        async function loadCertificatesData() {
            try {
                // Load approved applications from Firebase
                if (window.firebase && window.firebase.database) {
                    const snapshot = await window.firebase.database().ref('bonafideApplications').once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        // Filter only approved applications
                        allCertificates = Object.keys(data)
                            .map(key => ({ id: key, firebaseKey: key, ...data[key] }))
                            .filter(app => app.status === 'approved');
                        
                        console.log('Approved certificates loaded:', allCertificates.length);
                    } else {
                        allCertificates = [];
                    }
                } else {
                    // Fallback: Load from allApplications if Firebase not available
                    allCertificates = allApplications.filter(app => app.status === 'approved');
                }
                
                filteredCertificates = [...allCertificates];
                displayCertificates();
                updateCertificatesCount();
                
            } catch (error) {
                console.error('Error loading certificates:', error);
                // Fallback to approved applications from memory
                allCertificates = allApplications.filter(app => app.status === 'approved');
                filteredCertificates = [...allCertificates];
                displayCertificates();
                updateCertificatesCount();
            }
        }
        
        // Display certificates in table
        function displayCertificates() {
            const content = document.getElementById('certificatesContent');
            
            if (filteredCertificates.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <i class="fas fa-certificate" style="font-size: 48px; margin-bottom: 16px; color: #9CA3AF;"></i>
                        <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No Certificates Found</h3>
                        <p style="font-size: 14px;">No approved applications are ready for certificate generation.</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F9FAFB;">
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Certificate ID</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Student Details</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Department</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Purpose</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Status</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredCertificates.map(cert => `
                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding: 15px; color: #1F2937;"><strong>${getDisplayId(cert)}</strong></td>
                                    <td style="padding: 15px; color: #1F2937;">
                                        <div><strong>${cert.studentName}</strong></div>
                                        <div style="font-size: 0.8rem; color: #6B7280;">Roll: ${cert.rollNumber || cert.rollNo || 'N/A'} | Class: ${cert.class || cert.year || 'N/A'}</div>
                                        <div style="font-size: 0.8rem; color: #6B7280;"> ${cert.contactNumber || 'N/A'}</div>
                                    </td>
                                    <td style="padding: 15px; color: #1F2937;">${cert.department}</td>
                                    <td style="padding: 15px; color: #1F2937;">${cert.purpose}</td>
                                    <td style="padding: 15px;">
                                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; ${
                                            cert.status === 'approved' ? 'background: #D1FAE5; color: #10B981;' :
                                            cert.status === 'printed' ? 'background: #DBEAFE; color: #3B82F6;' :
                                            'background: #F3E8FF; color: #8B5CF6;'
                                        }">
                                            ${cert.status === 'approved' ? 'Ready to Print' : cert.status === 'printed' ? 'Printed' : 'Issued'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="viewCertificate('${cert.id}')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            ${cert.status === 'approved' ? `
                                                <button onclick="printBonafideCertificate(filteredCertificates.find(c => c.id === '${cert.id}'))" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-print"></i> Print Certificate
                                                </button>
                                            ` : cert.status === 'printed' ? `
                                                <button onclick="issueCertificate('${cert.id}')" style="background: #8B5CF6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-check-double"></i> Issue
                                                </button>
                                            ` : `
                                                <span style="color: #10B981; font-size: 12px; font-weight: 600;">
                                                    <i class="fas fa-check-circle"></i> Issued
                                                </span>
                                            `}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = tableHTML;
        }
        
        // Filter certificates
        function filterCertificates() {
            const statusFilter = document.getElementById('certificateStatusFilter').value;
            const departmentFilter = document.getElementById('certificateDepartmentFilter').value;
            
            filteredCertificates = allCertificates.filter(cert => {
                let matchesStatus = statusFilter === 'all' || cert.status === statusFilter;
                let matchesDepartment = departmentFilter === 'all' || cert.department === departmentFilter;
                
                return matchesStatus && matchesDepartment;
            });
            
            displayCertificates();
            updateCertificatesCount();
        }
        
        // Update certificates count
        function updateCertificatesCount() {
            const countElement = document.getElementById('certificatesCount');
            countElement.textContent = `${filteredCertificates.length} Certificates`;
        }
        
        // Refresh certificates
        function refreshCertificates() {
            loadCertificatesData();
        }
        
        // View certificate details
        function viewCertificate(certificateId) {
            const cert = allCertificates.find(c => c.id === certificateId);
            if (cert) {
                const formatDate = (timestamp) => {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                };
                
                alert(`Certificate Details:\n\nCertificate ID: ${cert.id}\nApplication ID: ${cert.applicationId}\nStudent: ${cert.studentName}\nRoll No: ${cert.rollNo}\nDepartment: ${cert.department}\nYear: ${cert.year}\nPurpose: ${cert.purpose}\nContact: ${cert.contactNumber}\nEmail: ${cert.email}\nStatus: ${cert.status.toUpperCase()}\nApproved: ${formatDate(cert.approvedDate)}\nApproved By: ${cert.approvedBy}`);
            }
        }
        
        // Print certificate
        function printCertificate(certificateId) {
            if (confirm('Are you sure you want to mark this certificate as printed?')) {
                const cert = allCertificates.find(c => c.id === certificateId);
                if (cert) {
                    cert.status = 'printed';
                    cert.printedDate = Date.now();
                    cert.printedBy = 'Clerk Admin';
                    
                    alert('Certificate marked as printed successfully!');
                    filterCertificates();
                }
            }
        }
        
        // Issue certificate
        function issueCertificate(certificateId) {
            if (confirm('Are you sure you want to mark this certificate as issued to the student?')) {
                const cert = allCertificates.find(c => c.id === certificateId);
                if (cert) {
                    cert.status = 'issued';
                    cert.issuedDate = Date.now();
                    cert.issuedBy = 'Clerk Admin';
                    
                    alert('Certificate marked as issued successfully!');
                    filterCertificates();
                }
            }
        }
        
        // Print Certificates functionality
        let allPrintCertificates = [];
        let filteredPrintCertificates = [];
        let selectedCertificates = new Set();
        
        // Sample print certificates data (ready to print + already printed)
        // Print certificates data (will be loaded from Firebase)
        // Sample data removed - using Firebase only
        
        // Show print certificates section
        async function showPrintCertificates() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('applicationsSection').style.display = 'none';
            document.getElementById('approveCertificatesSection').style.display = 'none';
            document.getElementById('certificateHistorySection').style.display = 'none';
            document.getElementById('printCertificatesSection').style.display = 'block';
            
            // Set active navigation
            setActiveNavigation('nav-print');
            
            // Load print certificates
            await loadPrintCertificatesData();
        }
        
        // Load print certificates data
        async function loadPrintCertificatesData() {
            try {
                // Load approved applications from Firebase for printing
                if (window.firebase && window.firebase.database) {
                    const snapshot = await window.firebase.database().ref('bonafideApplications').once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        // Filter approved applications (ready to print)
                        allPrintCertificates = Object.keys(data)
                            .map(key => ({ id: key, firebaseKey: key, ...data[key] }))
                            .filter(app => app.status === 'approved');
                        
                        console.log('Print certificates loaded:', allPrintCertificates.length);
                    } else {
                        allPrintCertificates = [];
                    }
                } else {
                    // Fallback: Load from allApplications if Firebase not available
                    allPrintCertificates = allApplications.filter(app => app.status === 'approved');
                }
                
                filteredPrintCertificates = [...allPrintCertificates];
                selectedCertificates.clear();
                displayPrintCertificates();
                updatePrintCertificatesCount();
                updateSelectedCount();
                
            } catch (error) {
                console.error('Error loading print certificates:', error);
                // Fallback to approved applications from memory
                allPrintCertificates = allApplications.filter(app => app.status === 'approved');
                filteredPrintCertificates = [...allPrintCertificates];
                selectedCertificates.clear();
                displayPrintCertificates();
                updatePrintCertificatesCount();
                updateSelectedCount();
            }
        }
        
        // Display print certificates in table
        function displayPrintCertificates() {
            const content = document.getElementById('printCertificatesContent');
            
            if (filteredPrintCertificates.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <i class="fas fa-print" style="font-size: 48px; margin-bottom: 16px; color: #9CA3AF;"></i>
                        <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No Certificates in Print Queue</h3>
                        <p style="font-size: 14px;">No certificates are ready for printing.</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F9FAFB;">
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="margin-right: 8px;"> Select
                                </th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Certificate ID</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Student Details</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Department</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Purpose</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Priority</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Status</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredPrintCertificates.map(cert => `
                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding: 15px;">
                                        <input type="checkbox" ${cert.status === 'approved' ? '' : 'disabled'} onchange="toggleCertificateSelection('${cert.id}')" ${selectedCertificates.has(cert.id) ? 'checked' : ''}>
                                    </td>
                                    <td style="padding: 15px; color: #1F2937;"><strong>${getDisplayId(cert)}</strong></td>
                                    <td style="padding: 15px; color: #1F2937;">
                                        <div><strong>${cert.studentName}</strong></div>
                                        <div style="font-size: 0.8rem; color: #6B7280;">Roll: ${cert.rollNumber || cert.rollNo || 'N/A'} | ${cert.class || cert.year || 'N/A'}</div>
                                        <div style="font-size: 0.8rem; color: #6B7280;"> ${cert.contactNumber || 'N/A'}</div>
                                    </td>
                                    <td style="padding: 15px; color: #1F2937;">${cert.department || 'N/A'}</td>
                                    <td style="padding: 15px; color: #1F2937;">${cert.purpose || 'N/A'}</td>
                                    <td style="padding: 15px;">
                                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; ${
                                            cert.priority === 'high' ? 'background: #FEE2E2; color: #DC2626;' :
                                            cert.priority === 'medium' ? 'background: #FEF3C7; color: #D97706;' :
                                            'background: #E0F2FE; color: #0891B2;'
                                        }">
                                            ${cert.priority || 'medium'}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; background: #D1FAE5; color: #10B981;">
                                            Ready to Print
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="viewPrintCertificate('${cert.id}')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <button onclick="printBonafideCertificate(filteredPrintCertificates.find(c => c.id === '${cert.id}'))" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-print"></i> Print Certificate
                                            </button>
                                        </div>
                                    </td>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = tableHTML;
        }
        
        // Toggle certificate selection
        function toggleCertificateSelection(certificateId) {
            const cert = allPrintCertificates.find(c => c.id === certificateId);
            if (cert && cert.status === 'ready') {
                if (selectedCertificates.has(certificateId)) {
                    selectedCertificates.delete(certificateId);
                } else {
                    selectedCertificates.add(certificateId);
                }
                updateSelectedCount();
            }
        }
        
        // Toggle select all
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const readyCertificates = filteredPrintCertificates.filter(cert => cert.status === 'ready');
            
            if (selectAllCheckbox.checked) {
                readyCertificates.forEach(cert => selectedCertificates.add(cert.id));
            } else {
                readyCertificates.forEach(cert => selectedCertificates.delete(cert.id));
            }
            
            updateSelectedCount();
            displayPrintCertificates();
        }
        
        // Update selected count
        function updateSelectedCount() {
            const count = selectedCertificates.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('batchPrintBtn').disabled = count === 0;
        }
        
        // Filter print certificates
        function filterPrintCertificates() {
            const statusFilter = document.getElementById('printStatusFilter').value;
            const departmentFilter = document.getElementById('printDepartmentFilter').value;
            
            filteredPrintCertificates = allPrintCertificates.filter(cert => {
                let matchesStatus = statusFilter === 'all' || 
                    (statusFilter === 'ready' && cert.status === 'ready') ||
                    (statusFilter === 'printed' && cert.status === 'printed');
                let matchesDepartment = departmentFilter === 'all' || cert.department === departmentFilter;
                
                return matchesStatus && matchesDepartment;
            });
            
            // Clear selections when filtering
            selectedCertificates.clear();
            displayPrintCertificates();
            updatePrintCertificatesCount();
            updateSelectedCount();
        }
        
        // Update print certificates count
        function updatePrintCertificatesCount() {
            const countElement = document.getElementById('printCertificatesCount');
            countElement.textContent = `${filteredPrintCertificates.length} Certificates`;
        }
        
        // Refresh print certificates
        function refreshPrintCertificates() {
            loadPrintCertificatesData();
        }
        
        // View print certificate details
        function viewPrintCertificate(certificateId) {
            const cert = allPrintCertificates.find(c => c.id === certificateId);
            if (cert) {
                const formatDate = (timestamp) => {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                };
                
                let details = `Certificate Print Details:\n\nCertificate ID: ${cert.id}\nApplication ID: ${cert.applicationId}\nStudent: ${cert.studentName}\nRoll No: ${cert.rollNo}\nDepartment: ${cert.department}\nYear: ${cert.year}\nPurpose: ${cert.purpose}\nContact: ${cert.contactNumber}\nEmail: ${cert.email}\nPriority: ${cert.priority.toUpperCase()}\nStatus: ${cert.status.toUpperCase()}\nApproved: ${formatDate(cert.approvedDate)}\nApproved By: ${cert.approvedBy}`;
                
                if (cert.status === 'printed') {
                    details += `\nPrinted: ${formatDate(cert.printedDate)}\nPrinted By: ${cert.printedBy}`;
                }
                
                alert(details);
            }
        }
        
        // Print single certificate
        function printSingleCertificate(certificateId) {
            if (confirm('Are you sure you want to print this certificate?')) {
                const cert = allPrintCertificates.find(c => c.id === certificateId);
                if (cert) {
                    cert.status = 'printed';
                    cert.printedDate = Date.now();
                    cert.printedBy = 'Clerk Admin';
                    
                    // Remove from selected if it was selected
                    selectedCertificates.delete(certificateId);
                    
                    alert(`Certificate ${cert.id} printed successfully!`);
                    filterPrintCertificates();
                }
            }
        }
        
        // Print selected certificates
        function printSelectedCertificates() {
            if (selectedCertificates.size === 0) {
                alert('Please select certificates to print.');
                return;
            }
            
            if (confirm(`Are you sure you want to print ${selectedCertificates.size} selected certificates?`)) {
                let printedCount = 0;
                selectedCertificates.forEach(certId => {
                    const cert = allPrintCertificates.find(c => c.id === certId);
                    if (cert && cert.status === 'ready') {
                        cert.status = 'printed';
                        cert.printedDate = Date.now();
                        cert.printedBy = 'Clerk Admin';
                        printedCount++;
                    }
                });
                
                selectedCertificates.clear();
                alert(`${printedCount} certificates printed successfully!`);
                filterPrintCertificates();
            }
        }
        
        // Certificate History functionality
        let allHistoryRecords = [];
        let filteredHistoryRecords = [];
        let currentPage = 1;
        const recordsPerPage = 10;
        
        // History records data (will be loaded from Firebase)
        // Sample data removed - using Firebase only
        
        // Show certificate history section
        async function showCertificateHistory() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('applicationsSection').style.display = 'none';
            document.getElementById('approveCertificatesSection').style.display = 'none';
            document.getElementById('printCertificatesSection').style.display = 'none';
            document.getElementById('certificateHistorySection').style.display = 'block';
            
            // Set active navigation
            setActiveNavigation('nav-history');
            
            // Load history data
            await loadHistoryData();
        }
        
        // Load history data
        async function loadHistoryData() {
            try {
                // Load all applications from Firebase for history
                if (window.firebase && window.firebase.database) {
                    const snapshot = await window.firebase.database().ref('bonafideApplications').once('value');
                    const data = snapshot.val();
                    
                    if (data) {
                        // Load all applications (approved, rejected, pending)
                        allHistoryRecords = Object.keys(data)
                            .map(key => ({ id: key, firebaseKey: key, ...data[key] }))
                            .sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                        
                        console.log('History records loaded:', allHistoryRecords.length);
                    } else {
                        allHistoryRecords = [];
                    }
                } else {
                    // Fallback: Load from allApplications if Firebase not available
                    allHistoryRecords = [...allApplications].sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                }
                
                filteredHistoryRecords = [...allHistoryRecords];
                currentPage = 1;
                displayHistory();
                updateHistoryCount();
                updateHistoryStats();
                
            } catch (error) {
                console.error('Error loading history:', error);
                // Fallback to applications from memory
                allHistoryRecords = [...allApplications].sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                filteredHistoryRecords = [...allHistoryRecords];
                currentPage = 1;
                displayHistory();
                updateHistoryCount();
                updateHistoryStats();
            }
        }
        
        // Display history records with pagination
        function displayHistory() {
            const content = document.getElementById('historyContent');
            
            if (filteredHistoryRecords.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 16px; color: #9CA3AF;"></i>
                        <h3 style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No History Records Found</h3>
                        <p style="font-size: 14px;">No certificate history matches your current filters.</p>
                    </div>
                `;
                document.getElementById('historyPagination').innerHTML = '';
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const paginatedRecords = filteredHistoryRecords.slice(startIndex, endIndex);
            
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #F9FAFB;">
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Certificate ID</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Student Details</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Department</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Purpose</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Status</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Timeline</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #E5E7EB;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paginatedRecords.map(record => `
                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                    <td style="padding: 15px; color: #1F2937;"><strong>${getDisplayId(record)}</strong></td>
                                    <td style="padding: 15px; color: #1F2937;">
                                        <div><strong>${record.studentName}</strong></div>
                                        <div style="font-size: 0.8rem; color: #6B7280;">Roll: ${record.rollNumber || record.rollNo || 'N/A'} | Class: ${record.class || record.year || 'N/A'}</div>
                                        <div style="font-size: 0.8rem; color: #6B7280;"> ${record.contactNumber || 'N/A'}</div>
                                    </td>
                                    <td style="padding: 15px; color: #1F2937;">${record.department}</td>
                                    <td style="padding: 15px; color: #1F2937;">${record.purpose}</td>
                                    <td style="padding: 15px;">
                                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; ${
                                            record.status === 'issued' ? 'background: #D1FAE5; color: #10B981;' :
                                            record.status === 'printed' ? 'background: #DBEAFE; color: #3B82F6;' :
                                            'background: #FEF3C7; color: #F59E0B;'
                                        }">
                                            ${record.status}
                                        </span>
                                    </td>
                                    <td style="padding: 15px; color: #1F2937; font-size: 0.8rem;">
                                        <div>Applied: ${formatDate(record.applicationDate)}</div>
                                        <div>Approved: ${formatDate(record.approvedDate)}</div>
                                        ${record.printedDate ? `<div>Printed: ${formatDate(record.printedDate)}</div>` : ''}
                                        ${record.issuedDate ? `<div>Issued: ${formatDate(record.issuedDate)}</div>` : ''}
                                    </td>
                                    <td style="padding: 15px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="viewHistoryRecord('${record.id}')" style="background: #3B82F6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <button onclick="downloadCertificate('${record.id}')" style="background: #10B981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-download"></i> Download
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            content.innerHTML = tableHTML;
            displayPagination();
        }
        
        // Display pagination controls
        function displayPagination() {
            const totalPages = Math.ceil(filteredHistoryRecords.length / recordsPerPage);
            const pagination = document.getElementById('historyPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid #D1D5DB; background: white; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button style="padding: 8px 12px; border: 1px solid #4F46E5; background: #4F46E5; color: white; border-radius: 6px;">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})" style="padding: 8px 12px; border: 1px solid #D1D5DB; background: white; border-radius: 6px; cursor: pointer;">${i}</button>`;
                }
            }
            
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px; border: 1px solid #D1D5DB; background: white; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }
        
        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredHistoryRecords.length / recordsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayHistory();
            }
        }
        
        // Format date helper
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        // Search history
        function searchHistory() {
            filterHistory();
        }
        
        // Filter history
        function filterHistory() {
            const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('historyStatusFilter').value;
            const departmentFilter = document.getElementById('historyDepartmentFilter').value;
            const dateFilter = document.getElementById('historyDateFilter').value;
            
            filteredHistoryRecords = allHistoryRecords.filter(record => {
                let matchesSearch = searchTerm === '' || 
                    record.studentName.toLowerCase().includes(searchTerm) ||
                    record.rollNo.toLowerCase().includes(searchTerm) ||
                    record.id.toLowerCase().includes(searchTerm) ||
                    record.purpose.toLowerCase().includes(searchTerm);
                    
                let matchesStatus = statusFilter === 'all' || record.status === statusFilter;
                let matchesDepartment = departmentFilter === 'all' || record.department === departmentFilter;
                
                let matchesDate = true;
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    const recordDate = new Date(record.applicationDate);
                    matchesDate = recordDate.toDateString() === filterDate.toDateString();
                }
                
                return matchesSearch && matchesStatus && matchesDepartment && matchesDate;
            });
            
            currentPage = 1;
            displayHistory();
            updateHistoryCount();
        }
        
        // Update history count
        function updateHistoryCount() {
            const countElement = document.getElementById('historyCount');
            countElement.textContent = `${filteredHistoryRecords.length} Records`;
        }
        
        // Update history statistics
        function updateHistoryStats() {
            const totalIssued = allHistoryRecords.filter(r => r.status === 'issued').length;
            const totalPrinted = allHistoryRecords.filter(r => r.status === 'printed' || r.status === 'issued').length;
            
            const now = new Date();
            const thisMonth = allHistoryRecords.filter(r => {
                const recordDate = new Date(r.issuedDate || r.printedDate || r.approvedDate);
                return recordDate.getMonth() === now.getMonth() && recordDate.getFullYear() === now.getFullYear();
            }).length;
            
            const oneWeekAgo = now.getTime() - (7 * 24 * 60 * 60 * 1000);
            const thisWeek = allHistoryRecords.filter(r => {
                const recordDate = new Date(r.issuedDate || r.printedDate || r.approvedDate);
                return recordDate.getTime() >= oneWeekAgo;
            }).length;
            
            document.getElementById('totalIssued').textContent = totalIssued;
            document.getElementById('totalPrinted').textContent = totalPrinted;
            document.getElementById('thisMonth').textContent = thisMonth;
            document.getElementById('thisWeek').textContent = thisWeek;
        }
        
        // Refresh history
        function refreshHistory() {
            loadHistoryData();
        }
        
        // View history record details
        function viewHistoryRecord(recordId) {
            const record = allHistoryRecords.find(r => r.id === recordId);
            if (record) {
                let details = `Certificate History Details:\n\nCertificate ID: ${record.id}\nApplication ID: ${record.applicationId}\nStudent: ${record.studentName}\nRoll No: ${record.rollNo}\nDepartment: ${record.department}\nYear: ${record.year}\nPurpose: ${record.purpose}\nContact: ${record.contactNumber}\nEmail: ${record.email}\nStatus: ${record.status.toUpperCase()}\n\nTimeline:\nApplied: ${formatDate(record.applicationDate)}\nApproved: ${formatDate(record.approvedDate)} by ${record.approvedBy}`;
                
                if (record.printedDate) {
                    details += `\nPrinted: ${formatDate(record.printedDate)} by ${record.printedBy}`;
                }
                
                if (record.issuedDate) {
                    details += `\nIssued: ${formatDate(record.issuedDate)} by ${record.issuedBy}`;
                }
                
                alert(details);
            }
        }
        
        // Download certificate
        function downloadCertificate(recordId) {
            const record = allHistoryRecords.find(r => r.id === recordId);
            if (record) {
                if (record.status === 'issued' || record.status === 'printed') {
                    alert(`Downloading certificate ${record.id} for ${record.studentName}...\n\nNote: In a real system, this would download the actual certificate PDF.`);
                } else {
                    alert('Certificate is not yet ready for download. It must be printed or issued first.');
                }
            }
        }
        
        // Export history
        function exportHistory() {
            if (filteredHistoryRecords.length === 0) {
                alert('No records to export.');
                return;
            }
            
            alert(`Exporting ${filteredHistoryRecords.length} history records...\n\nNote: In a real system, this would generate and download an Excel/CSV file with all the filtered records.`);
        }
        
        // Handle logout functionality
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear session storage
                sessionStorage.removeItem('clerkToken');
                sessionStorage.removeItem('clerkData');
                
                // Clear local storage if any
                localStorage.removeItem('clerkSession');
                
                // Show logout message
                alert('You have been logged out successfully!');
                
                // Redirect to login page
                window.location.href = 'welcome.html';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            initializeNavigation();
            initializePasswordForm();
            initializeModalHandlers();
        });

        // Mobile Menu Toggle Function
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const menuButton = document.querySelector('.mobile-menu-toggle i');
            
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                menuButton.classList.remove('fa-times');
                menuButton.classList.add('fa-bars');
            } else {
                sidebar.classList.add('active');
                menuButton.classList.remove('fa-bars');
                menuButton.classList.add('fa-times');
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const sidebar = document.querySelector('.sidebar');
            const menuButton = document.querySelector('.mobile-menu-toggle');
            
            if (sidebar.classList.contains('active') && 
                !sidebar.contains(event.target) && 
                !menuButton.contains(event.target)) {
                sidebar.classList.remove('active');
                const menuIcon = menuButton.querySelector('i');
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
            }
        });
    </script>
    
    <!-- Firebase Scripts - Using same version as firebase-config.js -->
    
    <script>
        // Firebase Integration for Clerk Panel
        let firebaseInitialized = false;
        
        // Initialize Firebase connection
        function initializeFirebase() {
            try {
                // Wait for Firebase to be loaded from firebase-config.js
                if (typeof firebase !== 'undefined') {
                    // Check if Firebase app is already initialized
                    if (firebase.apps.length > 0) {
                        console.log('Firebase already initialized, using existing app');
                        firebaseInitialized = true;
                        loadFirebaseData();
                    } else {
                        console.log('Firebase available but not initialized, waiting for config...');
                        // Wait a bit more for firebase-config.js to initialize
                        setTimeout(() => {
                            if (firebase.apps.length > 0) {
                                console.log('Firebase initialized by config file');
                                firebaseInitialized = true;
                                loadFirebaseData();
                            } else {
                                console.log('Firebase config not found, using sample data');
                                firebaseInitialized = false;
                            }
                        }, 1000);
                    }
                } else {
                    console.log('Firebase not available, using sample data');
                    firebaseInitialized = false;
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.log('Using sample data instead of Firebase');
                firebaseInitialized = false;
            }
        }
        
        // Load data from Firebase
        async function loadFirebaseData() {
            if (!firebaseInitialized) {
                console.log('Firebase not initialized, using sample data');
                return;
            }
            
            try {
                // Load applications from Firebase with error handling
                const applicationsRef = firebase.database().ref('bonafideApplications');
                applicationsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Convert Firebase data to array format
                        allApplications = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        
                        // Update displays if on applications section
                        if (document.getElementById('applicationsSection').style.display !== 'none') {
                            filteredApplications = [...allApplications];
                            displayApplications();
                            updateApplicationsCount();
                        }
                        
                        console.log('Applications loaded from Firebase:', allApplications.length);
                    }
                }, (error) => {
                    console.log('Permission denied for applications, using sample data');
                    // Keep using sample data if permission denied
                });
                
                // Load certificates from Firebase
                const certificatesRef = firebase.database().ref('certificates');
                certificatesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Convert Firebase data to array format
                        allCertificates = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        
                        // Update displays if on certificates section
                        if (document.getElementById('approveCertificatesSection').style.display !== 'none') {
                            filteredCertificates = [...allCertificates];
                            displayCertificates();
                            updateCertificatesCount();
                        }
                        
                        console.log('Certificates loaded from Firebase:', allCertificates.length);
                    }
                }, (error) => {
                    console.log('Permission denied for certificates, using sample data');
                });
                
                // Load print queue from Firebase
                const printQueueRef = firebase.database().ref('printQueue');
                printQueueRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        allPrintCertificates = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        
                        // Update displays if on print section
                        if (document.getElementById('printCertificatesSection').style.display !== 'none') {
                            filteredPrintCertificates = [...allPrintCertificates];
                            displayPrintCertificates();
                            updatePrintCertificatesCount();
                        }
                        
                        console.log('Print queue loaded from Firebase:', allPrintCertificates.length);
                    }
                });
                
                // Load history from Firebase
                const historyRef = firebase.database().ref('certificateHistory');
                historyRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        allHistoryRecords = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        
                        // Update displays if on history section
                        if (document.getElementById('certificateHistorySection').style.display !== 'none') {
                            filteredHistoryRecords = [...allHistoryRecords];
                            displayHistory();
                            updateHistoryCount();
                            updateHistoryStats();
                        }
                        
                        console.log('History loaded from Firebase:', allHistoryRecords.length);
                    }
                });
                
                // Load dashboard stats from Firebase
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error loading Firebase data:', error);
                console.log('Using sample data instead');
            }
        }
        
        // Load dashboard statistics from Firebase
        async function loadDashboardStats() {
            if (!firebaseInitialized) {
                console.log('Firebase not initialized, keeping sample dashboard stats');
                return;
            }
            
            try {
                const statsRef = firebase.database().ref('dashboardStats');
                const snapshot = await statsRef.once('value');
                const stats = snapshot.val();
                
                if (stats) {
                    // Update dashboard cards with real data
                    document.getElementById('totalApplications').textContent = stats.totalApplications || '0';
                    document.getElementById('pendingApplications').textContent = stats.pendingApplications || '0';
                    document.getElementById('approvedCertificates').textContent = stats.approvedCertificates || '0';
                    document.getElementById('issuedCertificates').textContent = stats.issuedCertificates || '0';
                    
                    console.log('Dashboard stats loaded from Firebase');
                } else {
                    console.log('No dashboard stats found in Firebase, keeping sample data');
                }
            } catch (error) {
                if (error.code === 'PERMISSION_DENIED') {
                    console.log('Permission denied for dashboard stats, keeping sample data');
                } else {
                    console.log('Error loading dashboard stats, keeping sample data:', error.message);
                }
                // Don't show error to user, just keep sample data
            }
        }
        
        // Update application status in Firebase
        async function updateApplicationInFirebase(applicationId, updates) {
            if (!firebaseInitialized) {
                console.log('Firebase not available, updating local data only');
                return;
            }
            
            try {
                const appRef = firebase.database().ref(`bonafideApplications/${applicationId}`);
                await appRef.update(updates);
                console.log('Application updated in Firebase:', applicationId);
            } catch (error) {
                console.error('Error updating application in Firebase:', error);
            }
        }
        
        // Update certificate status in Firebase
        async function updateCertificateInFirebase(certificateId, updates) {
            if (!firebaseInitialized) {
                console.log('Firebase not available, updating local data only');
                return;
            }
            
            try {
                const certRef = firebase.database().ref(`certificates/${certificateId}`);
                await certRef.update(updates);
                console.log('Certificate updated in Firebase:', certificateId);
            } catch (error) {
                console.error('Error updating certificate in Firebase:', error);
            }
        }
        
        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for firebase-config.js to load and initialize Firebase
            setTimeout(() => {
                if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    console.log('Firebase initialized by config file, enabling integration');
                    firebaseInitialized = true;
                    loadFirebaseData();
                } else {
                    console.log('Firebase not available or not initialized, using sample data');
                    firebaseInitialized = false;
                }
            }, 2000); // Wait 2 seconds for firebase-config.js to complete
        });
        
        // Override existing functions to use Firebase
        const originalApproveApplication = approveApplication;
        approveApplication = async function(applicationId) {
            // Call original function
            originalApproveApplication(applicationId);
            
            // Update in Firebase
            const app = allApplications.find(a => a.id === applicationId);
            if (app) {
                await updateApplicationInFirebase(applicationId, {
                    status: 'approved',
                    processedDate: Date.now(),
                    processedBy: 'Clerk Admin'
                });
            }
        };
        
        const originalRejectApplication = rejectApplication;
        rejectApplication = async function(applicationId) {
            // Call original function
            originalRejectApplication(applicationId);
            
            // Update in Firebase
            const app = allApplications.find(a => a.id === applicationId);
            if (app) {
                await updateApplicationInFirebase(applicationId, {
                    status: 'rejected',
                    processedDate: Date.now(),
                    processedBy: 'Clerk Admin',
                    rejectionReason: app.rejectionReason
                });
            }
        };
        
        console.log('Firebase integration loaded for Clerk Panel');
        
        // Handle logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any stored session data
                localStorage.removeItem('clerkLoggedIn');
                localStorage.removeItem('clerkName');
                sessionStorage.clear();
                
                // Redirect to login page
                window.location.href = 'index.html';
            }
        }
    </script>
    <!-- Firebase SDKs (MUST be before firebase-config.js) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</body>
</html>
