<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Students - BVIT Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="firebase-config.js"></script>
    <!-- SheetJS library for Excel handling -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: rgba(79, 70, 229, 0.1);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text-dark: #1F2937;
            --text-medium: #4B5563;
            --text-light: #6B7280;
            --border-color: #E5E7EB;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--text-dark);
            margin: 0;
            font-size: 24px;
        }

        .back-button {
            color: var(--text-medium);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .back-button:hover {
            color: var(--primary);
        }

        .upload-section {
            border: 2px dashed var(--border-color);
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 30px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-section i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .upload-section h3 {
            margin: 0 0 10px;
            color: var(--text-dark);
        }

        .upload-section p {
            margin: 0;
            color: var(--text-medium);
            font-size: 14px;
        }

        .preview-section {
            display: none;
            margin-top: 30px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-table th {
            background: var(--primary-light);
            color: var(--text-dark);
            font-weight: 600;
        }

        .preview-table tr:hover {
            background: #f9fafb;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--text-medium);
        }

        .actions {
            display: none;
            margin-top: 20px;
            gap: 10px;
        }

        .progress-bar {
            display: none;
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .template-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }

        .template-section h3 {
            color: var(--text-dark);
            margin: 0 0 15px;
        }

        .template-section p {
            color: var(--text-medium);
            margin: 0 0 15px;
            font-size: 14px;
        }

        #fileInput {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .upload-section {
                padding: 20px;
            }

            .preview-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Import Students</h1>
            <a href="student-management.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
                Back to Student Management
            </a>
        </div>

        <div class="upload-section" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-file-excel"></i>
            <h3>Upload Excel File</h3>
            <p>Click or drag & drop your Excel file here</p>
            <p class="text-sm">Supported formats: .xlsx, .xls</p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
        </div>

        <div id="progressBar" class="progress-bar">
            <div class="progress-bar-fill"></div>
        </div>

        <div id="previewSection" class="preview-section">
            <h3>Preview Data</h3>
            <div class="table-container">
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Branch</th>
                            <th>Year</th>
                            <th>Division</th>
                        </tr>
                    </thead>
                    <tbody id="previewTableBody"></tbody>
                </table>
            </div>
            <div class="actions" id="actionButtons">
                <button class="btn btn-primary" onclick="importStudents()">
                    <i class="fas fa-file-import"></i>
                    Import Students
                </button>
                <button class="btn btn-secondary" onclick="cancelImport()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>

        <div class="template-section">
            <h3>Download Template</h3>
            <p>Use our template file to ensure correct data format for import.</p>
            <button class="btn btn-secondary" onclick="downloadTemplate()">
                <i class="fas fa-download"></i>
                Download Template
            </button>
        </div>
    </div>

    <script>
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(window.firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database();

        let studentsData = [];

        // Validate data
        function validateData(data) {
            if (!Array.isArray(data) || data.length === 0) {
                showAlert('No data found in the file.', 'error');
                return false;
            }

            let isValid = true;
            const errors = [];

            data.forEach((student, index) => {
                const rowNum = index + 2; // Add 2 because of 0-based index and header row
                
                // Check required fields
                if (!student.rollNo) errors.push(`Row ${rowNum}: Roll No is required`);
                if (!student.name) errors.push(`Row ${rowNum}: Name is required`);
                if (!student.branch) errors.push(`Row ${rowNum}: Branch is required`);
                if (!student.year) errors.push(`Row ${rowNum}: Year is required`);

                // Validate email if provided
                if (student.email && !isValidEmail(student.email)) {
                    errors.push(`Row ${rowNum}: Invalid email format - ${student.email}`);
                }

                // Validate phone if provided
                if (student.phone && !isValidPhone(student.phone)) {
                    errors.push(`Row ${rowNum}: Invalid phone number format - ${student.phone}`);
                }

                // Validate year
                const validYears = ['First', 'Second', 'Third', 'Fourth'];
                if (student.year && !validYears.includes(student.year)) {
                    errors.push(`Row ${rowNum}: Year must be one of: First, Second, Third, Fourth`);
                }

                // Validate branch
                const validBranches = [
                    'Computer Technology',
                    'Information Technology',
                    'Electronics & Telecommunication',
                    'Mechanical Engineering',
                    'Civil Engineering',
                    'Electrical Engineering',
                    'Artificial Intelligence'
                ];
                
                // Case-insensitive branch check
                const branchFound = validBranches.some(
                    validBranch => student.branch?.toLowerCase() === validBranch.toLowerCase()
                );
                
                if (student.branch && !branchFound) {
                    errors.push(`Row ${rowNum}: Branch must be one of: Computer Technology, Information Technology, Electronics & Telecommunication, Mechanical Engineering, Civil Engineering, Electrical Engineering, Artificial Intelligence`);
                }

                // Validate division if provided
                if (student.division) {
                    const validDivisions = ['A', 'B', 'C', 'D'];
                    if (!validDivisions.includes(student.division)) {
                        errors.push(`Row ${rowNum}: Division must be one of: A, B, C, D (if provided)`);
                    }
                }
            });

            if (errors.length > 0) {
                // Show first 3 errors to avoid overwhelming the user
                const displayErrors = errors.slice(0, 3);
                if (errors.length > 3) {
                    displayErrors.push(`...and ${errors.length - 3} more errors`);
                }
                showAlert(displayErrors.join('<br>'), 'error');
                isValid = false;
            }

            return isValid;
        }

        // Helper functions
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function isValidPhone(phone) {
            return /^\d{10}$/.test(phone.toString().replace(/[^0-9]/g, ''));
        }

        function generatePassword() {
            const length = 12;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        // Function to check if email exists in Auth
        async function checkEmailExistsInAuth(email) {
            try {
                const signInMethods = await auth.fetchSignInMethodsForEmail(email);
                return signInMethods.length > 0;
            } catch (error) {
                if (error.code === 'auth/invalid-email') {
                    throw new Error('Invalid email format');
                }
                return false;
            }
        }

        // Generate default email for student
        function generateDefaultEmail(student) {
            // Remove spaces and special characters from name
            const cleanName = student.name.toLowerCase()
                .replace(/[^a-z0-9]/g, '')
                .substring(0, 10);
            
            // Get branch abbreviation
            const branchAbbr = student.branch
                .split(' ')[0]
                .toLowerCase()
                .substring(0, 3);
            
            // Create email with name, roll no and branch
            return `${cleanName}${student.rollNo}${branchAbbr}@bvit.edu`;
        }

        // Add auth state check
        auth.onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Check if user is admin
                const adminSnapshot = await db.ref('admins/' + user.uid).once('value');
                if (!adminSnapshot.exists()) {
                    showAlert('Only administrators can access this page.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                    return;
                }

                // Store admin status in session
                sessionStorage.setItem('isAdminLoggedIn', 'true');

                // Check database rules
                try {
                    const rulesTest = await db.ref('students')
                        .orderByChild('email')
                        .limitToFirst(1)
                        .once('value');
                    console.log('Database rules check passed');
                } catch (error) {
                    if (error.code === 'PERMISSION_DENIED') {
                        console.error('Database rules error: Make sure .indexOn rule is set for email field in students node');
                        showAlert('Warning: Database performance might be affected. Please contact administrator.', 'warning');
                    }
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
                showAlert('Error checking permissions. Please try again.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        });

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['xlsx', 'xls'].includes(fileExtension)) {
                showAlert('Please upload a valid Excel file (.xlsx or .xls)', 'error');
                return;
            }

            try {
                const data = await readExcelFile(file);
                if (validateData(data)) {
                    studentsData = data;
                    showPreview(data);
                }
            } catch (error) {
                console.error('Error reading file:', error);
                showAlert('Error reading file. Please check the format and try again.', 'error');
            }
        });

        // Read Excel file
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Convert to JSON with header row
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            header: ['rollNo', 'name', 'email', 'phone', 'branch', 'year', 'division'],
                            range: 1,  // Skip header row
                            defval: '' // Set default value for empty cells
                        });

                        if (jsonData.length === 0) {
                            showAlert('No data found in the Excel file. Please check the file content.', 'error');
                            reject(new Error('No data found'));
                            return;
                        }

                        // Process and validate each row
                        const students = jsonData
                            .map(row => {
                                // Convert all values to string and trim
                                const processedRow = {
                                    rollNo: (row.rollNo || '').toString().trim(),
                                    name: (row.name || '').toString().trim(),
                                    email: row.email ? row.email.toString().trim() : '', // Keep email empty if not provided
                                    phone: (row.phone || '').toString().trim(),
                                    branch: (row.branch || '').toString().trim(),
                                    year: (row.year || '').toString().trim(),
                                    division: (row.division || '').toString().trim()
                                };
                                
                                // Remove the example.com email if it's the default
                                if (processedRow.email.includes('example.com')) {
                                    processedRow.email = '';
                                }
                                
                                return processedRow;
                            })
                            .filter(student => {
                                // Filter out completely empty rows - at least one required field should be present
                                return student.rollNo || student.name || student.branch || student.year;
                            });

                        resolve(students);
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        showAlert('Error reading Excel file. Please check the format.', 'error');
                        reject(error);
                    }
                };
                reader.onerror = (error) => {
                    console.error('FileReader error:', error);
                    showAlert('Error reading file. Please try again.', 'error');
                    reject(error);
                };
                reader.readAsBinaryString(file);
            });
        }

        // Show preview
        function showPreview(data) {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            data.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.rollNo}</td>
                    <td>${student.name}</td>
                    <td>${student.email}</td>
                    <td>${student.phone || '-'}</td>
                    <td>${student.branch}</td>
                    <td>${student.year}</td>
                    <td>${student.division}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex';
        }

        // Add batch password reset function
        async function sendPasswordResetEmails(emails, batchSize = 5) {
            const results = {
                success: 0,
                failed: 0,
                errors: []
            };

            // Process emails in batches
            for (let i = 0; i < emails.length; i += batchSize) {
                const batch = emails.slice(i, i + batchSize);
                
                // Add delay between batches to avoid rate limiting
                if (i > 0) {
                    await new Promise(resolve => setTimeout(resolve, 60000)); // 1 minute delay between batches
                }

                // Send password reset emails for this batch
                for (const email of batch) {
                    try {
                        await auth.sendPasswordResetEmail(email);
                        results.success++;
                    } catch (error) {
                        results.failed++;
                        results.errors.push(`Failed to send reset email to ${email}: ${error.message}`);
                    }
                }
            }

            return results;
        }

        // Function to create student user using Firebase Auth REST API
        async function createStudentUser(studentData) {
            try {
                // Get admin token
                const idToken = await auth.currentUser.getIdToken();

                // Create user using Firebase Auth REST API
                const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyDClVT8h1T6mBcfD4USQU3a6iINmyWTNmk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: studentData.email,
                        password: studentData.password,
                        displayName: studentData.displayName,
                        returnSecureToken: true
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message);
                }

                const data = await response.json();
                return data.localId; // This is the user UID
            } catch (error) {
                console.error('Error creating student:', error);
                throw error;
            }
        }

        // Import students
        async function importStudents() {
            // First check if user is admin
            const adminUser = auth.currentUser;
            if (!adminUser) {
                showAlert('You must be logged in to import students.', 'error');
                return;
            }

            try {
                const adminSnapshot = await db.ref('admins/' + adminUser.uid).once('value');
                if (!adminSnapshot.exists()) {
                    showAlert('Only administrators can import students.', 'error');
                    return;
                }

                const progressBar = document.getElementById('progressBar');
                const progressBarFill = progressBar.querySelector('.progress-bar-fill');
                progressBar.style.display = 'block';

                try {
                    let totalSuccess = 0;
                    let totalSkipped = 0;
                    let totalErrors = 0;
                    const errors = [];
                    const existingEmails = new Set();
                    const authExistingEmails = new Set();
                    const newStudentEmails = [];
                    const batchSize = 5; // Process 5 students at a time

                    // First, collect all existing emails from database
                    const existingStudentsSnapshot = await db.ref('students')
                        .orderByChild('email')
                        .startAt('')
                        .endAt('\uf8ff')
                        .once('value');

                    if (existingStudentsSnapshot.exists()) {
                        existingStudentsSnapshot.forEach(childSnapshot => {
                            const studentData = childSnapshot.val();
                            if (studentData.email) {
                                existingEmails.add(studentData.email.toLowerCase());
                            }
                        });
                    }

                    // Pre-check all emails in Auth
                    for (const student of studentsData) {
                        if (student.email) {
                            try {
                                const exists = await checkEmailExistsInAuth(student.email);
                                if (exists) {
                                    authExistingEmails.add(student.email.toLowerCase());
                                }
                            } catch (error) {
                                console.warn(`Pre-check failed for email ${student.email}:`, error);
                            }
                        }
                    }

                    // Process students in batches
                    for (let i = 0; i < studentsData.length; i += batchSize) {
                        const batch = studentsData.slice(i, i + batchSize);
                        const progress = ((i + batch.length) / studentsData.length) * 100;
                        progressBarFill.style.width = `${progress}%`;

                        // Process each student in the batch
                        const batchPromises = batch.map(async (student, index) => {
                            try {
                                // Generate default email if not provided
                                if (!student.email) {
                                    let baseEmail = generateDefaultEmail(student);
                                    let counter = 1;
                                    let finalEmail = baseEmail;

                                    while (existingEmails.has(finalEmail.toLowerCase()) || 
                                           authExistingEmails.has(finalEmail.toLowerCase())) {
                                        finalEmail = baseEmail.replace('@bvit.edu', `${counter}@bvit.edu`);
                                        counter++;
                                    }
                                    student.email = finalEmail;
                                    console.log(`Generated unique email for ${student.name}: ${student.email}`);
                                }

                                // Check if email exists
                                if (existingEmails.has(student.email.toLowerCase())) {
                                    console.log(`Email ${student.email} already exists in database, skipping...`);
                                    errors.push(`Row ${i + index + 2}: Email ${student.email} already exists in the system`);
                                    totalSkipped++;
                                    return;
                                }

                                if (authExistingEmails.has(student.email.toLowerCase())) {
                                    console.log(`Email ${student.email} already exists in Auth, skipping...`);
                                    errors.push(`Row ${i + index + 2}: Email ${student.email} is already registered in authentication system`);
                                    totalSkipped++;
                                    return;
                                }

                                // Generate a random password
                                const password = generatePassword();

                                // Create student using REST API
                                const uid = await createStudentUser({
                                    email: student.email,
                                    password: password,
                                    displayName: student.name
                                });

                                // Save student data
                                await db.ref('students').child(uid).set({
                                    rollNo: student.rollNo,
                                    name: student.name,
                                    email: student.email,
                                    phone: student.phone || '',
                                    branch: student.branch,
                                    year: student.year,
                                    division: student.division || '',
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    passwordResetSent: false
                                });

                                // Add to tracking sets and arrays
                                existingEmails.add(student.email.toLowerCase());
                                authExistingEmails.add(student.email.toLowerCase());
                                newStudentEmails.push(student.email);
                                totalSuccess++;

                            } catch (error) {
                                console.error(`Error importing student ${student.email}:`, error);
                                errors.push(`Row ${i + index + 2}: ${error.message} (${student.email})`);
                                totalErrors++;
                            }
                        });

                        // Wait for all students in batch to be processed
                        await Promise.all(batchPromises);

                        // Add delay between batches to avoid rate limiting
                        if (i + batchSize < studentsData.length) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }

                    // Show import summary
                    let message = `Import completed:<br>`;
                    message += `✅ Successfully imported: ${totalSuccess}<br>`;
                    if (totalSkipped > 0) message += `⚠️ Skipped (already exists): ${totalSkipped}<br>`;
                    if (totalErrors > 0) {
                        message += `❌ Failed to import: ${totalErrors}<br>`;
                        message += `<br>Detailed Errors:<br>`;
                        message += errors.join('<br>');
                    }

                    // If we have new students, show password reset option
                    if (newStudentEmails.length > 0) {
                        message += `<br><br>Would you like to send password reset emails now?<br>`;
                        message += `<button class="btn btn-primary" onclick="sendPasswordResets(${JSON.stringify(newStudentEmails)})">`;
                        message += `<i class="fas fa-envelope"></i> Send Password Reset Emails</button>`;
                        message += `<br><small>(Will be sent in batches to avoid rate limiting)</small>`;
                    }

                    const alertType = totalErrors === 0 ? 'success' : (totalSuccess > 0 ? 'warning' : 'error');
                    showAlert(message, alertType);

                    if (totalSuccess > 0 && newStudentEmails.length === 0) {
                        setTimeout(() => {
                            window.location.href = 'student-management.html';
                        }, 7000);
                    }

                } catch (error) {
                    console.error('Import error:', error);
                    showAlert('Error importing students: ' + error.message, 'error');
                } finally {
                    progressBar.style.display = 'none';
                }

            } catch (error) {
                console.error('Error checking admin status:', error);
                showAlert('Error checking permissions. Please try again.', 'error');
                return;
            }
        }

        // Cancel import
        function cancelImport() {
            document.getElementById('fileInput').value = '';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            studentsData = [];
        }

        // Download template
        window.downloadTemplate = function() {
            try {
                // Define column widths
                const colWidths = [
                    { wch: 10 }, // Roll No
                    { wch: 30 }, // Name
                    { wch: 30 }, // Email
                    { wch: 15 }, // Phone
                    { wch: 35 }, // Branch
                    { wch: 10 }, // Year
                    { wch: 10 }  // Division
                ];
                
                // Create worksheet with sample data
                const template = [
                    ['Roll No', 'Name', 'Email (Optional)', 'Phone', 'Branch', 'Year', 'Division'],
                    ['1', 'Rahul Sharma', '', '9876543210', 'Computer Technology', 'First', 'A'],
                    ['2', 'Priya Patel', '', '9876543211', 'Information Technology', 'Second', 'B'],
                    ['3', 'Amit Kumar', '', '9876543212', 'Electronics & Telecommunication', 'Third', ''],
                    ['4', 'Sneha Desai', '', '9876543213', 'Mechanical Engineering', 'First', 'A'],
                    ['5', 'Raj Patil', '', '9876543214', 'Civil Engineering', 'Fourth', 'C'],
                    ['6', 'Neha Singh', '', '9876543215', 'Electrical Engineering', 'Second', 'B'],
                    ['7', 'Aditya Shah', '', '9876543216', 'Artificial Intelligence', 'First', 'A']
                ];

                // Add note about valid values
                const note = [
                    ['Note: Please use exactly these values:'],
                    ['Branch:', 'Computer Technology, Information Technology, Electronics & Telecommunication, Mechanical Engineering, Civil Engineering, Electrical Engineering, Artificial Intelligence'],
                    ['Year:', 'First, Second, Third, Fourth'],
                    ['Division:', 'A, B, C, D (optional)'],
                    [''],
                    ['Important:'],
                    ['1. Branch names must match exactly as given above'],
                    ['2. Year must be written as First, Second, Third, Fourth (not 1st, 2nd, etc.)'],
                    ['3. Division is optional, but if given must be A, B, C, or D'],
                    ['4. Email is optional - system will generate default email if not provided'],
                    ['5. Phone number should be 10 digits']
                ];

                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(template);
                const noteWs = XLSX.utils.aoa_to_sheet(note);

                // Set column widths
                ws['!cols'] = colWidths;

                // Add worksheets to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Students Template');
                XLSX.utils.book_append_sheet(wb, noteWs, 'Instructions');

                // Save the file
                XLSX.writeFile(wb, 'student_import_template.xlsx');
                showAlert('Template downloaded successfully! Please check both sheets for format and instructions.', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showAlert('Error downloading template. Please try again.', 'error');
            }
        };

        // Handle drag and drop
        const uploadSection = document.querySelector('.upload-section');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--primary)';
            uploadSection.style.background = 'var(--primary-light)';
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--border-color)';
            uploadSection.style.background = '#fafafa';
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = 'var(--border-color)';
            uploadSection.style.background = '#fafafa';

            const file = e.dataTransfer.files[0];
            if (file) {
                const fileInput = document.getElementById('fileInput');
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Update showAlert function to handle warning type
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            let icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            alertDiv.innerHTML = `
                <i class="fas fa-${icon}"></i>
                ${message}
            `;

            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);

            // Remove after longer duration for error/warning messages
            const duration = type === 'success' ? 5000 : 10000;
            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }

        // Add warning style
        const style = document.createElement('style');
        style.textContent = `
            .alert-warning {
                background: rgba(245, 158, 11, 0.1);
                color: var(--warning);
                border: 1px solid rgba(245, 158, 11, 0.2);
            }
        `;
        document.head.appendChild(style);

        // Add info alert style
        const styleInfo = document.createElement('style');
        styleInfo.textContent = `
            .alert-info {
                background: rgba(59, 130, 246, 0.1);
                color: #2563EB;
                border: 1px solid rgba(59, 130, 246, 0.2);
            }
            
            .btn {
                margin: 10px 0;
            }
        `;
        document.head.appendChild(styleInfo);
    </script>
</body>
</html> 