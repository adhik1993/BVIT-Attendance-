<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .student-row { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .btn-attendance { padding: 8px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .present { background: #10b981; color: white; }
        .absent { background: #ef4444; color: white; }
        .present.active { background: #059669; }
        .absent.active { background: #dc2626; }
        .save-btn { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; margin: 10px 0; }
        .save-btn:disabled { background: #fbbf24; color: #92400e; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Attendance Debug Test</h1>
    
    <div class="debug-info">
        <h3>Debug Information:</h3>
        <div id="debugInfo">
            <p>Total Students: <span id="totalCount">0</span></p>
            <p>Marked Students: <span id="markedCount">0</span></p>
            <p>Local Attendance: <span id="localData">{}</span></p>
        </div>
    </div>

    <div id="studentsContainer">
        <h3>Test Students:</h3>
        <div class="student-row">
            <strong>Student 1 (Roll: 1)</strong>
            <button class="btn-attendance present" onclick="markAttendance('student1', true)">Present</button>
            <button class="btn-attendance absent" onclick="markAttendance('student1', false)">Absent</button>
        </div>
        <div class="student-row">
            <strong>Student 2 (Roll: 2)</strong>
            <button class="btn-attendance present" onclick="markAttendance('student2', true)">Present</button>
            <button class="btn-attendance absent" onclick="markAttendance('student2', false)">Absent</button>
        </div>
        <div class="student-row">
            <strong>Student 3 (Roll: 3)</strong>
            <button class="btn-attendance present" onclick="markAttendance('student3', true)">Present</button>
            <button class="btn-attendance absent" onclick="markAttendance('student3', false)">Absent</button>
        </div>
    </div>

    <button class="save-btn" id="saveBtn" onclick="saveAttendance()" style="display: none;">
        Save Attendance
    </button>

    <div class="debug-info">
        <h3>Console Output:</h3>
        <div id="consoleOutput" style="height: 200px; overflow-y: auto; background: black; color: lime; padding: 10px; font-family: monospace;"></div>
    </div>

    <script>
        // Mock Firebase for testing
        window.firebase = {
            database: () => ({
                ref: () => ({
                    set: (data) => {
                        console.log('🔥 FIREBASE SAVE CALLED:', data);
                        logToConsole('🔥 FIREBASE SAVE CALLED: ' + JSON.stringify(data, null, 2));
                        return Promise.resolve();
                    }
                }),
                ServerValue: { TIMESTAMP: Date.now() }
            })
        };

        // Test variables
        let localAttendance = {};
        let totalStudentsCount = 3; // 3 test students

        // Console logging function
        function logToConsole(message) {
            const output = document.getElementById('consoleOutput');
            output.innerHTML += message + '\n';
            output.scrollTop = output.scrollHeight;
        }

        // Override console.log for this test
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToConsole(args.join(' '));
        };

        // Update debug info
        function updateDebugInfo() {
            document.getElementById('totalCount').textContent = totalStudentsCount;
            document.getElementById('markedCount').textContent = Object.keys(localAttendance).length;
            document.getElementById('localData').textContent = JSON.stringify(localAttendance);
        }

        // Function to check if all students are marked
        function areAllStudentsMarked() {
            const markedCount = Object.keys(localAttendance).length;
            console.log('🔍 Checking attendance completion:', {
                markedCount: markedCount,
                totalStudents: totalStudentsCount,
                allMarked: markedCount === totalStudentsCount && totalStudentsCount > 0
            });
            return markedCount === totalStudentsCount && totalStudentsCount > 0;
        }

        // Function to show save button
        function showSaveButton() {
            console.log('📝 showSaveButton called');
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                if (areAllStudentsMarked()) {
                    saveBtn.style.display = 'block';
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save Attendance';
                    saveBtn.style.backgroundColor = '#3b82f6';
                    console.log('✅ Save button enabled - All students marked');
                } else {
                    saveBtn.style.display = 'block';
                    saveBtn.disabled = true;
                    const markedCount = Object.keys(localAttendance).length;
                    const remainingCount = totalStudentsCount - markedCount;
                    saveBtn.innerHTML = `Mark All Students (${remainingCount} remaining)`;
                    saveBtn.style.backgroundColor = '#fbbf24';
                    console.log('⚠️ Save button shown but disabled - Not all students marked');
                }
            }
            updateDebugInfo();
        }

        // Function to mark attendance
        function markAttendance(studentId, isPresent) {
            console.log('🔥🔥🔥 === MARK ATTENDANCE CALLED === 🔥🔥🔥');
            console.log('🔄 markAttendance called:', { studentId, isPresent });
            console.log('📊 Current state:', {
                totalStudentsCount: totalStudentsCount,
                localAttendanceCount: Object.keys(localAttendance).length,
                localAttendance: localAttendance
            });
            
            // Store attendance locally ONLY
            localAttendance[studentId] = isPresent;
            console.log('📊 Local attendance updated:', localAttendance);
            
            // Update UI
            const presentBtn = document.querySelector(`button.present[onclick*="${studentId}"]`);
            const absentBtn = document.querySelector(`button.absent[onclick*="${studentId}"]`);
            
            if (presentBtn && absentBtn) {
                if (isPresent) {
                    presentBtn.classList.add('active');
                    absentBtn.classList.remove('active');
                } else {
                    presentBtn.classList.remove('active');
                    absentBtn.classList.add('active');
                }
                console.log('🎨 UI updated for student:', studentId);
            }
            
            // Show save button
            showSaveButton();
            
            console.log('✅ markAttendance completed - NO Firebase operations performed');
        }

        // Function to save attendance
        function saveAttendance() {
            console.log('🔥🔥🔥 === SAVE ATTENDANCE FUNCTION CALLED === 🔥🔥🔥');
            console.log('⚠️ This function should ONLY be called when Save button is clicked');
            
            // Check if all students are marked
            if (!areAllStudentsMarked()) {
                const markedCount = Object.keys(localAttendance).length;
                const remainingCount = totalStudentsCount - markedCount;
                alert(`Please mark all students before saving. ${remainingCount} students remaining.`);
                console.log('❌ Save blocked - Not all students marked');
                return;
            }

            console.log('🔥 SAVING TO FIREBASE NOW');
            firebase.database().ref('test-attendance').set({
                students: localAttendance,
                timestamp: Date.now()
            }).then(() => {
                console.log('✅ Save completed successfully');
                alert('Attendance saved successfully!');
                // Reset
                localAttendance = {};
                document.getElementById('saveBtn').style.display = 'none';
                updateDebugInfo();
                // Reset UI
                document.querySelectorAll('.btn-attendance').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
        }

        // Initialize
        updateDebugInfo();
        console.log('🚀 Debug page loaded - Ready for testing');
    </script>
</body>
</html>
