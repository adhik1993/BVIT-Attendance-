<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal - Student Attendance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1a73e8;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .search-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .search-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            height: fit-content;
        }

        .search-btn:hover {
            background: #0d47a1;
        }

        .attendance-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .student-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid #1a73e8;
        }

        .student-info h3 {
            color: #1a73e8;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            color: #333;
        }

        .attendance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-card.present {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
        }

        .summary-card.absent {
            background: linear-gradient(135deg, #f44336, #c62828);
        }

        .summary-card.percentage {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .summary-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .attendance-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .status-present {
            color: #4caf50;
            font-weight: 600;
        }

        .status-absent {
            color: #f44336;
            font-weight: 600;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .back-btn {
            background: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #555;
        }

        @media (max-width: 768px) {
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .attendance-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="welcome.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>

        <div class="header">
            <h1><i class="fas fa-user-friends"></i> Parent Portal</h1>
            <p>View your child's daily attendance records</p>
        </div>

        <div class="search-section">
            <div class="search-form">
                <div class="form-group">
                    <label for="studentRoll">Student Roll Number</label>
                    <input type="text" id="studentRoll" placeholder="Enter roll number" required>
                </div>
                <div class="form-group">
                    <label for="dateRange">Select Date Range</label>
                    <select id="dateRange">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <button class="search-btn" onclick="searchAttendance()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <div id="customDateRange" style="display: none; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
            </div>
        </div>

        <div class="attendance-section" id="attendanceSection">
            <div class="student-info" id="studentInfo">
                <!-- Student information will be populated here -->
            </div>

            <div class="attendance-summary" id="attendanceSummary">
                <!-- Summary cards will be populated here -->
            </div>

            <div id="attendanceTableContainer">
                <!-- Attendance table will be populated here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing Firebase for parent portal...');
                
                // Wait for Firebase SDK to load
                await window.waitForFirebaseSDK();
                
                // Initialize Firebase
                await window.initializeFirebase();
                
                console.log('Firebase initialized successfully for parent portal');
                
                // Enable anonymous authentication for read access
                if (window.auth && typeof window.auth.signInAnonymously === 'function') {
                    try {
                        await window.auth.signInAnonymously();
                        console.log('Anonymous authentication successful');
                    } catch (authError) {
                        console.log('Anonymous auth failed, continuing without auth:', authError);
                    }
                }
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                alert('Unable to connect to database. Please check your internet connection and try again.');
            }
        });

        // Handle date range selection
        document.getElementById('dateRange').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'block';
            } else {
                customRange.style.display = 'none';
            }
        });

        // Calculate date range based on selection
        function getDateRange() {
            const dateRange = document.getElementById('dateRange').value;
            const today = new Date();
            let startDate, endDate;

            switch (dateRange) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'custom':
                    startDate = document.getElementById('startDate').value;
                    endDate = document.getElementById('endDate').value;
                    break;
            }

            return { startDate, endDate };
        }

        // Search for student attendance
        async function searchAttendance() {
            const rollNumber = document.getElementById('studentRoll').value.trim();
            
            if (!rollNumber) {
                alert('Please enter a roll number');
                return;
            }

            const { startDate, endDate } = getDateRange();
            
            if (!startDate || !endDate) {
                alert('Please select a valid date range');
                return;
            }

            try {
                // Show loading state
                document.getElementById('attendanceSection').style.display = 'block';
                document.getElementById('studentInfo').innerHTML = '<p>Loading student information...</p>';
                document.getElementById('attendanceSummary').innerHTML = '';
                document.getElementById('attendanceTableContainer').innerHTML = '<p>Loading attendance data...</p>';

                // Get student information - try both rollNumber and rollNo fields
                let studentSnapshot = await firebase.database().ref('students').orderByChild('rollNumber').equalTo(rollNumber).once('value');
                
                // If not found with rollNumber, try rollNo field
                if (!studentSnapshot.exists()) {
                    studentSnapshot = await firebase.database().ref('students').orderByChild('rollNo').equalTo(rollNumber).once('value');
                }
                
                if (!studentSnapshot.exists()) {
                    // Try to get some sample students to help user
                    const sampleStudents = await firebase.database().ref('students').limitToFirst(10).once('value');
                    let helpText = 'Student not found with this roll number.';
                    
                    if (sampleStudents.exists()) {
                        const students = Object.values(sampleStudents.val());
                        const rollNumbers = students.map(s => s.rollNumber || s.rollNo).filter(r => r).slice(0, 5);
                        if (rollNumbers.length > 0) {
                            helpText += `<br><br>Available roll numbers include: ${rollNumbers.join(', ')}`;
                        }
                    }
                    
                    throw new Error(helpText);
                }

                const studentData = Object.values(studentSnapshot.val())[0];
                const studentKey = Object.keys(studentSnapshot.val())[0];

                // Display student information
                displayStudentInfo(studentData);

                // Get attendance data
                const attendanceData = await getAttendanceData(studentKey, startDate, endDate);
                
                // Display attendance summary and table
                displayAttendanceSummary(attendanceData);
                displayAttendanceTable(attendanceData);

            } catch (error) {
                console.error('Error fetching attendance:', error);
                document.getElementById('studentInfo').innerHTML = `
                    <div style="background: #ffebee; border: 1px solid #e57373; border-radius: 8px; padding: 20px; color: #c62828;">
                        <h3 style="color: #c62828; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                document.getElementById('attendanceSummary').innerHTML = '';
                document.getElementById('attendanceTableContainer').innerHTML = '';
            }
        }

        // Display student information
        function displayStudentInfo(student) {
            const studentInfoHtml = `
                <h3><i class="fas fa-user-graduate"></i> Student Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Name</span>
                        <span class="info-value">${student.name || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Roll Number</span>
                        <span class="info-value">${student.rollNumber || student.rollNo || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Department</span>
                        <span class="info-value">${student.branch || student.department || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Year</span>
                        <span class="info-value">${student.year || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Division</span>
                        <span class="info-value">${student.division || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">${student.email || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Phone</span>
                        <span class="info-value">${student.phone || 'N/A'}</span>
                    </div>
                </div>
            `;
            document.getElementById('studentInfo').innerHTML = studentInfoHtml;
        }

        // Get attendance data for date range - Fixed to match roll numbers properly
        async function getAttendanceData(rollNumber, startDate, endDate) {
            console.log('Getting attendance data for roll:', rollNumber, 'from', startDate, 'to', endDate);
            
            const attendanceRef = firebase.database().ref('attendance');
            const snapshot = await attendanceRef.once('value');
            const allAttendance = snapshot.val() || {};

            const attendanceRecords = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Iterate through all attendance records
            for (const [recordKey, record] of Object.entries(allAttendance)) {
                if (!record || !record.date) continue;
                
                const recordDate = new Date(record.date);
                
                // Check if date is in range
                if (recordDate >= start && recordDate <= end) {
                    // Check if this record has students data
                    if (record.students) {
                        // Look for student by roll number in the students object
                        for (const [studentKey, studentData] of Object.entries(record.students)) {
                            // Check if this student matches our roll number
                            if (studentData.rollNo == rollNumber || studentData.rollNumber == rollNumber || studentKey == rollNumber) {
                                console.log('Found attendance record:', record);
                                console.log('Student data:', studentData);
                                
                                // Get status - Firebase stores boolean values (true/false)
                                let status = 'absent'; // default
                                
                                // Check if studentData is boolean (true = present, false = absent)
                                if (typeof studentData === 'boolean') {
                                    status = studentData ? 'present' : 'absent';
                                } else if (studentData && typeof studentData === 'object') {
                                    // If it's an object, check various fields
                                    if (studentData.status) {
                                        status = studentData.status;
                                    } else if (typeof studentData.attendance === 'boolean') {
                                        status = studentData.attendance ? 'present' : 'absent';
                                    } else if (studentData.present === true) {
                                        status = 'present';
                                    } else if (studentData.absent === true) {
                                        status = 'absent';
                                    }
                                }
                                
                                console.log('Final status:', status);
                                
                                // Get better teacher name
                                let teacherName = 'Teacher';
                                if (record.teacherName && record.teacherName !== 'N/A') {
                                    teacherName = record.teacherName;
                                } else if (record.teacher && record.teacher !== 'N/A') {
                                    teacherName = record.teacher;
                                } else if (record.createdBy && record.createdBy !== 'N/A') {
                                    teacherName = record.createdBy;
                                }
                                
                                // Get better time
                                let timeDisplay = 'Not Available';
                                if (studentData.timestamp && !isNaN(new Date(studentData.timestamp))) {
                                    timeDisplay = new Date(studentData.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                                } else if (record.timestamp && !isNaN(new Date(record.timestamp))) {
                                    timeDisplay = new Date(record.timestamp).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                                }
                                
                                attendanceRecords.push({
                                    date: record.date,
                                    subject: record.subject || 'Subject',
                                    teacher: teacherName,
                                    status: status,
                                    time: timeDisplay,
                                    lectureType: record.lectureType || 'Theory'
                                });
                                break; // Found the student, no need to continue
                            }
                        }
                    }
                }
            }

            console.log('Found attendance records:', attendanceRecords);
            return attendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Display attendance summary
        function displayAttendanceSummary(attendanceData) {
            const totalClasses = attendanceData.length;
            const presentCount = attendanceData.filter(record => record.status === 'present').length;
            const absentCount = totalClasses - presentCount;
            const percentage = totalClasses > 0 ? Math.round((presentCount / totalClasses) * 100) : 0;

            const summaryHtml = `
                <div class="summary-card">
                    <div class="summary-number">${totalClasses}</div>
                    <div class="summary-label">Total Classes</div>
                </div>
                <div class="summary-card present">
                    <div class="summary-number">${presentCount}</div>
                    <div class="summary-label">Present</div>
                </div>
                <div class="summary-card absent">
                    <div class="summary-number">${absentCount}</div>
                    <div class="summary-label">Absent</div>
                </div>
                <div class="summary-card percentage">
                    <div class="summary-number">${percentage}%</div>
                    <div class="summary-label">Attendance</div>
                </div>
            `;

            document.getElementById('attendanceSummary').innerHTML = summaryHtml;
        }

        // Display attendance table - Enhanced to show all subjects
        function displayAttendanceTable(attendanceData) {
            if (attendanceData.length === 0) {
                document.getElementById('attendanceTableContainer').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-calendar-times" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>No attendance records found</h3>
                        <p>No attendance data available for the selected date range.</p>
                    </div>
                `;
                return;
            }

            let tableHtml = `
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Subject</th>
                            <th>Lecture Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort by date (newest first) and then by subject
            attendanceData.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return a.subject.localeCompare(b.subject);
            });

            attendanceData.forEach(record => {
                const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                const statusIcon = record.status === 'present' ? 'fa-check-circle' : 'fa-times-circle';
                
                tableHtml += `
                    <tr>
                        <td>${new Date(record.date).toLocaleDateString('en-IN')}</td>
                        <td><strong>${record.subject}</strong></td>
                        <td><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${record.lectureType || 'N/A'}</span></td>
                        <td class="${statusClass}">
                            <i class="fas ${statusIcon}"></i> ${record.status.charAt(0).toUpperCase() + record.status.slice(1)}
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; color: #666;">
                    <i class="fas fa-info-circle"></i> Showing ${attendanceData.length} attendance record(s)
                </div>
            `;

            document.getElementById('attendanceTableContainer').innerHTML = tableHtml;
        }

        // Allow Enter key to trigger search
        document.getElementById('studentRoll').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAttendance();
            }
        });
    </script>
</body>
</html>
